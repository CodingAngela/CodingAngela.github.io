<!DOCTYPE html><html class="appearance-auto"><head><meta charset="UTF-8"><title>（转）LibFuzzer workshop学习之路（一）</title><meta name="description" content="May the Force be with you"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="文章首发于安全客，由安全客原创发布：https://www.anquanke.com/post/id/224823
LibFuzzer workshop学习之路（一）
最近做项目开始上手学习libfuzzer，是跟着libfuzzer-workshop学的。写下自己的心得和收获。


官方给出的定义
12LibFuzzer is in-process, coverage-guided, evolutionary fuzzing engine.LibFuzzer is linked with the library under test, and feeds fuzzed inputs to the library via a specific fuzzing entrypoint (aka “target .."><meta name="generator" content="Hexo 6.2.0"></head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Haojen's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">（转）LibFuzzer workshop学习之路（一）</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#LibFuzzer-workshop%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF%EF%BC%88%E4%B8%80%EF%BC%89"><span class="toc-text">LibFuzzer workshop学习之路（一）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%EF%BC%9A"><span class="toc-text">环境搭建：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fuzz-testing"><span class="toc-text">fuzz testing</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-cc%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-text">编译.cc文件：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%A7%8Bfuzz"><span class="toc-text">开始fuzz</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%88%E6%9D%A5lesson-04%EF%BC%8C%E8%A6%81%E6%B5%8B%E8%AF%95%E7%9A%84%E5%BA%93%E6%98%AFvulnerable-functions-h%EF%BC%9A"><span class="toc-text">先来lesson 04，要测试的库是vulnerable_functions.h：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9C%8Blesson05%EF%BC%9A"><span class="toc-text">接下来看lesson05：</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#lesson06-gogogo"><span class="toc-text">lesson06 gogogo!</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/FUZZ"><i class="tag post-item-tag">FUZZ</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">（转）LibFuzzer workshop学习之路（一）</h1><time class="has-text-grey" datetime="2020-12-17T10:00:20.000Z">2020-12-17</time><article class="mt-2 post-content"><p>文章首发于安全客，由安全客原创发布：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/224823">https://www.anquanke.com/post/id/224823</a></p>
<h3 id="LibFuzzer-workshop学习之路（一）"><a href="#LibFuzzer-workshop学习之路（一）" class="headerlink" title="LibFuzzer workshop学习之路（一）"></a>LibFuzzer workshop学习之路（一）</h3><blockquote>
<p>最近做项目开始上手学习libfuzzer，是跟着libfuzzer-workshop学的。写下自己的心得和收获。</p>
</blockquote>
<span id="more"></span>
<p>官方给出的定义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LibFuzzer is in-process, coverage-guided, evolutionary fuzzing engine.</span><br><span class="line">LibFuzzer is linked with the library under test, and feeds fuzzed inputs to the library via a specific fuzzing entrypoint (aka “target function”); the fuzzer then tracks which areas of the code are reached, and generates mutations on the corpus of input data in order to maximize the code coverage. The code coverage information for libFuzzer is provided by LLVM’s SanitizerCoverage instrumentation.</span><br></pre></td></tr></table></figure>
<p>简单来说就是通过与要进行fuzz的库连接，并将libfuzzer生成的输入通过模糊测试进入点(fuzz target)喂给要fuzz的库进行fuzz testing。同时fuzzer会跟踪哪些区域的代码已经被测试过的，并且根据种料库的输入进行变异来使得代码覆盖率最大化。代码覆盖率的信息是由LLVM’s SanitizerCoverage插桩提供的</p>
<p>需要注意的是这几个libfuzzer的特性：in-process指进程内。即libfuzzer在fuzz时并不是产生出多个进程来分别处理不同的输入，而是将所有的测试数据放入进程的内存空间中。coverage-guided指覆盖率指导的。即会进行代码覆盖率的计算，正如定义所说的使得不断增大代码覆盖率。evolutionary是指libfuzzer是进化型的fuzz，结合了产生和变异两种形式。</p>
<h4 id="环境搭建："><a href="#环境搭建：" class="headerlink" title="环境搭建："></a>环境搭建：</h4><p>跟着<a href="https://github.com/Dor1s/libfuzzer-workshop">https://github.com/Dor1s/libfuzzer-workshop</a> 搭建就好了，主要是build llvm的环境可能要make一会儿。编译好后拿到libfuzzer.a(静态链接库文件)，就可以开始上手实践了。</p>
<h4 id="fuzz-testing"><a href="#fuzz-testing" class="headerlink" title="fuzz testing"></a>fuzz testing</h4><p>libfuzzer已经提供了数据样本生成和异常检测功能，我们要做的就是要实现模糊测试进入点(fuzz target)，将libfuzzer生成的数据交给目标程序处理。<br>fuzz target编写模板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fuzz_target.cc</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  DoSomethingInterestingWithMyAPI(Data, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// Non-zero return values are reserved for future use.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是<code>LLVMFuzzerTestOneInput</code>函数即使我们要实现的接口函数，他的两个参数Data(libfuzzer的测试样本数据)，size(样本数据的大小)。<br><code>DoSomethingInterestingWithMyAPI</code>函数即我们实际要进行fuzz的函数。</p>
<h5 id="编译-cc文件："><a href="#编译-cc文件：" class="headerlink" title="编译.cc文件："></a>编译.cc文件：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang++ -g -O1 -fsanitize=fuzzer,address \</span><br><span class="line">fuzz_target.cc ../../libFuzzer/Fuzzer/libFuzzer.a \</span><br><span class="line">-o fuzzer_target</span><br></pre></td></tr></table></figure>
<p>几个参数：<br>-g 可选参数，保留调试符号。<br>-O1 指定优化等级为1<br>-fsanitize 指定sanitize。<br>fuzzer是必须的，用来启用libfuzzer。还可以附加的其他sanitize有：address(用来检测内存访问相关的错误，如stack_overflow,heap_overflow,uaf,可以与fuzzer一起使用)；memory(检测未初始化内存的访问，应单独使用)；undefined(检测其他的漏洞，如整数溢出，类型混淆等未定义的漏洞)<br>注：-fsanitize-coverage&#x3D;trace-pc-guard选项在高版本的clang中已不再适用，代码的覆盖率情况默认自动开启。</p>
<p>这一步骤整体过程就是通过clang的-fsanitize&#x3D;fuzzer选项可以启用libFuzzer，这个选项在编译和链接过程中生效，实现了条件判断语句和分支执行的记录，并且辅以libFuzzer中的库函数(libfuzzer.a)，通过生成不同的测试样例然后能够获得代码的覆盖率情况，最终实现所谓的fuzz testing。</p>
<h5 id="开始fuzz"><a href="#开始fuzz" class="headerlink" title="开始fuzz"></a>开始fuzz</h5><h6 id="先来lesson-04，要测试的库是vulnerable-functions-h："><a href="#先来lesson-04，要测试的库是vulnerable-functions-h：" class="headerlink" title="先来lesson 04，要测试的库是vulnerable_functions.h："></a>先来lesson 04，要测试的库是vulnerable_functions.h：</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LESSONS_04_VULNERABLE_FUNCTIONS_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LESSLE_FONS_04_VULNERABUNCTIONS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction1</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (size &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    result = data[<span class="number">0</span>] == <span class="string">&#x27;F&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">1</span>] == <span class="string">&#x27;U&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">2</span>] == <span class="string">&#x27;Z&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">3</span>] == <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template&lt;class T&gt;</span><br><span class="line">typename T::value_type <span class="title function_">DummyHash</span><span class="params">(<span class="type">const</span> T&amp; buffer)</span> &#123;</span><br><span class="line">  typename T::value_type hash = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> value : buffer)</span><br><span class="line">    hash ^= value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">constexpr <span class="keyword">auto</span> kMagicHeader = <span class="string">&quot;ZN_2016&quot;</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxPacketLen = <span class="number">1024</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxBodyLength = <span class="number">1024</span> - <span class="keyword">sizeof</span>(kMagicHeader);</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction2</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="type">bool</span> verify_hash)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="keyword">sizeof</span>(kMagicHeader))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">header</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), <span class="keyword">sizeof</span>(kMagicHeader))</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="type">uint8_t</span>, kMaxBodyLength&gt; body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kMagicHeader, header.c_str()))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> target_hash = data[--size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; kMaxPacketLen)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!verify_hash)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::copy(data, data + size, body.data());</span><br><span class="line">  <span class="keyword">auto</span> real_hash = DummyHash(body);</span><br><span class="line">  <span class="keyword">return</span> real_hash == target_hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kZn2016VerifyHashFlag = <span class="number">0x0001000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction3</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="built_in">std</span>::<span class="type">size_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash = flags &amp; kZn2016VerifyHashFlag;</span><br><span class="line">  <span class="keyword">return</span> VulnerableFunction2(data, size, verify_hash);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// LESSONS_04_VULNERABLE_FUNCTIONS_H_</span></span></span><br></pre></td></tr></table></figure>
<p>首先看VulnerableFunction1()，有两个参数data&#x2F;size，当size&gt;3时会产生数组越界。接下来编写测试接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//first_fuzzer.cc</span></span><br><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  VulnerableFunction1(data, size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，直接将Libfuzzer生成的测试样例给到VulnerableFunction1就好。<br>接下来编译：<br><code>clang++ -g -std=c++11 -fsanitize=fuzzer,address first_fuzzer.cc ../../libFuzzer/Fuzzer/libFuzzer.a -o first_fuzzer</code><br>生成可执行程序first_fuzzer。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir corpus1</span><br><span class="line">./first_fuzz corpus1</span><br></pre></td></tr></table></figure>
<p>corpus1是我们提供的语料库。理想情况下，该语料库应该为被测代码提供各种有效和无效的输入，模糊器基于当前语料库中的样本输入生成随机突变。如果突变触发了测试代码中先前未覆盖的路径的执行，则该突变将保存到语料库中以供将来变更。当然LibFuzzer也可以没有任何初始种子的情况下工作（因为上面提到他是evolutionary型的fuzzer），但如果受测试的库接受复杂的结构化输入，则会因为随机产生的样例不易符合导致效率降低。<br>另外，如果我们有太多的样例并希望能够精简一下，则可以：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir corpus1_min</span><br><span class="line">./first_fuzzer -merge=1 corpus1_min corpus1</span><br></pre></td></tr></table></figure>
<p>这样，corpus1_min将会存放精简后的输入样例。</p>
<p>运行后得到crash，很快啊！！！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">04</span> git:(master) ✗ ./first_fuzzer corpus1 </span><br><span class="line">INFO: Seed: <span class="number">2222548757</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">35</span> inline <span class="number">8</span>-bit counters): <span class="number">35</span> [<span class="number">0x7f7120</span>, <span class="number">0x7f7143</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">35</span> PCs): <span class="number">35</span> [<span class="number">0x5b7a68</span>,<span class="number">0x5b7c98</span>), </span><br><span class="line">INFO:        <span class="number">0</span> files found in corpus1</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">3</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">3</span>	NEW    cov: <span class="number">4</span> ft: <span class="number">4</span> corp: <span class="number">2</span>/<span class="number">4</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">1</span> CMP- DE: <span class="string">&quot;\x00\x00&quot;</span>-</span><br><span class="line">#<span class="number">1190</span>	NEW    cov: <span class="number">5</span> ft: <span class="number">5</span> corp: <span class="number">3</span>/<span class="number">7</span>b lim: <span class="number">14</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">2</span> ChangeBinInt-CMP- DE: <span class="string">&quot;F\x00&quot;</span>-</span><br><span class="line">#<span class="number">12191</span>	NEW    cov: <span class="number">6</span> ft: <span class="number">6</span> corp: <span class="number">4</span>/<span class="number">11</span>b lim: <span class="number">122</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> InsertByte-</span><br><span class="line">#<span class="number">12297</span>	REDUCE cov: <span class="number">6</span> ft: <span class="number">6</span> corp: <span class="number">4</span>/<span class="number">10</span>b lim: <span class="number">122</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17213</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">40</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">30</span>/<span class="number">30</span> MS: <span class="number">1</span> InsertRepeatedBytes-</span><br><span class="line">#<span class="number">17274</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">27</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17356</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">24</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">14</span>/<span class="number">14</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">17437</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">18</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17458</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">14</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">9875</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x60200005a1d3</span> at pc <span class="number">0x00000059b461</span> bp <span class="number">0x7ffd79c84880</span> sp <span class="number">0x7ffd79c84878</span></span><br><span class="line">READ of size <span class="number">1</span> at <span class="number">0x60200005a1d3</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59b460</span> in VulnerableFunction1(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">22</span>:<span class="number">14</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59bde4</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/first_fuzzer.cc:<span class="number">10</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x466186</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x7fbfaac5abf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">9</span> <span class="number">0x41f599</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/first_fuzzer+<span class="number">0x41f599</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x60200005a1d3</span> is located <span class="number">0</span> bytes to the right of <span class="number">3</span>-<span class="type">byte</span> region [<span class="number">0x60200005a1d0</span>,<span class="number">0x60200005a1d3</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x597b58</span> in operator <span class="built_in">new</span>[](unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_new_delete.cpp:<span class="number">102</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x466092</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">541</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x7fbfaac5abf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">22</span>:<span class="number">14</span> in VulnerableFunction1(unsigned char <span class="keyword">const</span>*, unsigned long)</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c04800033e0</span>: fa fa fd fa fa fa fd fd fa fa fd fd fa fa fd fd</span><br><span class="line">  <span class="number">0x0c04800033f0</span>: fa fa fd fd fa fa fd fa fa fa fd fa fa fa fd fd</span><br><span class="line">  <span class="number">0x0c0480003400</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  <span class="number">0x0c0480003410</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  <span class="number">0x0c0480003420</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">=&gt;<span class="number">0x0c0480003430</span>: fa fa fd fa fa fa fd fa fa fa[<span class="number">03</span>]fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003440</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003450</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003460</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003470</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003480</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">9875</span>==ABORTING</span><br><span class="line">MS: <span class="number">1</span> EraseBytes-; base unit: aea2e3923af219a8956f626558ef32f30a914ebc</span><br><span class="line"><span class="number">0x46</span>,<span class="number">0x55</span>,<span class="number">0x5a</span>,</span><br><span class="line">FUZ</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-0</span>eb8e4ed029b774d80f2b66408203801cb982a60</span><br><span class="line">Base64: RlVa</span><br></pre></td></tr></table></figure>
<p>需要注意的地方有点多:<br>前面的几行输出fuzzer相关的选项和配置信息。seed&#x3D;2222548757是生成的随机数种子，可以利用<code>./first_fuzzer -seed=2222548757</code>指定随机种子。-max_len为测试输入的最大长度</p>
<p>以#开头的表示在fuzz的过程中覆盖的路径信息。<br><code>INITED</code> fuzzer已完成初始化，其中包括通过被测代码运行每个初始输入样本。<br><code>READ</code> fuzzer已从语料库目录中读取了所有提供的输入样本。<br><code>NEW</code> fuzzer创建了一个测试输入，该输入涵盖了被测代码的新区域。此输入将保存到主要语料库目录。<br><code>pulse</code> fuzzer已生成 2的n次方个输入（定期生成以使用户确信fuzzer仍在工作）。<br><code>REDUCE</code> fuzzer发现了一个更好（更小）的输入，可以触发先前发现的特征（设置-reduce_inputs&#x3D;0以禁用）。<br><code>cov</code> 执行当前语料库所覆盖的代码块或边的总数。<br><code>ft</code> libFuzzer使用不同的信号来评估代码覆盖率：边缘覆盖率，边缘计数器，值配置文件，间接调用方&#x2F;被调用方对等。这些组合的信号称为功能（ft：）。<br><code>corp</code> 当前内存中测试语料库中的条目数及其大小（以字节为单位）。<br><code>exec/s</code> 每秒模糊器迭代的次数。<br><code>rss</code> 当前的内存消耗。<br><code>L</code> 新输入的大小（以字节为单位）。<br><code>MS：&lt;n&gt; &lt;操作&gt;</code> 计数和用于生成输入的变异操作列表</p>
<p><code>#17458	REDUCE cov: 7 ft: 7 corp: 5/14b lim: 170 exec/s: 0 rss: 29Mb L: 4/4 MS: 1 EraseBytes-</code><br>指尝试了17458个输入，成功发现了5个样本（放入语料库）大小为14b，共覆盖了7个代码块，占用内存29mb，变异操作为EraseBytes-。</p>
<p>接下来就是异常检测相关的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==9875==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60200005a1d3 at pc 0x00000059b461 bp 0x7ffd79c84880 sp 0x7ffd79c84878</span><br><span class="line">READ of size 1 at 0x60200005a1d3 thread T0</span><br></pre></td></tr></table></figure>
<p>可以看到AddressSanitizer检测到其中的一个输入触发了堆溢出（heap-buffer-overflow）的漏洞。<br>更据错误信息中的<code> #0 0x59b460 in VulnerableFunction1(unsigned char const*, unsigned long) /home/admin/libfuzzer-workshop/lessons/04/./vulnerable_functions.h:22:14</code>可以看到错误点在<code>vulnerable_functions.h:22:14</code>，对应<code>             data[3] == &#39;Z&#39;;</code>即数组越界的位置。下面的SUMMARY也与之对应。</p>
<p>倒数第二行给出了造成crash的输入，并将其写入了crash-0eb8e4ed029b774d80f2b66408203801cb982a60。<br>复现crash可执行<code>./first_fuzzer ./crash-0eb8e4ed029b774d80f2b66408203801cb982a60</code>。</p>
<p>这样fuzz tesing基本上已经完成了，我们得到了一个造成程序crash的输入，并得知存在堆溢出的漏洞。这样我们就可以有针对性的对程序进行动态调试，利用造成crash的输入回溯出漏洞的细节。</p>
<p>继续fuzz函数VulnerableFunction2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="keyword">auto</span> kMagicHeader = <span class="string">&quot;ZN_2016&quot;</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxPacketLen = <span class="number">1024</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxBodyLength = <span class="number">1024</span> - <span class="keyword">sizeof</span>(kMagicHeader);</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction2</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="type">bool</span> verify_hash)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="keyword">sizeof</span>(kMagicHeader))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">header</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), <span class="keyword">sizeof</span>(kMagicHeader))</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="type">uint8_t</span>, kMaxBodyLength&gt; body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kMagicHeader, header.c_str()))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> target_hash = data[--size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; kMaxPacketLen)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!verify_hash)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::copy(data, data + size, body.data());</span><br><span class="line">  <span class="keyword">auto</span> real_hash = DummyHash(body);</span><br><span class="line">  <span class="keyword">return</span> real_hash == target_hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数多了一个bool参数，因此我们的的接口函数要有所改动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash_flags[] = &#123;<span class="literal">true</span>, <span class="literal">false</span>&#125;;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> flag : verify_hash_flags)</span><br><span class="line">	VulnerableFunction2(data, size, flag);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了提高fuzz出crash的概率，我们要分别fuzz flag为true和false的请况，而不应该把flag写死。<br>接着编译并执行得到：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">INFO: Seed: <span class="number">296692635</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">37</span> inline <span class="number">8</span>-bit counters): <span class="number">37</span> [<span class="number">0x7f8160</span>, <span class="number">0x7f8185</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">37</span> PCs): <span class="number">37</span> [<span class="number">0x5b7d00</span>,<span class="number">0x5b7f50</span>), </span><br><span class="line">INFO:        <span class="number">0</span> files found in corpus2</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">5</span> ft: <span class="number">6</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">414</span>	NEW    cov: <span class="number">6</span> ft: <span class="number">7</span> corp: <span class="number">2</span>/<span class="number">9</span>b lim: <span class="number">8</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">2</span> ChangeByte-CrossOver-</span><br><span class="line">	NEW_FUNC[<span class="number">1</span>/<span class="number">13</span>]: <span class="number">0x59bab0</span> in unsigned char* std::<span class="built_in">copy</span>&lt;unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">447</span></span><br><span class="line">	NEW_FUNC[<span class="number">2</span>/<span class="number">13</span>]: <span class="number">0x59bb40</span> in std::array&lt;unsigned char, <span class="number">1016</span>ul&gt;::data() /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/array:<span class="number">235</span></span><br><span class="line">#<span class="number">584</span>	NEW    cov: <span class="number">24</span> ft: <span class="number">26</span> corp: <span class="number">3</span>/<span class="number">17</span>b lim: <span class="number">8</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">5</span> CopyPart-CopyPart-ShuffleBytes-CrossOver-CMP- DE: <span class="string">&quot;ZN_2016&quot;</span>-</span><br><span class="line">#<span class="number">105505</span>	NEW    cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1067</span>b lim: <span class="number">1050</span> exec/s: <span class="number">0</span> rss: <span class="number">47</span>Mb L: <span class="number">1050</span>/<span class="number">1050</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">106508</span>	REDUCE cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1046</span>b lim: <span class="number">1050</span> exec/s: <span class="number">0</span> rss: <span class="number">48</span>Mb L: <span class="number">1029</span>/<span class="number">1029</span> MS: <span class="number">3</span> EraseBytes-ChangeBit-CopyPart-</span><br><span class="line">#<span class="number">108257</span>	REDUCE cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1043</span>b lim: <span class="number">1060</span> exec/s: <span class="number">0</span> rss: <span class="number">49</span>Mb L: <span class="number">1026</span>/<span class="number">1026</span> MS: <span class="number">4</span> ChangeByte-ChangeByte-CrossOver-InsertRepeatedBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">10468</span>==ERROR: AddressSanitizer: stack-buffer-overflow on address <span class="number">0x7fff31422548</span> at pc <span class="number">0x00000055286d</span> bp <span class="number">0x7fff31421f90</span> sp <span class="number">0x7fff31421740</span></span><br><span class="line">WRITE of size <span class="number">1023</span> at <span class="number">0x7fff31422548</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x55286c</span> in __asan_memmove /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:<span class="number">30</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59c238</span> in unsigned char* std::__copy_move&lt;<span class="literal">false</span>, <span class="literal">true</span>, std::random_access_iterator_tag&gt;::__copy_m&lt;unsigned char&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">368</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x59c158</span> in unsigned char* std::__copy_move_a&lt;<span class="literal">false</span>, unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">385</span>:<span class="number">14</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x59c0b6</span> in unsigned char* std::__copy_move_a2&lt;<span class="literal">false</span>, unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">422</span>:<span class="number">18</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x59bb39</span> in unsigned char* std::<span class="built_in">copy</span>&lt;unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">454</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x59b8b5</span> in VulnerableFunction2(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">61</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x59bf63</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/second_fuzzer.cc:<span class="number">12</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x466186</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">13</span> <span class="number">0x7fd1b4bf6bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">14</span> <span class="number">0x41f599</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/second_fuzzer+<span class="number">0x41f599</span>)</span><br><span class="line"></span><br><span class="line">Address <span class="number">0x7fff31422548</span> is located in stack of thread T0 at offset <span class="number">1128</span> in frame</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59b4af</span> in VulnerableFunction2(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">42</span></span><br><span class="line"></span><br><span class="line">  This frame has <span class="number">3</span> object(s):</span><br><span class="line">    [<span class="number">32</span>, <span class="number">64</span>) <span class="string">&#x27;header&#x27;</span> (line <span class="number">46</span>)</span><br><span class="line">    [<span class="number">96</span>, <span class="number">97</span>) <span class="string">&#x27;ref.tmp&#x27;</span> (line <span class="number">46</span>)</span><br><span class="line">    [<span class="number">112</span>, <span class="number">1128</span>) <span class="string">&#x27;body&#x27;</span> (line <span class="number">48</span>) &lt;== Memory access at offset <span class="number">1128</span> overflows this variable</span><br><span class="line">HINT: this may be a <span class="literal">false</span> positive <span class="keyword">if</span> your program uses some custom stack unwind mechanism, swapcontext or vfork</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:<span class="number">30</span> in __asan_memmove</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x10006627c450</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c460</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c470</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c480</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c490</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x10006627c4a0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>[f3]f3 f3 f3 f3 f3 f3</span><br><span class="line">  <span class="number">0x10006627c4b0</span>: f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4c0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4d0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4e0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f1 f1 f1 f1 <span class="number">02</span> f3 f3 f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4f0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">10468</span>==ABORTING</span><br><span class="line">MS: <span class="number">4</span> ChangeBinInt-CrossOver-ChangeByte-EraseBytes-; base unit: e63bf1b07c6950248bb14fe74c3a84f06c711b15</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-a42cbe2ff7331f281ef213e54919e8cd932883bd</span><br></pre></td></tr></table></figure>
<p>相信大家已经不再陌生了，定位错误位于<code>#5 0x59b8b5 in VulnerableFunction2(unsigned char const*, unsigned long, bool) /home/admin/libfuzzer-workshop/lessons/04/./vulnerable_functions.h:61:3</code><br>即<code>  std::copy(data, data + size, body.data());</code>，该句造成了stack_overflow，原因在于vector类型的body的大小为1024 - sizeof(kMagicHeader)，而在copy时的data的size的限制条件是<code>size &gt; kMaxPacketLen(1024)</code>，从而造成了缓冲区溢出。</p>
<p>如果我们写死flag为false的话就可能会跑很久，也跑不出来crash。因此，我们在套用模板时要结合函数的逻辑，使得fuzz的接口设计的更加合理，从而增加fuzz的效率。</p>
<p>继续继续VulnerableFunction3:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kZn2016VerifyHashFlag = <span class="number">0x0001000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction3</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="built_in">std</span>::<span class="type">size_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash = flags &amp; kZn2016VerifyHashFlag;</span><br><span class="line">  <span class="keyword">return</span> VulnerableFunction2(data, size, verify_hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，与2不同的地方就是对flag进行了&amp; kZn2016VerifyHashFlag的计算，这种其实我们可以计算出使得<code>flags &amp; kZn2016VerifyHashFlag</code>为true&#x2F;false的输入，并模仿second_fuzzer那样写个循环，这样就和2没差了。<br>但这里workshop提供了一个不同的方法：<code>In this case, we can get some randomization of flags values using data provided by libFuzzer:</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">data_string</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), size)</span>;</span><br><span class="line">  <span class="keyword">auto</span> data_hash = <span class="built_in">std</span>::hash&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;()(data_string);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="type">size_t</span> flags = static_cast&lt;<span class="type">size_t</span>&gt;(data_hash);</span><br><span class="line">  VulnerableFunction3(data, size, flags);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>采用了libfuzzer提供的随机化方法使得我们的输入flag为随机数，从而<code>flags &amp; kZn2016VerifyHashFlag</code>的结果也随机化。在次数足够多的情况下false和true的情况将趋于同为50%。</p>
<h6 id="接下来看lesson05："><a href="#接下来看lesson05：" class="headerlink" title="接下来看lesson05："></a>接下来看lesson05：</h6><p>这次的目标和lesson04有所不同，lesson04中我们针对.h函数库中的函数进行fuzz，而libfuzzer的威力远不止于此，它还可以对大型开源库进行模糊测试。在源码编译开源库时选择合适的选项以及将libfuzzer与开源库链接在一起以进行fuzz，这些细节将在该lesson05体现。</p>
<p>首先解包<code>tar xzf openssl1.0.1f.tgz</code>。接着执行<code>./config</code>生成makefile。之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">make CC=&quot;clang -O2 -fno-omit-frame-pointer -g -fsanitize=address&quot; -j$(nproc)</span><br></pre></td></tr></table></figure>
<p>第二条指令其实并不太规范，将编辑器以外的其他参数也一股脑写到CC变量里了。clang后的参数本应该是由CFLAGS或CXXFLAGS指定的。解释一下选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-02 指定优先级别</span><br><span class="line">-g 带有调试符号来编译</span><br><span class="line">-fno-omit-frame-pointer 对于不需要栈指针的函数就不在寄存器中保存指针，因此可以忽略存储和检索地址的代码，同时对许多函数提供一个额外的寄存器。所有”-O”级别都打开它，但仅在调试器可以不依靠栈指针运行时才有效。在AMD64平台上此选项默认打开，但是在x86平台上则默认关闭。建议显式的设置它。</span><br><span class="line">-fsanitize 指定sanitize</span><br></pre></td></tr></table></figure>
<p>这些参数的指定是至关重要的，它会影响到之后开源库与libfuzzer的链接以及fuzz的效率。如果不设置这些编译选项直接make的话fuzz的效率如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">05</span> git:(master) ✗ ./openssl_fuzzer2</span><br><span class="line">INFO: Seed: <span class="number">1865248494</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">10</span> inline <span class="number">8</span>-bit counters): <span class="number">10</span> [<span class="number">0x96c950</span>, <span class="number">0x96c95a</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">10</span> PCs): <span class="number">10</span> [<span class="number">0x6d56d0</span>,<span class="number">0x6d5770</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb</span><br><span class="line">#<span class="number">131072</span>	pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">1300</span> exec/s: <span class="number">43690</span> rss: <span class="number">388</span>Mb</span><br><span class="line">#<span class="number">262144</span>	pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">2611</span> exec/s: <span class="number">43690</span> rss: <span class="number">397</span>Mb</span><br><span class="line">#<span class="number">524288</span>	pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">37449</span> rss: <span class="number">411</span>Mb</span><br><span class="line">#<span class="number">1048576</span>	pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">34952</span> rss: <span class="number">411</span>Mb</span><br><span class="line">#<span class="number">2097152</span>	pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">32768</span> rss: <span class="number">411</span>Mb</span><br></pre></td></tr></table></figure>
<p>这路径覆盖率太感人，其中的重要原因就在于编译开源库时的选项设置。<br>设置编译选项后的fuzz效果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">INFO: Seed: <span class="number">2565779026</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">35878</span> inline <span class="number">8</span>-bit counters): <span class="number">35878</span> [<span class="number">0xcd8590</span>, <span class="number">0xce11b6</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">35878</span> PCs): <span class="number">35878</span> [<span class="number">0x954da8</span>,<span class="number">0x9e1008</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">410</span> ft: <span class="number">411</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">36</span>Mb</span><br><span class="line">#<span class="number">112</span>	NEW    cov: <span class="number">413</span> ft: <span class="number">416</span> corp: <span class="number">2</span>/<span class="number">2</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">42</span>Mb L: <span class="number">1</span>/<span class="number">1</span> MS: <span class="number">5</span> ChangeBit-ChangeBinInt-ChangeByte-InsertByte-EraseBytes-</span><br><span class="line">	NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x65f0a0</span> in ERR_put_error /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/err/err.c:<span class="number">708</span></span><br><span class="line">#<span class="number">319</span>	NEW    cov: <span class="number">420</span> ft: <span class="number">448</span> corp: <span class="number">3</span>/<span class="number">8</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">51</span>Mb L: <span class="number">6</span>/<span class="number">6</span> MS: <span class="number">2</span> ShuffleBytes-CrossOver-</span><br><span class="line">#<span class="number">327</span>	REDUCE cov: <span class="number">420</span> ft: <span class="number">448</span> corp: <span class="number">3</span>/<span class="number">7</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">51</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">3</span> ChangeByte-EraseBytes-CrossOver-</span><br><span class="line">	NEW_FUNC[<span class="number">1</span>/<span class="number">2</span>]: <span class="number">0x562a40</span> in tls1_enc /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_enc.c:<span class="number">685</span></span><br><span class="line">	NEW_FUNC[<span class="number">2</span>/<span class="number">2</span>]: <span class="number">0x67e1d0</span> in EVP_MD_CTX_md /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/evp/evp_lib.c:<span class="number">282</span></span><br><span class="line">#<span class="number">454</span>	REDUCE cov: <span class="number">431</span> ft: <span class="number">467</span> corp: <span class="number">4</span>/<span class="number">12</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">57</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">2</span> ShuffleBytes-CMP- DE: <span class="string">&quot;\xfd\x03\x00\x00&quot;</span>-</span><br><span class="line">	NEW_FUNC[<span class="number">1</span>/<span class="number">6</span>]: <span class="number">0x5663d0</span> in tls1_alert_code /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_enc.c:<span class="number">1214</span></span><br><span class="line">	NEW_FUNC[<span class="number">2</span>/<span class="number">6</span>]: <span class="number">0x5c6560</span> in do_ssl3_write /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_pkt.c:<span class="number">634</span></span><br><span class="line">#<span class="number">470</span>	NEW    cov: <span class="number">465</span> ft: <span class="number">514</span> corp: <span class="number">5</span>/<span class="number">17</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">1</span> ChangeByte-</span><br><span class="line">#<span class="number">472</span>	REDUCE cov: <span class="number">465</span> ft: <span class="number">521</span> corp: <span class="number">6</span>/<span class="number">23</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">6</span>/<span class="number">6</span> MS: <span class="number">2</span> CrossOver-CrossOver-</span><br><span class="line">#<span class="number">475</span>	NEW    cov: <span class="number">467</span> ft: <span class="number">523</span> corp: <span class="number">7</span>/<span class="number">28</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">5</span>/<span class="number">6</span> MS: <span class="number">3</span> PersAutoDict-ChangeByte-ShuffleBytes- DE: <span class="string">&quot;\xfd\x03\x00\x00&quot;</span>-</span><br><span class="line">#<span class="number">1025</span>	NEW    cov: <span class="number">467</span> ft: <span class="number">526</span> corp: <span class="number">8</span>/<span class="number">39</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">81</span>Mb L: <span class="number">11</span>/<span class="number">11</span> MS: <span class="number">5</span> CopyPart-ShuffleBytes-CrossOver-ShuffleBytes-ChangeBinInt-</span><br><span class="line">#<span class="number">1097</span>	NEW    cov: <span class="number">474</span> ft: <span class="number">549</span> corp: <span class="number">9</span>/<span class="number">49</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">84</span>Mb L: <span class="number">10</span>/<span class="number">11</span> MS: <span class="number">2</span> ChangeBit-CopyPart-</span><br><span class="line">#<span class="number">1293</span>	REDUCE cov: <span class="number">474</span> ft: <span class="number">549</span> corp: <span class="number">9</span>/<span class="number">48</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">92</span>Mb L: <span class="number">10</span>/<span class="number">10</span> MS: <span class="number">1</span> EraseBytes-</span><br></pre></td></tr></table></figure>
<p>选择合适的编译器和编译选项，完成对该库的源码编译，生成.a文件。接下来就要研究编写fuzzer接口函数了。<br>workshop提供了openssl_fuzzer.cc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CERT_PATH</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CERT_PATH</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">SSL_CTX *<span class="title function_">Init</span><span class="params">()</span> &#123;</span><br><span class="line">  SSL_library_init();</span><br><span class="line">  SSL_load_error_strings();</span><br><span class="line">  ERR_load_BIO_strings();</span><br><span class="line">  OpenSSL_add_all_algorithms();</span><br><span class="line">  SSL_CTX *sctx;</span><br><span class="line">  assert (sctx = SSL_CTX_new(TLSv1_method()));</span><br><span class="line">  <span class="comment">/* These two file were created with this command:</span></span><br><span class="line"><span class="comment">      openssl req -x509 -newkey rsa:512 -keyout server.key \</span></span><br><span class="line"><span class="comment">     -out server.pem -days 9999 -nodes -subj /CN=a/</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  assert(SSL_CTX_use_certificate_file(sctx, CERT_PATH <span class="string">&quot;server.pem&quot;</span>,</span><br><span class="line">                                      SSL_FILETYPE_PEM));</span><br><span class="line">  assert(SSL_CTX_use_PrivateKey_file(sctx, CERT_PATH <span class="string">&quot;server.key&quot;</span>,</span><br><span class="line">                                     SSL_FILETYPE_PEM));</span><br><span class="line">  <span class="keyword">return</span> sctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  <span class="type">static</span> SSL_CTX *sctx = Init();</span><br><span class="line">  SSL *server = SSL_new(sctx);</span><br><span class="line">  BIO *sinbio = BIO_new(BIO_s_mem());</span><br><span class="line">  BIO *soutbio = BIO_new(BIO_s_mem());</span><br><span class="line">  SSL_set_bio(server, sinbio, soutbio);</span><br><span class="line">  SSL_set_accept_state(server);</span><br><span class="line">  BIO_write(sinbio, Data, Size);</span><br><span class="line">  SSL_do_handshake(server);</span><br><span class="line">  SSL_free(server);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就涉及到openssl库提供的相关方法了，本篇主要讲解fuzz相关，就不细讲openssl了。总之就是要先搞清楚openssl的用法，再通过include openssl提供的函数来对openssl进行fuzz。编译如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang++ -g openssl_fuzzer.cc -O2 -fno-omit-frame-pointer -fsanitize=address,fuzzer \</span><br><span class="line">    -I openssl1.0.1f/include openssl1.0.1f/libssl.a openssl1.0.1f/libcrypto.a \</span><br><span class="line">    ../../libFuzzer/Fuzz/libFuzzer.a -o openssl_fuzzer</span><br></pre></td></tr></table></figure>
<p>-I指定inlcude的搜索路径，同时链接静态库libcrypto.a和libFuzzer.a以使用库中的函数。</p>
<p>运行跑出crash:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">24646</span>	REDUCE cov: <span class="number">611</span> ft: <span class="number">889</span> corp: <span class="number">50</span>/<span class="number">1105</span>b lim: <span class="number">116</span> exec/s: <span class="number">24646</span> rss: <span class="number">382</span>Mb L: <span class="number">64</span>/<span class="number">77</span> MS: <span class="number">5</span> InsertRepeatedBytes-PersAutoDict-InsertByte-ShuffleBytes-ChangeBit- DE: <span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x04&quot;</span>-</span><br><span class="line">#<span class="number">25193</span>	REDUCE cov: <span class="number">611</span> ft: <span class="number">889</span> corp: <span class="number">50</span>/<span class="number">1097</span>b lim: <span class="number">116</span> exec/s: <span class="number">25193</span> rss: <span class="number">382</span>Mb L: <span class="number">61</span>/<span class="number">77</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">2133</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x629000009748</span> at pc <span class="number">0x00000051eaba</span> bp <span class="number">0x7ffd255dae50</span> sp <span class="number">0x7ffd255da618</span></span><br><span class="line">READ of size <span class="number">21050</span> at <span class="number">0x629000009748</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x51eab9</span> in __asan_memcpy /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:<span class="number">22</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x55e323</span> in tls1_process_heartbeat /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_lib.c:<span class="number">2586</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x5cb97d</span> in ssl3_read_bytes /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_pkt.c:<span class="number">1092</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x5cff83</span> in ssl3_get_message /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">457</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x59ac86</span> in ssl3_get_client_hello /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">941</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x596ac1</span> in ssl3_accept /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">357</span>:<span class="number">9</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x5518ad</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer.cc:<span class="number">39</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x459a01</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">553</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x459245</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">469</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x45b4e7</span> in fuzzer::Fuzzer::MutateAndTestOne() /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">695</span>:<span class="number">19</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x45c205</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">831</span>:<span class="number">5</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x449fc8</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">825</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x473432</span> in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">13</span> <span class="number">0x7f40a3932bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">14</span> <span class="number">0x41e159</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer2+<span class="number">0x41e159</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x629000009748</span> is located <span class="number">0</span> bytes to the right of <span class="number">17736</span>-<span class="type">byte</span> region [<span class="number">0x629000005200</span>,<span class="number">0x629000009748</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x51f67d</span> in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:<span class="number">145</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x60091b</span> in CRYPTO_malloc /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/mem.c:<span class="number">308</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x5d1737</span> in freelist_extract /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">708</span>:<span class="number">12</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x5d1737</span> in ssl3_setup_read_buffer /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">770</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x5d1d4c</span> in ssl3_setup_buffers /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">827</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x597703</span> in ssl3_accept /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">292</span>:<span class="number">9</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x5518ad</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer.cc:<span class="number">39</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x459a01</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">553</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x45b8a5</span> in fuzzer::Fuzzer::ReadAndExecuteSeedCorpora(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">740</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x45be79</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">793</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x449fc8</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">825</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x473432</span> in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x7f40a3932bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:<span class="number">22</span>:<span class="number">3</span> in __asan_memcpy</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c527fff9290</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92a0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92b0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92c0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92d0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x0c527fff92e0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>[fa]fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff92f0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9300</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9310</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9320</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9330</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">2133</span>==ABORTING</span><br><span class="line">MS: <span class="number">2</span> ChangeBinInt-InsertByte-; base unit: <span class="number">7</span>bfa057a7ae6a7bc6ea487749407e4e7d4e9bf84</span><br><span class="line"><span class="number">0x15</span>,<span class="number">0x3</span>,<span class="number">0xd4</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0xd3</span>,<span class="number">0xb3</span>,<span class="number">0x18</span>,<span class="number">0x3</span>,<span class="number">0xd4</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x52</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x9</span>,<span class="number">0xd3</span>,<span class="number">0xb3</span>,<span class="number">0x18</span>,<span class="number">0x2c</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x2</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x0</span>,</span><br><span class="line">\x15\x03\xd4\x00\x07\x01:\x01:\x01\xd3\xb3\x18\x03\xd4\x00\x07\x01R:\x01:\x09\xd3\xb3\x18,\x00\x07\x02\x07\x01:\x01\x00</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-4</span>bfb53055de3fed318590b20ddd4cda0d95e8ed8</span><br><span class="line">Base64: FQPUAAcBOgE6AdOzGAPUAAcBUjoBOgnTsxgsAAcCBwE6AQA=</span><br></pre></td></tr></table></figure>
<p>通过SUMMARY容易找到造成heap_overflow的漏洞点在于:<code>/local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:22:3 in __asan_memcpy</code>这种目录一看就是很底层的目录，不易定位。再往找一层:<code>#1 0x55e323 in tls1_process_heartbeat /home/admin/libfuzzer-workshop/lessons/05/openssl1.0.1f/ssl/t1_lib.c:2586:3</code>这就很容易定位了，接下来就是漏洞溯源了。<br>定位到了代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">tls1_process_heartbeat(SSL *s)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = &amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], *pl;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> hbtype;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> payload;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> padding = <span class="number">16</span>; <span class="comment">/* Use minimum padding */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Read type and payload length first */</span></span><br><span class="line">	hbtype = *p++;</span><br><span class="line">	n2s(p, payload);</span><br><span class="line">	pl = p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s-&gt;msg_callback)</span><br><span class="line">		s-&gt;msg_callback(<span class="number">0</span>, s-&gt;version, TLS1_RT_HEARTBEAT,</span><br><span class="line">			&amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], s-&gt;s3-&gt;rrec.length,</span><br><span class="line">			s, s-&gt;msg_callback_arg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hbtype == TLS1_HB_REQUEST)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> *buffer, *bp;</span><br><span class="line">		<span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Allocate memory for the response, size is 1 bytes</span></span><br><span class="line"><span class="comment">		 * message type, plus 2 bytes payload length, plus</span></span><br><span class="line"><span class="comment">		 * payload, plus padding</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		buffer = OPENSSL_malloc(<span class="number">1</span> + <span class="number">2</span> + payload + padding);</span><br><span class="line">		bp = buffer;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* Enter response type, length and copy payload */</span></span><br><span class="line">		*bp++ = TLS1_HB_RESPONSE;</span><br><span class="line">		s2n(payload, bp);</span><br><span class="line">		<span class="built_in">memcpy</span>(bp, pl, payload);   <span class="comment">//漏洞点</span></span><br><span class="line">		bp += payload;</span><br><span class="line">		<span class="comment">/* Random padding */</span></span><br><span class="line">		RAND_pseudo_bytes(bp, padding);</span><br><span class="line"></span><br><span class="line">		r = ssl3_write_bytes(s, TLS1_RT_HEARTBEAT, buffer, <span class="number">3</span> + payload + padding);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (r &gt;= <span class="number">0</span> &amp;&amp; s-&gt;msg_callback)</span><br><span class="line">			s-&gt;msg_callback(<span class="number">1</span>, s-&gt;version, TLS1_RT_HEARTBEAT,</span><br><span class="line">				buffer, <span class="number">3</span> + payload + padding,</span><br><span class="line">				s, s-&gt;msg_callback_arg);</span><br><span class="line"></span><br><span class="line">		OPENSSL_free(buffer);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> r;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (hbtype == TLS1_HB_RESPONSE)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> seq;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* We only send sequence numbers (2 bytes unsigned int),</span></span><br><span class="line"><span class="comment">		 * and 16 random bytes, so we just try to read the</span></span><br><span class="line"><span class="comment">		 * sequence number */</span></span><br><span class="line">		n2s(pl, seq);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (payload == <span class="number">18</span> &amp;&amp; seq == s-&gt;tlsext_hb_seq)</span><br><span class="line">			&#123;</span><br><span class="line">			s-&gt;tlsext_hb_seq++;</span><br><span class="line">			s-&gt;tlsext_hb_pending = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>漏洞点再<code>memcpy(bp, pl, payload);</code>根据crash原因为over_flow说明payload的长度有问题。往上分析发现payload是通过n2s函数从p指向的结构体（用户数据包）内容得到的。该结构体为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl3_record_st</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">int</span> type;               / type of record /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> length;    / How many bytes available /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> off;       / read/write offset into <span class="string">&#x27;buf&#x27;</span> /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> data;    / pointer to the record data /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> input;   / where the decode bytes are /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> comp;    / only used with decompression - <span class="built_in">malloc</span>()ed /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> epoch;    / epoch number, needed by DTLS1 /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> seq_num[<span class="number">8</span>]; / sequence number, needed by DTLS1 /</span><br><span class="line">    &#125; SSL3_RECORD;</span><br></pre></td></tr></table></figure>
<p>而程序并没有对用户可控的length做检查，从而导致memcpy溢出（有可能将server端的数据写入到返回数据包中返回给用户）。</p>
<p>初学libfuzzer，如有纰漏错误还烦请师傅们指正。</p>
<h6 id="lesson06-gogogo"><a href="#lesson06-gogogo" class="headerlink" title="lesson06 gogogo!"></a>lesson06 gogogo!</h6><p>06给出的是CVE-2016-5180漏洞，该漏洞可以实现在ChromeOS下的远程代码执行，无疑是高危漏洞。<br>PS：我觉得在学习libfuzzer的过程中，我们不能仅仅局限局限于获得了一个crash，还要进一步的去定位漏洞之所在，分析漏洞产生的原因，思考漏洞的利用方法和修补方式，这才是正确对待fuzz的态度以及漏洞挖掘的魅力所在。<br>如同05所作的步骤，我们要先对开源库进行编译</p>
<p>如果我们单纯直接编译而不进行编译插桩的话:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf c-ares.tgz</span><br><span class="line">cd c-ares</span><br><span class="line">./buildconf</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>得到的fuzz效果为：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">06</span> git:(master) ✗ ./c_ares_fuzzer                                                                    </span><br><span class="line">INFO: Seed: <span class="number">2221841816</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">14</span> inline <span class="number">8</span>-bit counters): <span class="number">14</span> [<span class="number">0x7a7ef8</span>, <span class="number">0x7a7f06</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">14</span> PCs): <span class="number">14</span> [<span class="number">0x5700b8</span>,<span class="number">0x570198</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">4</span> ft: <span class="number">5</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">5</span>	NEW    cov: <span class="number">5</span> ft: <span class="number">6</span> corp: <span class="number">2</span>/<span class="number">3</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">2</span>/<span class="number">2</span> MS: <span class="number">3</span> ShuffleBytes-ChangeByte-CopyPart-</span><br><span class="line">#<span class="number">1337</span>	NEW    cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">20</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">2</span> ShuffleBytes-CrossOver-</span><br><span class="line">#<span class="number">1357</span>	REDUCE cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">16</span>/<span class="number">16</span> MS: <span class="number">5</span> CrossOver-EraseBytes-CopyPart-ChangeBinInt-InsertRepeatedBytes-</span><br><span class="line">#<span class="number">524288</span>	pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">712</span>Mb</span><br><span class="line">#<span class="number">1048576</span>	pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">775</span>Mb</span><br><span class="line">#<span class="number">2097152</span>	pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">777</span>Mb</span><br><span class="line">#<span class="number">4194304</span>	pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">246723</span> rss: <span class="number">777</span>Mb</span><br><span class="line">#<span class="number">8388608</span>	pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">220752</span> rss: <span class="number">777</span>Mb</span><br></pre></td></tr></table></figure>
<p>出现如此boring的结果的原因再与缺少了编译时的选项设置，即没有在编译时进行插桩<br>插桩操作：在其中特定的的位置插入汇编代码，实现在程序执行到该处时能够通过此处的插桩掌握程序的执行路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf c-ares.tgz</span><br><span class="line">cd c-ares</span><br><span class="line">./buildconf</span><br><span class="line">./configure CC=&quot;clang -O2 -fno-omit-frame-pointer -g -fsanitize=address&quot;</span><br><span class="line">make CFLAGS=</span><br></pre></td></tr></table></figure>
<p>这里的<code>-fsanitize=address</code>即开启ASAN(Address Sanitizer)，编译时则会在目标代码的关键位置添加检查代码，例如：malloc(),free()等，一旦发现了内存访问错误，便可以SIGABRT中止程序。（即完成了编译插桩）<br>这里指定CC选项也是不规范的，提倡<code>CC = &quot;clang&quot; &amp;&amp; CFLAGS = &quot;-O2 -fno-omit-frame-pointer -g -fsanitize=address&quot;</code><br>顺利编译生成.a静态链接库文件，接着是编写fuzzer接口函数。<br>workshop提供给我们的harness如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/nameser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ares.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">  <span class="type">int</span> buflen;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">s</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span> *&gt;(data), size)</span>;</span><br><span class="line">  ares_create_query(s.c_str(), ns_c_in, ns_t_a, <span class="number">0x1234</span>, <span class="number">0</span>, &amp;buf, &amp;buflen, <span class="number">0</span>);</span><br><span class="line">  ares_free_string(buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到harness将输入的测试样本data类型转化为strings s，之后选择了<code>ares_creat_query</code>和<code>ares_free_strings</code>作为入口函数来进行fuzz。<br>编译：<code>clang++ -g c_ares_fuzzer.cc -O2 -fno-omit-frame-pointer -fsanitize=address,fuzzer -Ic-ares c-ares/.libs/libcares.a</code><br>运行后很快得到了crash说明提供的harness是很有效的，接口函数的选择合适。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="number">06</span> git:(master) ✗ ./c_ares_fuzzer </span><br><span class="line">INFO: Seed: <span class="number">3003118136</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">11</span> inline <span class="number">8</span>-bit counters): <span class="number">11</span> [<span class="number">0x7f72c0</span>, <span class="number">0x7f72cb</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">11</span> PCs): <span class="number">11</span> [<span class="number">0x5b7740</span>,<span class="number">0x5b77f0</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>	INITED cov: <span class="number">4</span> ft: <span class="number">4</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">10</span>	NEW    cov: <span class="number">5</span> ft: <span class="number">5</span> corp: <span class="number">2</span>/<span class="number">3</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">2</span>/<span class="number">2</span> MS: <span class="number">3</span> ShuffleBytes-CrossOver-InsertByte-</span><br><span class="line">#<span class="number">1336</span>	NEW    cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">3</span>/<span class="number">20</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">1385</span>	REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">16</span>/<span class="number">16</span> MS: <span class="number">4</span> CopyPart-EraseBytes-InsertByte-CopyPart-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">7322</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x603000f7b654</span> at pc <span class="number">0x00000059bd4c</span> bp <span class="number">0x7fff83ba42b0</span> sp <span class="number">0x7fff83ba42a8</span></span><br><span class="line">WRITE of size <span class="number">1</span> at <span class="number">0x603000f7b654</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59bd4b</span> in ares_create_query /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">196</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59b33c</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer.cc:<span class="number">16</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x465fe6</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46e66f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x4569f9</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x41f382</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x7f19eeaeabf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">9</span> <span class="number">0x41f3f9</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer+<span class="number">0x41f3f9</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x603000f7b654</span> is located <span class="number">0</span> bytes to the right of <span class="number">20</span>-<span class="type">byte</span> region [<span class="number">0x603000f7b640</span>,<span class="number">0x603000f7b654</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x552ef0</span> in malloc /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:<span class="number">145</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59b826</span> in ares_create_query /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">133</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x59b33c</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer.cc:<span class="number">16</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x465fe6</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x46e66f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x4569f9</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x41f382</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x7f19eeaeabf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">196</span>:<span class="number">3</span> in ares_create_query</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c06801e7670</span>: fd fa fa fa fd fd fd fa fa fa fd fd fd fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7680</span>: fd fd fd fd fa fa fd fd fd fa fa fa fd fd fd fa</span><br><span class="line">  <span class="number">0x0c06801e7690</span>: fa fa fd fd fd fa fa fa fd fd fd fa fa fa fd fd</span><br><span class="line">  <span class="number">0x0c06801e76a0</span>: fd fa fa fa fd fd fd fd fa fa fd fd fd fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76b0</span>: fd fd fd fa fa fa fd fd fd fa fa fa fd fd fd fa</span><br><span class="line">=&gt;<span class="number">0x0c06801e76c0</span>: fa fa fd fd fd fa fa fa <span class="number">00</span> <span class="number">00</span>[<span class="number">04</span>]fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76d0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76e0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76f0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7700</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7710</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">7322</span>==ABORTING</span><br><span class="line">MS: <span class="number">4</span> ChangeByte-ChangeBinInt-CopyPart-ChangeBit-; base unit: <span class="number">900229</span>d109e2354708da1b4fe903c1ef0e741ab8</span><br><span class="line"><span class="number">0xdc</span>,<span class="number">0x2e</span>,<span class="number">0x5c</span>,<span class="number">0x2e</span>,</span><br><span class="line">\xdc.\\.</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-55</span>bfecc1f01482c0ec080b0da9ab7f50cd9fa363</span><br><span class="line">Base64: <span class="number">3</span>C5cLg==</span><br></pre></td></tr></table></figure>
<p>SUMMARY中:<code>SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/06/c-ares/ares_create_query.c:196:3 in ares_create_query</code>，了解到漏洞正位于<code>ares_create_query</code>函数中。定位一下漏洞点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ares_create_query.c:196:3</span></span><br><span class="line"><span class="comment">/* Finish off the question with the type and class. */</span></span><br><span class="line">DNS_QUESTION_SET_TYPE(q, type);</span><br><span class="line">DNS_QUESTION_SET_CLASS(q, dnsclass); <span class="comment">//漏洞点，该处存在heap_overflow</span></span><br></pre></td></tr></table></figure>
<p>但对于漏洞的具体产生方式进行溯源的话就要对代码进行审计，这里就不展开了。</p>
<p>到这里对libfuzzer的基本操作已经有了一个初步的认识，但fuzz的对象都是规模较小的开源库。当我们面对大规模的开源项目以及需要进行长时间的测试工作时，如何继续保持fuzz的高效进行以得到crash便是我们要继续研究的课题，这就涉及到一些对编译选项的设置以及对fuzz的一些额外条件的设定，这些都会可能会影响到fuzz的效率，等待这我们进一步的研究。</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2020/12/22/libfuzzer(2)/" title="（转）LibFuzzer workshop学习之路（二）"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: （转）LibFuzzer workshop学习之路（二）</span></a><a class="button is-default" href="/2020/11/20/kernel_pwn%20%E4%BB%8E%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E7%8B%AC%E5%86%99%E5%88%B0%E6%8F%90%E6%9D%83(1)/" title="kernel_pwn SringsIPC(P1)"><span class="has-text-weight-semibold">下一页: kernel_pwn SringsIPC(P1)</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/haojen"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Haojen 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>